diff -Naur mpg123/Makefile mpg123-new/Makefile
--- mpg123/Makefile	2001-01-23 13:00:46.000000000 -0500
+++ mpg123-new/Makefile	2005-07-29 11:39:56.000000000 -0400
@@ -4,9 +4,9 @@
 
 # Where to install binary and manpage on "make install":
 
-PREFIX=/usr/local
+PREFIX=@FINKPREFIX@
 BINDIR=$(PREFIX)/bin
-MANDIR=$(PREFIX)/man
+MANDIR=$(PREFIX)/share/man
 SECTION=1
 
 ########################################################
@@ -53,6 +53,7 @@
 	@echo "make os2            IBM OS/2"
 	@echo "make netbsd         NetBSD"
 	@echo "make openbsd        OpenBSD"
+	@echo "make macosx         MacOSX"
 	@echo "make mint           MiNT on Atari"
 	@echo "make generic        try this one if your system isn't listed above"
 	@echo ""
@@ -151,144 +152,153 @@
 
 linux-devel:
 	$(MAKE) OBJECTS='decode_i386.o dct64_i386.o audio_oss.o' \
-        CC=gcc LDFLAGS= \
-        CFLAGS='$(CFLAGS) -DREAL_IS_FLOAT -DLINUX -Wall -g -m486 \
+         LDFLAGS= \
+        CFLAGS='$(CFLAGS) -DREAL_IS_FLOAT -DLINUX -Wall -g  \
 		-DOSS -funroll-all-loops \
 		-finline-functions -ffast-math' \
         mpg123-make
 
 linux-profile:
 	$(MAKE) OBJECTS='decode_i386.o dct64_i386.o audio_oss.o' \
-        CC=gcc LDFLAGS='-pg' \
-        CFLAGS='$(CFLAGS) -DREAL_IS_FLOAT -DLINUX -Wall -pg -m486 \
+         LDFLAGS='-pg' \
+        CFLAGS='$(CFLAGS) -DREAL_IS_FLOAT -DLINUX -Wall -pg  \
 		-DOSS -funroll-all-loops \
 		-finline-functions -ffast-math' \
         mpg123-make
 
 linux:
-	$(MAKE) CC=gcc LDFLAGS= \
+	$(MAKE)  LDFLAGS= \
 		OBJECTS='decode_i386.o dct64_i386.o decode_i586.o \
 			audio_oss.o term.o' \
 		CFLAGS='$(CFLAGS) -DI386_ASSEM -DPENTIUM_OPT -DREAL_IS_FLOAT -DLINUX \
 			-DOSS -DTERM_CONTROL\
-			-Wall -O2 -m486 \
+			-Wall   \
+			-fomit-frame-pointer -funroll-all-loops \
+			-finline-functions -ffast-math' \
+		mpg123-make
+
+linux-generic:
+	$(MAKE)  LDFLAGS= \
+		OBJECTS='decode.o dct64.o audio_oss.o' \
+		CFLAGS='$(CFLAGS) -DREAL_IS_FLOAT -DLINUX -Wall \
+			-DOSS \
 			-fomit-frame-pointer -funroll-all-loops \
 			-finline-functions -ffast-math' \
 		mpg123-make
 
 linux-pentium:
-	$(MAKE) CC=gcc LDFLAGS= \
+	$(MAKE)  LDFLAGS= \
 		OBJECTS='decode_i386.o dct64_i386.o decode_i586.o \
 			audio_oss.o term.o' \
 		CFLAGS='$(CFLAGS) -DI386_ASSEM -DPENTIUM_OPT -DREAL_IS_FLOAT -DLINUX \
 			-DOSS -DTERM_CONTROL\
-			-Wall -O2 -mpentium \
+			-Wall  -mpentium \
 			-fomit-frame-pointer -funroll-all-loops \
 			-finline-functions -ffast-math' \
 		mpg123-make
 
 linux-mmx:
-	$(MAKE) CC=gcc LDFLAGS= \
+	$(MAKE)  LDFLAGS= \
 		OBJECTS='decode_i386.o dct64_MMX.o tabinit_MMX.o decode_MMX.o \
 			audio_oss.o term.o' \
 		CFLAGS='-DUSE_MMX -DI386_ASSEM -DPENTIUM_OPT -DREAL_IS_FLOAT \
 			-DLINUX -DOSS -DTERM_CONTROL\
-			-Wall -O2 -m486 \
+			-Wall   \
 			-fomit-frame-pointer -funroll-all-loops \
 			-finline-functions -ffast-math' \
 		mpg123-make
 
 linux-3dnow:
-	$(MAKE) CC=gcc LDFLAGS= \
+	$(MAKE)  LDFLAGS= \
 		OBJECTS='decode_i386.o decode_3dnow.o dct64_3dnow.o \
 			dct64_i386.o dct36_3dnow.o getcpuflags.o \
 			equalizer_3dnow.o decode_i586.o audio_oss.o term.o' \
 		CFLAGS='$(CFLAGS) -DI386_ASSEM -DREAL_IS_FLOAT -DPENTIUM_OPT -DLINUX \
 			-DUSE_3DNOW -DOSS -DTERM_CONTROL\
-			-Wall -O2 -m486 \
+			-Wall   \
 			-fomit-frame-pointer -funroll-all-loops \
 			-finline-functions -ffast-math' \
 		mpg123-make
 
 
 linux-i486:
-	$(MAKE) CC=gcc LDFLAGS= \
+	$(MAKE)  LDFLAGS= \
 		OBJECTS='decode_i386.o dct64_i386.o decode_i586.o \
 			decode_i486.o audio_oss.o term.o \
 			dct64_i486-a.o dct64_i486-b.o ' \
 		CFLAGS='$(CFLAGS) -DI386_ASSEM -DREAL_IS_FLOAT -DI486_OPT -DLINUX \
 			-DOSS -DTERM_CONTROL\
-			-Wall -O2 -m486 \
+			-Wall   \
 			-fomit-frame-pointer -funroll-all-loops \
 			-finline-functions -ffast-math' \
 		mpg123-make
 
 linux-esd:
-	$(MAKE) CC=gcc LDFLAGS= \
+	$(MAKE)  LDFLAGS= \
 		AUDIO_LIB='-lesd -laudiofile' \
 		OBJECTS='decode_i386.o dct64_i386.o decode_i586.o \
 			audio_esd.o' \
 		CFLAGS='$(CFLAGS) -DI386_ASSEM -DREAL_IS_FLOAT -DPENTIUM_OPT -DLINUX \
 			-DOSS -DUSE_ESD \
-			-Wall  -O2 -m486 \
+			-Wall    \
 			-fomit-frame-pointer -funroll-all-loops \
 			-finline-functions -ffast-math \
 			$(RPM_OPT_FLAGS)' \
 		mpg123-make
 
 linux-alsa:
-	$(MAKE) CC=gcc LDFLAGS= \
+	$(MAKE)  LDFLAGS= \
 		AUDIO_LIB='-lasound' \
 		OBJECTS='decode_i386.o dct64_i386.o decode_i586.o \
 			audio_alsa.o term.o' \
 		CFLAGS='$(CFLAGS) -DI386_ASSEM -DREAL_IS_FLOAT -DPENTIUM_OPT -DLINUX \
 			-DALSA -DTERM_CONTROL\
-			-Wall  -O2 -m486 \
+			-Wall    \
 			-fomit-frame-pointer -funroll-all-loops \
 			-finline-functions -ffast-math \
 			$(RPM_OPT_FLAGS)' \
 		mpg123-make
 
 linux-3dnow-alsa:
-	$(MAKE) CC=gcc LDFLAGS= \
+	$(MAKE)  LDFLAGS= \
 		AUDIO_LIB='-lasound' \
 		OBJECTS='decode_i386.o decode_3dnow.o dct64_3dnow.o \
 			dct64_i386.o dct36_3dnow.o getcpuflags.o \
 			equalizer_3dnow.o decode_i586.o audio_alsa.o term.o' \
 		CFLAGS='-DI386_ASSEM -DREAL_IS_FLOAT -DPENTIUM_OPT -DLINUX \
 			-DUSE_3DNOW -DALSA -DTERM_CONTROL\
-			-Wall -O2 -m486 \
+			-Wall   \
 			-fomit-frame-pointer -funroll-all-loops \
 			-finline-functions -ffast-math' \
 		mpg123-make
 
 linux-3dnow-esd:
-	$(MAKE) CC=gcc LDFLAGS= \
+	$(MAKE)  LDFLAGS= \
 		AUDIO_LIB='-lesd -laudiofile' \
 		OBJECTS='decode_i386.o decode_3dnow.o dct64_3dnow.o \
 			dct64_i386.o dct36_3dnow.o getcpuflags.o \
 			equalizer_3dnow.o decode_i586.o audio_esd.o' \
 		CFLAGS='-DI386_ASSEM -DREAL_IS_FLOAT -DPENTIUM_OPT -DLINUX \
 			-DUSE_3DNOW -DUSE_ESD \
-			-Wall -O2 -m486 \
+			-Wall   \
 			-fomit-frame-pointer -funroll-all-loops \
 			-finline-functions -ffast-math' \
 		mpg123-make
 
 linux-mips-alsa:
-	$(MAKE) CC=gcc LDFLAGS= \
+	$(MAKE)  LDFLAGS= \
 		AUDIO_LIB='-lasound' \
 		OBJECTS='decode.o dct64.o audio_alsa.o term.o' \
 		CFLAGS='$(CFLAGS) -DREAL_IS_FLOAT -DLINUX -DALSA \
-			-DTERM_CONTROL -Wall  -O2 \
+			-DTERM_CONTROL -Wall   \
 			-fomit-frame-pointer -funroll-all-loops \
 			-finline-functions -ffast-math \
 			$(RPM_OPT_FLAGS)' \
 		mpg123-make
 
 linux-alpha:
-	$(MAKE) CC=gcc LDFLAGS= OBJECTS='decode.o dct64.o audio_oss.o' \
-		CFLAGS='$(CFLAGS) -DLINUX -DOSS -Wall -O2 \
+	$(MAKE)  LDFLAGS= OBJECTS='decode.o dct64.o audio_oss.o' \
+		CFLAGS='$(CFLAGS) -DLINUX -DOSS -Wall  \
 			-fomit-frame-pointer -funroll-all-loops \
 			-finline-functions -ffast-math \
 			-Wall -O6 -DUSE_MMAP \
@@ -296,7 +306,7 @@
 		mpg123-make
 
 linux-alpha-alsa:
-	$(MAKE) CC=gcc LDFLAGS= \
+	$(MAKE)  LDFLAGS= \
 		AUDIO_LIB='-lasound' \
 		OBJECTS='decode.o dct64.o audio_alsa.o term.o' \
 		CFLAGS='-DLINUX \
@@ -308,82 +318,105 @@
 		mpg123-make
 
 linux-alpha-esd:
-	$(MAKE) CC=gcc LDFLAGS= \
+	$(MAKE)  LDFLAGS= \
 		AUDIO_LIB='-lesd -laudiofile' \
 		OBJECTS='decode.o dct64.o audio_esd.o' \
-		CFLAGS='$(CFLAGS) -DLINUX -DOSS -DUSE_ESD -Wall -O2 \
+		CFLAGS='$(CFLAGS) -DLINUX -DOSS -DUSE_ESD -Wall  \
 			-fomit-frame-pointer -funroll-all-loops \
 			-finline-functions -ffast-math \
 			-Wall -O6 -DUSE_MMAP \
 			$(RPM_OPT_FLAGS)' \
 		mpg123-make
 
-#linux-ppc:
-#	$(MAKE) CC=gcc  LDFLAGS= \
-#		OBJECTS='decode.o dct64.o audio_oss.o' \
-#		CFLAGS='$(CFLAGS) -DREAL_IS_FLOAT -DLINUX -Wall -O2 -mcpu=ppc \
-#			-DOSS -DPPC_ENDIAN \
-#			-fomit-frame-pointer -funroll-all-loops \
-#			-finline-functions -ffast-math' \
-#		mpg123-make
-
-#linux-ppc-esd:
-#	$(MAKE) CC=gcc  LDFLAGS= \
-#		AUDIO_LIB='-lesd -laudiofile' \
-#		OBJECTS='decode.o dct64.o audio_esd.o' \
-#		CFLAGS='$(CFLAGS) -DREAL_IS_FLOAT -DLINUX -Wall -O2 -mcpu=ppc \
-#			-DOSS -DPPC_ENDIAN \
-#			-fomit-frame-pointer -funroll-all-loops \
-#			-finline-functions -ffast-math' \
-#		mpg123-make
+linux-x86_64:
+	$(MAKE) LDFLAGS= \
+		OBJECTS='decode.o dct64.o audio_oss.o' \
+		CFLAGS=' -Wall -DLINUX -DOSS -DUSE_MMAP \
+			$(RPM_OPT_FLAGS)' \
+		mpg123-make
+
+linux-x86_64-esd:
+	$(MAKE) LDFLAGS= \
+		AUDIO_LIB='-lesd -laudiofile' \
+		OBJECTS='decode.o dct64.o audio_esd.o' \
+		CFLAGS=' -Wall -DLINUX -DOSS -DUSE_MMAP \
+			$(RPM_OPT_FLAGS)' \
+		mpg123-make
+
+linux-x86_64-alsa:
+	$(MAKE) LDFLAGS= \
+		AUDIO_LIB='-lasound' \
+		OBJECTS='decode.o dct64.o audio_alsa.o' \
+		CFLAGS=' -Wall -DLINUX -DOSS -DUSE_MMAP \
+			$(RPM_OPT_FLAGS)' \
+		mpg123-make
 
+linux-ppc64:
+	$(MAKE)   LDFLAGS= \
+		OBJECTS='decode.o dct64.o audio_oss.o' \
+		CFLAGS='$(CFLAGS) -DREAL_IS_FLOAT -DLINUX -Wall  \
+			-DOSS \
+			-fomit-frame-pointer -funroll-all-loops \
+			-finline-functions -ffast-math' \
+		mpg123-make
+
+linux-ppc64-esd:
+	$(MAKE)   LDFLAGS= \
+		AUDIO_LIB='-lesd -laudiofile' \
+		OBJECTS='decode.o dct64.o audio_esd.o' \
+		CFLAGS='$(CFLAGS) -DREAL_IS_FLOAT -DLINUX -Wall  \
+			-DOSS \
+			-fomit-frame-pointer -funroll-all-loops \
+			-finline-functions -ffast-math' \
+		mpg123-make
+ 
 linux-ppc:
-	$(MAKE) CC=gcc  LDFLAGS= \
+	$(MAKE)   LDFLAGS= \
 		OBJECTS='decode.o dct64.o audio_oss.o' \
-		CFLAGS='$(CFLAGS) -DREAL_IS_FLOAT -DLINUX -Wall -O2 -mcpu=ppc \
+		CFLAGS='$(CFLAGS) -DREAL_IS_FLOAT -DLINUX -Wall   \
 			-DOSS \
 			-fomit-frame-pointer -funroll-all-loops \
 			-finline-functions -ffast-math' \
 		mpg123-make
 
 linux-ppc-esd:
-	$(MAKE) CC=gcc  LDFLAGS= \
+	$(MAKE)   LDFLAGS= \
 		AUDIO_LIB='-lesd -laudiofile' \
 		OBJECTS='decode.o dct64.o audio_esd.o' \
-		CFLAGS='$(CFLAGS) -DREAL_IS_FLOAT -DLINUX -Wall -O2 -mcpu=ppc \
+		CFLAGS='$(CFLAGS) -DREAL_IS_FLOAT -DLINUX -Wall   \
 			-DOSS -DUSE_ESD \
 			-fomit-frame-pointer -funroll-all-loops \
 			-finline-functions -ffast-math' \
 		mpg123-make
 
 linux-sparc:
-	$(MAKE) CC=gcc  LDFLAGS= \
+	$(MAKE)   LDFLAGS= \
 		OBJECTS='decode.o dct64.o audio_sun.o' \
-		CFLAGS='$(CFLAGS) -DREAL_IS_FLOAT -DUSE_MMAP -DSPARCLINUX -Wall -O2 \
+		CFLAGS='$(CFLAGS) -DREAL_IS_FLOAT -DUSE_MMAP -DSPARCLINUX -Wall  \
 			-fomit-frame-pointer -funroll-all-loops \
 			-finline-functions -ffast-math' \
 		mpg123-make
 
 linux-sparc-esd:
-	$(MAKE) CC=gcc  LDFLAGS= \
+	$(MAKE)   LDFLAGS= \
 		AUDIO_LIB='-lesd -laudiofile' \
 		OBJECTS='decode.o dct64.o audio_esd.o' \
-		CFLAGS='-DREAL_IS_FLOAT -DUSE_MMAP -DOSS -DUSE_ESD -DSPARCLINUX -Wall -O2 \
+		CFLAGS='-DREAL_IS_FLOAT -DUSE_MMAP -DOSS -DUSE_ESD -DSPARCLINUX -Wall  \
 			-fomit-frame-pointer -funroll-all-loops \
-			-finline-functions -ffast-math \
+			-finline-functions -ffast-math' \
 		mpg123-make
 
 
 linux-armv4l:
-	$(MAKE) CC=gcc LDFLAGS= OBJECTS='decode.o dct64.o audio_oss.o' \
-		CFLAGS='-DLINUX -DOSS -Wall -O2 \
+	$(MAKE)  LDFLAGS= OBJECTS='decode.o dct64.o audio_oss.o' \
+		CFLAGS='-DLINUX -DOSS -Wall  \
 			-fomit-frame-pointer -funroll-all-loops \
 			-finline-functions -ffast-math \
-			-Wall -O6 -DUSE_MMAP \
+			-Wall -O6 -DUSE_MMAP' \
                 mpg123-make
 
 linux-arm:
-	$(MAKE) CC=gcc LDFLAGS= OBJECTS='decode.o dct64.o audio_oss.o' \
+	$(MAKE)  LDFLAGS= OBJECTS='decode.o dct64.o audio_oss.o' \
 		CFLAGS='-DREAL_IS_FIXED -DLINUX \
 			-DOSS -Wall -O6 -march=armv4 \
 			-fomit-frame-pointer -funroll-all-loops \
@@ -392,9 +425,9 @@
  
 
 linux-m68k:
-	$(MAKE) CC=gcc LDFLAGS= OBJECTS='decode.o dct64.o audio_oss.o' \
+	$(MAKE)  LDFLAGS= OBJECTS='decode.o dct64.o audio_oss.o' \
 		CFLAGS='$(CFLAGS) -DREAL_IS_FLOAT -DLINUX \
-			-DOSS -DOSS_BIG_ENDIAN -Wall -O2 -m68040 \
+			-DOSS -DOSS_BIG_ENDIAN -Wall  -m68040 \
 			-fomit-frame-pointer -funroll-loops \
 			-finline-functions -ffast-math' \
 		mpg123-make
@@ -412,36 +445,36 @@
 	@ $(MAKE) FRONTEND=mpg123m-make freebsd-frontend
 
 linux-frontend:
-	$(MAKE) CC=gcc LDFLAGS= \
+	$(MAKE)  LDFLAGS= \
 		OBJECTS='decode_i386.o dct64_i386.o decode_i586.o \
 			control_sajber.o control_tk3play.o audio_oss.o' \
 		CFLAGS='$(CFLAGS) -DFRONTEND -DOSS -DI386_ASSEM -DREAL_IS_FLOAT \
-			-DPENTIUM_OPT -DLINUX -Wall -O2 -m486 \
+			-DPENTIUM_OPT -DLINUX -Wall   \
 			-fomit-frame-pointer -funroll-all-loops \
 			-finline-functions -ffast-math' \
 		$(FRONTEND)
 
 linux-nas:
-	$(MAKE) CC=gcc LDFLAGS='-L/usr/X11R6/lib' \
+	$(MAKE)  LDFLAGS='-L/usr/X11R6/lib' \
 		AUDIO_LIB='-laudio -lXau' \
 		OBJECTS='decode_i386.o dct64_i386.o audio_nas.o' \
 		CFLAGS='$(CFLAGS) -I/usr/X11R6/include \
 			-DI386_ASSEM -DREAL_IS_FLOAT -DLINUX -DNAS \
-			-Wall -O2 -m486 \
+			-Wall   \
 			-fomit-frame-pointer -funroll-all-loops \
 			-finline-functions -ffast-math' \
 		mpg123-make
 
 #### the following defines are for experimental use ... 
 #
-#CFLAGS='$(CFLAGS) -pg -DI386_ASSEM -DREAL_IS_FLOAT -DLINUX -Wall -O2 -m486 -funroll-all-loops -finline-functions -ffast-math' mpg123
-#CFLAGS='$(CFLAGS) -DI386_ASSEM -O2 -DREAL_IS_FLOAT -DLINUX -Wall -g'
-#CFLAGS='$(CFLAGS) -DI386_ASSEM -DREAL_IS_FLOAT -DLINUX -Wall -O2 -m486 -fomit-frame-pointer -funroll-all-loops -finline-functions -ffast-math -malign-loops=2 -malign-jumps=2 -malign-functions=2'
+#CFLAGS='$(CFLAGS) -pg -DI386_ASSEM -DREAL_IS_FLOAT -DLINUX -Wall   -funroll-all-loops -finline-functions -ffast-math' mpg123
+#CFLAGS='$(CFLAGS) -DI386_ASSEM  -DREAL_IS_FLOAT -DLINUX -Wall -g'
+#CFLAGS='$(CFLAGS) -DI386_ASSEM -DREAL_IS_FLOAT -DLINUX -Wall   -fomit-frame-pointer -funroll-all-loops -finline-functions -ffast-math -malign-loops=2 -malign-jumps=2 -malign-functions=2'
 
 freebsd:
 	$(MAKE) CC=cc LDFLAGS= \
 		OBJECTS='decode_i386.o dct64_i386.o audio_oss.o' \
-		CFLAGS='$(CFLAGS) -Wall -ansi -pedantic -O4 -m486 -fomit-frame-pointer \
+		CFLAGS='$(CFLAGS) -Wall -ansi -pedantic -O4  -fomit-frame-pointer \
 			-funroll-all-loops -ffast-math -DROT_I386 \
 			-DI386_ASSEM -DREAL_IS_FLOAT -DUSE_MMAP -DOSS' \
 		mpg123-make
@@ -450,7 +483,7 @@
 	$(MAKE) CC=cc LDFLAGS= \
 		OBJECTS='decode_i386.o dct64_i386.o \
 			decode_i486.o dct64_i486.o audio_oss.o' \
-		CFLAGS='$(CFLAGS) -Wall -ansi -pedantic -O4 -m486 -fomit-frame-pointer \
+		CFLAGS='$(CFLAGS) -Wall -ansi -pedantic -O4  -fomit-frame-pointer \
 			-funroll-all-loops -ffast-math -DROT_I386 \
 			-DOPT_ARCH=i486 \
 			-march=i486 -finline-functions \
@@ -461,17 +494,17 @@
 	$(MAKE) CC=cc LDFLAGS= \
 		AUDIO_LIB='-lesd -laudiofile' \
 		OBJECTS='decode_i386.o dct64_i386.o $(GETBITS) audio_esd.o' \
-		CFLAGS='$(CFLAGS) -Wall -ansi -pedantic -O4 -m486 -fomit-frame-pointer \
+		CFLAGS='$(CFLAGS) -Wall -ansi -pedantic -O4  -fomit-frame-pointer \
 			-funroll-all-loops -ffast-math -DROT_I386 \
 			-DI386_ASSEM -DREAL_IS_FLOAT -DUSE_MMAP -DOSS -DUSE_ESD \
-			-I/usr/local/include -L/usr/local/lib 
+			-I/usr/local/include -L/usr/local/lib' \
 		mpg123-make
 
 freebsd-nas:
 	$(MAKE) CC=cc LDFLAGS= \
 		AUDIO_LIB='-L/usr/X11R6/lib -laudio -lXau' \
 		OBJECTS='decode_i386.o dct64_i386.o audio_nas.o' \
-		CFLAGS='-Wall -ansi -pedantic -O4 -m486 -fomit-frame-pointer \
+		CFLAGS='-Wall -ansi -pedantic -O4  -fomit-frame-pointer \
 			-funroll-all-loops -ffast-math -DROT_I386 \
 			-DREAD_MMAP \
 			-DI386_ASSEM -DREAL_IS_FLOAT -DUSE_MMAP -DNAS \
@@ -482,7 +515,7 @@
 	$(MAKE) CC=cc LDFLAGS= \
 		OBJECTS='decode_i386.o dct64_i386.o audio_oss.o \
 			control_sajber.o control_tk3play.o' \
-		CFLAGS='$(CFLAGS) -Wall -ansi -pedantic -O4 -m486 -fomit-frame-pointer \
+		CFLAGS='$(CFLAGS) -Wall -ansi -pedantic -O4  -fomit-frame-pointer \
 			-funroll-all-loops -ffast-math -DROT_I386 \
 			-DFRONTEND \
 			-DI386_ASSEM -DREAL_IS_FLOAT -DUSE_MMAP -DOSS' \
@@ -492,7 +525,7 @@
 	$(MAKE) CC=cc LDFLAGS='-L/usr/lib' \
 		AUDIO_LIB='-lossaudio' \
 		OBJECTS='decode_i386.o dct64_i386.o audio_oss.o' \
-		CFLAGS='-Wall -ansi -pedantic -O4 -m486 -fomit-frame-pointer \
+		CFLAGS='-Wall -ansi -pedantic -O4  -fomit-frame-pointer \
 			-funroll-all-loops -ffast-math -DROT_I386 \
 			-DREAD_MMAP \
 			-DI386_ASSEM -DREAL_IS_FLOAT -DUSE_MMAP -DOSS' \
@@ -529,54 +562,54 @@
 	$(MAKE) CC='gcc' \
 		LDFLAGS='-lsocket -lnsl -pg' \
 		OBJECTS='decode.o dct64.o audio_sun.o' \
-		CFLAGS='$(CFLAGS) -g -pg -O2 -Wall -DSOLARIS -DREAL_IS_FLOAT -DUSE_MMAP \
+		CFLAGS='$(CFLAGS) -g -pg  -Wall -DSOLARIS -DREAL_IS_FLOAT -DUSE_MMAP \
 			-funroll-all-loops -finline-functions' \
 		mpg123-make
 
 #	-DREAL_IS_FLOAT 
 
 solaris-gcc:
-	$(MAKE) CC=gcc \
+	$(MAKE)  \
 		LDFLAGS='-lsocket -lnsl' \
 		OBJECTS='decode.o dct64.o audio_sun.o term.o' \
-		CFLAGS='$(CFLAGS) -O2 -Wall -pedantic -DSOLARIS \
+		CFLAGS='$(CFLAGS)  -Wall -pedantic -DSOLARIS \
 			-DUSE_MMAP -g \
 			-DTERM_CONTROL \
 			-funroll-all-loops  -finline-functions' \
 		mpg123-make
 
 solaris-gcc-esd:
-	$(MAKE) CC=gcc LDFLAGS='-lsocket -lnsl' \
+	$(MAKE)  LDFLAGS='-lsocket -lnsl' \
 		AUDIO_LIB='-lesd -lresolv' \
 		OBJECTS='decode.o dct64.o audio_esd.o' \
-		CFLAGS='$(CFLAGS) -O2 -Wall -DSOLARIS -DREAL_IS_FLOAT -DUSE_MMAP \
+		CFLAGS='$(CFLAGS)  -Wall -DSOLARIS -DREAL_IS_FLOAT -DUSE_MMAP \
 			-DUSE_ESD -funroll-all-loops -finline-functions' \
 		mpg123-make
 
 solaris-x86-gcc-oss:
-	$(MAKE) CC=gcc LDFLAGS='-lsocket -lnsl' \
+	$(MAKE)  LDFLAGS='-lsocket -lnsl' \
 		OBJECTS='decode_i386.o dct64_i386.o decode_i586.o \
 			audio_oss.o' \
 		CFLAGS='$(CFLAGS) -DI386_ASSEM -DREAL_IS_FLOAT -DPENTIUM_OPT -DUSE_MMAP \
 			-DOSS \
-			-Wall -O2 -m486 \
+			-Wall   \
 			-funroll-all-loops -finline-functions' \
 		mpg123-make
 
 solaris-gcc-nas:
-	$(MAKE) CC=gcc LDFLAGS='-lsocket -lnsl' \
+	$(MAKE)  LDFLAGS='-lsocket -lnsl' \
 		AUDIO_LIB='-L/usr/openwin/lib -laudio -lXau'\
 		OBJECTS='decode.o dct64.o audio_nas.o' \
-		CFLAGS='$(CFLAGS) -O2 -I/usr/openwin/include -Wall \
+		CFLAGS='$(CFLAGS)  -I/usr/openwin/include -Wall \
 			-DSOLARIS -DREAL_IS_FLOAT -DUSE_MMAP \
 			-DNAS \
 			-funroll-all-loops -finline-functions' \
 		mpg123-make
 
 sunos:
-	$(MAKE) CC=gcc LDFLAGS= \
+	$(MAKE)  LDFLAGS= \
 		OBJECTS='decode.o dct64.o audio_sun.o' \
-		CFLAGS='$(CFLAGS) -O2 -DSUNOS -DREAL_IS_FLOAT -DUSE_MMAP \
+		CFLAGS='$(CFLAGS)  -DSUNOS -DREAL_IS_FLOAT -DUSE_MMAP \
 			-funroll-loops' \
 		mpg123-make
 
@@ -596,20 +629,20 @@
 		mpg123-make
 
 hpux-gcc:
-	$(MAKE) CC=gcc LDFLAGS= OBJECTS='decode.o dct64.o audio_hp.o' \
+	$(MAKE)  LDFLAGS= OBJECTS='decode.o dct64.o audio_hp.o' \
 		CFLAGS='$(CFLAGS) -DREAL_IS_FLOAT -O3 -D_HPUX_SOURCE -DHPUX' \
 		mpg123-make
 sgi:
 	$(MAKE) CC=cc LDFLAGS= \
 		OBJECTS='decode.o dct64.o audio_sgi.o' AUDIO_LIB=-laudio \
-		CFLAGS='$(CFLAGS) -O2 -DSGI -DTERM_CONTROL \
+		CFLAGS='$(CFLAGS)  -DSGI -DTERM_CONTROL \
 		-DREAL_IS_FLOAT -DUSE_MMAP' \
 		mpg123-make
 
 sgi-gcc:
-	$(MAKE) CC=gcc LDFLAGS= \
+	$(MAKE)  LDFLAGS= \
 		OBJECTS='decode.o dct64.o audio_sgi.o' AUDIO_LIB=-laudio \
-		CFLAGS='$(CFLAGS) -O2 -DSGI -DTERM_CONTROL \
+		CFLAGS='$(CFLAGS)  -DSGI -DTERM_CONTROL \
 		-DREAL_IS_FLOAT -DUSE_MMAP' \
 		mpg123-make
 
@@ -636,11 +669,11 @@
 
 ultrix:
 	$(MAKE) CC=cc LDFLAGS= OBJECTS='decode.o dct64.o audio_dummy.o' \
-		CFLAGS='$(CFLAGS) -std1 -O2 -DULTRIX' \
+		CFLAGS='$(CFLAGS) -std1  -DULTRIX' \
 		mpg123-make
 
 aix-gcc:
-	$(MAKE) CC=gcc LDFLAGS= OBJECTS='decode.o dct64.o audio_aix.o' \
+	$(MAKE)  LDFLAGS= OBJECTS='decode.o dct64.o audio_aix.o' \
 		CFLAGS='$(CFLAGS) -DAIX -Wall -O6 -DUSE_MMAP -DREAL_IS_FLOAT \
 			-fomit-frame-pointer -funroll-all-loops \
 			-finline-functions -ffast-math' \
@@ -674,9 +707,9 @@
 		$(FRONTEND)
 
 os2:
-	$(MAKE) CC=gcc LDFLAGS= \
+	$(MAKE)  LDFLAGS= \
 		OBJECTS='decode_i386.o dct64_i386.o audio_os2.o' \
-		CFLAGS='$(CFLAGS) -DREAL_IS_FLOAT -DNOXFERMEM -DOS2 -Wall -O2 -m486 \
+		CFLAGS='$(CFLAGS) -DREAL_IS_FLOAT -DNOXFERMEM -DOS2 -Wall   \
 		-fomit-frame-pointer -funroll-all-loops \
 		-finline-functions -ffast-math' \
 		LIBS='-los2me -lsocket' \
@@ -693,7 +726,7 @@
 netbsd-i386:
 	$(MAKE) CC=cc LDFLAGS= \
 		OBJECTS='decode_i386.o dct64_i386.o audio_sun.o' \
-		CFLAGS='$(CFLAGS) -Wall -ansi -pedantic -O4 -m486 -fomit-frame-pointer \
+		CFLAGS='$(CFLAGS) -Wall -ansi -pedantic -O4  -fomit-frame-pointer \
 			-funroll-all-loops -ffast-math -DROT_I386 \
 			-DI386_ASSEM -DREAL_IS_FLOAT -DUSE_MMAP -DNETBSD' \
 		mpg123-make
@@ -702,16 +735,16 @@
 	$(MAKE) CC=shlicc2 LDFLAGS= \
 		OBJECTS='decode_i386.o dct64_i386.o \
 			 audio_oss.o' \
-		CFLAGS='$(CFLAGS) -Wall -O4 -m486 -fomit-frame-pointer \
+		CFLAGS='$(CFLAGS) -Wall -O4  -fomit-frame-pointer \
 			-funroll-all-loops -ffast-math -DROT_I386 \
 			-DI386_ASSEM -DREAL_IS_FLOAT -DUSE_MMAP -DOSS \
 			-DDONT_CATCH_SIGNALS' \
 		mpg123-make
 
 bsdos4:
-	$(MAKE) CC=gcc LDFLAGS= \
+	$(MAKE)  LDFLAGS= \
 		OBJECTS='decode_i386.o dct64_i386.o audio_oss.o' \
-		CFLAGS='$(CFLAGS) -Wall -O4 -m486 -fomit-frame-pointer \
+		CFLAGS='$(CFLAGS) -Wall -O4  -fomit-frame-pointer \
 			-funroll-all-loops -ffast-math -DROT_I386 \
 			-DI386_ASSEM -DREAL_IS_FLOAT -DUSE_MMAP -DOSS \
 			-DDONT_CATCH_SIGNALS' \
@@ -722,22 +755,28 @@
 		AUDIO_LIB='-laudio -lXau -L/usr/X11R6/lib' \
 		OBJECTS='decode_i386.o dct64_i386.o \
 			audio_nas.o' \
-		CFLAGS='$(CFLAGS) -Wall -O4 -m486 -fomit-frame-pointer \
+		CFLAGS='$(CFLAGS) -Wall -O4  -fomit-frame-pointer \
 			-funroll-all-loops -ffast-math -DROT_I386 \
 			-DI386_ASSEM -DREAL_IS_FLOAT -DUSE_MMAP -DOSS \
 			-DDONT_CATCH_SIGNALS -DNAS' \
 		mpg123-make
 
 mint:
-	$(MAKE) CC=gcc LDFLAGS= \
+	$(MAKE)  LDFLAGS= \
 		OBJECTS='decode.o dct64.o audio_mint.o' \
-		CFLAGS='$(CFLAGS) -Wall -O2 -m68020-40 -m68881 \
+		CFLAGS='$(CFLAGS) -Wall  -m68020-40 -m68881 \
 		-fomit-frame-pointer -funroll-all-loops \
 		-finline-functions -ffast-math \
 		-DREAL_IS_FLOAT -DMINT -DNOXFERMEM' \
 		AUDIO_LIB='-lsocket' \
 		mpg123-make
 
+macosx:
+	$(MAKE) CC=cc LDFLAGS='$(LDFLAGS)' AUDIO_LIB='-framework CoreAudio' \
+		OBJECTS='decode.o dct64.o audio_macosx.o term.o' \
+		CFLAGS='$(CFLAGS) -DINET6 -DTERM_CONTROL -DMAC_OS_X -Wall -O2 -DPPC_ENDIAN' \
+ 		mpg123-make
+
 # maybe you need the additonal options LDFLAGS='-lnsl -lsocket' when linking (see solaris:)
 generic:
 	$(MAKE) LDFLAGS= OBJECTS='decode.o dct64.o audio_dummy.o' \
@@ -829,7 +868,7 @@
 	fi
 
 system: mpg123.h system.c
-	$(CC) -o $@ -Wall -O2 system.c
+	$(CC) -o $@ -Wall  system.c
 
 install:	prepared-for-install
 	strip mpg123
diff -Naur mpg123/audio.c mpg123-new/audio.c
--- mpg123/audio.c	2001-01-18 09:00:33.000000000 -0500
+++ mpg123-new/audio.c	2005-07-29 10:49:12.000000000 -0400
@@ -1,4 +1,4 @@
-
+#include <stdlib.h>
 #include "mpg123.h"
 
 void audio_info_struct_init(struct audio_info_struct *ai)
diff -Naur mpg123/audio_macosx.c mpg123-new/audio_macosx.c
--- mpg123/audio_macosx.c	1969-12-31 19:00:00.000000000 -0500
+++ mpg123-new/audio_macosx.c	2005-07-29 11:34:44.000000000 -0400
@@ -0,0 +1,337 @@
+/*- This is a 80 chars line, to have pretty formatted comments ---------------*/
+
+/* audio_macosx.c, originally written by Guillaume Outters
+ * to contact the author, please mail to: guillaume.outters@free.fr
+ *
+ * This file is some quick pre-alpha patch to allow me to have some music for my
+ * long working days, and it does it well. But it surely isn't a final version;
+ * as Mac OS X requires at least a G3, I'm not sure it will be useful to
+ * implement downsampling.
+ *
+ * Mac OS X audio works by asking you to fill its buffer, and, to complicate a
+ * bit, you must provide it with floats. In order not to patch too much mpg123,
+ * we'll accept signed short (mpg123 "approved" format) and transform them into
+ * floats as soon as received. Let's say this way calculations are faster.
+ *
+ * As we don't have some /dev/audio device with blocking write, we'll have to
+ * stop mpg123 before it does too much work, while we are waiting our dump proc
+ * to be called. I wanted to use semaphores, but they still need an
+ * implementation from Apple before I can do anything. So we'll block using a
+ * sleep and wake up on SIGUSR2.
+ * Version 0.2: now I use named semaphores (which are implemented AND work).
+ * Preprocessor flag MOSX_USES_SEM (defined at the beginning of this file)
+ * enables this behaviour.
+ *
+ * In order always to have a ready buffer to be dumped when the routine gets
+ * called, we have a "buffer loop" of NUMBER_BUFFERS buffers. mpg123 fills it
+ * on one extremity ('to'), playProc reads it on another point ('from'). 'to'
+ * blocks when it arrives on 'from' (having filled the whole circle of buffers)
+ * and 'from' blocks when no data is available. As soon as it has emptied a
+ * buffer, if mpg123 is sleeping, it awakes it quite brutaly (SIGUSR2) to tell
+ * it to fill the buffer. */
+
+#ifndef MOSX_USES_SEM
+#define MOSX_USES_SEM 1	/* Semaphores or sleep()/kill()? I would say semaphores, but this is just my advice, after all */
+#endif
+#ifndef MOSX_SEM_V2
+#define MOSX_SEM_V2 1
+#endif
+
+#include "mpg123.h"
+#include <CoreAudio/AudioHardware.h>
+#include <stdio.h>
+#include <stdlib.h>
+#include <errno.h>
+#if MOSX_USES_SEM
+#include <semaphore.h>
+#endif
+
+struct aBuffer
+{
+	float * buffer;
+	long size;
+	
+	float * ptr;	/* Where in the buffer are we? */
+	long remaining;
+	
+	struct aBuffer * next;
+};
+typedef struct aBuffer aBuffer;
+
+struct anEnv
+{
+	long size;
+	short * debut;
+	short * ptr;
+	AudioDeviceID device;
+	char play;
+	
+	/* Intermediate buffers */
+	
+	#if MOSX_USES_SEM
+	sem_t * semaphore;
+	#else
+	char wait;	/* mpg123 is waiting (due to the semaphore) to show the world its power; let's free him! */
+	pid_t pid;
+	#endif
+	aBuffer * from;	/* Current buffers */
+	aBuffer * to;
+};
+
+static struct anEnv env;
+
+#define ENV ((struct anEnv *)inClientData)
+#define NUMBER_BUFFERS 16	/* Tried with 3 buffers, but then any little window move is sufficient to stop the sound. Here we have 1.5 seconds music buffered */
+
+void destroyBuffers()
+{
+	aBuffer * ptr;
+	aBuffer * ptr2;
+	
+	ptr = env.to->next;
+	env.to->next = NULL;
+	while(ptr)
+	{
+		ptr2 = ptr->next;
+		if(ptr->buffer) free(ptr->buffer);
+		free(ptr);
+		ptr = ptr2;
+	}
+}
+
+void initBuffers()
+{
+	long m;
+	aBuffer ** ptrptr;
+	
+	ptrptr = &env.to;
+	for(m = 0; m < NUMBER_BUFFERS; m++)
+	{
+		*ptrptr = malloc(sizeof(aBuffer));
+		(*ptrptr)->size = 0;
+		(*ptrptr)->remaining = 0;
+		(*ptrptr)->buffer = NULL;
+		ptrptr = &(*ptrptr)->next;
+		#if MOSX_USES_SEM
+		sem_post(env.semaphore);	/* This buffer is ready for filling (of course, it is empty!) */ 
+		#endif
+	}
+	*ptrptr = env.from = env.to;
+}
+
+int fillBuffer(aBuffer * b, short * source, long size)
+{
+	float * dest;
+	
+	if(b->remaining)	/* Non empty buffer, must still be playing */
+		return(-1);
+	if(b->size != size)	/* Hey! What's that? Coudn't this buffer size be fixed once (well, perhaps we just didn't allocate it yet) */
+	{
+		if(b->buffer) free(b->buffer);
+		b->buffer = malloc(size * sizeof(float));
+		b->size = size;
+	}
+	
+	dest = b->buffer;
+	while(size--)
+		//*dest++ = ((*source++) + 32768) / 65536.0;
+		*dest++ = (*source++) / 32768.0;
+	
+	b->ptr = b->buffer;
+	b->remaining = b->size;	/* Do this at last; we shouldn't show the buffer is full before it is effectively */
+	
+	#ifdef DEBUG_MOSX
+	printf("."); fflush(stdout);
+	#endif
+	
+	return(0);
+}
+
+OSStatus playProc(AudioDeviceID inDevice, const AudioTimeStamp * inNow, const AudioBufferList * inInputData, const AudioTimeStamp * inInputTime, AudioBufferList * outOutputData, const AudioTimeStamp * inOutputTime, void * inClientData)
+{
+	long m, n, o;
+	float * dest;
+	
+	for(o = 0; o < outOutputData->mNumberBuffers; o++)
+	{
+		m = outOutputData->mBuffers[o].mDataByteSize / sizeof(float);	/* What we have to fill */
+		dest = outOutputData->mBuffers[o].mData;
+		
+		while(m > 0)
+		{
+			if( (n = ENV->from->remaining) <= 0 )	/* No more bytes in the current read buffer! */
+			{
+				while( (n = ENV->from->remaining) <= 0)
+					usleep(2000);	/* Let's wait a bit for the results... */
+			}
+						
+			/* We dump what we can */
+			
+			if(n > m) n = m;	/* In fact, just the necessary should be sufficient (I think) */
+			
+			memcpy(dest, ENV->from->ptr, n * sizeof(float));
+			
+			/* Let's remember all done work */
+			
+			m -= n;
+			ENV->from->ptr += n;
+			if( (ENV->from->remaining -= n) <= 0)	/* ... and tell mpg123 there's a buffer to fill */
+			{
+				#if MOSX_USES_SEM
+				sem_post(ENV->semaphore);
+				#else
+				if(ENV->wait)
+				{
+					kill(ENV->pid, SIGUSR2);
+					ENV->wait = 0;
+				}
+				#endif
+				ENV->from = ENV->from->next;
+			}
+		}
+	}
+	
+	return (0); 
+}
+
+#if ! MOSX_USES_SEM
+void start(int n)
+{
+	signal(SIGUSR2, start);
+}
+#endif
+
+int audio_open(struct audio_info_struct *ai)
+{
+	long size;
+	AudioStreamBasicDescription format;
+	#if MOSX_USES_SEM
+	char s[10];
+	long m;
+	#endif
+	/*float vol;
+	OSStatus e;*/
+	
+	/* Where did that default audio output go? */
+	
+	size = sizeof(env.device);
+	if(AudioHardwareGetProperty(kAudioHardwarePropertyDefaultOutputDevice, &size, &env.device)) return(-1);
+		
+	/* Hmmm, let's choose PCM format */
+	
+	size = sizeof(format);
+	if(AudioDeviceGetProperty(env.device, 0, 0, kAudioDevicePropertyStreamFormat, &size, &format)) return(-1);
+	if(format.mFormatID != kAudioFormatLinearPCM) return(-1);
+	
+	/* Let's test volume, which doesn't seem to work (but this is only an alpha, remember?) */
+	
+	/*vol = 0.5;
+	size = sizeof(vol);
+	if(e = AudioDeviceSetProperty(env.device, NULL, 0, 0, 'volm', size, &vol)) { printf("Didn't your mother ever tell you not to hear music so loudly?\n"); return(-1); } */
+	
+	/* Let's init our environment */
+	
+	env.size = 0;
+	env.debut = NULL;
+	env.ptr = NULL;
+	env.play = 0;
+	
+	#if MOSX_USES_SEM
+	strcpy(s, "/mpg123-0000");
+	do
+	{
+		for(m = 10;; m--)
+			if( (s[m]++) <= '9')
+				break;
+			else
+				s[m] = '0';
+	} while( (env.semaphore = sem_open(s, O_CREAT | O_EXCL, 0644, 0)) == (sem_t *)SEM_FAILED);
+	#else
+	env.pid = getpid();
+	env.wait = 0;
+	signal(SIGUSR2, start);
+	#endif
+	
+	initBuffers();
+		
+	/* And prepare audio launching */
+	
+	if(AudioDeviceAddIOProc(env.device, playProc, &env)) return(-1);
+	
+	return(0);
+}
+
+int audio_reset_parameters(struct audio_info_struct *ai)
+{
+	return 0;
+}
+
+int audio_rate_best_match(struct audio_info_struct *ai)
+{
+	return 0;
+}
+
+int audio_set_rate(struct audio_info_struct *ai)
+{
+	return 0;
+}
+
+int audio_set_channels(struct audio_info_struct *ai)
+{
+	return 0;
+}
+
+int audio_set_format(struct audio_info_struct *ai)
+{
+	return 0;
+}
+
+int audio_get_formats(struct audio_info_struct *ai)
+{
+	return AUDIO_FORMAT_SIGNED_16;
+}
+
+int audio_play_samples(struct audio_info_struct *ai,unsigned char *buf,int len)
+{
+	/* We have to calm down mpg123, else he wouldn't hesitate to drop us another buffer (which would be the same, in fact) */
+	
+	#if MOSX_USES_SEM && MOSX_SEM_V2	/* Suddenly, I have some kind of doubt: HOW COULD IT WORK??? */
+	while(sem_wait(env.semaphore)){}	/* We just have to wait a buffer fill request */
+	fillBuffer(env.to, (short *)buf, len / sizeof(short));
+	#else
+	while(fillBuffer(env.to, (short *)buf, len / sizeof(short)) < 0)	/* While the next buffer to write is not empty, we wait a bit... */
+	{
+		#ifdef DEBUG_MOSX
+		printf("|"); fflush(stdout);
+		#endif
+		#if MOSX_USES_SEM
+		sem_wait(env.semaphore);	/* This is a bug. I should wait for the semaphore once per empty buffer (and not each time fillBuffers() returns -1). See MOSX_SEM_V2; this was a too quickly modified part when I implemented MOSX_USES_SEM. */
+		#else
+		env.wait = 1;
+		sleep(3600);	/* This should be sufficient, shouldn't it? */
+		#endif
+	}
+	#endif
+	env.to = env.to->next;
+	
+	/* And we lauch action if not already done */
+	
+	if(!env.play)
+	{
+		if(AudioDeviceStart(env.device, playProc)) return(-1);
+		env.play = 1;
+	}
+	
+	return len;
+}
+
+int audio_close(struct audio_info_struct *ai)
+{
+	AudioDeviceStop(env.device, playProc);	/* No matter the error code, we want to close it (by brute force if necessary) */
+	AudioDeviceRemoveIOProc(env.device, playProc);
+	destroyBuffers();
+	#if MOSX_USES_SEM
+	sem_close(env.semaphore);
+	#endif
+	return 0;
+}
diff -Naur mpg123/audio_nas.c mpg123-new/audio_nas.c
--- mpg123/audio_nas.c	1999-09-20 10:54:59.000000000 -0400
+++ mpg123-new/audio_nas.c	2005-07-29 10:49:12.000000000 -0400
@@ -185,7 +185,7 @@
     info.buf_size = buf_samples * ai->channels * AuSizeofFormat(format);
     info.buf = (char *) malloc(info.buf_size);
     if (info.buf == NULL) {
-        fprintf(stderr, "Unable to allocate input/output buffer of size %ld\n",
+        fprintf(stderr, "Unable to allocate input/output buffer of size %d\n",
              info.buf_size);
         exit(1);
     }
diff -Naur mpg123/common.c mpg123-new/common.c
--- mpg123/common.c	2001-05-16 12:56:56.000000000 -0400
+++ mpg123-new/common.c	2005-07-29 10:49:12.000000000 -0400
@@ -127,7 +127,7 @@
 	return FALSE;
     if(!((head>>17)&3))
 	return FALSE;
-    if( ((head>>12)&0xf) == 0xf)
+    if( ((head>>12)&0xf) == 0xf || ((head>>12)&0xf) == 0) 
 	return FALSE;
     if( ((head>>10)&0x3) == 0x3 )
 	return FALSE;
@@ -140,7 +140,7 @@
  *       -1: giving up
  *        1: synched
  */
-#define MAX_INPUT_FRAMESIZE 1920
+#define MAX_INPUT_FRAMESIZE 4096
 #define SYNC_HEAD_MASK    0xffff0000
 #define SYNC_HEAD_MASK_FF 0x0000f000
 #define LOOK_AHEAD_NUM 3
@@ -579,7 +579,11 @@
         fprintf(stderr,"Sorry, unknown layer type.\n"); 
         return (0);
     }
-
+    if (fr->framesize>MAX_INPUT_FRAMESIZE) {
+        fprintf(stderr,"Frame size too big.\n");
+        fr->framesize = MAX_INPUT_FRAMESIZE;
+        return 0;
+    } 
     if(!fr->bitrate_index) {
         /* fprintf(stderr,"Warning, Free format not heavily tested: (head %08lx)\n",newhead); */
         fr->framesize = 0;
diff -Naur mpg123/httpget.c mpg123-new/httpget.c
--- mpg123/httpget.c	2000-10-30 12:45:12.000000000 -0500
+++ mpg123-new/httpget.c	2005-07-29 10:49:13.000000000 -0400
@@ -3,6 +3,11 @@
  *
  *   Oliver Fromme  <oliver.fromme@heim3.tu-clausthal.de>
  *   Wed Apr  9 20:57:47 MET DST 1997
+ *
+ *   Modified by Jeremy Huddleston <eradicator@gentoo.org> 2004.10.21 per 
+ *   http://bugs.gentoo.org/show_bug.cgi?id=68343
+ *   http://www.barrossecurity.com/advisories/mpg123_getauthfromurl_bof_advisory.txt
+ *
  */
 
 #undef ALSA
@@ -55,7 +60,7 @@
 #endif
 	int pos = 0;
 
-	while(1) {
+	while(maxlen>pos) {
 		if( read(fileno(f),string+pos,1) == 1) {
 			pos++;
 			if(string[pos-1] == '\n') {
@@ -221,12 +226,12 @@
 #define ACCEPT_HEAD "Accept: audio/mpeg, audio/x-mpegurl, */*\r\n"
 
 char *httpauth = NULL;
-char httpauth1[256];
+char *httpauth1 = NULL;
 
 int http_open (char *url)
 {
 	char *purl, *host, *request, *sptr;
-	int linelength;
+	unsigned int linelength, linelengthbase;
 	unsigned long myip;
 	unsigned char *myport;
 	int sock;
@@ -270,53 +275,74 @@
                        exit(1);
                }
 
-	
-	if ((linelength = strlen(url)+200) < 1024)
-		linelength = 1024;
-	if (!(request = malloc(linelength)) || !(purl = malloc(1024))) {
+	/* The length of purl is upper bound by 3*strlen(url) + 1 if everything in it is a space */
+	purl = (char *)malloc(sizeof(char) * (strlen(url)*3 + 1));
+	if (!purl) {
 		fprintf (stderr, "malloc() failed, out of memory.\n");
 		exit (1);
 	}
-       /*
-        * 2000-10-21:
-        * We would like spaces to be automatically converted to %20's when
-        * fetching via HTTP.
-        * -- Martin Sjögren <md9ms@mdstud.chalmers.se>
-        */
-       if ((sptr = strchr(url, ' ')) == NULL) {
-               strncpy (purl, url, 1023);
-               purl[1023] = '\0';
-       }
-       else {
-               int purllength = 0;
-               char *urlptr = url;
-               purl[0] = '\0';
-               do {
-                       purllength += sptr-urlptr + 3;
-                       if (purllength >= 1023)
-                               break;
-                       strncat (purl, urlptr, sptr-urlptr);
-                       //purl[sptr-url] = '\0';
-                       strcat (purl, "%20");
-                       urlptr = sptr + 1;
-               }
-               while ((sptr = strchr (urlptr, ' ')) != NULL);
-               strcat (purl, urlptr);
-       }
 
+	/*
+	 * 2000-10-21:
+	 * We would like spaces to be automatically converted to %20's when
+	 * fetching via HTTP.
+	 * -- Martin Sjögren <md9ms@mdstud.chalmers.se>
+	 */
+	if ((sptr = strchr(url, ' ')) == NULL) {
+		strcpy (purl, url);
+	} else {
+		char *urlptr = url;
+		purl[0] = '\0';
+		do {
+			strncat (purl, urlptr, sptr - urlptr);
+			strcat (purl, "%20");
+			urlptr = sptr + 1;
+		}
+		while ((sptr = strchr (urlptr, ' ')) != NULL);
+		strcat (purl, urlptr);
+	}
+
+	httpauth1 = (char *)malloc((strlen(purl) + 1) * sizeof(char));
+	if(!httpauth1) {
+		fprintf(stderr, "malloc() failed, out of memory.\n");
+		exit(1);
+	}
+	getauthfromURL(purl,httpauth1);
+
+	/* "GET http://" +               11
+	 * " HTTP/1.0\r\nUser-Agent: <prgName>/<prgVersion>\r\n"  26 + prgName + prgVersion
+	 * ACCEPT_HEAD               strlen(ACCEPT_HEAD)
+	 * "Authorization: Basic \r\n"   23
+	 * "\r\n"                         2
+	 */
+	linelengthbase = 62 + strlen(prgName) + strlen(prgVersion) + strlen(ACCEPT_HEAD);
+
+	if(httpauth)
+		linelengthbase += (strlen(httpauth) + 1) * 4;
 
-        getauthfromURL(purl,httpauth1);
+	if(httpauth1)
+		linelengthbase += (strlen(httpauth1) + 1) * 4;
 
 	do {
-		strcpy (request, "GET ");
 		if (proxyip != INADDR_NONE) {
-                        if (strncasecmp(url, "http://", 7) != 0 && strncasecmp(url,"ftp://", 6) != 0)
-				strcat (request, "http://");
-			strcat (request, purl);
 			myport = proxyport;
 			myip = proxyip;
-		}
-		else {
+
+			linelength = linelengthbase + strlen(purl);
+			if(host)
+				linelength += 9 + strlen(host) + strlen(myport); /* "Host: <host>:<port>\r\n" */
+
+			request = (char *)malloc((linelength + 1) * sizeof(char));
+			if (!request) {
+				fprintf (stderr, "malloc() failed, out of memory.\n");
+				exit (1);
+			}
+
+			strcpy (request, "GET ");
+			if (strncasecmp(url, "http://", 7) != 0 && strncasecmp(url,"ftp://", 6) != 0)
+				strcat (request, "http://");
+			strcat (request, purl);
+		} else {
 			if (host) {
 				free(host);
 				host=NULL;
@@ -325,19 +351,30 @@
 				free(proxyport);
 				proxyport=NULL;
 			}
-			if (!(sptr = url2hostport(purl, &host, &myip, &myport))) {
-				fprintf (stderr, "Unknown host \"%s\".\n",
-					host ? host : "");
+			
+			sptr = url2hostport(purl, &host, &myip, &myport);
+			if (!sptr) {
+				fprintf (stderr, "Unknown host \"%s\".\n", host ? host : "");
 				exit (1);
 			}
+
+			linelength = linelengthbase + strlen(sptr);
+			if(host)
+				linelength += 9 + strlen(host) + strlen(myport); /* "Host: <host>:<port>\r\n" */
+
+			request = (char *)malloc((linelength + 1) * sizeof(char));
+			if (!request) {
+				fprintf (stderr, "malloc() failed, out of memory.\n");
+				exit (1);
+			}
+
+			strcpy (request, "GET ");
 			strcat (request, sptr);
 		}
-		sprintf (request + strlen(request),
-			" HTTP/1.0\r\nUser-Agent: %s/%s\r\n",
-			prgName, prgVersion);
+
+		sprintf (request + strlen(request), " HTTP/1.0\r\nUser-Agent: %s/%s\r\n", prgName, prgVersion);
 		if (host) {
-			sprintf(request + strlen(request),
-				"Host: %s:%s\r\n", host, myport);
+			sprintf(request + strlen(request), "Host: %s:%s\r\n", host, myport);
 #if 0
 			free (host);
 #endif
@@ -394,15 +431,29 @@
 			exit(1);
 		}
 
-		if (strlen(httpauth1) || httpauth) {
-			char buf[1023];
+		if (httpauth1 || httpauth) {
+			char *buf;
 			strcat (request,"Authorization: Basic ");
-                        if(strlen(httpauth1))
-                          encode64(httpauth1,buf);
-                        else
-			  encode64(httpauth,buf);
-			strcat (request,buf);
+			if(httpauth1) {
+				buf=(char *)malloc((strlen(httpauth1) + 1) * 4 * sizeof(char));
+				if(!buf) {
+					fprintf(stderr, "Error allocating sufficient memory for http authentication.  Exiting.");
+					exit(1);
+				}
+				encode64(httpauth1,buf);
+				free(httpauth1);
+			} else {
+				buf=(char *)malloc((strlen(httpauth) + 1) * 4 * sizeof(char));
+				if(!buf) {
+					fprintf(stderr, "Error allocating sufficient memory for http authentication.  Exiting.");
+					exit(1);
+				}
+				encode64(httpauth,buf);
+			}
+
+			strcat (request, buf);
 			strcat (request,"\r\n");
+			free(buf);
 		}
 		strcat (request, "\r\n");
 
@@ -431,13 +482,14 @@
 			if (!strncmp(request, "Location:", 9))
 				strncpy (purl, request+10, 1023);
 		} while (request[0] != '\r' && request[0] != '\n');
+		
+		free(request);
 	} while (relocate && purl[0] && numrelocs++ < 5);
 	if (relocate) {
 		fprintf (stderr, "Too many HTTP relocations.\n");
 		exit (1);
 	}
-	free (purl);
-	free (request);
+	free(purl);
 	free(host);
 	free(proxyport);
 	free(myport);
diff -Naur mpg123/layer2.c mpg123-new/layer2.c
--- mpg123/layer2.c	2001-01-23 10:10:02.000000000 -0500
+++ mpg123-new/layer2.c	2005-07-29 10:49:13.000000000 -0400
@@ -262,7 +262,7 @@
        { alloc_0, alloc_1, alloc_2, alloc_3 , alloc_4 };
   static int sblims[5] = { 27 , 30 , 8, 12 , 30 };
 
-  if(fr->lsf)
+  if(fr->sampling_frequency >= 3) /* Or equivalent: (fr->lsf == 1) */
     table = 4;
   else
     table = translate[fr->sampling_frequency][2-fr->stereo][fr->bitrate_index];
@@ -287,6 +287,12 @@
   fr->jsbound = (fr->mode == MPG_MD_JOINT_STEREO) ?
      (fr->mode_ext<<2)+4 : fr->II_sblimit;
 
+  /* security fix. */
+  if (fr->jsbound > fr->II_sblimit) {
+    fprintf(stderr, "Truncating stereo boundary to sideband limit.\n");
+    fr->jsbound=fr->II_sblimit;
+  }
+
   if(stereo == 1 || single == 3)
     single = 0;
 
diff -Naur mpg123/layer3.c mpg123-new/layer3.c
--- mpg123/layer3.c	2001-01-23 10:10:02.000000000 -0500
+++ mpg123-new/layer3.c	2005-07-29 10:49:12.000000000 -0400
@@ -609,7 +609,7 @@
  * Dequantize samples (includes huffman decoding)
  */
 /* 24 is enough because tab13 has max. a 19 bit huffvector */
-#define BITSHIFT ((sizeof(long)-1)*8)
+#define BITSHIFT ((sizeof(int)-1)*8)
 #define REFRESH_MASK \
   while(num < BITSHIFT) { \
     mask |= ((unsigned long)getbyte(&bsi))<<(BITSHIFT-num); \
@@ -626,7 +626,7 @@
   int *me;
 
   int num=getbitoffset(&bsi);
-  long mask;
+  int mask;
   /* we must split this, because for num==0 the shift is undefined if you do it in one step */
   mask  = ((unsigned long) getbits(&bsi,num))<<BITSHIFT;
   mask <<= 8-num;
@@ -713,7 +713,7 @@
         if(x == 15 && h->linbits) {
           max[lwin] = cb;
           REFRESH_MASK;
-          x += ((unsigned long) mask) >> (BITSHIFT+8-h->linbits);
+          x += ((unsigned int) mask) >> (BITSHIFT+8-h->linbits);
           num -= h->linbits+1;
           mask <<= h->linbits;
           if(mask < 0)
@@ -737,7 +737,7 @@
         if(y == 15 && h->linbits) {
           max[lwin] = cb;
           REFRESH_MASK;
-          y += ((unsigned long) mask) >> (BITSHIFT+8-h->linbits);
+          y += ((unsigned int) mask) >> (BITSHIFT+8-h->linbits);
           num -= h->linbits+1;
           mask <<= h->linbits;
           if(mask < 0)
@@ -891,7 +891,7 @@
         if (x == 15 && h->linbits) {
           max = cb;
 	  REFRESH_MASK;
-          x += ((unsigned long) mask) >> (BITSHIFT+8-h->linbits);
+          x += ((unsigned int) mask) >> (BITSHIFT+8-h->linbits);
           num -= h->linbits+1;
           mask <<= h->linbits;
           if(mask < 0)
@@ -915,7 +915,7 @@
         if (y == 15 && h->linbits) {
           max = cb;
 	  REFRESH_MASK;
-          y += ((unsigned long) mask) >> (BITSHIFT+8-h->linbits);
+          y += ((unsigned int) mask) >> (BITSHIFT+8-h->linbits);
           num -= h->linbits+1;
           mask <<= h->linbits;
           if(mask < 0)
diff -Naur mpg123/playlist.c mpg123-new/playlist.c
--- mpg123/playlist.c	2000-10-25 07:05:26.000000000 -0400
+++ mpg123-new/playlist.c	2005-07-29 10:49:13.000000000 -0400
@@ -110,9 +110,9 @@
 		if ((playlist->listnamedir) && (line[0]!='/') && (line[0]!='\\') 
                     && (strncasecmp(line, "http://", 7)) && (strncasecmp(line, 
 "ftp://",6)) ){
-		    strcpy (linetmp, playlist->listnamedir);
-		    strcat (linetmp, line);
-		    strcpy (line, linetmp);
+		    strncpy (linetmp, playlist->listnamedir, 1023);
+		    strncat (linetmp, line, 1023 - strlen(linetmp));
+		    strncpy (line, linetmp, 1023);
 		}
 		return 1;
 	    }
