
--- kdebase-3.5.2/applnk/Makefile.am	2005-09-10 04:25:45.000000000 -0400
+++ kdebase-3.5.2-new/applnk/Makefile.am	2006-04-14 16:18:17.000000000 -0400
@@ -3,7 +3,7 @@
 xdg_menu_DATA = kde-settings.menu kde-information.menu kde-screensavers.menu
 
 xdg_mergedmenu_DATA = kde-essential.menu
-xdg_mergedmenudir = $(xdg_menudir)/applications-merged
+xdg_mergedmenudir = $(xdg_menudir)/kde-applications-merged
 
 xdg_directory_DATA = \
 kde-main.directory \
--- kdebase-3.5.2/doc/userguide/kde-for-admins.docbook	2006-03-17 05:17:25.000000000 -0500
+++ kdebase-3.5.2-new/doc/userguide/kde-for-admins.docbook	2006-04-14 16:18:17.000000000 -0400
@@ -1669,7 +1669,7 @@
 </para>
 
 <informalexample>
-<para>Example from <filename>applications.menu</filename>:
+<para>Example from <filename>kde-applications.menu</filename>:
 <programlisting>
 <markup>
 	&lt;Menu&gt;
@@ -1743,7 +1743,7 @@
 information, see <ulink url="http://www.freedesktop.org/Standards/basedir-spec">http://www.freedesktop.org/Standards/basedir-spec</ulink></para>
 
 <informalexample>
-<para>Example from <filename>applications.menu</filename>:
+<para>Example from <filename>kde-applications.menu</filename>:
 <programlisting>
 <markup>
              &lt;Menu&gt;
@@ -1795,7 +1795,7 @@
 <title>Essential Menus</title>
 
 <para><filename
-class="directory">$<envar>KDEDIR</envar>/etc/xdg/menus/applications-merged/</filename>
+class="directory">$<envar>KDEDIR</envar>/etc/xdg/menus/kde-applications-merged/</filename>
 contains <filename>kde-essential.menu</filename> which includes some
 essential menus that are normally not shown in the &kde; menu itself:
 <itemizedlist>
--- kdebase-3.5.2/drkonqi/Makefile.am	2005-09-10 04:25:55.000000000 -0400
+++ kdebase-3.5.2-new/drkonqi/Makefile.am	2006-04-14 16:18:17.000000000 -0400
@@ -8,15 +8,17 @@
 
 EXTRA_DIST = LICENSE
 
-bin_PROGRAMS = drkonqi
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = drkonqi.la
 
 # Libraries:
-AM_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-LDADD  = $(LIB_KDEUI) $(LIB_KIO)
+drkonqi_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+drkonqi_la_LIBADD  = $(LIB_KDEUI) $(LIB_KIO)
 
 # toplevel.cpp must be last in row due to X-headers being included. (--enable-final)
 # Did I mention already that X header files really suck?
-drkonqi_SOURCES = krashdcopinterface.skel main.cpp debugger.cpp krashconf.cpp drbugreport.cpp backtrace.cpp toplevel.cpp
+drkonqi_la_SOURCES = krashdcopinterface.skel main.cpp debugger.cpp krashconf.cpp drbugreport.cpp backtrace.cpp toplevel.cpp
 
 
 check_PROGRAMS = crashtest
--- kdebase-3.5.2/drkonqi/crashtest.cpp	2005-09-10 04:25:55.000000000 -0400
+++ kdebase-3.5.2-new/drkonqi/crashtest.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -79,7 +79,7 @@
 
   KApplication app(false, false);
   KCmdLineArgs *args = KCmdLineArgs::parsedArgs();
-  QCString type = args->arg(0);
+  QCString type = args->count() ? args->arg(0) : "";
   int crashtype = Crash;
   if (type == "malloc")
     crashtype = Malloc;
--- kdebase-3.5.2/drkonqi/main.cpp	2005-09-10 04:25:55.000000000 -0400
+++ kdebase-3.5.2-new/drkonqi/main.cpp	2006-04-14 16:18:17.000000000 -0400
@@ -57,7 +57,7 @@
   KCmdLineLastOption
 };
 
-int main( int argc, char* argv[] )
+extern "C" KDE_EXPORT int kdemain( int argc, char* argv[] )
 {
   // Drop privs.
   setgid(getgid());
--- kdebase-3.5.2/kappfinder/Makefile.am	2005-09-10 04:25:41.000000000 -0400
+++ kdebase-3.5.2-new/kappfinder/Makefile.am	2006-04-14 16:18:17.000000000 -0400
@@ -1,9 +1,17 @@
 SUBDIRS = apps
 
-bin_PROGRAMS = kappfinder
-kappfinder_SOURCES = main.cpp toplevel.cpp common.cpp
-kappfinder_LDADD = $(LIB_KDEUI) $(LIB_KIO)
-kappfinder_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kappfinder.la
+
+kappfinder_la_SOURCES = main.cpp toplevel.cpp kacommon.cpp
+kappfinder_la_LIBADD = $(LIB_KDEUI) $(LIB_KIO)
+kappfinder_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+
+$(srcdir)/kacommon.cpp: $(srcdir)/common.cpp
+	cat $(srcdir)/common.cpp > $(srcdir)/kacommon.cpp
+
+DISTCLEANFILES = kacommon.cpp
 
 noinst_PROGRAMS = kappfinder_install
 kappfinder_install_SOURCES = main_install.cpp common.cpp
--- kdebase-3.5.2/kappfinder/main.cpp	2005-10-10 11:04:07.000000000 -0400
+++ kdebase-3.5.2-new/kappfinder/main.cpp	2006-04-14 16:18:17.000000000 -0400
@@ -31,7 +31,7 @@
   KCmdLineLastOption
 };
 
-int main( int argc, char *argv[] )
+extern "C" KDE_EXPORT int kdemain( int argc, char *argv[] )
 {
   KAboutData aboutData( "kappfinder", I18N_NOOP( "KAppfinder" ),
                         "1.0", description, KAboutData::License_GPL,
--- kdebase-3.5.2/kcontrol/access/kaccess.cpp	2006-03-20 07:43:10.000000000 -0500
+++ kdebase-3.5.2-new/kcontrol/access/kaccess.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -325,7 +325,7 @@
   overlay = 0;
 }
 
-int maskToBit (int mask) {
+static int maskToBit (int mask) {
    for (int i = 0; i < 8; i++)
       if (mask & (1 << i))
          return i;
@@ -337,12 +337,12 @@
       keys [i] = -1;
    state = 0;
 
-   for (int i = 0; modifierKeys[i].name != ""; i++) {
+   for (int i = 0; strcmp (modifierKeys[i].name, "") != 0; i++) {
       int mask = modifierKeys[i].mask;
       if (mask == 0)
          if (modifierKeys[i].keysym != 0)
             mask = XkbKeysymToModifiers (qt_xdisplay(), modifierKeys[i].keysym);
-         else if (modifierKeys[i].name == "Win")
+         else if (!strcmp(modifierKeys[i].name, "Win"))
             mask = KKeyNative::modX(KKey::WIN);
          else
             mask = XkbKeysymToModifiers (qt_xdisplay(), XK_Mode_switch)
--- kdebase-3.5.2/kcontrol/access/kcmaccess.cpp	2006-01-19 12:00:47.000000000 -0500
+++ kdebase-3.5.2-new/kcontrol/access/kcmaccess.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -512,7 +512,7 @@
   hbox = new QHBoxLayout(vvbox, KDialog::spacingHint());
   hbox->addSpacing(24);
   timeoutDelay = new KIntNumInput(grp);
-  timeoutDelay->setSuffix(i18n(" minutes"));
+  timeoutDelay->setSuffix(i18n(" min"));
   timeoutDelay->setRange(1, 30, 4);
   timeoutDelay->setLabel(i18n("Timeout:"));
   hbox->addWidget(timeoutDelay);
--- kdebase-3.5.2/kcontrol/background/bgrender.cpp	2006-03-17 05:17:11.000000000 -0500
+++ kdebase-3.5.2-new/kcontrol/background/bgrender.cpp	2006-04-14 16:18:23.000000000 -0400
@@ -386,7 +386,8 @@
 	    {
 	       xs = ys = 1;
 	    }
-	    wp = wp.smoothScale(xs, ys);
+	    if( wp.size() != QSize( xs, ys ))
+		wp = wp.smoothScale(xs, ys);
 	}
     }
 wp_out:
@@ -420,7 +421,10 @@
 	    d.setCoords(-ww + ((w - ww) / 2) % ww, -wh + ((h - wh) / 2) % wh, w-1, h-1);
 	    break;
 	case Scaled:
-	    wp = wp.smoothScale(ww = w, wh = h);
+	    ww = w;
+	    wh = h;
+	    if( wp.size() != QSize( w, h ))
+		wp = wp.smoothScale( w, h );
 	    d.setRect(0, 0, w, h);
 	    break;
         case CentredAutoFit:
@@ -440,7 +444,8 @@
                   wh = (int)(sx * wh);
                   ww = w;
               }
-              wp = wp.smoothScale(ww, wh);
+	      if( wp.size() != QSize( ww, wh ))
+	        wp = wp.smoothScale(ww, wh);
 	      d.setRect((w - ww) / 2, (h - wh) / 2, ww, wh);
 	      break;
             }
@@ -455,7 +460,8 @@
                   wh = (int)(sx * wh);
                   ww = w;
               }
-              wp = wp.smoothScale(ww, wh);
+              if( wp.size() != QSize( ww, wh ))
+                wp = wp.smoothScale(ww, wh);
 	      d.setRect(0, 0, w, h);
 	      break;
             }
@@ -472,7 +478,8 @@
                   wh = h;
                   ww = (int)(sy*ww);
               }
-              wp = wp.smoothScale(ww, wh);
+              if( wp.size() != QSize( ww, wh ))
+                wp = wp.smoothScale(ww, wh);
 	      d.setRect((w - ww) / 2, (h - wh) / 2,w, h);
 	      break;
             }
--- kdebase-3.5.2/kcontrol/crypto/crypto.cpp	2006-03-17 05:17:17.000000000 -0500
+++ kdebase-3.5.2-new/kcontrol/crypto/crypto.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -1977,7 +1977,7 @@
 			QByteArray qba;
 			qba.duplicate(cr, qf.size());
 			certtext = KCodecs::base64Encode(qba);
-			delete cr;
+			delete [] cr;
 		}
 
 		qf.close();
--- kdebase-3.5.2/kcontrol/filetypes/Makefile.am	2005-09-10 04:25:08.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/filetypes/Makefile.am	2006-04-14 16:18:17.000000000 -0400
@@ -12,16 +12,18 @@
 	kservicelistwidget.h typeslistitem.h newtypedlg.h \
 	kserviceselectdlg.h
 
-bin_PROGRAMS = keditfiletype
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = keditfiletype.la
 
 noinst_LTLIBRARIES = libfiletypes.la
 libfiletypes_la_SOURCES = filetypesview.cpp filetypedetails.cpp filegroupdetails.cpp \
 		 kservicelistwidget.cpp typeslistitem.cpp newtypedlg.cpp \
 		 kserviceselectdlg.cpp
 
-keditfiletype_SOURCES = keditfiletype.cpp
-keditfiletype_LDADD = libfiletypes.la $(LIB_KIO)
-keditfiletype_LDFLAGS = $(KDE_RPATH) $(all_libraries)
+keditfiletype_la_SOURCES = keditfiletype.cpp
+keditfiletype_la_LIBADD = libfiletypes.la $(LIB_KIO)
+keditfiletype_la_LDFLAGS = $(KDE_PLUGIN) $(all_libraries) -module
 
 messages:
 	$(XGETTEXT) *.cpp -o $(podir)/filetypes.pot
--- kdebase-3.5.2/kcontrol/filetypes/filetypedetails.cpp	2005-09-10 04:25:08.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/filetypes/filetypedetails.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -201,8 +201,8 @@
 {
   if ( !m_item )
     return;
-        
-  int button = m_item->autoEmbed();  
+
+  int button = m_item->autoEmbed();
   if (button == 2)
   {
     bool embedParent = TypesListItem::defaultEmbeddingSetting(m_item->majorType());
@@ -223,9 +223,9 @@
   config->setGroup("Notification Messages");
   bool ask = config->readEntry(dontAskAgainName).isEmpty();
   m_item->getAskSave(ask);
-  
+
   bool neverAsk = false;
-  
+
   if (button == 0)
   {
     KMimeType::Ptr mime = KMimeType::mimeType( mimeType );
@@ -248,12 +248,12 @@
         neverAsk = true;
     }
   }
-  
+
   m_chkAskSave->blockSignals(true);
   m_chkAskSave->setChecked(ask && !neverAsk);
   m_chkAskSave->setEnabled(!neverAsk);
   m_chkAskSave->blockSignals(false);
-}  
+}
 
 void FileTypeDetails::slotAskSaveToggled(bool askSave)
 {
@@ -281,12 +281,13 @@
   serviceListWidget->setTypeItem( tlitem );
   embedServiceListWidget->setTypeItem( tlitem );
   m_autoEmbed->setButton( tlitem ? tlitem->autoEmbed() : -1 );
+  m_rbGroupSettings->setEnabled( tlitem->canUseGroupSetting() );
 
   if ( tlitem )
     extensionLB->insertStringList(tlitem->patterns());
   else
     extensionLB->clear();
-    
+
   updateAskSave();
 }
 
--- kdebase-3.5.2/kcontrol/filetypes/keditfiletype.cpp	2005-10-10 11:03:47.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/filetypes/keditfiletype.cpp	2006-04-14 16:18:17.000000000 -0400
@@ -108,7 +108,7 @@
   KCmdLineLastOption
 };
 
-int main(int argc, char ** argv)
+extern "C" KDE_EXPORT int kdemain(int argc, char ** argv)
 {
   KServiceTypeProfile::setConfigurationMode();
   KLocale::setMainCatalogue("filetypes");
--- kdebase-3.5.2/kcontrol/filetypes/typeslistitem.cpp	2005-10-10 11:03:47.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/filetypes/typeslistitem.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -74,7 +74,8 @@
 
 bool TypesListItem::defaultEmbeddingSetting( const QString& major )
 {
-  return (major=="image"); // embedding is false by default except for image/*
+  // embedding is false by default except for image/*
+  return ( major=="image" );
 }
 
 void TypesListItem::setup()
@@ -103,9 +104,18 @@
   m_comment = mimetype->comment(QString(), false);
   m_icon = mimetype->icon(QString(), false);
   m_patterns = mimetype->patterns();
+  m_autoEmbed = readAutoEmbed( mimetype );
+}
 
+int TypesListItem::readAutoEmbed( KMimeType::Ptr mimetype )
+{
   QVariant v = mimetype->property( "X-KDE-AutoEmbed" );
-  m_autoEmbed = v.isValid() ? (v.toBool() ? 0 : 1) : 2;
+  if ( v.isValid() )
+      return (v.toBool() ? 0 : 1);
+  else if ( !mimetype->property( "X-KDE-LocalProtocol" ).toString().isEmpty() )
+      return 0; // embed by default for zip, tar etc.
+  else
+      return 2;
 }
 
 QStringList TypesListItem::appServices() const
@@ -172,9 +182,7 @@
     return true;
   }
 
-  QVariant v = m_mimetype->property( "X-KDE-AutoEmbed" );
-  unsigned int oldAutoEmbed = v.isValid() ? (v.toBool() ? 0 : 1) : 2;
-  if ( oldAutoEmbed != m_autoEmbed )
+  if ( readAutoEmbed( m_mimetype ) != (int)m_autoEmbed )
     return true;
   return false;
 }
@@ -222,7 +230,7 @@
     if ( m_autoEmbed != oldAutoEmbed )
       return true;
   }
-  
+
   if (m_askSave != 2)
     return true;
 
@@ -261,7 +269,7 @@
 
   if (isMimeTypeDirty())
   {
-    // We must use KConfig otherwise config.deleteEntry doesn't 
+    // We must use KConfig otherwise config.deleteEntry doesn't
     // properly cancel out settings already present in system files.
     KConfig config( m_mimetype->desktopEntryPath(), false, false, "mime" );
     config.setDesktopGroup();
@@ -411,7 +419,7 @@
       it != mimeTypeList.end(); ++it)
   {
     if (m->is(*it))
-       return true;  
+       return true;
   }
 
   return false;
@@ -555,3 +563,11 @@
    else
       m_askSave = 1;
 }
+
+bool TypesListItem::canUseGroupSetting() const
+{
+  // "Use group settings" isn't available for zip, tar etc.; those have a builtin default...
+    bool hasLocalProtocolRedirect = !m_mimetype->property( "X-KDE-LocalProtocol" ).toString().isEmpty();
+    return !hasLocalProtocolRedirect;
+}
+
--- kdebase-3.5.2/kcontrol/filetypes/typeslistitem.h	2005-10-10 11:03:47.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/filetypes/typeslistitem.h	2006-04-14 16:18:24.000000000 -0400
@@ -77,6 +77,7 @@
   int autoEmbed() const { return m_autoEmbed; }
   void setAutoEmbed( int a ) { m_autoEmbed = a; }
   const KMimeType::Ptr& mimeType() const { return m_mimetype; }
+  bool canUseGroupSetting() const;
 
   void getAskSave(bool &);
   void setAskSave(bool);
@@ -98,6 +99,7 @@
   void saveServices( KConfig & profile, QStringList services, const QString & servicetype2 );
   void initMeta( const QString & major );
   void init(KMimeType::Ptr mimetype);
+  static int readAutoEmbed( KMimeType::Ptr mimetype );
 
   KMimeType::Ptr m_mimetype;
   unsigned int groupCount:16; // shared between saveServices and sync
--- kdebase-3.5.2/kcontrol/fonts/Makefile.am	2006-03-17 05:17:12.000000000 -0500
+++ kdebase-3.5.2-new/kcontrol/fonts/Makefile.am	2006-04-14 16:18:17.000000000 -0400
@@ -4,13 +4,13 @@
 libkxftconfig_la_LIBADD = $(LIBFONTCONFIG_LIBS)
 libkxftconfig_la_LDFLAGS = $(LIBFONTCONFIG_RPATH)
 
-AM_CPPFLAGS  = $(all_includes) $(LIBFONTCONFIG_CFLAGS) -D_LARGEFILE64_SOURCE
+AM_CPPFLAGS  = $(LIBFONTCONFIG_CFLAGS) -D_LARGEFILE64_SOURCE $(all_includes)
 
 kde_module_LTLIBRARIES = kcm_fonts.la
 
 kcm_fonts_la_SOURCES = fonts.cpp
 kcm_fonts_la_LDFLAGS = $(KDE_RPATH) $(LIBFONTCONFIG_RPATH) -module -avoid-version $(all_libraries) -no-undefined
-kcm_fonts_la_LIBADD = libkxftconfig.la $(top_builddir)/kcontrol/krdb/libkrdb.la $(LIB_KDEUI) $(LIBFONTCONFIG_LIBS)
+kcm_fonts_la_LIBADD = $(LIBFONTCONFIG_LIBS) libkxftconfig.la $(top_builddir)/kcontrol/krdb/libkrdb.la $(LIB_KDEUI)
 METASOURCES = AUTO
 
 noinst_HEADERS = fonts.h kxftconfig.h
--- kdebase-3.5.2/kcontrol/fonts/configure.in.in	2005-09-10 04:25:04.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/fonts/configure.in.in	2006-04-14 16:18:17.000000000 -0400
@@ -1,8 +1,6 @@
-KDE_FIND_PATH(fontconfig-config, FONTCONFIG_CONFIG, [${prefix}/bin ${exec_prefix}/bin /usr/bin /usr/local/bin /opt/local/bin], [
         KDE_FIND_PATH(pkg-config, PKGCONFIG, [${prefix}/bin ${exec_prefix}/bin /usr/bin /usr/local/bin /opt/local/bin], [
             AC_MSG_WARN([Could not find neither pkg-config nor fontconfig-config, check http://www.fontconfig.org/ ])
         ])
-])
 
 if test -n "$PKGCONFIG"; then
   vers=`$PKGCONFIG fontconfig --modversion 2>/dev/null | sed -e 's/libfontconfig //' | awk 'BEGIN { FS = "."; } { printf "%d", ($1 * 1000 + $2) * 1000 + $3;}'`
--- kdebase-3.5.2/kcontrol/fonts/kxftconfig.cpp	2005-11-19 06:23:23.000000000 -0500
+++ kdebase-3.5.2-new/kcontrol/fonts/kxftconfig.cpp	2006-04-14 16:18:23.000000000 -0400
@@ -1134,7 +1134,7 @@
          *eostr=NULL,
          data[constMaxDataLen];
 
-    if(m_required&&Dirs)
+    if(m_required&Dirs)
         while((ptr=getKey(ptr, "dir")))
         {
             from=ptr;
--- kdebase-3.5.2/kcontrol/input/logitechmouse.cpp	2005-10-10 11:03:43.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/input/logitechmouse.cpp	2006-04-14 16:18:23.000000000 -0400
@@ -53,7 +53,7 @@
 
     m_usbDeviceHandle = usb_open( usbDev );
 
-    if ( 0 > m_usbDeviceHandle ) {
+    if ( 0 == m_usbDeviceHandle ) {
         kdWarning() << "Error opening usbfs file: " << usb_strerror() << endl;
         return;
     }
--- kdebase-3.5.2/kcontrol/input/mouse.cpp	2006-01-19 12:00:43.000000000 -0500
+++ kdebase-3.5.2-new/kcontrol/input/mouse.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -206,10 +206,11 @@
     thresh = new KIntNumInput(accel, 20, tab2);
     thresh->setLabel(i18n("Pointer threshold:"));
     thresh->setRange(0,20,1);
-    thresh->setSuffix(i18n(" pixels"));
     thresh->setSteps(1,1);
     lay->addWidget(thresh);
     connect(thresh, SIGNAL(valueChanged(int)), this, SLOT(changed()));
+    connect(thresh, SIGNAL(valueChanged(int)), this, SLOT(slotThreshChanged(int)));
+    slotThreshChanged(thresh->value());
 
     wtstr = i18n("The threshold is the smallest distance that the"
          " mouse pointer must move on the screen before acceleration"
@@ -258,10 +259,11 @@
     dragStartDist = new KIntNumInput(dragStartTime, 20, tab2);
     dragStartDist->setLabel(i18n("Drag start distance:"));
     dragStartDist->setRange(1, 20, 1);
-    dragStartDist->setSuffix(i18n(" pixels"));
     dragStartDist->setSteps(1,1);
     lay->addWidget(dragStartDist);
     connect(dragStartDist, SIGNAL(valueChanged(int)), this, SLOT(changed()));
+    connect(dragStartDist, SIGNAL(valueChanged(int)), this, SLOT(slotDragStartDistChanged(int)));
+    slotDragStartDistChanged(dragStartDist->value());
 
     wtstr = i18n("If you click with the mouse and begin to move the"
          " mouse at least the drag start distance, a drag"
@@ -271,10 +273,11 @@
     wheelScrollLines = new KIntNumInput(dragStartDist, 3, tab2);
     wheelScrollLines->setLabel(i18n("Mouse wheel scrolls by:"));
     wheelScrollLines->setRange(1, 12, 1);
-    wheelScrollLines->setSuffix(i18n(" lines"));
     wheelScrollLines->setSteps(1,1);
     lay->addWidget(wheelScrollLines);
     connect(wheelScrollLines, SIGNAL(valueChanged(int)), this, SLOT(changed()));
+    connect(wheelScrollLines, SIGNAL(valueChanged(int)), SLOT(slotWheelScrollLinesChanged(int)));
+    slotWheelScrollLinesChanged(wheelScrollLines->value());
 
     wtstr = i18n("If you use the wheel of a mouse, this value determines the number of lines to scroll for each wheel movement. Note that if this number exceeds the number of visible lines, it will be ignored and the wheel movement will be handled as a page up/down movement.");
     QWhatsThis::add( wheelScrollLines, wtstr);
@@ -718,6 +721,21 @@
   changeCursor = config->readBoolEntry("ChangeCursor", KDE_DEFAULT_CHANGECURSOR);
 }
 
+void MouseConfig::slotThreshChanged(int value)
+{
+  thresh->setSuffix(i18n(" pixel", " pixels", value));
+}
+
+void MouseConfig::slotDragStartDistChanged(int value)
+{
+  dragStartDist->setSuffix(i18n(" pixel", " pixels", value));
+}
+
+void MouseConfig::slotWheelScrollLinesChanged(int value)
+{
+  wheelScrollLines->setSuffix(i18n(" line", " lines", value));
+}
+
 void MouseSettings::apply(bool force)
 {
   XChangePointerControl( kapp->getDisplay(),
--- kdebase-3.5.2/kcontrol/input/mouse.h	2005-10-10 11:03:44.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/input/mouse.h	2006-04-14 16:18:24.000000000 -0400
@@ -107,6 +107,9 @@
   void slotHandedChanged(int val);
   void slotScrollPolarityChanged();
   void checkAccess();
+  void slotThreshChanged(int value);
+  void slotDragStartDistChanged(int value);
+  void slotWheelScrollLinesChanged(int value);
 
 private:
 
--- kdebase-3.5.2/kcontrol/kfontinst/configure.in.in	2006-01-19 12:00:50.000000000 -0500
+++ kdebase-3.5.2-new/kcontrol/kfontinst/configure.in.in	2006-04-14 16:18:17.000000000 -0400
@@ -36,11 +36,9 @@
 
     KFI_FOUND_FONTCONFIG=0
     # check for fontconfig...
-    KDE_FIND_PATH(fontconfig-config, FONTCONFIG_CONFIG, [${prefix}/bin ${exec_prefix}/bin /usr/bin /usr/local/bin /opt/local/bin], [
             KDE_FIND_PATH(pkg-config, PKGCONFIG, [${prefix}/bin ${exec_prefix}/bin /usr/bin /usr/local/bin /opt/local/bin], [
                 AC_MSG_WARN([Could not find neither pkg-config nor fontconfig-config, check http://www.fontconfig.org/ ])
             ])
-    ])
 
     if test -n "$PKGCONFIG"; then
         vers=`$PKGCONFIG fontconfig --modversion 2>/dev/null | sed -e 's/libfontconfig //' | awk 'BEGIN { FS = "."; } { printf "%d", ($1 * 1000 + $2) * 1000 + $3;}'`
--- kdebase-3.5.2/kcontrol/kfontinst/kcmfontinst/Makefile.am	2005-09-10 04:25:09.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/kfontinst/kcmfontinst/Makefile.am	2006-04-14 16:18:17.000000000 -0400
@@ -4,10 +4,10 @@
 endif
 
 kde_module_LTLIBRARIES = kcm_fontinst.la
-kcm_fontinst_la_LIBADD  = $(LIB_KIO) $(FONTINST_PRINT_LIB) $(LIBFREETYPE_LIBS) $(LIBFONTCONFIG_LIBS) ../lib/libkfontinst.la
+kcm_fontinst_la_LIBADD  = $(LIBFREETYPE_LIBS) $(LIBFONTCONFIG_LIBS) $(LIB_KIO) $(FONTINST_PRINT_LIB) ../lib/libkfontinst.la
 METASOURCES = AUTO
 kcm_fontinst_la_LDFLAGS = $(KDE_PLUGIN) $(all_libraries) $(KDE_RPATH) -module -avoid-version -no-undefined
-AM_CPPFLAGS = -I$(srcdir)/../lib $(FONTINST_PRINT_INC) -I$(srcdir)/../../fonts $(all_includes) $(LIBFREETYPE_CFLAGS) $(LIBFONTCONFIG_CFLAGS)
+AM_CPPFLAGS = -I$(srcdir)/../lib $(FONTINST_PRINT_INC) -I$(srcdir)/../../fonts $(LIBFREETYPE_CFLAGS) $(LIBFONTCONFIG_CFLAGS) $(all_includes)
  
 xdg_apps_DATA = kcmfontinst.desktop
  
--- kdebase-3.5.2/kcontrol/kfontinst/kfile-plugin/Makefile.am	2005-09-10 04:25:09.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/kfontinst/kfile-plugin/Makefile.am	2006-04-14 16:18:17.000000000 -0400
@@ -1,13 +1,13 @@
 kde_module_LTLIBRARIES = kfile_font.la
 
 kfile_font_la_SOURCES = KFileFont.cpp
-kfile_font_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) $(LIBFREETYPE_RPATH) -module $(KDE_PLUGIN)
-kfile_font_la_LIBADD = $(LIB_KIO) $(LIBFREETYPE_LIBS) ../lib/libkfontinst.la
+kfile_font_la_LDFLAGS = $(LIBFREETYPE_RPATH) $(all_libraries) $(KDE_RPATH) -module $(KDE_PLUGIN)
+kfile_font_la_LIBADD = $(LIBFREETYPE_LIBS) $(LIB_KIO) ../lib/libkfontinst.la
 
 kdelnkdir = $(kde_servicesdir)
 kde_services_DATA = kfile_font.desktop
 
-AM_CPPFLAGS = -I$(srcdir)/../lib -I$(srcdir)/../../fonts $(all_includes) $(LIBFREETYPE_CFLAGS)
+AM_CPPFLAGS = -I$(srcdir)/../lib -I$(srcdir)/../../fonts $(LIBFREETYPE_CFLAGS) $(all_includes)
 
 METASOURCES = AUTO
 noinst_HEADERS = KFileFont.h
--- kdebase-3.5.2/kcontrol/kfontinst/kfontinst/Main.cpp	2005-10-10 11:03:47.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/kfontinst/kfontinst/Main.cpp	2006-04-14 16:18:17.000000000 -0400
@@ -190,7 +190,7 @@
         KFI::CXConfig::refreshPaths(true);
 }
 
-int main(int argc, char *argv[])
+extern "C" KDE_EXPORT int kdemain(int argc, char *argv[])
 {
 #ifdef HAVE_GETOPT_H
     static struct option options[]=
--- kdebase-3.5.2/kcontrol/kfontinst/kfontinst/Makefile.am	2005-09-10 04:25:09.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/kfontinst/kfontinst/Makefile.am	2006-04-14 16:18:17.000000000 -0400
@@ -1,5 +1,8 @@
-bin_PROGRAMS = kfontinst
-kfontinst_SOURCES = \
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kfontinst.la
+
+kfontinst_la_SOURCES = \
 CompressedFile.cpp \
 Main.cpp \
 Encodings.cpp \
@@ -15,6 +18,6 @@
 Fontmap.h \
 XConfig.h
 
-kfontinst_LDADD = ../../fonts/libkxftconfig.la $(LIBFONTCONFIG_LIBS) $(LIBFREETYPE_LIBS) $(LIB_FONT_ENC) $(LIBZ) $(LIB_KIO) ../lib/libkfontinst.la
-kfontinst_LDFLAGS = $(all_libraries) $(LIBFONTCONFIG_RPATH) $(LIBFREETYPE_RPATH) $(KDE_RPATH)
-AM_CPPFLAGS= -DOS_$(UNAME) -I$(srcdir)/../lib -I$(srcdir)/../../fonts $(all_includes) $(LIBFREETYPE_CFLAGS) $(LIBFONTCONFIG_CFLAGS)
+kfontinst_la_LIBADD = $(LIBFONTCONFIG_LIBS) $(LIBFREETYPE_LIBS) $(LIB_FONT_ENC) ../../fonts/libkxftconfig.la $(LIBZ) $(LIB_KIO) ../lib/libkfontinst.la
+kfontinst_la_LDFLAGS = $(LIBFONTCONFIG_RPATH) $(LIBFREETYPE_RPATH) $(all_libraries) $(KDE_PLUGIN) -module
+AM_CPPFLAGS= -DOS_$(UNAME) -I$(srcdir)/../lib -I$(srcdir)/../../fonts $(LIBFREETYPE_CFLAGS) $(LIBFONTCONFIG_CFLAGS) $(all_includes)
--- kdebase-3.5.2/kcontrol/kfontinst/kio/KioFonts.cpp	2006-03-17 05:17:16.000000000 -0500
+++ kdebase-3.5.2-new/kcontrol/kfontinst/kio/KioFonts.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -69,6 +69,7 @@
 #include "FcEngine.h"
 #include "Misc.h"
 #include <X11/Xlib.h>
+#include <fixx11h.h>
 #include <ctype.h>
 
 //#define KFI_FORCE_DEBUG_TO_STDERR
--- kdebase-3.5.2/kcontrol/kfontinst/kio/Makefile.am	2005-09-10 04:25:09.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/kfontinst/kio/Makefile.am	2006-04-14 16:18:17.000000000 -0400
@@ -2,9 +2,9 @@
 kio_fonts_la_SOURCES = \
 KioFonts.cpp
 
-kio_fonts_la_LIBADD = ../../fonts/libkxftconfig.la $(LIBFONTCONFIG_LIBS) $(LIBFREETYPE_LIBS) $(LIB_KIO) -lkdesu ../lib/libkfontinst.la
-kio_fonts_la_LDFLAGS = $(KDE_PLUGIN) $(all_libraries) $(KDE_RPATH) $(LIBFONTCONFIG_RPATH) $(LIBFREETYPE_RPATH) -module -avoid-version -no-undefined
-AM_CPPFLAGS= -I$(srcdir)/../lib -I$(srcdir)/../../fonts $(all_includes) $(LIBFREETYPE_CFLAGS) $(LIBFONTCONFIG_CFLAGS) -D_LARGEFILE64_SOURCE
+kio_fonts_la_LIBADD = $(LIBFONTCONFIG_LIBS) $(LIBFREETYPE_LIBS) ../../fonts/libkxftconfig.la $(LIB_KIO) -lkdesu ../lib/libkfontinst.la
+kio_fonts_la_LDFLAGS = $(LIBFONTCONFIG_RPATH) $(LIBFREETYPE_RPATH) $(KDE_PLUGIN) $(all_libraries) $(KDE_RPATH) -module -avoid-version -no-undefined
+AM_CPPFLAGS= -I$(srcdir)/../lib -I$(srcdir)/../../fonts $(LIBFREETYPE_CFLAGS) $(LIBFONTCONFIG_CFLAGS) -D_LARGEFILE64_SOURCE $(all_includes)
 
 # The kxftconfig stuf really belongs to kdebase/kcontrol/fonts - here only so that can distribute this as an archive.
 noinst_HEADERS = \
--- kdebase-3.5.2/kcontrol/kfontinst/lib/FcEngine.cpp	2005-09-10 04:25:09.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/kfontinst/lib/FcEngine.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -11,7 +11,9 @@
 #include "FcEngine.h"
 #include "KfiConstants.h"
 #ifdef HAVE_XFT
+#include <X11/Xlib.h>
 #include <X11/Xft/Xft.h>
+#include <fixx11h.h>
 #endif
 
 #define KFI_HAVE_OBLIQUE         // Do we differentiate between Italic and Oblique?
@@ -24,8 +26,6 @@
 #define KFI_DISPLAY(pix) (pix ? pix->x11Display() : QPaintDevice::x11AppDisplay())
 #endif
 
-// CPD: TODO: should I use latin1, local8Bit, or utf8?
-
 namespace KFI
 {
 
@@ -477,7 +477,7 @@
         if(!itsInstalled)  // Then add to fontconfig's list, so that Xft can display it...
         {
             FcInitReinitialize();
-            FcConfigAppFontAddFile(FcConfigGetCurrent(), (const FcChar8 *)(itsName.latin1()));
+            FcConfigAppFontAddFile(FcConfigGetCurrent(), (const FcChar8 *)(itsName.utf8().data()));
         }
 
         if(thumb && (w!=h || h>128))
@@ -1028,7 +1028,7 @@
     {
         FcObjectSet *os  = FcObjectSetBuild(FC_SPACING, FC_FOUNDRY, (void *)0);
         FcPattern   *pat = FcPatternBuild(NULL,
-                                            FC_FAMILY, FcTypeString, (const FcChar8 *)(itsName.latin1()),
+                                            FC_FAMILY, FcTypeString, (const FcChar8 *)(itsName.utf8().data()),
                                             FC_WEIGHT, FcTypeInteger, itsWeight,
                                             FC_SLANT, FcTypeInteger, itsSlant,
 #ifndef KFI_FC_NO_WIDTHS
@@ -1056,7 +1056,7 @@
 {
     if(itsInstalled)
         return XftFontOpen(KFI_DISPLAY(pix), 0,
-                           FC_FAMILY, FcTypeString, (const FcChar8 *)(itsName.latin1()),
+                           FC_FAMILY, FcTypeString, (const FcChar8 *)(itsName.utf8().data()),
                            FC_WEIGHT, FcTypeInteger, itsWeight,
                            FC_SLANT, FcTypeInteger, itsSlant,
 #ifndef KFI_FC_NO_WIDTHS
@@ -1152,7 +1152,7 @@
                            FcResultMatch==FcPatternGetInteger(f->pattern, FC_WIDTH, 0, &iv) && equalWidth(iv, itsWidth) &&
 #endif
                            FcResultMatch==FcPatternGetString(f->pattern, FC_FAMILY, 0, &str) && str &&
-                           0==strcmp((const char *)str, itsName.latin1()))
+                           QString::fromUtf8((char *)str)==itsName)
                         {
                             itsSizes.push_back(constSizes[l][i]);
                             gotSizes=true;
--- kdebase-3.5.2/kcontrol/kfontinst/lib/FcEngine.h	2005-09-10 04:25:09.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/kfontinst/lib/FcEngine.h	2006-04-14 16:18:17.000000000 -0400
@@ -5,6 +5,8 @@
 #include "config.h"
 #endif
 
+#define KFI_FC_NO_WIDTHS 1
+
 #include <qstring.h>
 #include <qvaluevector.h>
 #include <qfont.h>
--- kdebase-3.5.2/kcontrol/kfontinst/lib/Makefile.am	2005-09-10 04:25:09.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/kfontinst/lib/Makefile.am	2006-04-14 16:18:17.000000000 -0400
@@ -9,6 +9,6 @@
 FcEngine.h \
 KfiConstants.h
 
-libkfontinst_la_LIBADD = $(LIB_KDECORE) $(LIBFONTCONFIG_LIBS) $(LIBFREETYPE_LIBS) $(LIB_KIO) $(LIBXFT_LIB)
-libkfontinst_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) $(LIBFONTCONFIG_RPATH) $(LIBFREETYPE_RPATH) -no-undefined
-AM_CPPFLAGS= $(all_includes) $(LIBFREETYPE_CFLAGS) $(LIBFONTCONFIG_CFLAGS) -D_LARGEFILE64_SOURCE
+libkfontinst_la_LIBADD = $(LIBFONTCONFIG_LIBS) $(LIBFREETYPE_LIBS) $(LIB_KDECORE) $(LIB_KIO) $(LIBXFT_LIB)
+libkfontinst_la_LDFLAGS = $(LIBFONTCONFIG_RPATH) $(LIBFREETYPE_RPATH) $(all_libraries) $(KDE_RPATH) -no-undefined
+AM_CPPFLAGS= $(LIBFREETYPE_CFLAGS) $(LIBFONTCONFIG_CFLAGS) -D_LARGEFILE64_SOURCE $(all_includes)
--- kdebase-3.5.2/kcontrol/kfontinst/thumbnail/Makefile.am	2005-09-10 04:25:09.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/kfontinst/thumbnail/Makefile.am	2006-04-14 16:18:17.000000000 -0400
@@ -2,7 +2,7 @@
 
 fontthumbnail_la_SOURCES = FontThumbnail.cpp
 fontthumbnail_la_LIBADD = $(LIBFREETYPE_LIBS) $(LIB_KDECORE) $(LIB_KIO) ../lib/libkfontinst.la
-fontthumbnail_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) $(LIBFREETYPE_RPATH) -module $(KDE_PLUGIN)
+fontthumbnail_la_LDFLAGS = $(KDE_RPATH) $(LIBFREETYPE_RPATH) -module $(KDE_PLUGIN) $(all_libraries)
 METASOURCES = AUTO
 
 noinst_HEADERS = FontThumbnail.h
@@ -11,4 +11,4 @@
 
 kde_services_DATA = fontthumbnail.desktop
 
-AM_CPPFLAGS= -I$(srcdir)/../lib -I$(srcdir)/../../fonts $(all_includes) $(LIBFREETYPE_CFLAGS)
+AM_CPPFLAGS= -I$(srcdir)/../lib -I$(srcdir)/../../fonts $(LIBFREETYPE_CFLAGS) $(all_includes)
--- kdebase-3.5.2/kcontrol/kfontinst/viewpart/FontViewerApp.cpp	2005-10-10 11:03:47.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/kfontinst/viewpart/FontViewerApp.cpp	2006-04-14 16:18:17.000000000 -0400
@@ -116,7 +116,7 @@
                             KAboutData::License_GPL,
                             I18N_NOOP("(c) Craig Drummond, 2004"));
 
-int main(int argc, char **argv)
+extern "C" KDE_EXPORT int kdemain(int argc, char **argv)
 {
     KCmdLineArgs::init(argc, argv, &aboutData);
     KCmdLineArgs::addCmdLineOptions(options);
--- kdebase-3.5.2/kcontrol/kfontinst/viewpart/Makefile.am	2005-09-10 04:25:09.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/kfontinst/viewpart/Makefile.am	2006-04-14 16:18:18.000000000 -0400
@@ -13,18 +13,21 @@
 
 kde_services_DATA = kfontviewpart.desktop
 
-AM_CPPFLAGS = -I$(srcdir)/../lib -I$(srcdir)/../../fonts $(all_includes) $(LIBFREETYPE_CFLAGS) $(LIBFONTCONFIG_CFLAGS)
+AM_CPPFLAGS = -I$(srcdir)/../lib -I$(srcdir)/../../fonts $(LIBFREETYPE_CFLAGS) $(LIBFONTCONFIG_CFLAGS) $(all_includes)
 METASOURCES = AUTO
 
-kfontview_LDADD = $(LIB_KPARTS)
-kfontview_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+kfontview_la_LIBADD = $(LIB_KPARTS)
+kfontview_la_LDFLAGS = $(KDE_PLUGIN) -module $(all_libraries)
+
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kfontview.la
 
-bin_PROGRAMS = kfontview
 xdg_apps_DATA = kfontview.desktop
 
 appdata_DATA = kfontviewpart.rc kfontviewui.rc
 appdatadir = $(kde_datadir)/kfontview
 
-kfontview_SOURCES = FontViewerApp.cpp
+kfontview_la_SOURCES = FontViewerApp.cpp
 
 
--- kdebase-3.5.2/kcontrol/kicker/hidingtab_impl.cpp	2005-09-10 04:25:09.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/kicker/hidingtab_impl.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -240,7 +240,7 @@
         return Bottom;
     else if (trigger == 6)
         return BottomLeft;
-    else if (Left == 7)
+    else if (trigger == 7)
         return Left;
 
     return 0;
@@ -262,7 +262,7 @@
         return 5;
     else if (trigger == BottomLeft)
         return 6;
-    else if (Left == Left)
+    else if (trigger == Left)
         return 7;
 
     return 0;
--- kdebase-3.5.2/kcontrol/konq/fontopts.cpp	2005-10-10 11:03:47.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/konq/fontopts.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -143,13 +143,13 @@
     else
     {
         m_pNbLines = new QSpinBox( 1, 10, 1, this );
-        m_pNbLines->setSuffix( i18n( " lines" ) );
-        m_pNbLines->setSpecialValueText( i18n( "1 line" ) );
         QLabel* label = new QLabel( m_pNbLines, i18n("H&eight for icon text:"), this );
         lay->addWidget( label, row, 0 );
         lay->addWidget( m_pNbLines, row, 1 );
         connect( m_pNbLines, SIGNAL( valueChanged(int) ),
                  this, SLOT( changed() ) );
+        connect( m_pNbLines, SIGNAL( valueChanged(int) ),
+                 SLOT( slotPNbLinesChanged(int)) );
 
         QString thwt = i18n("This is the maximum number of lines that can be"
                             " used to draw icon text. Long file names are"
@@ -161,13 +161,14 @@
 
         // width for the items in multicolumn icon view
         m_pNbWidth = new QSpinBox( 1, 100000, 1, this );
-        m_pNbWidth->setSuffix( i18n( " pixels" ) );
 
         label = new QLabel( m_pNbWidth, i18n("&Width for icon text:"), this );
         lay->addWidget( label, row, 0 );
         lay->addWidget( m_pNbWidth, row, 1 );
         connect( m_pNbWidth, SIGNAL( valueChanged(int) ),
                  this, SLOT( changed() ) );
+        connect( m_pNbWidth, SIGNAL( valueChanged(int) ),
+                 SLOT( slotPNbWidthChanged(int)) );
 
         thwt = i18n( "This is the maximum width for the icon text when konqueror "
                      "is used in multi column view mode." );
@@ -217,6 +218,16 @@
     m_stdName = n;
 }
 
+void KonqFontOptions::slotPNbLinesChanged(int value)
+{
+    m_pNbLines->setSuffix( i18n( " line", " lines", value ) );
+}
+
+void KonqFontOptions::slotPNbWidthChanged(int value)
+{
+    m_pNbWidth->setSuffix( i18n( " pixel", " pixels", value ) );
+}
+
 void KonqFontOptions::load()
 {
     g_pConfig->setGroup(groupname);
--- kdebase-3.5.2/kcontrol/konq/fontopts.h	2005-10-10 11:03:47.000000000 -0400
+++ kdebase-3.5.2-new/kcontrol/konq/fontopts.h	2006-04-14 16:18:24.000000000 -0400
@@ -69,6 +69,10 @@
   //void slotHighlightedTextColorChanged( const QColor &col );
   void slotTextBackgroundColorChanged( const QColor &col );
 
+private slots:
+  void slotPNbLinesChanged(int value);
+  void slotPNbWidthChanged(int value);
+
 private:
   void updateGUI();
 
--- kdebase-3.5.2/kcontrol/screensaver/scrnsave.cpp	2006-01-19 12:00:50.000000000 -0500
+++ kdebase-3.5.2-new/kcontrol/screensaver/scrnsave.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -183,8 +183,7 @@
     mWaitEdit = new QSpinBox(mSettingsGroup);
     mWaitEdit->setSteps(1, 10);
     mWaitEdit->setRange(1, INT_MAX);
-    mWaitEdit->setSuffix(i18n(" minutes"));
-    mWaitEdit->setSpecialValueText(i18n("1 minute"));
+    mWaitEdit->setSuffix(i18n(" min"));
     mWaitEdit->setValue(mTimeout/60);
     mWaitEdit->setEnabled(mEnabled);
     connect(mWaitEdit, SIGNAL(valueChanged(int)),
@@ -219,8 +218,7 @@
     mWaitLockEdit = new QSpinBox(mSettingsGroup);
     mWaitLockEdit->setSteps(1, 10);
     mWaitLockEdit->setRange(1, 1800);
-    mWaitLockEdit->setSuffix(i18n(" seconds"));
-    mWaitLockEdit->setSpecialValueText(i18n("1 second"));
+    mWaitLockEdit->setSuffix(i18n(" sec"));
     mWaitLockEdit->setValue(mLockTimeout/1000);
     mWaitLockEdit->setEnabled(mEnabled && mLock);
     if ( mWaitLockEdit->sizeHint().width() <
--- kdebase-3.5.2/kdcop/Makefile.am	2005-09-10 04:25:53.000000000 -0400
+++ kdebase-3.5.2-new/kdcop/Makefile.am	2006-04-14 16:18:18.000000000 -0400
@@ -7,10 +7,13 @@
 
 INCLUDES = $(all_includes)
 
-bin_PROGRAMS = kdcop
-
-kdcop_SOURCES = kdcop.cpp kdcopwindow.cpp kdcoplistview.cpp kdcopview.ui
-kdcop_LDFLAGS = $(all_libraries) $(KDE_RPATH) $(LIB_KDEUI) $(LIB_KDECORE) $(LIB_KIO) -lDCOP $(LIB_QT)
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kdcop.la
+
+kdcop_la_SOURCES = kdcop.cpp kdcopwindow.cpp kdcoplistview.cpp kdcopview.ui
+kdcop_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kdcop_la_LIBADD  = $(LIB_KDEUI) $(LIB_KDECORE) $(LIB_KIO) -lDCOP $(LIB_QT)
 
 noinst_HEADERS = kdcopwindow.h
 METASOURCES =	AUTO
--- kdebase-3.5.2/kdcop/kdcop.cpp	2005-09-10 04:25:53.000000000 -0400
+++ kdebase-3.5.2-new/kdcop/kdcop.cpp	2006-04-14 16:18:18.000000000 -0400
@@ -15,7 +15,7 @@
     KCmdLineLastOption
 };
 
-int main( int argc, char ** argv )
+extern "C" KDE_EXPORT int kdemain( int argc, char ** argv )
 {
   KAboutData aboutData( "kdcop", I18N_NOOP("KDCOP"),
 			"0.1", I18N_NOOP( "A graphical DCOP browser/client" ),
--- kdebase-3.5.2/kdebugdialog/Makefile.am	2005-09-10 04:24:57.000000000 -0400
+++ kdebase-3.5.2-new/kdebugdialog/Makefile.am	2006-04-14 16:18:18.000000000 -0400
@@ -4,12 +4,14 @@
 
 ####### Files
 
-bin_PROGRAMS = kdebugdialog
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kdebugdialog.la
 
-kdebugdialog_SOURCES = main.cpp kabstractdebugdialog.cpp kdebugdialog.cpp klistdebugdialog.cpp
-kdebugdialog_METASOURCES = AUTO
-kdebugdialog_LDFLAGS =       $(all_libraries) $(KDE_RPATH)
-kdebugdialog_LDADD   =       $(LIB_KDEUI)
+kdebugdialog_la_SOURCES = main.cpp kabstractdebugdialog.cpp kdebugdialog.cpp klistdebugdialog.cpp
+kdebugdialog_la_METASOURCES = AUTO
+kdebugdialog_la_LDFLAGS =       $(all_libraries) $(KDE_PLUGIN) -module
+kdebugdialog_la_LIBADD   =       $(LIB_KDEUI)
 
 messages:
 	$(XGETTEXT) *.cpp -o $(podir)/kdebugdialog.pot	
--- kdebase-3.5.2/kdebugdialog/main.cpp	2005-10-10 11:03:40.000000000 -0400
+++ kdebase-3.5.2-new/kdebugdialog/main.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -75,7 +75,7 @@
   KCmdLineLastOption
 };
 
-int main(int argc, char ** argv)
+extern "C" KDE_EXPORT int kdemain(int argc, char ** argv)
 {
   KAboutData data( "kdebugdialog", I18N_NOOP( "KDebugDialog"),
     "1.0", I18N_NOOP("A dialog box for setting preferences for debug output"),
--- kdebase-3.5.2/kdepasswd/Makefile.am	2005-09-10 04:24:59.000000000 -0400
+++ kdebase-3.5.2-new/kdepasswd/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -1,10 +1,13 @@
 
 SUBDIRS = kcm
 
-bin_PROGRAMS = kdepasswd
-kdepasswd_SOURCES = kdepasswd.cpp passwd.cpp passwddlg.cpp
-kdepasswd_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-kdepasswd_LDADD = $(LIB_KIO)
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kdepasswd.la
+
+kdepasswd_la_SOURCES = kdepasswd.cpp passwd.cpp passwddlg.cpp
+kdepasswd_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kdepasswd_la_LIBADD = $(LIB_KIO)
 
 METASOURCES =  AUTO
 AM_CPPFLAGS= -I$(top_srcdir)/libkonq $(all_includes)
--- kdebase-3.5.2/kdepasswd/kdepasswd.cpp	2005-09-10 04:24:59.000000000 -0400
+++ kdebase-3.5.2-new/kdepasswd/kdepasswd.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -26,7 +26,7 @@
 };
 
 
-int main(int argc, char **argv)
+extern "C" KDE_EXPORT int kdemain(int argc, char **argv)
 {
     KAboutData aboutData("kdepasswd", I18N_NOOP("KDE passwd"),
             VERSION, I18N_NOOP("Changes a UNIX password."),
--- kdebase-3.5.2/kdeprint/kdeprintfax/Makefile.am	2005-09-10 04:25:38.000000000 -0400
+++ kdebase-3.5.2-new/kdeprint/kdeprintfax/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -1,11 +1,14 @@
 INCLUDES= $(all_includes)
 
-bin_PROGRAMS = kdeprintfax
-kdeprintfax_SOURCES = main.cpp kdeprintfax.cpp faxab.cpp faxctrl.cpp confgeneral.cpp configdlg.cpp \
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kdeprintfax.la
+
+kdeprintfax_la_SOURCES = main.cpp kdeprintfax.cpp faxab.cpp faxctrl.cpp confgeneral.cpp configdlg.cpp \
 		      conffax.cpp confsystem.cpp conffilters.cpp filterdlg.cpp defcmds.cpp
-kdeprintfax_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-kdeprintfax_LDADD   = $(LIB_KDEUI) $(LIB_KIO) $(LIB_KDEPRINT) -lkabc
-kdeprintfax_METASOURCES = AUTO
+kdeprintfax_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kdeprintfax_la_LIBADD  = $(LIB_KDEUI) $(LIB_KIO) $(LIB_KDEPRINT) -lkabc
+kdeprintfax_la_METASOURCES = AUTO
 
 xdg_apps_DATA = kdeprintfax.desktop
 
--- kdebase-3.5.2/kdeprint/kdeprintfax/main.cpp	2005-10-10 11:04:02.000000000 -0400
+++ kdebase-3.5.2-new/kdeprint/kdeprintfax/main.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -44,7 +44,7 @@
   // INSERT YOUR COMMANDLINE OPTIONS HERE
 };
 
-int main(int argc, char *argv[])
+extern "C" KDE_EXPORT int kdemain(int argc, char *argv[])
 {
 
   KAboutData aboutData( "kdeprintfax", I18N_NOOP("KdeprintFax"),
--- kdebase-3.5.2/kdeprint/kprinter/printwrapper.cpp	2005-10-10 11:04:05.000000000 -0400
+++ kdebase-3.5.2-new/kdeprint/kprinter/printwrapper.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -137,10 +137,6 @@
 {
 	KCmdLineArgs	*args = KCmdLineArgs::parsedArgs();
 
-#if defined(HAVE_SIGACTION) && !defined(HAVE_SIGSET)
-	struct sigaction action;
-#endif /* HAVE_SIGACTION && !HAVE_SIGSET*/
-
 	// read variables from command line
 	QString	printer = args->getOption("d");
 	QString	title = args->getOption("t");
@@ -325,6 +321,10 @@
 
 		// print from stdin
 
+#if defined(HAVE_SIGACTION) && !defined(HAVE_SIGSET)
+	struct sigaction action;
+#endif /* HAVE_SIGACTION && !HAVE_SIGSET*/
+
 #  if defined(HAVE_SIGSET)
 		sigset(SIGHUP, signal_handler);
 		sigset(SIGINT, signal_handler);
--- kdebase-3.5.2/kdesktop/Makefile.am	2005-09-10 04:25:45.000000000 -0400
+++ kdebase-3.5.2-new/kdesktop/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -8,9 +8,9 @@
 
 ####### Files
 
-bin_PROGRAMS = kcheckrunning
+bin_PROGRAMS = 
 lib_LTLIBRARIES =
-kdeinit_LTLIBRARIES = kdesktop.la
+kdeinit_LTLIBRARIES = kdesktop.la kcheckrunning.la
 noinst_LTLIBRARIES = libkdesktopsettings.la
 
 libkdesktopsettings_la_LDFLAGS = $(all_libraries) -no-undefined
@@ -31,9 +31,9 @@
 	xautolock.h lockeng.h init.h minicli.h \
 	pixmapserver.h startupid.h xautolock_c.h
 
-kcheckrunning_SOURCES = kcheckrunning.cpp
-kcheckrunning_LDFLAGS = $(all_libraries)
-kcheckrunning_LDADD = $(LIB_X11)
+kcheckrunning_la_SOURCES = kcheckrunning.cpp
+kcheckrunning_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kcheckrunning_la_LIBADD = $(LIB_X11)
 
 METASOURCES = AUTO
 
--- kdebase-3.5.2/kdesktop/desktop.cc	2006-03-17 05:17:38.000000000 -0500
+++ kdebase-3.5.2-new/kdesktop/desktop.cc	2006-04-14 16:18:25.000000000 -0400
@@ -92,8 +92,7 @@
      else if ( e->type() == QEvent::DragEnter )
      {
        QDragEnterEvent* de = static_cast<QDragEnterEvent *>( e );
-       bool b = !KGlobal::config()->isImmutable();
-       b &= !KGlobal::dirs()->isRestrictedResource( "wallpaper" );
+       bool b = !KGlobal::config()->isImmutable() && !KGlobal::dirs()->isRestrictedResource( "wallpaper" );
 
        bool imageURL = false;
        if ( KURLDrag::canDecode( de ) )
@@ -107,7 +106,7 @@
            imageURL = true;
        }
 
-       b &= KColorDrag::canDecode( de ) || QImageDrag::canDecode( de ) || imageURL;
+       b = b && ( KColorDrag::canDecode( de ) || QImageDrag::canDecode( de ) || imageURL );
        de->accept( b );
        return true;
      }
--- kdebase-3.5.2/kdesktop/init.h	2005-10-10 11:04:11.000000000 -0400
+++ kdebase-3.5.2-new/kdesktop/init.h	2006-04-14 16:18:19.000000000 -0400
@@ -27,4 +27,18 @@
  */
 void testLocalInstallation();
 
+typedef struct fileinfobuf {
+   u_int32_t info_length;
+   union {
+     struct {
+       u_int32_t type;
+       u_int32_t creator;
+       u_int16_t fdFlags;
+       u_int16_t location;
+       u_int32_t padding[4];
+     } finder;
+     off_t rsrcForkSize;
+   } data;
+} fileinfobuf;
+
 #endif
--- kdebase-3.5.2/kdesktop/kcheckrunning.cpp	2005-10-10 11:04:11.000000000 -0400
+++ kdebase-3.5.2-new/kdesktop/kcheckrunning.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -18,8 +18,9 @@
 */
 
 #include <X11/Xlib.h>
+#include <kdemacros.h>
 
-int main()
+extern "C" KDE_EXPORT int kdemain()
     {
     Display* dpy = XOpenDisplay( NULL );
     if( dpy == NULL )
--- kdebase-3.5.2/kdesktop/krootwm.cc	2005-10-10 11:04:11.000000000 -0400
+++ kdebase-3.5.2-new/kdesktop/krootwm.cc	2006-04-14 16:18:19.000000000 -0400
@@ -52,6 +52,7 @@
 #include <kuser.h>
 #include <qfile.h>
 
+#include <kprocess.h>
 #include "krootwm.h"
 #include "kdiconview.h"
 #include "desktop.h"
@@ -82,6 +83,9 @@
   m_configDialog = 0;
 
 
+  new KAction(i18n("Konsole..." ), "openterm", 0, this, SLOT( slotOpenTerminal() ),
+               m_actionCollection, "open_terminal" );
+
   // Creates the new menu
   menuBar = 0; // no menubar yet
   menuNew = 0;
@@ -135,6 +139,7 @@
   {
      new KAction(i18n("Run Command..."), "run", 0, m_pDesktop, SLOT( slotExecuteCommand() ), m_actionCollection, "exec" );
   }
+
   if (!KGlobal::config()->isImmutable())
   {
      new KAction(i18n("Configure Desktop..."), "configure", 0, this, SLOT( slotConfigureDesktop() ),
@@ -378,6 +383,13 @@
     desktopMenu->disconnect( this );
     bool needSeparator = false;
 
+    action = m_actionCollection->action("open_terminal");
+    if (action)
+    {
+       action->plug( desktopMenu );
+       needSeparator = true;
+    }
+
     if (menuNew)
     {
        menuNew->plug( desktopMenu );
@@ -724,6 +736,13 @@
   return args;
 }
 
+void KRootWm::slotOpenTerminal()
+{
+  KProcess proc;
+  proc << locate("exe", "konsole");
+  proc.start(KProcess::DontCare);
+}
+
 void KRootWm::slotConfigureDesktop() {
   if (!m_configDialog)
   {
--- kdebase-3.5.2/kdesktop/krootwm.h	2005-10-10 11:04:11.000000000 -0400
+++ kdebase-3.5.2-new/kdesktop/krootwm.h	2006-04-14 16:18:19.000000000 -0400
@@ -119,6 +119,7 @@
   void slotSessionActivated( int );
   void slotNewSession();
   void slotLockNNewSession();
+  void slotOpenTerminal();
 
 private:
   KDesktop* m_pDesktop;
--- kdebase-3.5.2/kdesktop/kwebdesktop/Makefile.am	2005-09-10 04:25:45.000000000 -0400
+++ kdebase-3.5.2-new/kdesktop/kwebdesktop/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -2,12 +2,15 @@
 INCLUDES= $(all_includes)
 LDADD = $(LIB_KHTML)
 
-bin_PROGRAMS = 	kwebdesktop
+bin_PROGRAMS =
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kwebdesktop.la
 
 METASOURCES = AUTO
 
-kwebdesktop_SOURCES = kwebdesktop.cpp kwebdesktopsettings.kcfgc 
-kwebdesktop_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+kwebdesktop_la_SOURCES = kwebdesktop.cpp kwebdesktopsettings.kcfgc 
+kwebdesktop_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kwebdesktop_la_LIBADD  = $(LIB_KHTML)
 
 kdesktop_kwebdesktop_data_DATA = kwebdesktop.desktop
 kdesktop_kwebdesktop_datadir = $(kde_datadir)/kdesktop/programs
--- kdebase-3.5.2/kdesktop/kwebdesktop/kwebdesktop.cpp	2005-10-10 11:04:07.000000000 -0400
+++ kdebase-3.5.2-new/kdesktop/kwebdesktop/kwebdesktop.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -84,7 +84,7 @@
 }
 
 
-int main( int argc, char **argv )
+extern "C" KDE_EXPORT int kdemain( int argc, char **argv )
 {
     KAboutData data( "kwebdesktop", I18N_NOOP("KDE Web Desktop"),
                      VERSION,
--- kdebase-3.5.2/kdesktop/lock/Makefile.am	2005-09-10 04:25:41.000000000 -0400
+++ kdebase-3.5.2-new/kdesktop/lock/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -1,14 +1,16 @@
 ## Makefile.am of kdebase/kdesktop/lock
 
 INCLUDES = -I.. -I$(top_srcdir)/kcheckpass -I$(top_srcdir)/kdmlib $(GLINC) $(all_includes)
-kdesktop_lock_LDFLAGS  = $(all_libraries) $(KDE_RPATH)
-kdesktop_lock_LDADD    = ../libkdesktopsettings.la ../../kdmlib/libdmctl.la $(LIB_KIO) $(LIB_XF86MISC) $(GLLIB)
+kdesktop_lock_la_LDFLAGS  = $(all_libraries) $(KDE_RPATH) -module -avoid-version
+kdesktop_lock_la_LIBADD    = ../libkdesktopsettings.la ../../kdmlib/libdmctl.la $(LIB_KIO) $(LIB_XF86MISC) $(GLLIB)
 
 ####### Files
 
-bin_PROGRAMS = kdesktop_lock
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kdesktop_lock.la
 
-kdesktop_lock_SOURCES = lockprocess.cc lockdlg.cc autologout.cc main.cc
+kdesktop_lock_la_SOURCES = lockprocess.cc lockdlg.cc autologout.cc main.cc
 
 noinst_HEADERS = lockprocess.h lockdlg.h autologout.h main.h
 
--- kdebase-3.5.2/kdesktop/lock/main.cc	2006-03-17 05:17:37.000000000 -0500
+++ kdebase-3.5.2-new/kdesktop/lock/main.cc	2006-04-14 16:18:19.000000000 -0400
@@ -59,7 +59,7 @@
 
 // -----------------------------------------------------------------------------
 
-int main( int argc, char **argv )
+extern "C" KDE_EXPORT int kdemain( int argc, char **argv )
 {
     KLocale::setMainCatalogue("kdesktop");
 
--- kdebase-3.5.2/kdesktop/minicli.cpp	2006-03-17 05:17:38.000000000 -0500
+++ kdebase-3.5.2-new/kdesktop/minicli.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -521,6 +521,7 @@
             }
           }
         }
+        // fall-through to shell case
         case KURIFilterData::SHELL:
         {
           if (kapp->authorize("shell_access"))
--- kdebase-3.5.2/kdesu/kdesu/Makefile.am	2005-09-10 04:26:14.000000000 -0400
+++ kdebase-3.5.2-new/kdesu/kdesu/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -3,11 +3,14 @@
 INCLUDES= $(all_includes)
 
 ## kdesu
-bin_PROGRAMS = 	kdesu
-kdesu_SOURCES = kdesu.cpp sudlg.cpp
-kdesu_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-kdesu_LDADD   = $(LIB_KIO) -lkdesu
-kdesu_METASOURCES =  AUTO
+bin_PROGRAMS =
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kdesu.la
+
+kdesu_la_SOURCES = kdesu.cpp sudlg.cpp
+kdesu_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kdesu_la_LIBADD  = $(LIB_KIO) -lkdesu
+kdesu_la_METASOURCES =  AUTO
 noinst_HEADERS = sudlg.h
 
 ## Messages
--- kdebase-3.5.2/kdesu/kdesu/kdesu.cpp	2005-11-08 17:37:00.000000000 -0500
+++ kdebase-3.5.2-new/kdesu/kdesu/kdesu.cpp	2006-04-14 16:18:26.000000000 -0400
@@ -63,6 +63,7 @@
     { "p <prio>", I18N_NOOP("Set priority value: 0 <= prio <= 100, 0 is lowest"), "50" },
     { "r", I18N_NOOP("Use realtime scheduling"), 0 },
     { "nonewdcop", I18N_NOOP("Let command use existing dcopserver"), 0 },
+    { "noignorebutton", I18N_NOOP("Do not display ignore button"), 0 },
     { "i <icon name>", I18N_NOOP("Specify icon to use in the password dialog"), 0},
     { "d", I18N_NOOP("Do not show the command to be run in the dialog"), 0},
     KCmdLineLastOption
@@ -85,7 +86,7 @@
 
 static int startApp();
 
-int main(int argc, char *argv[])
+extern "C" KDE_EXPORT int kdemain(int argc, char *argv[])
 {
     // FIXME: this can be considered a poor man's solution, as it's not
     // directly obvious to a gui user. :)
@@ -272,7 +273,8 @@
     bool keep = !args->isSet("n") && have_daemon;
     bool terminal = args->isSet("t");
     bool new_dcop = args->isSet("newdcop");
-
+    bool withIgnoreButton = args->isSet("ignorebutton");
+    
     QCStringList env;
     QCString options;
     env << ( "DESKTOP_STARTUP_ID=" + kapp->startupId());
@@ -355,7 +357,7 @@
         KStartupInfoData data;
         data.setSilent( KStartupInfoData::Yes );
         KStartupInfo::sendChange( id, data );
-        KDEsuDialog dlg(user, auth_user, keep && !terminal, icon);
+        KDEsuDialog dlg(user, auth_user, keep && !terminal,icon, withIgnoreButton);
 	if (prompt)
 	    dlg.addLine(i18n("Command:"), command);
         if ((priority != 50) || (scheduler != SuProcess::SchedNormal))
--- kdebase-3.5.2/kdesu/kdesu/sudlg.cpp	2005-09-10 04:26:14.000000000 -0400
+++ kdebase-3.5.2-new/kdesu/kdesu/sudlg.cpp	2006-04-14 16:18:26.000000000 -0400
@@ -12,24 +12,32 @@
 #include "sudlg.h"
 
 
-KDEsuDialog::KDEsuDialog(QCString user, QCString auth_user, bool enableKeep, const QString& icon)
-    : KPasswordDialog(Password, enableKeep, User1, icon)
+KDEsuDialog::KDEsuDialog(QCString user, QCString auth_user, bool enableKeep,const QString& icon, bool withIgnoreButton)
+     : KPasswordDialog(Password, enableKeep, (withIgnoreButton ? User1:NoDefault), icon)
 {
     m_User = auth_user;
     setCaption(i18n("Run as %1").arg(user));
 
     QString prompt;
     if (m_User == "root")
+            {
+	if ( withIgnoreButton )
 	prompt = i18n("The action you requested needs root privileges. "
-		"Please enter root's password below or click "
-		"Ignore to continue with your current privileges.");
+	              "Please enter root's password below or click "
+		      "Ignore to continue with your current privileges.");
+	else
+	    prompt = i18n("The action you requested needs root privileges. "
+		          "Please enter root's password below ");
+	    }
+    
     else
 	prompt = i18n("The action you requested needs additional privileges. "
 		"Please enter the password for \"%1\" below or click "
 		"Ignore to continue with your current privileges.").arg(m_User);
     setPrompt(prompt);
 
-    setButtonText(User1, i18n("&Ignore"));
+    if( withIgnoreButton )
+	setButtonText(User1, i18n("&Ignore"));
 }
 
 
--- kdebase-3.5.2/kdesu/kdesu/sudlg.h	2005-09-10 04:26:14.000000000 -0400
+++ kdebase-3.5.2-new/kdesu/kdesu/sudlg.h	2006-04-14 16:18:26.000000000 -0400
@@ -15,7 +15,7 @@
     Q_OBJECT
 
 public:
-    KDEsuDialog(QCString user, QCString auth_user, bool enableKeep, const QString& icon );
+    KDEsuDialog(QCString user, QCString auth_user, bool enableKeep, const QString& icon , bool withIgnoreButton=false);
     ~KDEsuDialog();
 
     enum ResultCodes { AsUser = 10 };
--- kdebase-3.5.2/kdesu/kdesud/Makefile.am	2005-09-10 04:26:13.000000000 -0400
+++ kdebase-3.5.2-new/kdesu/kdesud/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -4,10 +4,13 @@
 
 KDE_CXXFLAGS = $(KDE_USE_FPIE)
 
-bin_PROGRAMS = kdesud
-kdesud_SOURCES = kdesud.cpp repo.cpp lexer.cpp handler.cpp secure.cpp 
-kdesud_LDFLAGS = $(KDE_USE_PIE) $(all_libraries) $(KDE_RPATH)
-kdesud_LDADD = $(LIB_KDECORE) -lkdesu $(LIBSOCKET)
+bin_PROGRAMS = 
+lib_LTLIBRARIES = 
+kdeinit_LTLIBRARIES = kdesud.la
+
+kdesud_la_SOURCES = kdesud.cpp repo.cpp lexer.cpp handler.cpp secure.cpp 
+kdesud_la_LDFLAGS = $(KDE_USE_PIE) $(all_libraries) $(KDE_PLUGIN) -module
+kdesud_la_LIBADD = $(LIB_KDECORE) -lkdesu $(LIBSOCKET)
 noinst_HEADERS = repo.h handler.h lexer.h secure.h
 
 ## kdesud needs to be suid or sgid something
--- kdebase-3.5.2/kdesu/kdesud/kdesud.cpp	2005-09-10 04:26:13.000000000 -0400
+++ kdebase-3.5.2-new/kdesu/kdesud/kdesud.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -246,7 +246,7 @@
  * Main program
  */
 
-int main(int argc, char *argv[])
+extern "C" KDE_EXPORT int kdemain(int argc, char *argv[])
 {
     KAboutData aboutData("kdesud", I18N_NOOP("KDE su daemon"),
             Version, I18N_NOOP("Daemon used by kdesu"),
--- kdebase-3.5.2/kdialog/Makefile.am	2005-09-10 04:25:36.000000000 -0400
+++ kdebase-3.5.2-new/kdialog/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -1,11 +1,13 @@
 KDE_CXXFLAGS = -DQT_NO_CAST_ASCII -DQT_NO_ASCII_CAST
 INCLUDES = $(all_includes)
 
-bin_PROGRAMS = kdialog
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kdialog.la
 
-kdialog_SOURCES = kdialog.cpp widgets.cpp klistboxdialog.cpp progressdialog.cpp progressdialogiface.skel
-kdialog_LDADD = $(LIB_KIO)
-kdialog_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+kdialog_la_SOURCES = kdialog.cpp widgets.cpp klistboxdialog.cpp progressdialog.cpp progressdialogiface.skel
+kdialog_la_LIBADD = $(LIB_KIO)
+kdialog_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 METASOURCES = AUTO
 
--- kdebase-3.5.2/kdialog/kdialog.cpp	2005-10-10 11:04:00.000000000 -0400
+++ kdebase-3.5.2-new/kdialog/kdialog.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -52,6 +52,8 @@
 #include <netwm.h>
 #endif
 
+#include <assert.h>
+
 using namespace std;
 
 #if defined(Q_WS_X11)
@@ -105,7 +107,7 @@
 class WinIdEmbedder: public QObject
 {
 public:
-    WinIdEmbedder(bool printID = false, WId winId = 0):
+    WinIdEmbedder(bool printID, WId winId):
         QObject(qApp), print(printID), id(winId)
     {
         if (qApp)
@@ -130,7 +132,8 @@
         if (id)
             XSetTransientForHint(w->x11Display(), w->winId(), id);
 #endif
-        delete this; // delete - set the transient hint only on the first dialog
+        deleteLater(); // WinIdEmbedder is not needed anymore after the first dialog was shown
+        return false;
     }
     return QObject::eventFilter(o, e);
 }
@@ -661,7 +664,7 @@
 }
 
 
-int main(int argc, char *argv[])
+extern "C" KDE_EXPORT int kdemain(int argc, char *argv[])
 {
   KAboutData aboutData( "kdialog", I18N_NOOP("KDialog"),
                         "1.0", I18N_NOOP( "KDialog can be used to show nice dialog boxes from shell scripts" ),
--- kdebase-3.5.2/kdm/kfrontend/kdmconfig.cpp	2005-10-10 11:04:31.000000000 -0400
+++ kdebase-3.5.2-new/kdm/kfrontend/kdmconfig.cpp	2006-04-14 16:18:26.000000000 -0400
@@ -86,11 +86,11 @@
 		aRetFont.setStyleHint( (QFont::StyleHint)sl[2].toUInt() );
 
 		nFontBits = sl[5].toUInt();
-		aRetFont.setItalic( nFontBits & 0x01 != 0 );
-		aRetFont.setUnderline( nFontBits & 0x02 != 0 );
-		aRetFont.setStrikeOut( nFontBits & 0x04 != 0 );
-		aRetFont.setFixedPitch( nFontBits & 0x08 != 0 );
-		aRetFont.setRawMode( nFontBits & 0x20 != 0 );
+		aRetFont.setItalic( (nFontBits & 0x01) != 0 );
+		aRetFont.setUnderline( (nFontBits & 0x02) != 0 );
+		aRetFont.setStrikeOut( (nFontBits & 0x04) != 0 );
+		aRetFont.setFixedPitch( (nFontBits & 0x08) != 0 );
+		aRetFont.setRawMode( (nFontBits & 0x20) != 0 );
 	}
 	aRetFont.setStyleStrategy( (QFont::StyleStrategy)
 	   (QFont::PreferMatch |
--- kdebase-3.5.2/kdm/kfrontend/kgapp.cpp	2005-10-10 11:04:31.000000000 -0400
+++ kdebase-3.5.2-new/kdm/kfrontend/kgapp.cpp	2006-04-14 16:18:26.000000000 -0400
@@ -100,6 +100,7 @@
 		break;
 	case ButtonPress:
 		emit activity();
+		/* fall through */
 	case ButtonRelease:
 		// Hack to let the RMB work as LMB
 		if (ev->xbutton.button == 3)
--- kdebase-3.5.2/kdm/kfrontend/kgverify.cpp	2006-01-19 12:03:15.000000000 -0500
+++ kdebase-3.5.2-new/kdm/kfrontend/kgverify.cpp	2006-04-14 16:18:26.000000000 -0400
@@ -811,8 +811,10 @@
 				return true;
 			}
 		}
+		/* fall through */
 	case QEvent::KeyRelease:
 		updateLockStatus();
+		/* fall through */
 	default:
 		break;
 	}
--- kdebase-3.5.2/kdmlib/dmctl.cpp	2006-01-19 12:01:24.000000000 -0500
+++ kdebase-3.5.2-new/kdmlib/dmctl.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -127,7 +127,8 @@
 	if (fd < 0)
 		goto busted;
 
-	if (::write( fd, cmd, (tl = strlen( cmd )) ) != tl) {
+	tl = strlen( cmd );
+	if (::write( fd, cmd, tl ) != tl) {
 	    bust:
 		::close( fd );
 		fd = -1;
--- kdebase-3.5.2/kfind/Makefile.am	2005-09-10 04:25:00.000000000 -0400
+++ kdebase-3.5.2-new/kfind/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -28,9 +28,12 @@
 
 #And this is for kfind
 
-bin_PROGRAMS = kfind
-kfind_SOURCES = kfwin.cpp kfinddlg.cpp main.cpp 
-kfind_LDADD   =  libkfind_common.la $(LIB_KPARTS)
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kfind.la
+
+kfind_la_SOURCES = kfwin.cpp kfinddlg.cpp main.cpp 
+kfind_la_LIBADD  =  libkfind_common.la $(LIB_KPARTS)
 
 # the library search path.
-kfind_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+kfind_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
--- kdebase-3.5.2/kfind/main.cpp	2005-09-10 04:25:00.000000000 -0400
+++ kdebase-3.5.2-new/kfind/main.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -19,7 +19,7 @@
   KCmdLineLastOption
 };
 
-int main( int argc, char ** argv )
+extern "C" KDE_EXPORT int kdemain( int argc, char ** argv )
 {
   KLocale::setMainCatalogue("kfindpart");
   KAboutData aboutData( "kfind", I18N_NOOP("KFind"),
--- kdebase-3.5.2/khelpcenter/Makefile.am	2005-09-10 04:25:18.000000000 -0400
+++ kdebase-3.5.2-new/khelpcenter/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -3,14 +3,14 @@
 INCLUDES = $(all_includes)
 METASOURCES = AUTO
 
-bin_PROGRAMS = khc_indexbuilder
+bin_PROGRAMS = 
 lib_LTLIBRARIES = 
 
-khc_indexbuilder_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-khc_indexbuilder_LDADD = $(LIB_KDECORE)
-khc_indexbuilder_SOURCES = khc_indexbuilder.cpp
+khc_indexbuilder_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+khc_indexbuilder_la_LIBADD = $(LIB_KDECORE)
+khc_indexbuilder_la_SOURCES = khc_indexbuilder.cpp
 
-kdeinit_LTLIBRARIES = khelpcenter.la
+kdeinit_LTLIBRARIES = khelpcenter.la khc_indexbuilder.la
 
 khelpcenter_la_LDFLAGS = $(all_libraries) -module $(KDE_PLUGIN)
 khelpcenter_la_LIBADD = $(LIB_KHTML)
--- kdebase-3.5.2/khelpcenter/htmlsearch/Makefile.am	2005-09-10 04:25:18.000000000 -0400
+++ kdebase-3.5.2-new/khelpcenter/htmlsearch/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -21,14 +21,15 @@
 
 xdg_apps_DATA = htmlsearch.desktop
 
-bin_PROGRAMS = khtmlindex
+bin_PROGRAMS = 
+kdeinit_LTLIBRARIES = khtmlindex.la
 
 wrapperdir = $(kde_datadir)/khelpcenter/
 wrapper_SCRIPTS = meinproc_wrapper
 
-khtmlindex_SOURCES = index.cpp
-khtmlindex_LDFLAGS = $(KDE_RPATH) $(all_libraries)
-khtmlindex_LDADD = libhtmlsearch.la $(LIB_KDEUI)
+khtmlindex_la_SOURCES = index.cpp
+khtmlindex_la_LDFLAGS = $(KDE_PLUGIN) $(all_libraries) -module
+khtmlindex_la_LIBADD = libhtmlsearch.la $(LIB_KDEUI)
 
 xpm_DATA = unchecked.xpm checked.xpm
 xpmdir = $(kde_datadir)/khelpcenter/pics
--- kdebase-3.5.2/khelpcenter/htmlsearch/index.cpp	2005-09-10 04:25:18.000000000 -0400
+++ kdebase-3.5.2-new/khelpcenter/htmlsearch/index.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -13,7 +13,7 @@
 };
 
 
-int main(int argc, char *argv[])
+extern "C" KDE_EXPORT int kdemain(int argc, char *argv[])
 {
   KAboutData aboutData( "khtmlindex", I18N_NOOP("KHtmlIndex"),
 	"",
--- kdebase-3.5.2/khelpcenter/khc_indexbuilder.cpp	2005-10-10 11:03:57.000000000 -0400
+++ kdebase-3.5.2-new/khelpcenter/khc_indexbuilder.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -163,7 +163,7 @@
   KCmdLineLastOption
 };
 
-int main( int argc, char **argv )
+extern "C" KDE_EXPORT int kdemain( int argc, char **argv )
 {
   KAboutData aboutData( "khc_indexbuilder",
                         I18N_NOOP("KHelpCenter Index Builder"),
--- kdebase-3.5.2/khotkeys/shared/voicesignature.cpp	2006-01-19 12:02:21.000000000 -0500
+++ kdebase-3.5.2-new/khotkeys/shared/voicesignature.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -342,7 +342,7 @@
 {
 	if(s1.isNull() || s2.isNull())
 		return 1000000;
-/*
+#if 0
 	double result=0;
 	for(int x=0;x<WINDOW_NUMBER;x++)
 		for(int y=0;y<FOUR_NUMBER;y++)
@@ -351,7 +351,7 @@
 		result+= d1*d1;//*pond[x][y];
 	}
 	return result;
-*/
+#endif
 	
 	//DTW
 	//  http://tcts.fpms.ac.be/cours/1005-08/speech/projects/2001/delfabro_henry_poitoux/
--- kdebase-3.5.2/kicker/applets/launcher/popularity.cpp	2005-09-10 04:25:31.000000000 -0400
+++ kdebase-3.5.2-new/kicker/applets/launcher/popularity.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -340,7 +340,9 @@
 
 PopularityStatisticsImpl::PopularityStatisticsImpl()
 {
-    static const int rateBaseCount(8);
+    const int rateBaseCount(8);
+
+    m_historyHorizon = 0.0;
     
     for (int n=0; n<rateBaseCount; ++n) 
     {
--- kdebase-3.5.2/kicker/extensions/kasbar/Makefile.am	2005-09-10 04:25:29.000000000 -0400
+++ kdebase-3.5.2-new/kicker/extensions/kasbar/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -35,10 +35,12 @@
 
 EXTRA_DIST = $(lnk_DATA)
 
-bin_PROGRAMS = kasbar
-kasbar_SOURCES = kasbarapp.cpp
-kasbar_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-kasbar_LDADD = 	libkasbar.la \
+bin_PROGRAMS = 
+kdeinit_LTLIBRARIES = kasbar.la
+
+kasbar_la_SOURCES = kasbarapp.cpp
+kasbar_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kasbar_la_LIBADD = 	libkasbar.la \
 		$(LIB_QT) $(LIB_KDECORE) $(LIB_KDEUI)
 
 
--- kdebase-3.5.2/kicker/extensions/kasbar/kasbarapp.cpp	2005-10-10 11:03:59.000000000 -0400
+++ kdebase-3.5.2-new/kicker/extensions/kasbar/kasbarapp.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -73,7 +73,7 @@
    KCmdLineLastOption
 };
 
-int main( int argc, char **argv )
+extern "C" KDE_EXPORT int kdemain( int argc, char **argv )
 {
   KCmdLineArgs::init( argc, argv, "kasbar", "KasBar", I18N_NOOP( "An alternative task manager" ), VERSION_STRING );
   KCmdLineArgs::addCmdLineOptions( options );
--- kdebase-3.5.2/kicker/extensions/kasbar/kasprefsdlg.cpp	2005-10-10 11:03:59.000000000 -0400
+++ kdebase-3.5.2-new/kicker/extensions/kasbar/kasprefsdlg.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -142,11 +142,12 @@
 
    customSize = new QSpinBox( 5, 1000, 1, itemSizeBox );
 
-   customSize->setSuffix( i18n(" Pixels") );
    customSize->setValue( kasbar->itemExtent() );
 
    connect( customSize, SIGNAL( valueChanged( int ) ),
 	    kasbar, SLOT( setItemExtent( int ) ) );
+   connect( customSize, SIGNAL( valueChanged( int ) ),
+	    kasbar, SLOT( customSizeChanged( int ) ) );
 
    int sz = kasbar->itemSize();
    itemSizeCombo->setCurrentItem( sz );
@@ -439,6 +440,11 @@
    (void) new QWidget( advancedPage, "spacer" );
 }
 
+void KasPrefsDialog::customSizeChanged ( int value )
+{
+   customSize->setSuffix( i18n(" pixel", " pixels", value) );
+}
+
 void KasPrefsDialog::accept()
 {
    KConfig *conf = kasbar->config();
--- kdebase-3.5.2/kicker/extensions/kasbar/kasprefsdlg.h	2005-10-10 11:03:59.000000000 -0400
+++ kdebase-3.5.2-new/kicker/extensions/kasbar/kasprefsdlg.h	2006-04-14 16:18:24.000000000 -0400
@@ -97,6 +97,9 @@
    virtual void accept();
    virtual void reject();
 
+private slots:
+   void customSizeChanged ( int value );
+
 private:
 
    QComboBox *itemSizeCombo;
--- kdebase-3.5.2/kicker/kicker/core/containerarea.cpp	2006-03-17 05:17:32.000000000 -0500
+++ kdebase-3.5.2-new/kicker/kicker/core/containerarea.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -99,7 +99,6 @@
     // m_contents.
     m_contents->installEventFilter(this);
 
-    setAcceptDrops( !Kicker::the()->isImmutable() );
     connect(&_autoScrollTimer, SIGNAL(timeout()), SLOT(autoScroll()));
     connect(kapp, SIGNAL(kdisplayPaletteChanged()), SLOT(setBackground()));
     connect(Kicker::the(), SIGNAL(immutabilityChanged(bool)),
@@ -137,6 +136,7 @@
         defaultContainerConfig();
     }
 
+    setAcceptDrops(!isImmutable());
     QTimer::singleShot(0, this, SLOT(resizeContents()));
 }
 
@@ -1496,6 +1496,7 @@
         (*it)->setImmutable(immutable);
     }
 
+    setAcceptDrops(!isImmutable());
     QTimer::singleShot(0, this, SLOT(setBackground()));
 }
 
--- kdebase-3.5.2/kicker/kicker/core/extensionmanager.cpp	2006-03-17 05:17:32.000000000 -0500
+++ kdebase-3.5.2-new/kicker/kicker/core/extensionmanager.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -140,13 +140,13 @@
         QString extensionId(*it);
 
         // create a matching applet container
-        if(!extensionId.contains("Extension") > 0)
+        if (extensionId.find("Extension") == -1)
         {
             continue;
         }
 
         // is there a config group for this extension?
-        if(!config->hasGroup(extensionId))
+        if (!config->hasGroup(extensionId))
         {
             continue;
         }
@@ -259,13 +259,13 @@
     {
         QString extensionId(*it);
 
-        if(!extensionId.contains("Extension") > 0)
+        if (extensionId.find("Extension") == -1)
         {
             continue;
         }
 
         // is there a config group for this extension?
-        if(!config->hasGroup(extensionId))
+        if (!config->hasGroup(extensionId))
         {
             continue;
         }
--- kdebase-3.5.2/kicker/kicker/core/kicker.cpp	2006-03-17 05:17:32.000000000 -0500
+++ kdebase-3.5.2-new/kicker/kicker/core/kicker.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -90,7 +90,7 @@
     }
 
     // Make kicker immutable if configuration modules have been marked immutable
-    if (isImmutable() && kapp->authorizeControlModules(Kicker::configModules(true)).isEmpty())
+    if (isKioskImmutable() && kapp->authorizeControlModules(Kicker::configModules(true)).isEmpty())
     {
         config()->setReadOnly(true);
         config()->reparseConfiguration();
--- kdebase-3.5.2/kicker/kicker/ui/service_mnu.cpp	2006-03-17 05:17:32.000000000 -0500
+++ kdebase-3.5.2-new/kicker/kicker/ui/service_mnu.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -423,7 +423,10 @@
 
 void PanelServiceMenu::slotExec(int id)
 {
-    if (!entryMap_.contains(id)) return;
+    if (!entryMap_.contains(id))
+    {
+        return;
+    }
 
     KSycocaEntry * e = entryMap_[id];
 
@@ -445,7 +448,7 @@
 
 void PanelServiceMenu::mouseReleaseEvent(QMouseEvent * ev)
 {
-    if (ev->button() == RightButton && !Kicker::the()->isImmutable())
+    if (ev->button() == RightButton && !Kicker::the()->isKioskImmutable())
     {
         int id = idAt( ev->pos() );
 
@@ -476,7 +479,7 @@
                 popupMenu_->insertItem(SmallIconSet("desktop"),
                     i18n("Add Item to Desktop"), AddItemToDesktop);
             }
-            if (kapp->authorizeKAction("kicker_rmb"))
+            if (kapp->authorizeKAction("kicker_rmb") && !Kicker::the()->isImmutable())
             {
                 hasEntries = true;
                 popupMenu_->insertItem(SmallIconSet("kicker"),
@@ -503,7 +506,7 @@
                 popupMenu_->insertItem(SmallIconSet("desktop"),
                     i18n("Add Menu to Desktop"), AddMenuToDesktop);
             }
-            if (kapp->authorizeKAction("kicker_rmb"))
+            if (kapp->authorizeKAction("kicker_rmb") && !Kicker::the()->isImmutable())
             {
                 hasEntries = true;
                 popupMenu_->insertItem(SmallIconSet("kicker"),
@@ -612,7 +615,7 @@
 {
     KPanelMenu::mouseMoveEvent(ev);
 
-    if (Kicker::the()->isImmutable())
+    if (Kicker::the()->isKioskImmutable())
         return;
 
     if ( (ev->state() & LeftButton ) != LeftButton )
@@ -738,7 +741,8 @@
 
 void PanelServiceMenu::slotClose()
 {
-    if (clearOnClose_) {
+    if (clearOnClose_)
+    {
         clearOnClose_ = false;
         slotClear();
     }
--- kdebase-3.5.2/kicker/libkicker/kickertip.cpp	2006-03-17 05:17:31.000000000 -0500
+++ kdebase-3.5.2-new/kicker/libkicker/kickertip.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -36,6 +36,9 @@
 #include "kickertip.h"
 #include "kickerSettings.h"
 
+// putting this #include higher results in compile errors
+#include <netwm.h>
+
 static const int DEFAULT_FRAMES_PER_SECOND = 30;
 
 KickerTip* KickerTip::m_self = 0;
@@ -91,6 +94,16 @@
         return;
     }
 
+    {
+        // prevent tips from showing when the active window is fullscreened
+        NETRootInfo ri(qt_xdisplay(), NET::ActiveWindow);
+        NETWinInfo wi(qt_xdisplay(), ri.activeWindow(), ri.rootWindow(), NET::WMState);
+        if (wi.state() & NET::FullScreen)
+        {
+            return;
+        }
+    }
+
     QWidget *widget = const_cast<QWidget*>(m_tippingFor);
     KickerTip::Client *client = dynamic_cast<KickerTip::Client*>(widget);
 
--- kdebase-3.5.2/kicker/libkicker/simplebutton.cpp	2005-10-10 11:03:59.000000000 -0400
+++ kdebase-3.5.2-new/kicker/libkicker/simplebutton.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -62,7 +62,7 @@
     update();
 }
 
-QSize SimpleButton::sizeHint()
+QSize SimpleButton::sizeHint() const
 {
     const QPixmap* pm = pixmap();
 
--- kdebase-3.5.2/kicker/libkicker/simplebutton.h	2005-10-10 11:03:59.000000000 -0400
+++ kdebase-3.5.2-new/kicker/libkicker/simplebutton.h	2006-04-14 16:18:24.000000000 -0400
@@ -34,7 +34,7 @@
         SimpleButton(QWidget *parent, const char *name = 0);
         void setPixmap(const QPixmap &pix);
         void setOrientation(Qt::Orientation orientaton);
-        QSize sizeHint();
+        QSize sizeHint() const;
 
     protected:
         void drawButton( QPainter *p );
--- kdebase-3.5.2/kicker/proxy/appletproxy.cpp	2005-09-10 04:25:26.000000000 -0400
+++ kdebase-3.5.2-new/kicker/proxy/appletproxy.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -270,7 +270,7 @@
 	QDataStream dataStream( data, IO_WriteOnly );
 
 	int actions = 0;
-	if(_applet) actions = _applet->actions();
+	if (_applet) actions = _applet->actions();
 	dataStream << actions;
 
 	int type = 0;
@@ -307,7 +307,10 @@
 
     if (win)
     {
-        _applet->hide();
+        if (_applet)
+        {
+            _applet->hide();
+        }
         QXEmbed::initialize();
         QXEmbed::embedClientIntoWindow(_applet, win);
     }
--- kdebase-3.5.2/kicker/proxy/extensionproxy.cpp	2005-09-10 04:25:26.000000000 -0400
+++ kdebase-3.5.2-new/kicker/proxy/extensionproxy.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -241,7 +241,10 @@
     }
 
     if (win) {
-        _extension->hide();
+        if (_extension)
+        {
+            _extension->hide();
+        }
         QXEmbed::initialize();
         QXEmbed::embedClientIntoWindow( _extension, win );
     }
--- kdebase-3.5.2/kicker/taskbar/taskbar.cpp	2006-03-17 05:17:31.000000000 -0500
+++ kdebase-3.5.2-new/kicker/taskbar/taskbar.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -200,7 +200,7 @@
             maxWidth = BUTTON_MAX_WIDTH;
         }
 
-        int actualMax = maxWidth * (containerCount() / rows);
+        int actualMax = maxWidth * ( ( containerCount() != 0 ? containerCount() : 1 ) / rows);
 
         if (containerCount() % rows > 0)
         {
--- kdebase-3.5.2/kicker/taskbar/taskcontainer.cpp	2006-03-17 05:17:31.000000000 -0500
+++ kdebase-3.5.2-new/kicker/taskbar/taskcontainer.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -1499,10 +1499,10 @@
         pixmap = t->thumbnail(TaskBarSettings::thumbnailMaxDimension());
     }
 
-    if (pixmap.isNull())
+    if (pixmap.isNull() && tasks.last())
     {
         // try to load icon via net_wm
-        pixmap = KWin::icon(tasks.first()->window(),
+        pixmap = KWin::icon(tasks.last()->window(),
                             KIcon::SizeMedium,
                             KIcon::SizeMedium,
                             true);
--- kdebase-3.5.2/kioslave/info/kde-info2html.conf	2005-09-10 04:25:37.000000000 -0400
+++ kdebase-3.5.2-new/kioslave/info/kde-info2html.conf	2006-04-14 16:18:19.000000000 -0400
@@ -25,6 +25,7 @@
 
 #-- location of info files.
 our @INFODIR = (
+	    "@FINKPREFIX@/share/info",
 	    "/usr/share/info",
 	    "/usr/info",
 	    "/usr/lib/info",
--- kdebase-3.5.2/kioslave/ldap/configure.in.in	2005-10-10 11:04:01.000000000 -0400
+++ kdebase-3.5.2-new/kioslave/ldap/configure.in.in	2006-04-14 16:18:19.000000000 -0400
@@ -38,10 +38,11 @@
 case "$with_ldap" in
 no) AC_MSG_RESULT(no) ;;
 framework)
-  LDAP_LIBS="-Xlinker -framework -Xlinker LDAP"
+  LDAP_LIBS="-Wl,-framework,LDAP"
   AC_DEFINE_UNQUOTED(HAVE_LIBLDAP, 1, [Define if you have LDAP libraries])
   LDAP_SUBDIR="ldap"
   AC_MSG_RESULT(Apple framework)
+  with_ldap=FOUND
   ;;
 FOUND)
   AC_MSG_RESULT(incs=$ldap_incdir libs=$ldap_libdir)
--- kdebase-3.5.2/kioslave/man/kio_man.cpp	2005-10-10 11:04:01.000000000 -0400
+++ kdebase-3.5.2-new/kioslave/man/kio_man.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -50,7 +50,7 @@
 
 MANProtocol *MANProtocol::_self = 0;
 
-#define SGML2ROFF_DIRS "/usr/lib/sgml"
+#define SGML2ROFF_DIRS "@FINKPREFIX@/share/sgml"
 
 /*
  * Drop trailing ".section[.gz]" from name
@@ -883,6 +883,7 @@
 
     // Default paths
     static const char *manpaths[] = {
+        "@FINKPREFIX@/share/man",
         "/usr/X11/man",
         "/usr/X11R6/man",
         "/usr/man",
--- kdebase-3.5.2/kioslave/media/kcmodule/notifiermodule.cpp	2005-10-10 11:04:00.000000000 -0400
+++ kdebase-3.5.2-new/kioslave/media/kcmodule/notifiermodule.cpp	2006-04-14 16:18:24.000000000 -0400
@@ -175,7 +175,7 @@
 		= static_cast<ActionListBoxItem*>(m_view->actionsList->selectedItem());
 	
 	NotifierServiceAction * action;
-	if ( action = dynamic_cast<NotifierServiceAction*>( action_item->action() ) )
+	if ( (action = dynamic_cast<NotifierServiceAction*>( action_item->action() ) ) )
 	{
 		ServiceConfigDialog dialog(action, m_settings.supportedMimetypes(), this);
 		
@@ -195,7 +195,7 @@
 		= static_cast<ActionListBoxItem*>(m_view->actionsList->selectedItem());
 	
 	NotifierServiceAction *action;
-	if ( action = dynamic_cast<NotifierServiceAction*>( action_item->action() ) )
+	if ( (action = dynamic_cast<NotifierServiceAction*>( action_item->action() )) )
 	{
 		m_settings.deleteAction( action );
 		updateListBox();
--- kdebase-3.5.2/kioslave/media/mediamanager/fstabbackend.cpp	2006-03-17 05:17:33.000000000 -0500
+++ kdebase-3.5.2-new/kioslave/media/mediamanager/fstabbackend.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -144,7 +144,7 @@
 
 void FstabBackend::handleMtabChange(bool allowNotification)
 {
-	QStringList new_mtabIds;
+	QStringList new_mtabIds, new_mtabEntries;
 	KMountPoint::List mtab = KMountPoint::currentMountPoints();
 
 	KMountPoint::List::iterator it = mtab.begin();
@@ -158,6 +158,14 @@
 
 		if ( ::inExclusionPattern(*it, m_networkSharesOnly) ) continue;
 
+		/* Did we know this already before ? If yes, then
+		   nothing has changed, do not stat the mount point. Avoids
+		   hang if network shares are stalling */
+		QString mtabEntry = dev + "*" + mp + "*" + fs;
+		bool isOldEntry = m_mtabEntries.contains(mtabEntry);
+		new_mtabEntries+=mtabEntry;
+		if (isOldEntry) continue;
+
 		QString id = generateId(dev, mp);
 		new_mtabIds+=id;
 
@@ -218,6 +226,7 @@
 	}
 
 	m_mtabIds = new_mtabIds;
+        m_mtabEntries = new_mtabEntries;
 }
 
 void FstabBackend::handleFstabChange(bool allowNotification)
--- kdebase-3.5.2/kioslave/media/mediamanager/fstabbackend.h	2005-10-10 11:04:01.000000000 -0400
+++ kdebase-3.5.2-new/kioslave/media/mediamanager/fstabbackend.h	2006-04-14 16:18:25.000000000 -0400
@@ -53,6 +53,7 @@
 
 	bool m_networkSharesOnly;
 	QStringList m_mtabIds;
+        QStringList m_mtabEntries;
 	QStringList m_fstabIds;
 #ifdef Q_OS_FREEBSD
 	QTimer m_mtabTimer;
--- kdebase-3.5.2/kioslave/media/mounthelper/Makefile.am	2005-09-10 04:25:36.000000000 -0400
+++ kdebase-3.5.2-new/kioslave/media/mounthelper/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -1,12 +1,14 @@
-bin_PROGRAMS = kio_media_mounthelper
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kio_media_mounthelper.la
 
 INCLUDES = -I$(srcdir)/../libmediacommon $(all_includes)
 AM_LDFLAGS = $(all_libraries)
 
-kio_media_mounthelper_SOURCES = kio_media_mounthelper.cpp
+kio_media_mounthelper_la_SOURCES = kio_media_mounthelper.cpp
 
-kio_media_mounthelper_LDFLAGS = $(KDE_RPATH) $(all_libraries)
-kio_media_mounthelper_LDADD = $(LIB_KIO) ../libmediacommon/libmediacommon.la
+kio_media_mounthelper_la_LDFLAGS = $(KDE_RPATH) $(all_libraries) -module
+kio_media_mounthelper_la_LIBADD = $(LIB_KIO) ../libmediacommon/libmediacommon.la
 
 METASOURCES = AUTO
 
--- kdebase-3.5.2/kioslave/media/mounthelper/kio_media_mounthelper.cpp	2006-03-17 05:17:33.000000000 -0500
+++ kdebase-3.5.2-new/kioslave/media/mounthelper/kio_media_mounthelper.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -192,7 +192,7 @@
 };
 
 
-int main(int argc, char **argv)
+extern "C" KDE_EXPORT int kdemain(int argc, char **argv)
 {
 	KCmdLineArgs::init(argc, argv, "kio_media_mounthelper",
 	                   "kio_media_mounthelper", "kio_media_mounthelper",
--- kdebase-3.5.2/kioslave/nfs/mount.h	2005-09-10 04:25:37.000000000 -0400
+++ kdebase-3.5.2-new/kioslave/nfs/mount.h	2006-04-14 16:18:19.000000000 -0400
@@ -8,6 +8,22 @@
 
 #include <rpc/rpc.h>
 
+#if !defined(IXDR_GET_INT32)
+#define IXDR_GET_INT32(buf)             ((int32_t)ntohl((u_int32_t)*(buf)++))
+#endif
+
+#if !defined(IXDR_PUT_INT32)
+#define IXDR_PUT_INT32(buf, v)          (*(buf)++ =(int32_t)htonl((u_int32_t)v))
+#endif
+
+#if !defined(IXDR_GET_U_INT32) && defined(IXDR_GET_INT32)
+#define IXDR_GET_U_INT32(buf)           ((u_int32_t)IXDR_GET_INT32(buf))
+#endif
+
+#if !defined(IXDR_PUT_U_INT32) && defined(IXDR_PUT_INT32)
+#define IXDR_PUT_U_INT32(buf, v)        IXDR_PUT_INT32((buf), ((int32_t)(v)))
+#endif
+
 /*
  * Sun RPC is a product of Sun Microsystems, Inc. and is provided for
  * unrestricted use provided that this legend is included on all tape
--- kdebase-3.5.2/kioslave/trash/Makefile.am	2005-09-10 04:25:37.000000000 -0400
+++ kdebase-3.5.2-new/kioslave/trash/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -9,10 +9,13 @@
 kio_trash_la_LIBADD  = libtrashcommon.la $(LIB_KIO)
 kio_trash_la_LDFLAGS = $(all_libraries) -module $(KDE_PLUGIN) -no-undefined
 
-bin_PROGRAMS = ktrash
-ktrash_SOURCES = ktrash.cpp
-ktrash_LDADD = $(LIB_KIO)
-ktrash_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = ktrash.la
+
+ktrash_la_SOURCES = ktrash.cpp
+ktrash_la_LIBADD = $(LIB_KIO)
+ktrash_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 kde_services_DATA = trash.protocol
 
--- kdebase-3.5.2/kioslave/trash/ktrash.cpp	2005-10-10 11:04:01.000000000 -0400
+++ kdebase-3.5.2-new/kioslave/trash/ktrash.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -35,7 +35,7 @@
     KCmdLineLastOption
 };
 
-int main(int argc, char *argv[])
+extern "C" KDE_EXPORT int kdemain(int argc, char *argv[])
 {
     KApplication::disableAutoDcopRegistration();
     KCmdLineArgs::init( argc, argv, "ktrash",
--- kdebase-3.5.2/kioslave/trash/trashimpl.cpp	2005-10-10 11:04:01.000000000 -0400
+++ kdebase-3.5.2-new/kioslave/trash/trashimpl.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -768,7 +768,7 @@
         if ( (buff.st_uid == 0) // must be owned by root
              && (S_ISDIR(buff.st_mode)) // must be a dir
              && (!S_ISLNK(buff.st_mode)) // not a symlink
-             && (buff.st_mode & requiredBits == requiredBits)
+             && ((buff.st_mode & requiredBits) == requiredBits)
             ) {
             const QString trashDir = rootTrashDir + "/" + QString::number( uid );
             const QCString trashDir_c = QFile::encodeName( trashDir );
--- kdebase-3.5.2/knetattach/Makefile.am	2005-09-10 04:25:49.000000000 -0400
+++ kdebase-3.5.2-new/knetattach/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -1,9 +1,12 @@
 INCLUDES= $(all_includes)
 
-bin_PROGRAMS = knetattach
-knetattach_SOURCES = knetattach.ui main.cpp
-knetattach_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-knetattach_LDADD   = $(LIB_KIO)
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = knetattach.la
+
+knetattach_la_SOURCES = knetattach.ui main.cpp
+knetattach_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+knetattach_la_LIBADD  = $(LIB_KIO)
 METASOURCES = AUTO
 xdg_apps_DATA = knetattach.desktop
 KDE_ICON = AUTO
--- kdebase-3.5.2/knetattach/main.cpp	2005-10-10 11:04:20.000000000 -0400
+++ kdebase-3.5.2-new/knetattach/main.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -25,7 +25,7 @@
 
 #include "knetattach.h"
 
-int main(int argc, char **argv) {
+extern "C" KDE_EXPORT int kdemain(int argc, char **argv) {
 	KAboutData about("knetattach", I18N_NOOP("KDE Network Wizard"), "1.0",
 		I18N_NOOP("KDE Network Wizard"),
 		KAboutData::License_GPL,
--- kdebase-3.5.2/konqueror/client/kfmclient.cc	2006-01-19 12:02:07.000000000 -0500
+++ kdebase-3.5.2-new/konqueror/client/kfmclient.cc	2006-04-14 16:18:25.000000000 -0400
@@ -56,7 +56,7 @@
 static const char version[] = "2.0";
 
 QCString clientApp::startup_id_str;
-bool clientApp::m_ok;
+bool clientApp::m_ok = true;
 bool s_interactive = true;
 
 static const KCmdLineOptions options[] =
@@ -322,7 +322,7 @@
             QObject::connect( run, SIGNAL( finished() ), &app, SLOT( delayedQuit() ));
             QObject::connect( run, SIGNAL( error() ), &app, SLOT( delayedQuit() ));
             app.exec();
-            return m_ok;
+            return !run->hasError();
         }
     }
 
@@ -498,6 +498,7 @@
     checkArgumentCount(argc, 2, 2);
     KPropertiesDialog * p = new KPropertiesDialog( args->url(1) );
     QObject::connect( p, SIGNAL( destroyed() ), &app, SLOT( quit() ));
+    QObject::connect( p, SIGNAL( canceled() ), &app, SLOT( slotDialogCanceled() ));
     app.exec();
     return m_ok;
   }
@@ -515,7 +516,7 @@
       QObject::connect( run, SIGNAL( finished() ), &app, SLOT( delayedQuit() ));
       QObject::connect( run, SIGNAL( error() ), &app, SLOT( delayedQuit() ));
       app.exec();
-      return m_ok;
+      return !run->hasError();
     }
     else if ( argc == 3 )
     {
@@ -628,4 +629,10 @@
   quit();
 }
 
+void clientApp::slotDialogCanceled()
+{
+    m_ok = false;
+    quit();
+}
+
 #include "kfmclient.moc"
--- kdebase-3.5.2/konqueror/client/kfmclient.h	2006-01-19 12:02:07.000000000 -0500
+++ kdebase-3.5.2-new/konqueror/client/kfmclient.h	2006-04-14 16:18:25.000000000 -0400
@@ -39,6 +39,7 @@
 protected slots:
   void slotResult( KIO::Job * );
   void delayedQuit();
+  void slotDialogCanceled();
 
 private:
   static void sendASNChange();
--- kdebase-3.5.2/konqueror/keditbookmarks/Makefile.am	2005-09-10 04:25:49.000000000 -0400
+++ kdebase-3.5.2-new/konqueror/keditbookmarks/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -2,13 +2,13 @@
 
 METASOURCES = AUTO
 
-bin_PROGRAMS = kbookmarkmerger
+bin_PROGRAMS = 
 lib_LTLIBRARIES =
-kdeinit_LTLIBRARIES = keditbookmarks.la
+kdeinit_LTLIBRARIES = keditbookmarks.la kbookmarkmerger.la
 
-kbookmarkmerger_SOURCES = kbookmarkmerger.cpp
-kbookmarkmerger_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-kbookmarkmerger_LDADD = $(LIB_KIO)
+kbookmarkmerger_la_SOURCES = kbookmarkmerger.cpp
+kbookmarkmerger_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kbookmarkmerger_la_LIBADD = $(LIB_KIO)
 
 dcop_DCOPIDLNG = true
 keditbookmarks_la_SOURCES = main.cpp listview.cpp toplevel.cpp actionsimpl.cpp commands.cpp importers.cpp dcop.skel dcop.cpp bookmarkiterator.cpp  \
--- kdebase-3.5.2/konqueror/keditbookmarks/actionsimpl.cpp	2006-01-19 12:02:09.000000000 -0500
+++ kdebase-3.5.2-new/konqueror/keditbookmarks/actionsimpl.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -145,6 +145,9 @@
         i18n("Show in T&oolbar"), "bookmark_toolbar", 0,
         actn, SLOT( slotShowInToolbar() ), actionCollection(), "showintoolbar");
     (void) new KAction(
+        i18n("Hide in T&oolbar"), "bookmark_toolbar", 0,
+        actn, SLOT( slotHideInToolbar() ), actionCollection(), "hideintoolbar");
+    (void) new KAction(
         i18n("&Expand All Folders"), 0,
         actn, SLOT( slotExpandAll() ), actionCollection(), "expandall");
     (void) new KAction(
@@ -228,7 +231,8 @@
 }
 
 void CurrentMgr::doExport(ExportType type, const QString & _path) {
-    KEBApp::self()->bkInfo()->commitChanges();
+    if(KEBApp::self())
+        KEBApp::self()->bkInfo()->commitChanges();
     QString path(_path);
     // TODO - add a factory and make all this use the base class
     if (type == OperaExport) {
@@ -292,8 +296,10 @@
         if( sa.multiSelect || (sa.singleSelect && !sa.root && (sa.group || !sa.urlIsEmpty) && !sa.separator))
             toEnable << "testlink" << "updatefavicon";
 
-        if( sa.itemSelected)
-            toEnable << "showintoolbar";
+        if(sa.multiSelect)
+            toEnable << "showintoolbar" << "hideintoolbar";
+        else if(sa.itemSelected)
+            toEnable << (sa.tbShowState ? "hideintoolbar" : "showintoolbar");
 
         if (sa.singleSelect && !sa.root && !sa.separator) {
             toEnable << "rename" << "changeicon" << "changecomment";
@@ -308,9 +314,6 @@
         }
     }
 
-    QString stbString = sa.tbShowState ? i18n("Hide in T&oolbar") : i18n("Show in T&oolbar");
-    coll->action("showintoolbar")->setText(stbString);
-
     for ( QStringList::Iterator it = toEnable.begin();
             it != toEnable.end(); ++it )
     {
@@ -598,9 +601,15 @@
 
 void ActionsImpl::slotShowInToolbar() {
     KEBApp::self()->bkInfo()->commitChanges();
-    KBookmark bk = ListView::self()->firstSelected()->bookmark();
-    bool shown = CmdGen::shownInToolbar(bk);
-    KEBMacroCommand *mcmd = CmdGen::setShownInToolbar(bk, !shown);
+    QValueList<KBookmark> bks = ListView::self()->itemsToBookmarks(ListView::self()->selectedItemsMap());
+    KEBMacroCommand *mcmd = CmdGen::setShownInToolbar(bks, true);
+    CmdHistory::self()->addCommand(mcmd);
+}
+
+void ActionsImpl::slotHideInToolbar() {
+    KEBApp::self()->bkInfo()->commitChanges();
+    QValueList<KBookmark> bks = ListView::self()->itemsToBookmarks(ListView::self()->selectedItemsMap());
+    KEBMacroCommand *mcmd = CmdGen::setShownInToolbar(bks, false);
     CmdHistory::self()->addCommand(mcmd);
 }
 
--- kdebase-3.5.2/konqueror/keditbookmarks/actionsimpl.h	2005-10-10 11:04:20.000000000 -0400
+++ kdebase-3.5.2-new/konqueror/keditbookmarks/actionsimpl.h	2006-04-14 16:18:25.000000000 -0400
@@ -48,6 +48,7 @@
    void slotSort();
    void slotSetAsToolbar();
    void slotShowInToolbar();
+   void slotHideInToolbar();
    void slotOpenLink();
    void slotShowNS();
    void slotTestSelection();
--- kdebase-3.5.2/konqueror/keditbookmarks/commands.cpp	2006-01-19 12:02:09.000000000 -0500
+++ kdebase-3.5.2-new/konqueror/keditbookmarks/commands.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -619,16 +619,20 @@
     return (bk.internalElement().attribute("showintoolbar") == "yes");
 }
 
-KEBMacroCommand* CmdGen::setShownInToolbar(const KBookmark &bk, bool show) {
+KEBMacroCommand* CmdGen::setShownInToolbar(const QValueList<KBookmark> &bks, bool show) {
     QString i18n_name = i18n("%1 in Bookmark Toolbar").arg(show ? i18n("Show") 
             : i18n("Hide"));
     KEBMacroCommand *mcmd = new KEBMacroCommand(i18n_name);
 
-    QValueList<EditCommand::Edition> lst;
-    lst.append(EditCommand::Edition("showintoolbar", show ? "yes" : "no"));
-    EditCommand *cmd2 = new EditCommand(bk.address(), lst);
-    mcmd->addCommand(cmd2);
-
+    QValueList<KBookmark>::ConstIterator it, end;
+    end = bks.end();
+    for(it = bks.begin(); it != end; ++it)
+    {
+        QValueList<EditCommand::Edition> lst;
+        lst.append(EditCommand::Edition("showintoolbar", show ? "yes" : "no"));
+        EditCommand *cmd = new EditCommand((*it).address(), lst);
+        mcmd->addCommand(cmd);
+    }
     return mcmd;
 }
 
@@ -696,7 +700,7 @@
     return mcmd;
 }
 
-KEBMacroCommand* CmdGen::itemsMoved(const QMap<KEBListViewItem *, bool> & items, 
+KEBMacroCommand* CmdGen::itemsMoved(const QValueVector<KEBListViewItem *> & items, 
         const QString &newAddress, bool copy) {
     KEBMacroCommand *mcmd = new KEBMacroCommand(copy ? i18n("Copy Items") 
             : i18n("Move Items"));
--- kdebase-3.5.2/konqueror/keditbookmarks/commands.h	2005-10-10 11:04:20.000000000 -0400
+++ kdebase-3.5.2-new/konqueror/keditbookmarks/commands.h	2006-04-14 16:18:25.000000000 -0400
@@ -23,6 +23,7 @@
 
 #include <kcommand.h>
 #include <kbookmark.h>
+#include <qvaluevector.h>
 
 // Interface adds the affectedBookmarks method
 // Any class should on call add those bookmarks which are 
@@ -243,11 +244,11 @@
 class CmdGen {
 public:
    static KEBMacroCommand* setAsToolbar(const KBookmark &bk);
-   static KEBMacroCommand* setShownInToolbar(const KBookmark &bk, bool show);
+   static KEBMacroCommand* setShownInToolbar(const QValueList<KBookmark> &bk, bool show);
    static bool shownInToolbar(const KBookmark &bk);
-   static KEBMacroCommand* deleteItems(const QString &commandName, const QMap<KEBListViewItem *, bool> & items);
+   static KEBMacroCommand* deleteItems(const QString &commandName, const QValueVector<KEBListViewItem *> & items);
    static KEBMacroCommand* insertMimeSource(const QString &cmdName, QMimeSource *data, const QString &addr);
-   static KEBMacroCommand* itemsMoved(const QMap<KEBListViewItem *, bool> & items, const QString &newAddress, bool copy);
+   static KEBMacroCommand* itemsMoved(const QValueVector<KEBListViewItem *> & items, const QString &newAddress, bool copy);
 private:
    CmdGen() { ; }
 };
--- kdebase-3.5.2/konqueror/keditbookmarks/kbookmarkmerger.cpp	2005-09-10 04:25:49.000000000 -0400
+++ kdebase-3.5.2-new/konqueror/keditbookmarks/kbookmarkmerger.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -55,7 +55,7 @@
 	return XGetSelectionOwner( dpy, atom ) != None;
 }
 
-int main( int argc, char**argv )
+extern "C" KDE_EXPORT int kdemain( int argc, char**argv )
 {
 	const bool kdeRunning = kdeIsRunning();
 
--- kdebase-3.5.2/konqueror/keditbookmarks/kebsearchline.cpp	2005-10-10 11:04:20.000000000 -0400
+++ kdebase-3.5.2-new/konqueror/keditbookmarks/kebsearchline.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -17,6 +17,7 @@
 */
 
 #include "kebsearchline.h"
+#include "kebsearchline.moc"
 
 KEBSearchLine::KEBSearchLine(QWidget *parent, KListView *listView, const char *name)
     : KListViewSearchLine(parent, listView, name)
@@ -30,6 +31,12 @@
     mmode = AND;
 }
 
+void KEBSearchLine::updateSearch(const QString &s)
+{
+    KListViewSearchLine::updateSearch(s);
+    emit searchUpdated();
+}
+
 KEBSearchLine::~KEBSearchLine()
 {
 }
--- kdebase-3.5.2/konqueror/keditbookmarks/kebsearchline.h	2005-10-10 11:04:20.000000000 -0400
+++ kdebase-3.5.2-new/konqueror/keditbookmarks/kebsearchline.h	2006-04-14 16:18:25.000000000 -0400
@@ -20,10 +20,11 @@
 #define __kebsearchline_h
 
 #include <klistviewsearchline.h>
-
+#include <qobject.h>
 
 class KEBSearchLine : public KListViewSearchLine
 {
+    Q_OBJECT
 public:
     KEBSearchLine(QWidget *parent = 0, KListView *listView = 0, const char *name = 0);
 
@@ -34,6 +35,10 @@
     enum modes { EXACTLY, AND, OR } mmode;
     modes mode();
     void setMode(modes m);
+    virtual void updateSearch(const QString &s = QString::null);
+
+signals:
+    void searchUpdated();
 
 protected:
 
--- kdebase-3.5.2/konqueror/keditbookmarks/keditbookmarksui.rc	2006-01-19 12:02:09.000000000 -0500
+++ kdebase-3.5.2-new/konqueror/keditbookmarks/keditbookmarksui.rc	2006-04-14 16:18:25.000000000 -0400
@@ -1,5 +1,5 @@
 <!DOCTYPE kpartgui SYSTEM "kpartgui.dtd">
-<kpartgui name="keditbookmarks" version="29">
+<kpartgui name="keditbookmarks" version="30">
 
 <MenuBar>
 
@@ -43,6 +43,7 @@
   <Action name="changeicon"/>
   <Separator/>
   <Action name="showintoolbar"/>
+  <Action name="hideintoolbar"/>
 </Menu>
 
 <Menu name="view"><text>&amp;View</text>
@@ -97,6 +98,7 @@
   <!-- Stuff for folders -->
   <Action name="setastoolbar"/>
   <Action name="showintoolbar"/>
+  <Action name="hideintoolbar"/>
   <Action name="sort"/>
   <Action name="recursivesort"/>
    <Separator/>
@@ -123,6 +125,7 @@
 <Menu name="popup_bookmark">
   <!-- Stuff for bookmarks -->
   <Action name="showintoolbar"/>
+  <Action name="hideintoolbar"/>
   <Action name="openlink"/>
   <Action name="testlink"/>
   <Action name="updatefavicon"/>
@@ -200,6 +203,7 @@
     <Action name="rename"/>
     <Action name="setastoolbar"/>
     <Action name="showintoolbar"/>
+    <Action name="hideintoolbar"/>
     <Action name="sort"/>
     <Action name="recursivesort"/>
     <Action name="testall"/>
--- kdebase-3.5.2/konqueror/keditbookmarks/listview.cpp	2005-10-10 11:04:20.000000000 -0400
+++ kdebase-3.5.2-new/konqueror/keditbookmarks/listview.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -33,7 +33,7 @@
 #include <qpopupmenu.h>
 #include <qpainter.h>
 #include <qheader.h>
-#include <qvaluevector.h>
+
 
 #include <klocale.h>
 #include <dcopclient.h>
@@ -144,15 +144,15 @@
 
 
 
-QValueList<KBookmark> ListView::itemsToBookmarks(const QMap<KEBListViewItem *, bool> & items) const
+QValueList<KBookmark> ListView::itemsToBookmarks(const QValueVector<KEBListViewItem *> & items) const
 {
     QValueList<KBookmark> bookmarks; //TODO optimize by using a QValueVector
-    QMap<KEBListViewItem *, bool>::const_iterator it = items.begin();
-    QMap<KEBListViewItem *, bool>::const_iterator end = items.end();
+    QValueVector<KEBListViewItem *>::const_iterator it = items.constBegin();
+    QValueVector<KEBListViewItem *>::const_iterator end = items.constEnd();
     for( ; it!=end; ++it)
     {
-        if(it.key() != m_listView->rootItem() )
-            bookmarks.push_back( it.key()->bookmark() );
+        if(*it != m_listView->rootItem() )
+            bookmarks.push_back( (*it)->bookmark() );
     }
     qHeapSort(bookmarks);
     return bookmarks;
@@ -223,7 +223,8 @@
 
     KEBApp::self()->updateActions();
 
-    if (mSelectedItems.count() != 1)
+    const QValueVector<KEBListViewItem *> & selected = selectedItemsMap();
+    if (selected.count() != 1)
     {
         KEBApp::self()->bkInfo()->showBookmark(KBookmark());
         return;
@@ -235,16 +236,33 @@
         KEBApp::self()->bkInfo()->setConnected(true);
     }
 
-    KEBApp::self()->bkInfo()->showBookmark(firstSelected()->bookmark());
+    KEBApp::self()->bkInfo()->showBookmark((*(selected.constBegin()))->bookmark());
     firstSelected()->modUpdate();
 }
 
+QValueVector<KEBListViewItem *> ListView::selectedItemsMap() const
+{
+    QValueVector<KEBListViewItem *> selected;
+    QMap<KEBListViewItem *, bool>::ConstIterator it, end;
+    end = mSelectedItems.constEnd();
+    for(it = mSelectedItems.constBegin(); it != end; ++it)
+    {
+        if( it.key()->isVisible())
+            selected.push_back(it.key());
+    }
+    return selected;
+}
+
 KEBListViewItem * ListView::firstSelected() const
 {
     if(mSelectedItems.isEmpty())
         return 0L;
+
+    QValueVector<KEBListViewItem *> selected = selectedItemsMap(); 
+    if(selected.isEmpty())
+        return 0L;
     else
-        return mSelectedItems.begin().key();
+        return *(selected.constBegin());
 }
 
 void ListView::deselectAllChildren(KEBListViewItem *item) 
@@ -283,6 +301,8 @@
             continue;
         if(it.current() == m_listView->firstChild()) // root case
             continue;
+        if(!it.current()->isVisible()) // skip over filtered bookmarks
+            continue;
         if (it.current()->childCount() == 0) // non folder case
             bookmarks.append(static_cast<KEBListViewItem *>(it.current())->bookmark());
         else
@@ -297,10 +317,13 @@
     KEBListViewItem* child = static_cast<KEBListViewItem *>(item->firstChild());
     while( child )
     {
-        if (!child->isEmptyFolderPadder() && (child->childCount() == 0))
-            bookmarks.append(child->bookmark());
-        if(child->childCount())
-            selectedBookmarksExpandedHelper(child, bookmarks);
+        if(child->isVisible())
+        {
+            if (!child->isEmptyFolderPadder() && (child->childCount() == 0))
+                bookmarks.append(child->bookmark());
+            if(child->childCount())
+                selectedBookmarksExpandedHelper(child, bookmarks);
+        }
         child = static_cast<KEBListViewItem *>(child->nextSibling());
     }
 }
@@ -360,16 +383,22 @@
 SelcAbilities ListView::getSelectionAbilities() const {
     SelcAbilities sa = { false, false, false, false, false, false, false, false, false };
 
-    if (mSelectedItems.count() > 0) {
-        KBookmark nbk = firstSelected()->bookmark();
-        sa.itemSelected   = true;
-        sa.group          = nbk.isGroup();
-        sa.separator      = nbk.isSeparator();
-        sa.urlIsEmpty     = nbk.url().isEmpty();
-        sa.root           = (firstSelected() == m_listView->rootItem());
-        sa.multiSelect    = (mSelectedItems.count() > 1);
-        sa.singleSelect   = (!sa.multiSelect && sa.itemSelected);
-        sa.tbShowState    = CmdGen::shownInToolbar(nbk);
+    if (mSelectedItems.count() > 0) 
+    {
+        QValueVector<KEBListViewItem *> selected = selectedItemsMap();
+        if(!selected.isEmpty())
+        {
+            //Optimize
+            KBookmark nbk = (*(selected.constBegin()))->bookmark();
+            sa.itemSelected   = true;
+            sa.group          = nbk.isGroup();
+            sa.separator      = nbk.isSeparator();
+            sa.urlIsEmpty     = nbk.url().isEmpty();
+            sa.root           = (*(selected.constBegin()) == m_listView->rootItem());
+            sa.multiSelect    = (selected.count() > 1);
+            sa.singleSelect   = (!sa.multiSelect && sa.itemSelected);
+            sa.tbShowState    = CmdGen::shownInToolbar(nbk);
+        }
     }
 
     sa.notEmpty = (m_listView->rootItem()->childCount() > 0);
@@ -397,10 +426,11 @@
         mcmd = CmdGen::insertMimeSource(i18n("Drop Items"), e, newAddress);
 
     } else {
-        if (!(mSelectedItems.count() > 0) || (firstSelected() == itemAfterQLVI))
+        const QValueVector<KEBListViewItem *> & selected = selectedItemsMap();
+        if (!(selected.count() > 0) || (*(selected.constBegin()) == itemAfterQLVI))
             return;
         bool copy = (e->action() == QDropEvent::Copy);
-        mcmd = CmdGen::itemsMoved(selectedItemsMap(), newAddress, copy);
+        mcmd = CmdGen::itemsMoved(selected, newAddress, copy);
     }
 
     CmdHistory::self()->didCommand(mcmd);
--- kdebase-3.5.2/konqueror/keditbookmarks/listview.h	2005-10-10 11:04:20.000000000 -0400
+++ kdebase-3.5.2-new/konqueror/keditbookmarks/listview.h	2006-04-14 16:18:25.000000000 -0400
@@ -24,6 +24,7 @@
 
 #include <qlistview.h>
 #include <qmap.h>
+#include <qvaluevector.h>
 
 #include <klocale.h>
 #include <kbookmark.h>
@@ -142,14 +143,14 @@
    void invalidate(const QString & address);
    void invalidate(QListViewItem * item);
    void fixUpCurrent(const QString & address);
-   
+
    KEBListViewItem * firstSelected() const;
-   QMap<KEBListViewItem *, bool> selectedItemsMap() const
-   { return mSelectedItems; }
+   QValueVector<KEBListViewItem *> selectedItemsMap() const;
+
    QValueList<QString> selectedAddresses();
 
    // bookmark helpers
-   QValueList<KBookmark> itemsToBookmarks(const QMap<KEBListViewItem *, bool> & items) const;
+   QValueList<KBookmark> itemsToBookmarks(const QValueVector<KEBListViewItem *> & items) const;
 
    // bookmark stuff
    QValueList<KBookmark> allBookmarks() const;
--- kdebase-3.5.2/konqueror/keditbookmarks/toplevel.cpp	2005-10-10 11:04:20.000000000 -0400
+++ kdebase-3.5.2-new/konqueror/keditbookmarks/toplevel.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -222,6 +222,7 @@
     quicksearch->setStretchableWidget(searchLineEdit);
     lbl->setBuddy(searchLineEdit);
     connect(resetQuickSearch, SIGNAL(activated()), searchLineEdit, SLOT(clear()));
+    connect(searchLineEdit, SIGNAL(searchUpdated()), SLOT(updateActions()));
 
     ListView::createListViews(vsplitter);
     ListView::self()->initListViews();
--- kdebase-3.5.2/konqueror/keditbookmarks/toplevel.h	2005-10-10 11:04:20.000000000 -0400
+++ kdebase-3.5.2-new/konqueror/keditbookmarks/toplevel.h	2006-04-14 16:18:25.000000000 -0400
@@ -116,7 +116,6 @@
     KEBApp(const QString & bookmarksFile, bool readonly, const QString &address, bool browser, const QString &caption);
     virtual ~KEBApp();
 
-    void updateActions();
     void updateStatus(QString url);
     void setActionsEnabled(SelcAbilities);
 
@@ -140,6 +139,7 @@
     BookmarkInfoWidget *bkInfo() { return m_bkinfo; }
 
 public slots:
+    void updateActions();
     void slotConfigureToolbars();
 
 protected slots:
--- kdebase-3.5.2/konqueror/konq_factory.cc	2006-03-17 05:17:40.000000000 -0500
+++ kdebase-3.5.2-new/konqueror/konq_factory.cc	2006-04-14 16:18:25.000000000 -0400
@@ -105,12 +105,12 @@
 
   // We ask ourselves whether to do it or not only if no service was specified.
   // If it was (from the View menu or from RMB + Embedding service), just do it.
-  forceAutoEmbed |= !serviceName.isEmpty();
+  forceAutoEmbed = forceAutoEmbed || !serviceName.isEmpty();
   // Or if we have no associated app anyway, then embed.
-  forceAutoEmbed |= appOffers.isEmpty() && !offers.isEmpty();
+  forceAutoEmbed = forceAutoEmbed || ( appOffers.isEmpty() && !offers.isEmpty() );
   // Or if the associated app is konqueror itself, then embed.
   if ( !appOffers.isEmpty() )
-    forceAutoEmbed |= KonqMainWindow::isMimeTypeAssociatedWithSelf( serviceType, appOffers.first() );
+    forceAutoEmbed = forceAutoEmbed || KonqMainWindow::isMimeTypeAssociatedWithSelf( serviceType, appOffers.first() );
 
   if ( ! forceAutoEmbed )
   {
--- kdebase-3.5.2/konqueror/konq_mainwindow.cc	2006-03-17 05:17:40.000000000 -0500
+++ kdebase-3.5.2-new/konqueror/konq_mainwindow.cc	2006-04-14 16:18:25.000000000 -0400
@@ -696,7 +696,7 @@
     if ( ptr )
     {
       const QString protocol = ptr->property("X-KDE-LocalProtocol").toString();
-      if ( !protocol.isEmpty() )
+      if ( !protocol.isEmpty() && KonqFMSettings::settings()->shouldEmbed( serviceType ) )
       {
         url.setProtocol( protocol );
         if ( serviceType == "application/x-webarchive" )
@@ -2757,7 +2757,7 @@
 {
   if ( KMessageBox::warningContinueCancel( this,
        i18n("Do you really want to close all other tabs?"),
-       i18n("Close Other Tabs Confirmation"), KGuiItem(i18n("Close &Other Tabs"),"tab_remove"),
+       i18n("Close Other Tabs Confirmation"), KGuiItem(i18n("Close &Other Tabs"),"tab_remove_other"),
        "CloseOtherTabConfirm") != KMessageBox::Continue )
     return;
 
@@ -3798,7 +3798,7 @@
   m_paBreakOffTab = new KAction( i18n( "Detach Current Tab" ), "tab_breakoff", CTRL+SHIFT+Key_B, this, SLOT( slotBreakOffTab() ), actionCollection(), "breakoffcurrenttab" );
   m_paRemoveView = new KAction( i18n( "&Close Active View" ),"view_remove", CTRL+SHIFT+Key_R, this, SLOT( slotRemoveView() ), actionCollection(), "removeview" );
   m_paRemoveTab = new KAction( i18n( "Close Current Tab" ), "tab_remove", CTRL+Key_W, this, SLOT( slotRemoveTab() ), actionCollection(), "removecurrenttab" );
-  m_paRemoveOtherTabs = new KAction( i18n( "Close &Other Tabs" ), "tab_remove", 0, this, SLOT( slotRemoveOtherTabsPopup() ), actionCollection(), "removeothertabs" );
+  m_paRemoveOtherTabs = new KAction( i18n( "Close &Other Tabs" ), "tab_remove_other", 0, this, SLOT( slotRemoveOtherTabsPopup() ), actionCollection(), "removeothertabs" );
 
   m_paActivateNextTab = new KAction( i18n( "Activate Next Tab" ), "tab_next", QApplication::reverseLayout() ? KStdAccel::tabPrev() : KStdAccel::tabNext(), this, SLOT( slotActivateNextTab() ), actionCollection(), "activatenexttab" );
   m_paActivatePrevTab = new KAction( i18n( "Activate Previous Tab" ), "tab_previous", QApplication::reverseLayout() ? KStdAccel::tabNext() : KStdAccel::tabPrev(), this, SLOT( slotActivatePrevTab() ), actionCollection(), "activateprevtab" );
@@ -3980,6 +3980,15 @@
   kdDebug() << "KonqMainWindow::slotFillContextMenu(bk, pm == " << pm << ")" << endl;
   popupItems.clear();
   popupUrlArgs = KParts::URLArgs();
+
+  //Set tab_new_x to point to the correct icon based on NewTabsInFront
+  bool newtabsinfront = KonqSettings::newTabsInFront();
+  QString tab_new_x ;
+  if ( newtabsinfront )
+    tab_new_x = "tab_new" ;
+  else
+    tab_new_x = "tab_new_bg" ;
+
   if ( bk.isGroup() )
   {
     KBookmarkGroup grp = bk.toGroup();
@@ -3987,13 +3996,13 @@
     QValueList<KURL>::Iterator it = list.begin();
     for (; it != list.end(); ++it )
       popupItems.append( new KFileItem( (*it), QString::null, KFileItem::Unknown) );
-    pm->insertItem( SmallIcon("tab_new"), i18n( "Open Folder in Tabs" ), this, SLOT( slotPopupNewTabRight() ) );
+    pm->insertItem( SmallIcon(tab_new_x), i18n( "Open Folder in Tabs" ), this, SLOT( slotPopupNewTabRight() ) );
   }
   else
   {
     popupItems.append( new KFileItem( bk.url(), QString::null, KFileItem::Unknown) );
     pm->insertItem( SmallIcon("window_new"), i18n( "Open in New Window" ), this, SLOT( slotPopupNewWindow() ) );
-    pm->insertItem( SmallIcon("tab_new"), i18n( "Open in New Tab" ), this, SLOT( slotPopupNewTabRight() ) );
+    pm->insertItem( SmallIcon(tab_new_x), i18n( "Open in New Tab" ), this, SLOT( slotPopupNewTabRight() ) );
   }
 }
 
@@ -4665,7 +4674,16 @@
       }
       actNewWindow = new KAction( i18n( "Open in New &Window" ), "window_new", 0, this, SLOT( slotPopupNewWindow() ), konqyMenuClient->actionCollection(), "newview" );
       actNewWindow->setToolTip( i18n( "Open the document in a new window" ) );
-      actNewTab = new KAction( i18n( "Open in &New Tab" ), "tab_new", 0, this, SLOT( slotPopupNewTab() ), konqyMenuClient->actionCollection(), "openintab" );
+
+      //Set tab_new_x to point to the correct icon based on NewTabsInFront
+      bool newtabsinfront = KonqSettings::newTabsInFront();
+      QString tab_new_x ;
+      if ( newtabsinfront )
+        tab_new_x = "tab_new" ;
+      else
+        tab_new_x = "tab_new_bg" ;
+
+      actNewTab = new KAction( i18n( "Open in &New Tab" ), tab_new_x, 0, this, SLOT( slotPopupNewTab() ), konqyMenuClient->actionCollection(), "openintab" );
       actNewTab->setToolTip( i18n( "Open the document in a new tab" ) );
       doTabHandling = true;
   }
--- kdebase-3.5.2/konqueror/konq_tabs.cc	2006-03-17 05:17:40.000000000 -0500
+++ kdebase-3.5.2-new/konqueror/konq_tabs.cc	2006-04-14 16:18:25.000000000 -0400
@@ -417,7 +417,7 @@
     }
     m_pSubPopupMenuTab->insertSeparator();
     m_closeOtherTabsId =
-      m_pSubPopupMenuTab->insertItem( SmallIconSet( "tab_remove" ),
+      m_pSubPopupMenuTab->insertItem( SmallIconSet( "tab_remove_other" ),
 				      i18n( "Close &Other Tabs" ),
 				      m_pViewManager->mainWindow(),
 				      SLOT( slotRemoveOtherTabsPopup() ),
--- kdebase-3.5.2/konqueror/konq_view.cc	2006-01-19 12:02:09.000000000 -0500
+++ kdebase-3.5.2-new/konqueror/konq_view.cc	2006-04-14 16:18:25.000000000 -0400
@@ -551,7 +551,7 @@
     if ( m_pMainWindow->currentView() == this )
         m_pMainWindow->updateToolBarActions( hasPending );
 
-    m_pMainWindow->viewManager()->setLoading( this, loading | hasPending );
+    m_pMainWindow->viewManager()->setLoading( this, loading || hasPending );
 }
 
 void KonqView::slotPercent( KIO::Job *, unsigned long percent )
--- kdebase-3.5.2/konqueror/shellcmdplugin/kshellcmdexecutor.cpp	2005-10-10 11:04:17.000000000 -0400
+++ kdebase-3.5.2-new/konqueror/shellcmdplugin/kshellcmdexecutor.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -127,7 +127,11 @@
    }
    else
       slotFinished();
-   m_writeNotifier->setEnabled(false);
+
+   if (m_writeNotifier)
+   {
+      m_writeNotifier->setEnabled(false);
+   }
 }
 
 void KShellCommandExecutor::slotFinished()
@@ -135,10 +139,11 @@
    setTextFormat(PlainText);
    if (m_shellProcess!=0)
    {
-      if (m_readNotifier!=0)
-         delete m_readNotifier;
-      if (m_writeNotifier!=0)
-         delete m_writeNotifier;
+      delete m_readNotifier;
+      m_readNotifier = 0;
+      delete m_writeNotifier;
+      m_writeNotifier = 0;
+
       //kdDebug()<<"slotFinished: pid: "<<m_shellProcess->pid()<<endl;
       ::kill(m_shellProcess->pid()+1, SIGTERM);
       ::kill(m_shellProcess->pid(), SIGTERM);
--- kdebase-3.5.2/konqueror/sidebar/trees/history_module/kcmhistory.cpp	2005-09-10 04:25:47.000000000 -0400
+++ kdebase-3.5.2-new/konqueror/sidebar/trees/history_module/kcmhistory.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -209,14 +209,7 @@
 
 void HistorySidebarConfig::slotExpireChanged( int value )
 {
-    if ( value == 1 )
-        dialog->spinExpire->setSuffix( i18n(" day") );
-    else
-        dialog->spinExpire->setSuffix(
-            i18n("'URLs expire after XX days.' Unfortunately the plural "
-                 "handling of KLocale does not work here, as I only need "
-                 "the word 'days' and not the entire sentence here. Sorry.",
-                 " days") );
+    dialog->spinExpire->setSuffix( i18n(" day", " days", value) );
     configChanged();
 }
 
@@ -225,21 +218,10 @@
 // to enfore newer <= older.
 void HistorySidebarConfig::slotNewerChanged( int value )
 {
-    const QString& days = i18n("Days");
-    const QString& minutes = i18n("Minutes");
-
-    if ( value == 1 ) {
-	dialog->comboNewer->changeItem( i18n("Day"),
-                                        KonqSidebarHistorySettings::DAYS );
-	dialog->comboNewer->changeItem( i18n("Minute"),
-                                        KonqSidebarHistorySettings::MINUTES );
-    }
-    else {
-	dialog->comboNewer->changeItem( days,
-                                        KonqSidebarHistorySettings::DAYS );
-	dialog->comboNewer->changeItem( minutes,
-                                        KonqSidebarHistorySettings::MINUTES);
-    }
+    dialog->comboNewer->changeItem( i18n ( "Day", "Days", value),
+                                    KonqSidebarHistorySettings::DAYS);
+    dialog->comboNewer->changeItem( i18n ( "Minute", "Minutes", value),
+                                    KonqSidebarHistorySettings::MINUTES);
 
     if ( dialog->spinNewer->value() > dialog->spinOlder->value() )
 	dialog->spinOlder->setValue( dialog->spinNewer->value() );
@@ -248,21 +230,10 @@
 
 void HistorySidebarConfig::slotOlderChanged( int value )
 {
-    const QString& days = i18n("Days");
-    const QString& minutes = i18n("Minutes");
-
-    if ( value == 1 ) {
-	dialog->comboOlder->changeItem( i18n("Day"),
-                                        KonqSidebarHistorySettings::DAYS );
-	dialog->comboOlder->changeItem( i18n("Minute"),
-                                        KonqSidebarHistorySettings::MINUTES );
-    }
-    else {
-	dialog->comboOlder->changeItem( days,
-                                        KonqSidebarHistorySettings::DAYS );
-	dialog->comboOlder->changeItem( minutes,
-                                        KonqSidebarHistorySettings::MINUTES);
-    }
+    dialog->comboOlder->changeItem( i18n ( "Day", "Days", value),
+                                    KonqSidebarHistorySettings::DAYS);
+    dialog->comboOlder->changeItem( i18n ( "Minute", "Minutes", value),
+                                    KonqSidebarHistorySettings::MINUTES);
 
     if ( dialog->spinNewer->value() > dialog->spinOlder->value() )
 	dialog->spinNewer->setValue( dialog->spinOlder->value() );
--- kdebase-3.5.2/konqueror/sidebar/web_module/web_module.cpp	2005-10-10 11:04:15.000000000 -0400
+++ kdebase-3.5.2-new/konqueror/sidebar/web_module/web_module.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -89,9 +89,9 @@
 	QHBox *hbox = dlg.makeHBoxMainWidget();
 	
 	QSpinBox *mins = new QSpinBox( 0, 120, 1, hbox );
-	mins->setSuffix( i18n(" minutes") );
+	mins->setSuffix( i18n(" min") );
 	QSpinBox *secs = new QSpinBox( 0, 59, 1, hbox );
-	secs->setSuffix( i18n(" seconds") );
+	secs->setSuffix( i18n(" sec") );
 
 	if( reloadTimeout > 0 )	{
 		int seconds = reloadTimeout / 1000;
--- kdebase-3.5.2/konsole/konsole/BlockArray.cpp	2005-09-10 04:26:08.000000000 -0400
+++ kdebase-3.5.2-new/konsole/konsole/BlockArray.cpp	2006-04-14 16:18:26.000000000 -0400
@@ -210,6 +210,7 @@
 
     FILE *fion = fdopen(dup(ion), "w+b");
     if (!fion) {
+        delete [] buffer1;
         perror("fdopen/dup");
         return;
     }
--- kdebase-3.5.2/konsole/konsole/TEWidget.cpp	2005-09-10 04:26:08.000000000 -0400
+++ kdebase-3.5.2-new/konsole/konsole/TEWidget.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -393,6 +393,8 @@
   qApp->installEventFilter( this ); //FIXME: see below
   KCursor::setAutoHideCursor( this, true );
 
+  setInputMethodEnabled( true );
+
   // Init DnD ////////////////////////////////////////////////////////////////
   setAcceptDrops(true); // attempt
   dragInfo.state = diNone;
--- kdebase-3.5.2/konsole/konsole/TEmuVt102.cpp	2005-09-10 04:26:07.000000000 -0400
+++ kdebase-3.5.2-new/konsole/konsole/TEmuVt102.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -952,7 +952,10 @@
     scr->setHistCursor(scr->getHistLines());
 
   if (cmd==CMD_send) {
-    if ((ev->state() & AltButton) && !metaspecified ) sendString("\033");
+    if ( (ev->state() & AltButton) && 
+      !metaspecified &&
+      !(len && txt[0]==27) )
+      sendString("\033");
     emit sndBlock(txt,len);
     return;
   }
--- kdebase-3.5.2/konsole/konsole/konsole.cpp	2006-03-17 05:17:43.000000000 -0500
+++ kdebase-3.5.2-new/konsole/konsole/konsole.cpp	2006-04-14 16:18:26.000000000 -0400
@@ -214,6 +214,7 @@
 ,selectScrollbar(0)
 ,selectTabbar(0)
 ,selectBell(0)
+,selectSetEncoding(0)
 ,m_clearHistory(0)
 ,m_findHistory(0)
 ,m_saveHistory(0)
--- kdebase-3.5.2/kpager/Makefile.am	2005-09-10 04:25:36.000000000 -0400
+++ kdebase-3.5.2-new/kpager/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -1,14 +1,16 @@
 INCLUDES= $(all_includes)
 
-bin_PROGRAMS = kpager
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kpager.la
 
-kpager_SOURCES = desktop.cpp kpager.cpp config.cpp windowdrag.cpp \
+kpager_la_SOURCES = desktop.cpp kpager.cpp config.cpp windowdrag.cpp \
 	kpagerIface.skel main.cpp  
 
-kpager_METASOURCES = AUTO
-kpager_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+kpager_la_METASOURCES = AUTO
+kpager_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
-kpager_LDADD = $(LIB_KDEUI)
+kpager_la_LIBADD = $(LIB_KDEUI)
 
 KDE_ICON = kpager
 
--- kdebase-3.5.2/kpager/main.cpp	2005-10-10 11:04:00.000000000 -0400
+++ kdebase-3.5.2-new/kpager/main.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -62,7 +62,7 @@
 
 };
 
-int main(int argc, char **argv)
+extern "C" KDE_EXPORT int kdemain(int argc, char **argv)
 {
     KAboutData *aboutdata = new KAboutData("kpager", "KPager", "1.5",
 					   I18N_NOOP("Desktop Overview"), KAboutData::License_GPL,
--- kdebase-3.5.2/kpersonalizer/Makefile.am	2005-09-10 04:25:00.000000000 -0400
+++ kdebase-3.5.2-new/kpersonalizer/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -1,11 +1,14 @@
-bin_PROGRAMS = kpersonalizer
-kpersonalizer_SOURCES = stylepreview.ui krefinepage.cpp \
+bin_PROGRAMS =
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kpersonalizer.la
+
+kpersonalizer_la_SOURCES = stylepreview.ui krefinepage.cpp \
       kstylepage.cpp keyecandypage.cpp kospage.cpp kcountrypage.cpp kpersonalizer.cpp \
       main.cpp kfindlanguage.cpp \
       kcountrypagedlg.ui kospagedlg.ui keyecandypagedlg.ui kstylepagedlg.ui \
       krefinepagedlg.ui  ksysinfo.cpp
 
-kpersonalizer_LDADD   = $(LIB_KIO) 
+kpersonalizer_la_LIBADD  = $(LIB_KIO) 
 
 EXTRA_DIST = main.cpp kpersonalizer.cpp kpersonalizer.h kpersonalizer.desktop kcountrypage.cpp kcountrypage.h kospage.cpp kospage.h keyecandypage.cpp keyecandypage.h kstylepage.cpp kstylepage.h krefinepage.cpp krefinepage.h cr16-app-kpersonalizer.png cr32-app-kpersonalizer.png README kcountrypagedlg.ui kospage.ui keyecandypagedlg.ui kstylepagedlg.ui krefinepagedlg.ui kfindlanguage.cpp kfindlanguage.h
 
@@ -38,7 +41,7 @@
 
 KDE_ICON= AUTO
 # the library search path. 
-kpersonalizer_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+kpersonalizer_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 # Uncomment the following two lines if you add a ui.rc file for your application to make use of
 # KDEs XML GUI builing
--- kdebase-3.5.2/kpersonalizer/main.cpp	2005-09-10 04:25:00.000000000 -0400
+++ kdebase-3.5.2-new/kpersonalizer/main.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -33,7 +33,7 @@
         KCmdLineLastOption
 };
 
-int main(int argc, char *argv[])
+extern "C" KDE_EXPORT int kdemain(int argc, char *argv[])
 {
 	KAboutData aboutData( "kpersonalizer", I18N_NOOP("KPersonalizer"),
 		VERSION, description, KAboutData::License_GPL,
--- kdebase-3.5.2/kreadconfig/Makefile.am	2005-09-10 04:25:36.000000000 -0400
+++ kdebase-3.5.2-new/kreadconfig/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -1,12 +1,17 @@
 AM_CPPFLAGS = -DQT_NO_CAST_ASCII 
 
 INCLUDES = $(all_includes)
-AM_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-LDADD   =       $(LIB_KDECORE)
 
-bin_PROGRAMS	= kreadconfig kwriteconfig
-kreadconfig_SOURCES	= kreadconfig.cpp
-kwriteconfig_SOURCES	= kwriteconfig.cpp
+bin_PROGRAMS	= 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kreadconfig.la kwriteconfig.la
+kreadconfig_la_SOURCES = kreadconfig.cpp
+kreadconfig_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kreadconfig_la_LIBADD  = $(LIB_KDECORE)
+
+kwriteconfig_la_SOURCES	= kwriteconfig.cpp
+kwriteconfig_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kwriteconfig_la_LIBADD  = $(LIB_KDECORE)
 
 messages:
 	$(XGETTEXT) $(kreadconfig_SOURCES) -o $(podir)/kreadconfig.pot
--- kdebase-3.5.2/kreadconfig/kreadconfig.cpp	2005-09-10 04:25:36.000000000 -0400
+++ kdebase-3.5.2-new/kreadconfig/kreadconfig.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -41,7 +41,7 @@
 	{ "type <type>", I18N_NOOP("Type of variable"), 0 },
         KCmdLineLastOption
 };
-int main(int argc, char **argv)
+extern "C" KDE_EXPORT int kdemain(int argc, char **argv)
 {
 	KAboutData aboutData("kreadconfig", I18N_NOOP("KReadConfig"),
 		"1.0.1",
--- kdebase-3.5.2/kreadconfig/kwriteconfig.cpp	2005-09-10 04:25:36.000000000 -0400
+++ kdebase-3.5.2-new/kreadconfig/kwriteconfig.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -23,7 +23,7 @@
 	{ "+value", I18N_NOOP( "The value to write. Mandatory, on a shell use '' for empty" ), 0 },
         KCmdLineLastOption
 };
-int main(int argc, char **argv)
+extern "C" KDE_EXPORT int kdemain(int argc, char **argv)
 {
 	KAboutData aboutData("kwriteconfig", I18N_NOOP("KWriteConfig"),
 		"1.0.0",
--- kdebase-3.5.2/ksmserver/legacy.cpp	2006-03-17 05:17:10.000000000 -0500
+++ kdebase-3.5.2-new/ksmserver/legacy.cpp	2006-04-14 16:18:23.000000000 -0400
@@ -40,6 +40,10 @@
 
 #include "server.h"
 
+#ifdef HAVE_SYS_TIME_H
+#include <sys/time.h>
+#endif
+
 #include <unistd.h>
 
 #include <qtimer.h>
--- kdebase-3.5.2/ksplashml/Makefile.am	2005-09-10 04:25:51.000000000 -0400
+++ kdebase-3.5.2-new/ksplashml/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -4,10 +4,13 @@
 
 METASOURCES=AUTO
 
-bin_PROGRAMS = ksplash
-ksplash_SOURCES = wndmain.cpp ksplashiface.skel main.cpp
-ksplash_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-ksplash_LDADD = $(LIB_KDEUI) themeengine/default/libthemedefault.la themeengine/libksplashthemes.la $(LIB_KIO)
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = ksplash.la
+
+ksplash_la_SOURCES = wndmain.cpp ksplashiface.skel main.cpp
+ksplash_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+ksplash_la_LIBADD = $(LIB_KDEUI) themeengine/default/libthemedefault.la themeengine/libksplashthemes.la $(LIB_KIO)
 
 noinst_HEADERS = ksplashiface.h wndmain.h
 
--- kdebase-3.5.2/ksplashml/main.cpp	2005-09-10 04:25:51.000000000 -0400
+++ kdebase-3.5.2-new/ksplashml/main.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -37,7 +37,7 @@
   KCmdLineLastOption
 };
 
-int main( int argc, char **argv )
+extern "C" KDE_EXPORT int kdemain( int argc, char **argv )
 {
   KAboutData about(
     "ksplash",
--- kdebase-3.5.2/ksplashml/themeengine/simple/Makefile.am	2005-09-10 04:25:50.000000000 -0400
+++ kdebase-3.5.2-new/ksplashml/themeengine/simple/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -1,7 +1,10 @@
 
 INCLUDES = $(all_includes)
 
-bin_PROGRAMS = ksplashsimple
-ksplashsimple_SOURCES = main.cpp
-ksplashsimple_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-ksplashsimple_LDADD = $(LIB_XINERAMA) $(LIB_X11)
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = ksplashsimple.la
+
+ksplashsimple_la_SOURCES = main.cpp
+ksplashsimple_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+ksplashsimple_la_LIBADD = $(LIB_XINERAMA) $(LIB_X11)
--- kdebase-3.5.2/ksplashml/themeengine/simple/main.cpp	2005-09-10 04:25:50.000000000 -0400
+++ kdebase-3.5.2-new/ksplashml/themeengine/simple/main.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -31,10 +31,11 @@
 # endif
 #endif
 
+#include <kdemacros.h>
 
 //#define DEBUG
 
-int main( int argc, char* argv[])
+extern "C" KDE_EXPORT int kdemain( int argc, char* argv[])
     {
     if( fork() != 0 )
         return 0;
--- kdebase-3.5.2/kstart/Makefile.am	2005-09-10 04:25:55.000000000 -0400
+++ kdebase-3.5.2-new/kstart/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -6,10 +6,13 @@
 
 #######	Files
 
-bin_PROGRAMS	= kstart
-kstart_SOURCES	= kstart.cpp
-kstart_LDFLAGS  = $(all_libraries) $(KDE_RPATH)
-kstart_LDADD    = $(LIB_KDECORE)
+bin_PROGRAMS	= 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kstart.la
+
+kstart_la_SOURCES	= kstart.cpp
+kstart_la_LDFLAGS  = $(all_libraries) $(KDE_PLUGIN) -module
+kstart_la_LIBADD   = $(LIB_KDECORE)
 METASOURCES =	kstart.moc 
 
 noinst_HEADERS = kstart.h version.h
--- kdebase-3.5.2/kstart/kstart.cpp	2005-09-10 04:25:55.000000000 -0400
+++ kdebase-3.5.2-new/kstart/kstart.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -283,7 +283,7 @@
   KCmdLineLastOption
 };
 
-int main( int argc, char *argv[] )
+extern "C" KDE_EXPORT int kdemain( int argc, char *argv[] )
 {
   // David, 05/03/2000
   KAboutData aboutData( "kstart", I18N_NOOP("KStart"), KSTART_VERSION,
--- kdebase-3.5.2/ksysguard/gui/Makefile.am	2005-09-10 04:26:15.000000000 -0400
+++ kdebase-3.5.2-new/ksysguard/gui/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -18,21 +18,23 @@
  
 ####### This part is very ksysguard specific
 # you can add here more. This one gets installed 
-bin_PROGRAMS = ksysguard kpm
+bin_PROGRAMS = kpm
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = ksysguard.la
 
 # Which sources should be compiled for ksysguard.
-ksysguard_SOURCES = \
+ksysguard_la_SOURCES = \
 	SensorBrowser.cc \
 	WorkSheet.cc \
 	WorkSheetSettings.cc \
 	Workspace.cc \
 	ksysguard.cc ksysguard.skel
 
-ksysguard_LDADD = \
+ksysguard_la_LIBADD = \
 	ksgrd/libksgrd.la \
 	SensorDisplayLib/libsensordisplays.la \
 	$(LIB_KDEUI) $(LIB_KIO) $(LIB_KDNSSD)
-ksysguard_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+ksysguard_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -module
 
 kpm_SOURCES = kpm.c
 
--- kdebase-3.5.2/ksysguard/gui/SensorDisplayLib/DancingBars.cc	2005-10-10 11:04:32.000000000 -0400
+++ kdebase-3.5.2-new/ksysguard/gui/SensorDisplayLib/DancingBars.cc	2006-04-14 16:18:26.000000000 -0400
@@ -45,7 +45,8 @@
   : KSGRD::SensorDisplay( parent, name, title, noFrame_, isApplet )
 {
   mBars = 0;
-  mFlags = 0;
+  mFlags = QBitArray(100);
+  mFlags.fill( false );
 
   if ( noFrame() )
     mPlotter = new BarGraph( this );
@@ -245,16 +246,16 @@
 	
   if ( id < 100 ) {
     mSampleBuffer[ id ] = answer.toDouble();
-    if ( mFlags & ( 1 << id ) ) {
+    if ( mFlags.testBit( id ) == true ) {
       kdDebug(1215) << "ERROR: DancingBars lost sample (" << mFlags
                     << ", " << mBars << ")" << endl;
       sensorError( id, true );
     }
-    mFlags |= 1 << id;
+    mFlags.setBit( id, true );
 
-    if ( mFlags == (uint)( ( 1 << mBars ) - 1 ) ) {
+    if ( mFlags.testBit( ( 1 << mBars ) - 1 ) == true ) {
       mPlotter->updateSamples( mSampleBuffer );
-      mFlags = 0;
+      mFlags.fill( false );
     }
   } else if ( id >= 100 ) {
     KSGRD::SensorIntegerInfo info( answer );
--- kdebase-3.5.2/ksysguard/gui/SensorDisplayLib/DancingBars.h	2005-10-10 11:04:32.000000000 -0400
+++ kdebase-3.5.2-new/ksysguard/gui/SensorDisplayLib/DancingBars.h	2006-04-14 16:18:26.000000000 -0400
@@ -25,6 +25,7 @@
 #define KSG_DANCINGBARS_H
 
 #include <SensorDisplay.h>
+#include <qbitarray.h>
 
 class KIntNumInput;
 
@@ -83,7 +84,7 @@
       been received.
      */
     QMemArray<double> mSampleBuffer;
-    ulong mFlags;
+    QBitArray mFlags;
 };
 
 #endif
--- kdebase-3.5.2/ksysguard/gui/SensorDisplayLib/ProcessList.cc	2006-03-17 05:17:48.000000000 -0500
+++ kdebase-3.5.2-new/ksysguard/gui/SensorDisplayLib/ProcessList.cc	2006-04-14 16:18:26.000000000 -0400
@@ -774,27 +774,27 @@
 		if (QString::compare(header()->label(i), i18n("Nice")) == 0)
 			currentNiceValue = lvi->text(i).toInt();
 
-	processPM = new QPopupMenu();
+	QPopupMenu processPM;
   if (columnWidth(col) != 0)
-  	processPM->insertItem(i18n("Hide Column"), 5);
-	QPopupMenu* hiddenPM = new QPopupMenu(processPM);
+  	processPM.insertItem(i18n("Hide Column"), 5);
+	QPopupMenu* hiddenPM = new QPopupMenu(&processPM);
 	for (int i = 0; i < columns(); ++i)
 		if (columnWidth(i) == 0)
 			hiddenPM->insertItem(header()->label(i), i + 100);
 	if(columns())
-	  processPM->insertItem(i18n("Show Column"), hiddenPM);
+	  processPM.insertItem(i18n("Show Column"), hiddenPM);
 
-	processPM->insertSeparator();
+	processPM.insertSeparator();
 
-	processPM->insertItem(i18n("Select All Processes"), 1);
-	processPM->insertItem(i18n("Unselect All Processes"), 2);
+	processPM.insertItem(i18n("Select All Processes"), 1);
+	processPM.insertItem(i18n("Unselect All Processes"), 2);
 
-	QPopupMenu* signalPM = new QPopupMenu(processPM);
+	QPopupMenu* signalPM = new QPopupMenu(&processPM);
 	if (killSupported && lvi->isSelected())
 	{
-		processPM->insertSeparator();
-		processPM->insertItem(i18n("Select All Child Processes"), 3);
-		processPM->insertItem(i18n("Unselect All Child Processes"), 4);
+		processPM.insertSeparator();
+		processPM.insertItem(i18n("Select All Child Processes"), 3);
+		processPM.insertItem(i18n("Unselect All Child Processes"), 4);
 
 		signalPM->insertItem(i18n("SIGABRT"), MENU_ID_SIGABRT);
 		signalPM->insertItem(i18n("SIGALRM"), MENU_ID_SIGALRM);
@@ -816,20 +816,20 @@
 		signalPM->insertItem(i18n("SIGUSR1"), MENU_ID_SIGUSR1);
 		signalPM->insertItem(i18n("SIGUSR2"), MENU_ID_SIGUSR2);
 
-		processPM->insertSeparator();
-		processPM->insertItem(i18n("Send Signal"), signalPM);
+		processPM.insertSeparator();
+		processPM.insertItem(i18n("Send Signal"), signalPM);
 	}
 
 	/* differ between killSupported and reniceSupported in a future
 	 * version. */
 	if (killSupported && lvi->isSelected())
 	{
-		processPM->insertSeparator();
-		processPM->insertItem(i18n("Renice Process..."), 300);
+		processPM.insertSeparator();
+		processPM.insertItem(i18n("Renice Process..."), 300);
 	}
 
 	int id;
-	switch (id = processPM->exec(p))
+	switch (id = processPM.exec(p))
 	{
 	case -1:
 		break;
@@ -901,7 +901,6 @@
 			setModified(true);
 		}
 	}
-	delete processPM;
 }
 
 void
--- kdebase-3.5.2/ksysguard/gui/SensorDisplayLib/ProcessList.h	2005-10-10 11:04:32.000000000 -0400
+++ kdebase-3.5.2-new/ksysguard/gui/SensorDisplayLib/ProcessList.h	2006-04-14 16:18:26.000000000 -0400
@@ -265,7 +265,6 @@
 	QDict<QPixmap> iconCache;
 
 	KIconLoader* icons;
-	QPopupMenu* processPM;
 	QPopupMenu* headerPM;
 };
 
--- kdebase-3.5.2/ksysguard/gui/SensorDisplayLib/SensorLogger.cc	2005-10-10 11:04:32.000000000 -0400
+++ kdebase-3.5.2-new/ksysguard/gui/SensorDisplayLib/SensorLogger.cc	2006-04-14 16:18:26.000000000 -0400
@@ -25,6 +25,8 @@
 #include <ksgrd/SensorManager.h>
 #include <ksgrd/StyleEngine.h>
 
+#include <qfile.h>
+
 #include "SensorLogger.moc"
 #include "SensorLoggerSettings.h"
 
@@ -84,20 +86,18 @@
 void
 LogSensor::answerReceived(int id, const QString& answer)
 {
-	logFile = new QFile(fileName);
-	Q_CHECK_PTR(logFile);
+	QFile logFile(fileName);
 
-	if (!logFile->open(IO_ReadWrite | IO_Append))
+	if (!logFile.open(IO_ReadWrite | IO_Append))
 	{
 		stopLogging();
-		delete logFile;
 		return;
 	}
 
 	switch (id)
 	{
 		case 42: {
-			QTextStream stream(logFile);
+			QTextStream stream(&logFile);
 			double value = answer.toDouble();
 
 			if (lowerLimitActive && value < lowerLimit)
@@ -124,8 +124,7 @@
 		}
 	}
 
-	logFile->close();
-	delete logFile;
+	logFile.close();
 }
 
 SensorLogger::SensorLogger(QWidget *parent, const char *name, const QString& title)
--- kdebase-3.5.2/ksysguard/gui/SensorDisplayLib/SensorLogger.h	2005-10-10 11:04:32.000000000 -0400
+++ kdebase-3.5.2-new/ksysguard/gui/SensorDisplayLib/SensorLogger.h	2006-04-14 16:18:26.000000000 -0400
@@ -22,7 +22,6 @@
 #define _SensorLogger_h
 
 #include <qdom.h>
-#include <qfile.h>
 #include <qlabel.h>
 #include <qlineedit.h>
 #include <qlistview.h>
@@ -122,7 +121,6 @@
 	virtual void timerEvent(QTimerEvent*);
 
 private:
-	QFile* logFile;
 	QListView* monitor;
 	SLListViewItem* lvi;
 	QPixmap pixmap_running;
--- kdebase-3.5.2/ksysguard/gui/WorkSheet.cc	2005-10-10 11:04:32.000000000 -0400
+++ kdebase-3.5.2-new/ksysguard/gui/WorkSheet.cc	2006-04-14 16:18:26.000000000 -0400
@@ -24,6 +24,7 @@
 #include <qclipboard.h>
 #include <qcursor.h>
 #include <qdragobject.h>
+#include <qfile.h>
 #include <qlayout.h>
 
 #include <kdebug.h>
--- kdebase-3.5.2/ksysguard/gui/ksgrd/SensorShellAgent.cc	2005-10-10 11:04:32.000000000 -0400
+++ kdebase-3.5.2-new/ksysguard/gui/ksgrd/SensorShellAgent.cc	2006-04-14 16:18:26.000000000 -0400
@@ -41,7 +41,7 @@
   if ( mDaemon ) {
     mDaemon->writeStdin( "quit\n", strlen( "quit\n" ) );
     delete (KShellProcess*)mDaemon;
-		mDaemon = 0;
+    mDaemon = 0;
   }
 }
 	
@@ -50,9 +50,9 @@
 {
   mDaemon = new KShellProcess;
 
-	setHostName( host );
-	mShell = shell;
-	mCommand = command;
+  setHostName( host );
+  mShell = shell;
+  mCommand = command;
 
   connect( mDaemon, SIGNAL( processExited( KProcess* ) ),
            SLOT( daemonExited( KProcess* ) ) );
@@ -84,7 +84,7 @@
 {
   shell = mShell;
   command = mCommand;
-	port = -1;
+  port = -1;
 }
 
 void SensorShellAgent::msgSent( KProcess* )
@@ -122,7 +122,8 @@
   sensorManager()->hostLost( this );
   sensorManager()->disengage( this );
 
-  process->deleteLater();
+  if ( mDaemon )
+    mDaemon->deleteLater();
 }
 
 bool SensorShellAgent::writeMsg( const char *msg, int len )
--- kdebase-3.5.2/ksysguard/gui/ksysguard.cc	2006-03-17 05:17:48.000000000 -0500
+++ kdebase-3.5.2-new/ksysguard/gui/ksysguard.cc	2006-04-14 16:18:19.000000000 -0400
@@ -520,7 +520,7 @@
 /*
  * Once upon a time...
  */
-int main( int argc, char** argv )
+extern "C" KDE_EXPORT int kdemain( int argc, char** argv )
 {
   // initpipe is used to keep the parent process around till the child
   // has registered with dcop.
--- kdebase-3.5.2/ksystraycmd/Makefile.am	2005-09-10 04:26:16.000000000 -0400
+++ kdebase-3.5.2-new/ksystraycmd/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -1,16 +1,19 @@
 ####### Fiddle here
 
 INCLUDES = $(all_includes)
-LDADD    = $(LIB_KDEUI)
 
 #######	Files
 
-bin_PROGRAMS	= ksystraycmd
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = ksystraycmd.la
+
 METASOURCES	= ksystraycmd.moc
 noinst_HEADERS  = ksystraycmd.h
 
-ksystraycmd_SOURCES = ksystraycmd.cpp main.cpp
-ksystraycmd_LDFLAGS  = $(all_libraries) $(KDE_RPATH)
+ksystraycmd_la_SOURCES = ksystraycmd.cpp main.cpp
+ksystraycmd_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+ksystraycmd_la_LIBADD  = $(LIB_KDEUI)
 
 messages:
 	$(XGETTEXT) $(ksystraycmd_SOURCES) -o $(podir)/ksystraycmd.pot
--- kdebase-3.5.2/ksystraycmd/main.cpp	2006-01-19 12:03:19.000000000 -0500
+++ kdebase-3.5.2-new/ksystraycmd/main.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -45,7 +45,7 @@
   KCmdLineLastOption
 };
 
-int main( int argc, char *argv[] )
+extern "C" KDE_EXPORT int kdemain( int argc, char *argv[] )
 {
   KAboutData aboutData( "ksystraycmd", I18N_NOOP( "KSysTrayCmd" ),
 			"KSysTrayCmd 0.1",
--- kdebase-3.5.2/ktip/Makefile.am	2005-09-10 04:25:55.000000000 -0400
+++ kdebase-3.5.2-new/ktip/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -2,10 +2,13 @@
 
 SUBDIRS = pics
 
-bin_PROGRAMS = ktip
-ktip_SOURCES = ktipwindow.cpp
-ktip_LDADD = $(LIB_KDEUI)
-ktip_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = ktip.la
+
+ktip_la_SOURCES = ktipwindow.cpp
+ktip_la_LIBADD = $(LIB_KDEUI)
+ktip_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 METASOURCES = AUTO
 KDE_ICON = AUTO
--- kdebase-3.5.2/ktip/ktipwindow.cpp	2005-10-10 11:04:21.000000000 -0400
+++ kdebase-3.5.2-new/ktip/ktipwindow.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -31,7 +31,7 @@
 
 static const char description[] = I18N_NOOP("Useful tips");
 
-int main(int argc, char *argv[])
+extern "C" KDE_EXPORT int kdemain(int argc, char *argv[])
 {
 	KAboutData aboutData("ktip", I18N_NOOP("KTip"),
 				"0.3", description, KAboutData::License_GPL,
--- kdebase-3.5.2/kwin/activation.cpp	2006-03-17 05:17:43.000000000 -0500
+++ kdebase-3.5.2-new/kwin/activation.cpp	2006-04-14 16:18:26.000000000 -0400
@@ -231,7 +231,7 @@
         last_active_client = active_client;
     if ( active_client ) 
         {
-        updateFocusChains( active_client, true ); // make it first in focus chain
+        updateFocusChains( active_client, FocusChainMakeFirst );
         active_client->demandAttention( false );
         }
     pending_take_activity = NULL;
--- kdebase-3.5.2/kwin/client.cpp	2006-03-17 05:17:43.000000000 -0500
+++ kdebase-3.5.2-new/kwin/client.cpp	2006-04-14 16:18:26.000000000 -0400
@@ -578,7 +578,7 @@
     updateAllowedActions();
     workspace()->updateMinimizedOfTransients( this );
     updateWindowRules();
-    workspace()->updateFocusChains( this, false ); // make it last in the focus chain
+    workspace()->updateFocusChains( this, Workspace::FocusChainMakeLast );
     }
 
 void Client::unminimize( bool avoid_animation )
@@ -895,7 +895,16 @@
         }
     if( show )
         {
-        if( workspace()->showingDesktop())
+        bool belongs_to_desktop = false;
+        for( ClientList::ConstIterator it = group()->members().begin();
+             it != group()->members().end();
+             ++it )
+            if( (*it)->isDesktop())
+                {
+                belongs_to_desktop = true;
+                break;
+                }
+        if( !belongs_to_desktop && workspace()->showingDesktop())
             workspace()->resetShowingDesktop( true );
         if( isShade())
             setMappingState( IconicState );
@@ -1149,7 +1158,8 @@
     info->setState( b?NET::SkipTaskbar:0, NET::SkipTaskbar );
     updateWindowRules();
     if( was_wants_tab_focus != wantsTabFocus())
-        workspace()->updateFocusChains( this, isActive());
+        workspace()->updateFocusChains( this,
+            isActive() ? Workspace::FocusChainMakeFirst : Workspace::FocusChainUpdate );
     }
 
 void Client::setSkipPager( bool b )
@@ -1191,7 +1201,7 @@
         }
     if( decoration != NULL )
         decoration->desktopChange();
-    workspace()->updateFocusChains( this, true );
+    workspace()->updateFocusChains( this, Workspace::FocusChainMakeFirst );
     updateVisibility();
     updateWindowRules();
     }
--- kdebase-3.5.2/kwin/clients/b2/b2client.cpp	2006-01-19 12:01:02.000000000 -0500
+++ kdebase-3.5.2-new/kwin/clients/b2/b2client.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -530,7 +530,7 @@
     if (drawSmallBorders && (maximizeMode() & MaximizeVertical)) {
 	return false;
     } else {
-	return do_draw_handle & resizable;
+	return do_draw_handle && resizable;
     }
 }
 
--- kdebase-3.5.2/kwin/clients/default/kdedefault.cpp	2005-09-10 04:25:55.000000000 -0400
+++ kdebase-3.5.2-new/kwin/clients/default/kdedefault.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -808,7 +808,7 @@
 		case LM_ExplicitButtonSpacer:
 			if ( !isToolWindow() )
 				return borderWidth/2;
-
+			// fall though
 		default:
 			return KCommonDecoration::layoutMetric(lm, respectWindowState, btn);
 	}
--- kdebase-3.5.2/kwin/clients/kwmtheme/cli_installer/Makefile.am	2005-09-10 04:25:55.000000000 -0400
+++ kdebase-3.5.2-new/kwin/clients/kwmtheme/cli_installer/Makefile.am	2006-04-14 16:18:19.000000000 -0400
@@ -4,15 +4,17 @@
 
 ####### This part is very kwmtheme specific
 # you can add here more. This one gets installed 
-bin_PROGRAMS = 	kwmtheme
+bin_PROGRAMS = 	
+lib_LTLIBRARIES = 
+kdeinit_LTLIBRARIES = kwmtheme.la
 
 # Which sources should be compiled for kwmtheme.
-kwmtheme_SOURCES = main.cpp 
+kwmtheme_la_SOURCES = main.cpp 
 
 # the library search path. 
-kwmtheme_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+kwmtheme_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 # the libraries to link against. Be aware of the order. First the libraries,
 # that depend on the following ones.
-kwmtheme_LDADD   = $(LIB_KDECORE)
+kwmtheme_la_LIBADD   = $(LIB_KDECORE)
 
--- kdebase-3.5.2/kwin/clients/kwmtheme/cli_installer/main.cpp	2005-09-10 04:25:55.000000000 -0400
+++ kdebase-3.5.2-new/kwin/clients/kwmtheme/cli_installer/main.cpp	2006-04-14 16:18:19.000000000 -0400
@@ -37,7 +37,7 @@
     copyOutput.close();
 }
 
-int main(int argc, char **argv)
+extern "C" KDE_EXPORT int kdemain(int argc, char **argv)
 {
     KCmdLineArgs::init(argc, argv, "kwmtheme", description, "0.1");
     KCmdLineArgs::addCmdLineOptions( options );
--- kdebase-3.5.2/kwin/events.cpp	2006-03-17 05:17:43.000000000 -0500
+++ kdebase-3.5.2-new/kwin/events.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -370,7 +370,7 @@
             if( c )
                 {
                 c->windowEvent( e );
-                updateFocusChains( c, true );
+                updateFocusChains( c, FocusChainUpdate );
                 return true;
                 }
             break;
@@ -402,15 +402,15 @@
             if ( e->xconfigurerequest.parent == root ) 
                 {
                 XWindowChanges wc;
-                unsigned int value_mask = 0;
-                wc.border_width = 0;
+                wc.border_width = e->xconfigurerequest.border_width;
                 wc.x = e->xconfigurerequest.x;
                 wc.y = e->xconfigurerequest.y;
                 wc.width = e->xconfigurerequest.width;
                 wc.height = e->xconfigurerequest.height;
                 wc.sibling = None;
                 wc.stack_mode = Above;
-                value_mask = e->xconfigurerequest.value_mask | CWBorderWidth;
+                unsigned int value_mask = e->xconfigurerequest.value_mask
+                    & ( CWX | CWY | CWWidth | CWHeight | CWBorderWidth );
                 XConfigureWindow( qt_xdisplay(), e->xconfigurerequest.window, value_mask, &wc );
                 return true;
                 }
--- kdebase-3.5.2/kwin/geometry.cpp	2006-03-17 05:17:43.000000000 -0500
+++ kdebase-3.5.2-new/kwin/geometry.cpp	2006-04-14 16:18:26.000000000 -0400
@@ -1281,7 +1281,21 @@
         { // update to match restrictions
         QSize new_size = adjustedSize();
         if( new_size != size() && !isFullScreen())
+            {
+            QRect orig_geometry = geometry();
             resizeWithChecks( new_size );
+            if( ( !isSpecialWindow() || isToolbar()) && !isFullScreen())
+                {
+                // try to keep the window in its xinerama screen if possible,
+                // if that fails at least keep it visible somewhere
+                QRect area = workspace()->clientArea( MovementArea, this );
+                if( area.contains( orig_geometry ))
+                    keepInArea( area );
+                area = workspace()->clientArea( WorkArea, this );
+                if( area.contains( orig_geometry ))
+                    keepInArea( area );
+                }
+            }
         }
     updateAllowedActions(); // affects isResizeable()
     }
@@ -1840,7 +1854,7 @@
 
     // maximing one way and unmaximizing the other way shouldn't happen
     Q_ASSERT( !( vertical && horizontal )
-        || (( max_mode & MaximizeVertical != 0 ) == ( max_mode & MaximizeHorizontal != 0 )));
+        || ((( max_mode & MaximizeVertical ) != 0 ) == (( max_mode & MaximizeHorizontal ) != 0 )));
 
     QRect clientArea = workspace()->clientArea( MaximizeArea, this );
 
--- kdebase-3.5.2/kwin/kcmkwin/kwinoptions/windows.cpp	2006-03-17 05:17:42.000000000 -0500
+++ kdebase-3.5.2-new/kwin/kcmkwin/kwinoptions/windows.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -228,6 +228,7 @@
                  " is pressed, with no popup widget.  In addition, the previously"
                  " activated window will be sent to the back in this mode.");
     QWhatsThis::add( altTabPopup, wtstr );
+    connect(focusCombo, SIGNAL(activated(int)), this, SLOT(updateAltTabMode()));
 
     traverseAll = new QCheckBox( i18n( "&Traverse windows on all desktops" ), kbdBox );
     kLay->addWidget( traverseAll );
@@ -279,6 +280,13 @@
 
     // this will disable/hide the auto raise delay widget if focus==click
     setAutoRaiseEnabled();
+    updateAltTabMode();
+}
+
+void KFocusConfig::updateAltTabMode()
+{
+    // not KDE-style Alt+Tab with unreasonable focus policies
+    altTabPopup->setEnabled( focusCombo->currentItem() == 0 || focusCombo->currentItem() == 1 );
 }
 
 void KFocusConfig::setAutoRaiseInterval(int tb)
@@ -900,7 +908,6 @@
     BrdrSnap->setSpecialValueText( i18n("none") );
     BrdrSnap->setRange( 0, MAX_BRDR_SNAP);
     BrdrSnap->setLabel(i18n("&Border snap zone:"));
-    BrdrSnap->setSuffix(i18n(" pixels"));
     BrdrSnap->setSteps(1,10);
     QWhatsThis::add( BrdrSnap, i18n("Here you can set the snap zone for screen borders, i.e."
                                     " the 'strength' of the magnetic field which will make windows snap to the border when"
@@ -910,7 +917,6 @@
     WndwSnap->setSpecialValueText( i18n("none") );
     WndwSnap->setRange( 0, MAX_WNDW_SNAP);
     WndwSnap->setLabel(i18n("&Window snap zone:"));
-    WndwSnap->setSuffix( i18n(" pixels"));
     BrdrSnap->setSteps(1,10);
     QWhatsThis::add( WndwSnap, i18n("Here you can set the snap zone for windows, i.e."
                                     " the 'strength' of the magnetic field which will make windows snap to each other when"
@@ -935,8 +941,14 @@
     connect( moveResizeMaximized, SIGNAL(toggled(bool)), SLOT(changed()));
     connect( placementCombo, SIGNAL(activated(int)), SLOT(changed()));
     connect( BrdrSnap, SIGNAL(valueChanged(int)), SLOT(changed()));
+    connect( BrdrSnap, SIGNAL(valueChanged(int)), SLOT(slotBrdrSnapChanged(int)));
     connect( WndwSnap, SIGNAL(valueChanged(int)), SLOT(changed()));
+    connect( WndwSnap, SIGNAL(valueChanged(int)), SLOT(slotWndwSnapChanged(int)));
     connect( OverlapSnap, SIGNAL(clicked()), SLOT(changed()));
+
+    // To get suffix to BrdrSnap and WndwSnap inputs with default values.
+    slotBrdrSnapChanged(BrdrSnap->value());
+    slotWndwSnapChanged(WndwSnap->value());
 }
 
 int KMovingConfig::getMove()
@@ -1007,6 +1019,14 @@
     moveResizeMaximized->setChecked(a);
 }
 
+void KMovingConfig::slotBrdrSnapChanged(int value) {
+    BrdrSnap->setSuffix(i18n(" pixel", " pixels", value));
+}
+
+void KMovingConfig::slotWndwSnapChanged(int value) {
+    WndwSnap->setSuffix(i18n(" pixel", " pixels", value));
+}
+
 void KMovingConfig::load( void )
 {
     QString key;
--- kdebase-3.5.2/kwin/kcmkwin/kwinoptions/windows.h	2006-01-19 12:01:05.000000000 -0500
+++ kdebase-3.5.2-new/kwin/kcmkwin/kwinoptions/windows.h	2006-04-14 16:18:25.000000000 -0400
@@ -85,6 +85,7 @@
   void autoRaiseOnTog(bool);//CT 23Oct1998
   void delayFocusOnTog(bool);
   void clickRaiseOnTog(bool);
+  void updateAltTabMode();
 	void changed() { emit KCModule::changed(true); }
 
 
@@ -138,6 +139,8 @@
   void setMinimizeAnim( bool );
   void setMinimizeAnimSpeed( int );
 	void changed() { emit KCModule::changed(true); }
+  void slotBrdrSnapChanged( int );
+  void slotWndwSnapChanged( int );
 
 private:
   int getMove( void );
--- kdebase-3.5.2/kwin/kcmkwin/kwinrules/main.cpp	2006-03-17 05:17:42.000000000 -0500
+++ kdebase-3.5.2-new/kwin/kcmkwin/kwinrules/main.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -119,8 +119,8 @@
             if( rule->types != NET::AllTypesMask )
                 {
                 int bits = 0;
-                for( int bit = 1;
-                     bit < 1 << 31;
+                for( unsigned int bit = 1;
+                     bit < 1U << 31;
                      bit <<= 1 )
                     if( rule->types & bit )
                         ++bits;
--- kdebase-3.5.2/kwin/killer/Makefile.am	2005-09-10 04:25:55.000000000 -0400
+++ kdebase-3.5.2-new/kwin/killer/Makefile.am	2006-04-14 16:18:20.000000000 -0400
@@ -1,9 +1,11 @@
 INCLUDES = $(all_includes)
 
-bin_PROGRAMS = kwin_killer_helper
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kwin_killer_helper.la
 
-kwin_killer_helper_SOURCES = killer.cpp
-kwin_killer_helper_LDADD = $(LIB_KDEUI)
-kwin_killer_helper_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+kwin_killer_helper_la_SOURCES = killer.cpp
+kwin_killer_helper_la_LIBADD = $(LIB_KDEUI)
+kwin_killer_helper_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 METASOURCES = AUTO
--- kdebase-3.5.2/kwin/killer/killer.cpp	2005-09-10 04:25:55.000000000 -0400
+++ kdebase-3.5.2-new/kwin/killer/killer.cpp	2006-04-14 16:18:20.000000000 -0400
@@ -43,7 +43,7 @@
         KCmdLineLastOption
     };
 
-int main( int argc, char* argv[] )
+extern "C" KDE_EXPORT int kdemain( int argc, char* argv[] )
     {
     KLocale::setMainCatalogue( "kwin" ); // the messages are in kwin's .po file
     KCmdLineArgs::init( argc, argv, "kwin_killer_helper", I18N_NOOP( "KWin" ),
--- kdebase-3.5.2/kwin/kompmgr/kompmgr.c	2006-03-17 05:17:43.000000000 -0500
+++ kdebase-3.5.2-new/kwin/kompmgr/kompmgr.c	2006-04-14 16:18:26.000000000 -0400
@@ -201,7 +201,7 @@
 typedef enum _compMode {
     CompSimple,		/* looks like a regular X server */
     CompServerShadows,	/* use window alpha for shadow; sharp, but precise */
-    CompClientShadows,	/* use window extents for shadow, blurred */
+    CompClientShadows	/* use window extents for shadow, blurred */
 } CompMode;
 
 static void
@@ -2878,7 +2878,16 @@
 									break;*/ /*skip if opacity does not change*/
 								if (fadeTrans)
 								{
-								    set_fade (dpy, w, w->opacity*1.0/OPAQUE, (tmp*1.0)/OPAQUE, fade_out_step, 0, False, True, True, False);
+									static double start, finish, step;
+									start = w->opacity*1.0/OPAQUE;
+									finish = (tmp*1.0)/OPAQUE;
+									
+									if ( start > finish )
+										step = fade_out_step;
+									else
+										step = fade_in_step;
+									
+								    set_fade (dpy, w, start, finish, step, 0, False, True, True, False);
                                     break;
                                     }
                                 else
--- kdebase-3.5.2/kwin/layers.cpp	2006-03-17 05:17:43.000000000 -0500
+++ kdebase-3.5.2-new/kwin/layers.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -100,7 +100,7 @@
     {
     if( block_stacking_updates > 0 )
         {
-        blocked_propagating_new_clients |= propagate_new_clients;
+        blocked_propagating_new_clients = blocked_propagating_new_clients || propagate_new_clients;
         return;
         }
     ClientList new_stacking_order = constrainedStackingOrder();
@@ -441,6 +441,21 @@
                 }
             }
       	}
+    // the same for global_focus_chain
+    if( c->wantsTabFocus() && global_focus_chain.contains( active_client ))
+        {
+        global_focus_chain.remove( c );
+        for( ClientList::Iterator it = global_focus_chain.fromLast();
+             it != global_focus_chain.end();
+             --it )
+            {
+            if( Client::belongToSameApplication( active_client, *it ))
+                {
+                global_focus_chain.insert( it, c );
+                break;
+                }
+            }
+      	}
     updateStackingOrder();
     }
 
--- kdebase-3.5.2/kwin/manage.cpp	2006-03-17 05:17:43.000000000 -0500
+++ kdebase-3.5.2-new/kwin/manage.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -455,7 +455,16 @@
         if( !isOnCurrentDesktop() && !isMapped && !session && ( allow || workspace()->sessionSaving()))
             workspace()->setCurrentDesktop( desktop());
 
-        if( workspace()->showingDesktop())
+        bool belongs_to_desktop = false;
+        for( ClientList::ConstIterator it = group()->members().begin();
+             it != group()->members().end();
+             ++it )
+            if( (*it)->isDesktop())
+                {
+                belongs_to_desktop = true;
+                break;
+                }
+        if( !belongs_to_desktop && workspace()->showingDesktop())
             workspace()->resetShowingDesktop( false );
 
         if( isOnCurrentDesktop() && !isMapped && !allow )
--- kdebase-3.5.2/kwin/popupinfo.cpp	2006-03-17 05:17:43.000000000 -0500
+++ kdebase-3.5.2-new/kwin/popupinfo.cpp	2006-04-14 16:18:26.000000000 -0400
@@ -38,6 +38,7 @@
     : QWidget( 0, name )
     {
     m_infoString = "";
+    m_shown = false;
     reset();
     reconfigure();
     connect(&m_delayedHideTimer, SIGNAL(timeout()), this, SLOT(hide()));
--- kdebase-3.5.2/kwin/tabbox.cpp	2006-03-17 05:17:43.000000000 -0500
+++ kdebase-3.5.2-new/kwin/tabbox.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -763,7 +763,7 @@
         return;
     if ( tab_grab || control_grab )
         return;
-    if ( options->altTabStyle == Options::CDE )
+    if ( options->altTabStyle == Options::CDE || !options->focusPolicyIsReasonable())
         {
         //XUngrabKeyboard(qt_xdisplay(), qt_x_time); // need that because of accelerator raw mode
         // CDE style raise / lower
@@ -789,7 +789,7 @@
         return;
     if( tab_grab || control_grab )
         return;
-    if ( options->altTabStyle == Options::CDE )
+    if ( options->altTabStyle == Options::CDE || !options->focusPolicyIsReasonable())
         {
         // CDE style raise / lower
         CDEWalkThroughWindows( false );
@@ -926,7 +926,23 @@
 
 void Workspace::CDEWalkThroughWindows( bool forward )
     {
-    Client* c = activeClient();
+    Client* c = NULL;
+// this function find the first suitable client for unreasonable focus
+// policies - the topmost one, with some exceptions (can't be keepabove/below,
+// otherwise it gets stuck on them)
+    Q_ASSERT( block_stacking_updates == 0 );
+    for( ClientList::ConstIterator it = stacking_order.fromLast();
+         it != stacking_order.end();
+         --it )
+        {
+        if ( (*it)->isOnCurrentDesktop() && !(*it)->isSpecialWindow()
+            && (*it)->isShown( false ) && (*it)->wantsTabFocus()
+            && !(*it)->keepAbove() && !(*it)->keepBelow())
+            {
+            c = *it;
+            break;
+            }
+        }
     Client* nc = c;
     bool options_traverse_all;
         {
@@ -952,7 +968,7 @@
             }
         } while (nc && nc != c &&
             (( !options_traverse_all && !nc->isOnDesktop(currentDesktop())) ||
-             nc->isMinimized() || !nc->wantsTabFocus() ) );
+             nc->isMinimized() || !nc->wantsTabFocus() || nc->keepAbove() || nc->keepBelow() ) );
     if (nc)
         {
         if (c && c != nc)
@@ -1152,14 +1168,13 @@
 */
 Client* Workspace::nextFocusChainClient( Client* c ) const
     {
-    int desktop = c->isOnAllDesktops() ? currentDesktop() : c->desktop();
-    if ( focus_chain[desktop].isEmpty() )
+    if ( global_focus_chain.isEmpty() )
         return 0;
-    ClientList::ConstIterator it = focus_chain[desktop].find( c );
-    if ( it == focus_chain[desktop].end() )
-        return focus_chain[desktop].last();
-    if ( it == focus_chain[desktop].begin() )
-        return focus_chain[desktop].last();
+    ClientList::ConstIterator it = global_focus_chain.find( c );
+    if ( it == global_focus_chain.end() )
+        return global_focus_chain.last();
+    if ( it == global_focus_chain.begin() )
+        return global_focus_chain.last();
     --it;
     return *it;
     }
@@ -1170,15 +1185,14 @@
 */
 Client* Workspace::previousFocusChainClient( Client* c ) const
     {
-    int desktop = c->isOnAllDesktops() ? currentDesktop() : c->desktop();
-    if ( focus_chain[desktop].isEmpty() )
+    if ( global_focus_chain.isEmpty() )
         return 0;
-    ClientList::ConstIterator it = focus_chain[desktop].find( c );
-    if ( it == focus_chain[desktop].end() )
-        return focus_chain[desktop].first();
+    ClientList::ConstIterator it = global_focus_chain.find( c );
+    if ( it == global_focus_chain.end() )
+        return global_focus_chain.first();
     ++it;
-    if ( it == focus_chain[desktop].end() )
-        return focus_chain[desktop].first();
+    if ( it == global_focus_chain.end() )
+        return global_focus_chain.first();
     return *it;
     }
 
--- kdebase-3.5.2/kwin/useractions.cpp	2005-11-08 17:36:42.000000000 -0500
+++ kdebase-3.5.2-new/kwin/useractions.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -391,6 +391,7 @@
             break;
         case Options::RestoreOp:
             c->maximize( Client::MaximizeRestore );
+            break;
         case Options::MinimizeOp:
             c->minimize();
             break;
@@ -471,7 +472,7 @@
             cancelShadeHover();
             break;
         case Options::MouseOperationsMenu:
-            if ( isActive() & options->clickRaise )
+            if ( isActive() && options->clickRaise )
                 autoRaise();
             workspace()->showWindowMenu( globalPos, this );
             break;
--- kdebase-3.5.2/kwin/utils.cpp	2006-03-17 05:17:43.000000000 -0500
+++ kdebase-3.5.2-new/kwin/utils.cpp	2006-04-14 16:18:26.000000000 -0400
@@ -309,9 +309,12 @@
         hostnamebuf[sizeof(hostnamebuf)-1] = 0;
         if (host == hostnamebuf)
             return true;
-        char *dot = strchr(hostnamebuf, '.');
-        if (dot && !(*dot = 0) && host == hostnamebuf)
-            return true;
+        if( char *dot = strchr(hostnamebuf, '.'))
+            {
+            *dot = '\0';
+            if( host == hostnamebuf )
+                return true;
+            }
         }
     return false;
     }
--- kdebase-3.5.2/kwin/utils.h	2006-03-17 05:17:43.000000000 -0500
+++ kdebase-3.5.2-new/kwin/utils.h	2006-04-14 16:18:25.000000000 -0400
@@ -232,15 +232,13 @@
 inline
 int timestampCompare( Time time1, Time time2 ) // like strcmp()
     {
-    if( time1 == time2 )
-        return 0;
-    return ( time1 - time2 ) < 1000000000 ? 1 : -1; // time1 > time2 -> 1, handle wrapping
+    return NET::timestampCompare( time1, time2 );
     }
 
 inline
 Time timestampDiff( Time time1, Time time2 ) // returns time2 - time1
-    { // no need to handle wrapping?
-    return time2 - time1;
+    {
+    return NET::timestampDiff( time1, time2 );
     }
 
 bool isLocalMachine( const QCString& host );
--- kdebase-3.5.2/kwin/workspace.cpp	2006-03-17 05:17:43.000000000 -0500
+++ kdebase-3.5.2-new/kwin/workspace.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -512,7 +512,7 @@
         }
     else
         {
-        updateFocusChains( c, true );
+        updateFocusChains( c, FocusChainUpdate ); // add to focus chain if not already there
         clients.append( c );
         }
     if( !unconstrained_stacking_order.contains( c ))
@@ -564,6 +564,7 @@
          i <= numberOfDesktops();
          ++i )
         focus_chain[ i ].remove( c );
+    global_focus_chain.remove( c );
     attention_chain.remove( c );
     if( c->isTopMenu())
         removeTopMenu( c );
@@ -590,7 +591,7 @@
     updateClientArea();
     }
 
-void Workspace::updateFocusChains( Client* c, bool make_first )
+void Workspace::updateFocusChains( Client* c, FocusChainChange change )
     {
     if( !c->wantsTabFocus()) // doesn't want tab focus, remove
         {
@@ -598,16 +599,21 @@
              i<= numberOfDesktops();
              ++i )
             focus_chain[i].remove(c);
+        global_focus_chain.remove( c );
         return;
         }
     if(c->desktop() == NET::OnAllDesktops)
         { //now on all desktops, add it to focus_chains it is not already in
         for( int i=1; i<= numberOfDesktops(); i++)
-            { // make_first works only on current desktop, don't affect all desktops
-            if( make_first && i == currentDesktop())
+            { // making first/last works only on current desktop, don't affect all desktops
+            if( i == currentDesktop()
+                && ( change == FocusChainMakeFirst || change == FocusChainMakeLast ))
                 {
                 focus_chain[ i ].remove( c );
-                focus_chain[ i ].append( c );
+                if( change == FocusChainMakeFirst )
+                    focus_chain[ i ].append( c );
+                else
+                    focus_chain[ i ].prepend( c );
                 }
             else if( !focus_chain[ i ].contains( c ))
                 focus_chain[ i ].prepend( c ); // otherwise add as the last one
@@ -619,11 +625,16 @@
             {
             if( i == c->desktop())
                 {
-                if( make_first )
+                if( change == FocusChainMakeFirst )
                     {
                     focus_chain[ i ].remove( c );
                     focus_chain[ i ].append( c );
                     }
+                else if( change == FocusChainMakeLast )
+                    {
+                    focus_chain[ i ].remove( c );
+                    focus_chain[ i ].prepend( c );
+                    }
                 else if( !focus_chain[ i ].contains( c ))
                     focus_chain[ i ].prepend( c );
                 }
@@ -631,6 +642,18 @@
                 focus_chain[ i ].remove( c );
             }
         }
+    if( change == FocusChainMakeFirst )
+        {
+        global_focus_chain.remove( c );
+        global_focus_chain.append( c );
+        }
+    else if( change == FocusChainMakeLast )
+        {
+        global_focus_chain.remove( c );
+        global_focus_chain.prepend( c );
+        }
+    else if( !global_focus_chain.contains( c ))
+        global_focus_chain.prepend( c );
     }
 
 void Workspace::updateCurrentTopMenu()
--- kdebase-3.5.2/kwin/workspace.h	2006-03-17 05:17:43.000000000 -0500
+++ kdebase-3.5.2-new/kwin/workspace.h	2006-04-14 16:18:25.000000000 -0400
@@ -251,7 +251,8 @@
         bool checkStartupNotification( Window w, KStartupInfoId& id, KStartupInfoData& data );
 
         void focusToNull(); // SELI public?
-        void updateFocusChains( Client* c, bool make_first );
+        enum FocusChainChange { FocusChainMakeFirst, FocusChainMakeLast, FocusChainUpdate };
+        void updateFocusChains( Client* c, FocusChainChange change );
         
         bool forcedGlobalMouseGrab() const;
         void clientShortcutUpdated( Client* c );
@@ -510,6 +511,7 @@
         ClientList unconstrained_stacking_order;
         ClientList stacking_order;
         QValueVector< ClientList > focus_chain;
+        ClientList global_focus_chain; // this one is only for things like tabbox's MRU
         ClientList should_get_focus; // last is most recent
         ClientList attention_chain;
         
--- kdebase-3.5.2/kxkb/kcmlayout.cpp	2006-03-17 05:17:41.000000000 -0500
+++ kdebase-3.5.2-new/kxkb/kcmlayout.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -40,8 +40,9 @@
  LAYOUT_COLUMN_MAP = 2,
  LAYOUT_COLUMN_VARIANT = 3,
  LAYOUT_COLUMN_INCLUDE = 4,
+ LAYOUT_COLUMN_DISPLAY_NAME = 5,
  SRC_LAYOUT_COLUMN_COUNT = 3,
- DST_LAYOUT_COLUMN_COUNT = 5
+ DST_LAYOUT_COLUMN_COUNT = 6
 };
 
 static const QString DEFAULT_VARIANT_NAME("<default>");
@@ -117,6 +118,8 @@
   connect( widget->listLayoutsDst, SIGNAL(selectionChanged(QListViewItem *)),
 		this, SLOT(layoutSelChanged(QListViewItem *)));
 
+  connect( widget->editDisplayName, SIGNAL(textChanged(const QString&)), this, SLOT(displayNameChanged(const QString&)));
+
   connect( widget->chkLatin, SIGNAL(clicked()), this, SLOT(changed()));
   connect( widget->chkLatin, SIGNAL(clicked()), this, SLOT(latinChanged()));
 
@@ -135,19 +138,23 @@
   widget->listLayoutsSrc->setColumnText(LAYOUT_COLUMN_FLAG, "");
   widget->listLayoutsDst->setColumnText(LAYOUT_COLUMN_FLAG, "");
   widget->listLayoutsDst->setColumnText(LAYOUT_COLUMN_INCLUDE, "");
+//  widget->listLayoutsDst->setColumnText(LAYOUT_COLUMN_DISPLAY_NAME, "");
 
   widget->listLayoutsSrc->setColumnWidth(LAYOUT_COLUMN_FLAG, 28);
   widget->listLayoutsDst->setColumnWidth(LAYOUT_COLUMN_FLAG, 28);
 
   widget->listLayoutsDst->header()->setResizeEnabled(FALSE, LAYOUT_COLUMN_INCLUDE);
+  widget->listLayoutsDst->header()->setResizeEnabled(FALSE, LAYOUT_COLUMN_DISPLAY_NAME);
   widget->listLayoutsDst->setColumnWidthMode(LAYOUT_COLUMN_INCLUDE, QListView::Manual);
   widget->listLayoutsDst->setColumnWidth(LAYOUT_COLUMN_INCLUDE, 0);
+//  widget->listLayoutsDst->setColumnWidth(LAYOUT_COLUMN_DISPLAY_NAME, 0);
   
   widget->listLayoutsDst->setSorting(-1);
 #if 0
   widget->listLayoutsDst->setResizeMode(QListView::LastColumn);
   widget->listLayoutsSrc->setResizeMode(QListView::LastColumn);
 #endif
+  widget->listLayoutsDst->setResizeMode(QListView::LastColumn);
 
   //Read rules - we _must_ read _before_ creating xkb-options comboboxes
   loadRules();
@@ -193,10 +200,10 @@
 				
 				newItem->setText(LAYOUT_COLUMN_VARIANT, layoutUnit.variant);
 				newItem->setText(LAYOUT_COLUMN_INCLUDE, layoutUnit.includeGroup);
+				newItem->setText(LAYOUT_COLUMN_DISPLAY_NAME, layoutUnit.displayName);
 				widget->listLayoutsDst->insertItem(newItem);
 				newItem->moveItem(widget->listLayoutsDst->lastItem());
 
-// 				m_includes[ layoutUnit ] = layoutUnit.includeGroup;
 				break;
 			}
 		}
@@ -274,13 +281,17 @@
 		QString layout = item->text(LAYOUT_COLUMN_MAP);
 		QString variant = item->text(LAYOUT_COLUMN_VARIANT);
 		QString includes = item->text(LAYOUT_COLUMN_INCLUDE);
+		QString displayName = item->text(LAYOUT_COLUMN_DISPLAY_NAME);
 		
 		LayoutUnit layoutUnit(layout, variant);
 		layoutUnit.includeGroup = includes;
+		layoutUnit.displayName = displayName;
 		layouts.append( layoutUnit );
 		
 		item = item->nextSibling();
-		kdDebug() << "Tosave: layout " << layoutUnit.toPair() << ", inc: " << layoutUnit.includeGroup << endl;
+		kdDebug() << "To save: layout " << layoutUnit.toPair() 
+				<< ", inc: " << layoutUnit.includeGroup 
+				<< ", disp: " << layoutUnit.displayName << endl;
 	}
 	m_kxkbConfig.m_layouts = layouts;
 
@@ -415,13 +426,42 @@
 }
 
 // helper
-static LayoutUnit getLayoutUnit(QListViewItem *sel)
+LayoutUnit LayoutConfig::getLayoutUnitKey(QListViewItem *sel)
 {
 	QString kbdLayout = sel->text(LAYOUT_COLUMN_MAP);
 	QString kbdVariant = sel->text(LAYOUT_COLUMN_VARIANT);
 	return LayoutUnit(kbdLayout, kbdVariant);
 }
 
+void LayoutConfig::displayNameChanged(const QString& newDisplayName)
+{
+	QListViewItem* selLayout = widget->listLayoutsDst->selectedItem();
+	if( selLayout == NULL )
+		return;
+	
+	const LayoutUnit layoutUnitKey = getLayoutUnitKey( selLayout );
+	LayoutUnit& layoutUnit = *m_kxkbConfig.m_layouts.find(layoutUnitKey);
+	
+	QString oldName = selLayout->text(LAYOUT_COLUMN_DISPLAY_NAME);
+	 
+	if( oldName.isEmpty() )
+		oldName = KxkbConfig::getDefaultDisplayName( layoutUnit );
+	
+	if( oldName != newDisplayName ) {
+		kdDebug() << "setting label for " << layoutUnit.toPair() << " : " << newDisplayName << endl;
+		selLayout->setText(LAYOUT_COLUMN_DISPLAY_NAME, newDisplayName);
+		updateIndicator(selLayout);
+		emit changed();
+	}
+}
+
+/** will update flag with label if layout label has been edited
+*/
+void LayoutConfig::updateIndicator(QListViewItem* selLayout)
+{
+}
+
+
 void LayoutConfig::latinChanged()
 {
     QListViewItem* selLayout = widget->listLayoutsDst->selectedItem();
@@ -438,24 +478,24 @@
 		include = "";
 	selLayout->setText(LAYOUT_COLUMN_INCLUDE, include);
 
- 	LayoutUnit layoutUnitKey = getLayoutUnit(selLayout);
+ 	LayoutUnit layoutUnitKey = getLayoutUnitKey(selLayout);
 	kdDebug() << "layout " << layoutUnitKey.toPair() << ", inc: " << include << endl;
 }
 
 void LayoutConfig::layoutSelChanged(QListViewItem *sel)
 {
     widget->comboVariant->clear();
-    widget->comboVariant->setEnabled( sel != 0 );
+    widget->comboVariant->setEnabled( sel != NULL );
     widget->chkLatin->setChecked( false );
-    widget->chkLatin->setEnabled( sel != 0 );
+    widget->chkLatin->setEnabled( sel != NULL );
 
-    if( sel == 0 ) {
+    if( sel == NULL ) {
         updateLayoutCommand();
         return;
     }
 
 
-	LayoutUnit layoutUnitKey = getLayoutUnit(sel);
+	LayoutUnit layoutUnitKey = getLayoutUnitKey(sel);
 	QString kbdLayout = layoutUnitKey.layout;
 
 	// TODO: need better algorithm here for determining if needs us group
@@ -578,9 +618,10 @@
 void LayoutConfig::updateLayoutCommand()
 {
   QString setxkbmap;
+  QString layoutDisplayName;
   QListViewItem* sel = widget->listLayoutsDst->selectedItem();
 
-  if( sel ) {
+  if( sel != NULL ) {
     QString kbdLayout = sel->text(LAYOUT_COLUMN_MAP);
     QString variant = widget->comboVariant->currentText();
 	if( variant == DEFAULT_VARIANT_NAME )
@@ -593,6 +634,23 @@
       setxkbmap += "us,";
     setxkbmap += kbdLayout;
 
+/*	LayoutUnit layoutUnitKey = getLayoutUnitKey(sel);
+	layoutDisplayName = m_kxkbConfig.getLayoutDisplayName( *m_kxkbConfig.m_layouts.find(layoutUnitKey) );*/
+	layoutDisplayName = sel->text(LAYOUT_COLUMN_DISPLAY_NAME);
+	if( layoutDisplayName.isEmpty() ) {
+		int count = 0;
+		QListViewItem *item = widget->listLayoutsDst->firstChild();
+		while (item) {
+			QString layout_ = item->text(LAYOUT_COLUMN_MAP);
+			if( layout_ == kbdLayout )
+				++count;
+			item = item->nextSibling();
+		}
+		bool single = count < 2;
+		layoutDisplayName = m_kxkbConfig.getDefaultDisplayName(LayoutUnit(kbdLayout, variant), single);
+	}
+	kdDebug() << "disp: '" << layoutDisplayName << "'" << endl;
+	
     if( !variant.isEmpty() ) {
       setxkbmap += " -variant ";
       if( widget->chkLatin->isChecked() )
@@ -600,7 +658,11 @@
       setxkbmap += variant;
     }
   }
+  
   widget->editCmdLine->setText(setxkbmap);
+  
+  widget->editDisplayName->setEnabled( sel != NULL );
+  widget->editDisplayName->setText(layoutDisplayName);
 }
 
 void LayoutConfig::changed()
--- kdebase-3.5.2/kxkb/kcmlayout.h	2006-03-17 05:17:41.000000000 -0500
+++ kdebase-3.5.2-new/kxkb/kcmlayout.h	2006-04-14 16:18:25.000000000 -0400
@@ -29,11 +29,13 @@
 
 protected:
   QString createOptionString();
+  void updateIndicator(QListViewItem* selLayout);
 
 protected slots:
   void moveUp();
   void moveDown();
   void variantChanged();
+  void displayNameChanged(const QString& name);
   void latinChanged();
   void layoutSelChanged(QListViewItem *);
   void loadRules();
@@ -53,6 +55,7 @@
 
   QWidget* makeOptionsTab();
   void updateStickyLimit();
+  static LayoutUnit getLayoutUnitKey(QListViewItem *sel);
 };
 
 
--- kdebase-3.5.2/kxkb/kcmlayoutwidget.ui	2006-03-17 05:17:41.000000000 -0500
+++ kdebase-3.5.2-new/kxkb/kcmlayoutwidget.ui	2006-04-14 16:18:25.000000000 -0400
@@ -8,8 +8,8 @@
         <rect>
             <x>0</x>
             <y>0</y>
-            <width>733</width>
-            <height>556</height>
+            <width>709</width>
+            <height>563</height>
         </rect>
     </property>
     <property name="sizePolicy">
@@ -26,14 +26,11 @@
             <height>510</height>
         </size>
     </property>
-    <vbox>
+    <grid>
         <property name="name">
             <cstring>unnamed</cstring>
         </property>
-        <property name="margin">
-            <number>0</number>
-        </property>
-        <widget class="QTabWidget">
+        <widget class="QTabWidget" row="0" column="0">
             <property name="name">
                 <cstring>tabWidget</cstring>
             </property>
@@ -79,287 +76,247 @@
                             <property name="name">
                                 <cstring>unnamed</cstring>
                             </property>
-                            <widget class="QLayoutWidget" row="0" column="0" rowspan="1" colspan="2">
+                            <widget class="QLabel" row="2" column="0" rowspan="1" colspan="2">
                                 <property name="name">
-                                    <cstring>layout5</cstring>
+                                    <cstring>textLabel1_4</cstring>
                                 </property>
-                                <grid>
+                                <property name="text">
+                                    <string>Available layouts:</string>
+                                </property>
+                            </widget>
+                            <widget class="QLabel" row="2" column="2" rowspan="1" colspan="3">
+                                <property name="name">
+                                    <cstring>textLabel1_4_2</cstring>
+                                </property>
+                                <property name="text">
+                                    <string>Active layouts:</string>
+                                </property>
+                            </widget>
+                            <widget class="QLabel" row="0" column="2" rowspan="1" colspan="3">
+                                <property name="name">
+                                    <cstring>textLabel1_2</cstring>
+                                </property>
+                                <property name="text">
+                                    <string>Keyboard &amp;model:</string>
+                                </property>
+                                <property name="buddy" stdset="0">
+                                    <cstring>comboModel</cstring>
+                                </property>
+                            </widget>
+                            <widget class="QComboBox" row="1" column="2" rowspan="1" colspan="3">
+                                <property name="name">
+                                    <cstring>comboModel</cstring>
+                                </property>
+                                <property name="sizePolicy">
+                                    <sizepolicy>
+                                        <hsizetype>7</hsizetype>
+                                        <vsizetype>0</vsizetype>
+                                        <horstretch>0</horstretch>
+                                        <verstretch>0</verstretch>
+                                    </sizepolicy>
+                                </property>
+                                <property name="whatsThis" stdset="0">
+                                    <string>Here you can choose a keyboard model. This setting is independent of your keyboard layout and refers to the "hardware" model, i.e. the way your keyboard is manufactured. Modern keyboards that come with your computer usually have two extra keys and are referred to as "104-key" models, which is probably what you want if you do not know what kind of keyboard you have.
+</string>
+                                </property>
+                            </widget>
+                            <widget class="QListView" row="3" column="2" rowspan="1" colspan="3">
+                                <column>
+                                    <property name="text">
+                                        <string>1</string>
+                                    </property>
+                                    <property name="clickable">
+                                        <bool>false</bool>
+                                    </property>
+                                    <property name="resizable">
+                                        <bool>false</bool>
+                                    </property>
+                                </column>
+                                <column>
+                                    <property name="text">
+                                        <string>Layout</string>
+                                    </property>
+                                    <property name="clickable">
+                                        <bool>false</bool>
+                                    </property>
+                                    <property name="resizable">
+                                        <bool>true</bool>
+                                    </property>
+                                </column>
+                                <column>
+                                    <property name="text">
+                                        <string>Keymap</string>
+                                    </property>
+                                    <property name="clickable">
+                                        <bool>false</bool>
+                                    </property>
+                                    <property name="resizable">
+                                        <bool>true</bool>
+                                    </property>
+                                </column>
+                                <column>
+                                    <property name="text">
+                                        <string>Variant</string>
+                                    </property>
+                                    <property name="clickable">
+                                        <bool>false</bool>
+                                    </property>
+                                    <property name="resizable">
+                                        <bool>true</bool>
+                                    </property>
+                                </column>
+                                <column>
+                                    <property name="text">
+                                        <string>5</string>
+                                    </property>
+                                    <property name="clickable">
+                                        <bool>false</bool>
+                                    </property>
+                                    <property name="resizable">
+                                        <bool>false</bool>
+                                    </property>
+                                </column>
+                                <column>
+                                    <property name="text">
+                                        <string>Label</string>
+                                    </property>
+                                    <property name="clickable">
+                                        <bool>false</bool>
+                                    </property>
+                                    <property name="resizable">
+                                        <bool>false</bool>
+                                    </property>
+                                </column>
+                                <property name="name">
+                                    <cstring>listLayoutsDst</cstring>
+                                </property>
+                                <property name="allColumnsShowFocus">
+                                    <bool>true</bool>
+                                </property>
+                                <property name="whatsThis" stdset="0">
+                                    <string>If more than one layout is present in this list, the KDE panel will offer a docked flag. By clicking on this flag you can easily switch between layouts. The first layout will be default one.</string>
+                                </property>
+                            </widget>
+                            <widget class="QLayoutWidget" row="4" column="2" rowspan="1" colspan="3">
+                                <property name="name">
+                                    <cstring>layout10</cstring>
+                                </property>
+                                <hbox>
                                     <property name="name">
                                         <cstring>unnamed</cstring>
                                     </property>
-                                    <widget class="QLabel" row="2" column="0">
+                                    <widget class="QPushButton">
                                         <property name="name">
-                                            <cstring>textLabel1_4</cstring>
+                                            <cstring>btnAdd</cstring>
                                         </property>
                                         <property name="text">
-                                            <string>Available layouts:</string>
+                                            <string>Add &gt;&gt;</string>
                                         </property>
                                     </widget>
-                                    <widget class="QLabel" row="2" column="1">
+                                    <widget class="QPushButton">
                                         <property name="name">
-                                            <cstring>textLabel1_4_2</cstring>
+                                            <cstring>btnRemove</cstring>
                                         </property>
                                         <property name="text">
-                                            <string>Active layouts:</string>
+                                            <string>&lt;&lt; Remove</string>
                                         </property>
                                     </widget>
-                                    <widget class="QLabel" row="0" column="1">
+                                    <widget class="QPushButton">
                                         <property name="name">
-                                            <cstring>textLabel1_2</cstring>
-                                        </property>
-                                        <property name="text">
-                                            <string>Keyboard &amp;model:</string>
-                                        </property>
-                                        <property name="buddy" stdset="0">
-                                            <cstring>comboModel</cstring>
-                                        </property>
-                                    </widget>
-                                    <widget class="QComboBox" row="1" column="1">
-                                        <property name="name">
-                                            <cstring>comboModel</cstring>
+                                            <cstring>btnUp</cstring>
                                         </property>
                                         <property name="sizePolicy">
                                             <sizepolicy>
-                                                <hsizetype>7</hsizetype>
+                                                <hsizetype>0</hsizetype>
                                                 <vsizetype>0</vsizetype>
                                                 <horstretch>0</horstretch>
                                                 <verstretch>0</verstretch>
                                             </sizepolicy>
                                         </property>
-                                        <property name="whatsThis" stdset="0">
-                                            <string>Here you can choose a keyboard model. This setting is independent of your keyboard layout and refers to the "hardware" model, i.e. the way your keyboard is manufactured. Modern keyboards that come with your computer usually have two extra keys and are referred to as "104-key" models, which is probably what you want if you do not know what kind of keyboard you have.
-</string>
-                                        </property>
-                                    </widget>
-                                    <widget class="QCheckBox" row="6" column="1">
-                                        <property name="name">
-                                            <cstring>chkLatin</cstring>
-                                        </property>
-                                        <property name="enabled">
-                                            <bool>false</bool>
-                                        </property>
                                         <property name="text">
-                                            <string>Include latin layout</string>
-                                        </property>
-                                        <property name="whatsThis" stdset="0">
-                                            <string>If after you switch to this layout some keyboard shortcuts based on latin keys do not work try to enable this option.</string>
-                                        </property>
-                                    </widget>
-                                    <widget class="QListView" row="3" column="1">
-                                        <column>
-                                            <property name="text">
-                                                <string></string>
-                                            </property>
-                                            <property name="clickable">
-                                                <bool>false</bool>
-                                            </property>
-                                            <property name="resizable">
-                                                <bool>false</bool>
-                                            </property>
-                                        </column>
-                                        <column>
-                                            <property name="text">
-                                                <string>Layout</string>
-                                            </property>
-                                            <property name="clickable">
-                                                <bool>false</bool>
-                                            </property>
-                                            <property name="resizable">
-                                                <bool>true</bool>
-                                            </property>
-                                        </column>
-                                        <column>
-                                            <property name="text">
-                                                <string>Keymap</string>
-                                            </property>
-                                            <property name="clickable">
-                                                <bool>false</bool>
-                                            </property>
-                                            <property name="resizable">
-                                                <bool>true</bool>
-                                            </property>
-                                        </column>
-                                        <column>
-                                            <property name="text">
-                                                <string>Variant</string>
-                                            </property>
-                                            <property name="clickable">
-                                                <bool>false</bool>
-                                            </property>
-                                            <property name="resizable">
-                                                <bool>true</bool>
-                                            </property>
-                                        </column>
-                                        <column>
-                                            <property name="text">
-                                                <string></string>
-                                            </property>
-                                            <property name="clickable">
-                                                <bool>false</bool>
-                                            </property>
-                                            <property name="resizable">
-                                                <bool>false</bool>
-                                            </property>
-                                        </column>
-                                        <property name="name">
-                                            <cstring>listLayoutsDst</cstring>
-                                        </property>
-                                        <property name="allColumnsShowFocus">
-                                            <bool>true</bool>
-                                        </property>
-                                        <property name="whatsThis" stdset="0">
-                                            <string>If more than one layout is present in this list, the KDE panel will offer a docked flag. By clicking on this flag you can easily switch between layouts. The first layout will be default one.</string>
+                                            <string></string>
                                         </property>
                                     </widget>
-                                    <widget class="QLayoutWidget" row="5" column="1">
+                                    <widget class="QPushButton">
                                         <property name="name">
-                                            <cstring>layout11</cstring>
+                                            <cstring>btnDown</cstring>
                                         </property>
-                                        <hbox>
-                                            <property name="name">
-                                                <cstring>unnamed</cstring>
-                                            </property>
-                                            <widget class="QLabel">
-                                                <property name="name">
-                                                    <cstring>textLabel1</cstring>
-                                                </property>
-                                                <property name="text">
-                                                    <string>Layout variant:</string>
-                                                </property>
-                                                <property name="buddy" stdset="0">
-                                                    <cstring>comboVariant</cstring>
-                                                </property>
-                                            </widget>
-                                            <widget class="QComboBox">
-                                                <property name="name">
-                                                    <cstring>comboVariant</cstring>
-                                                </property>
-                                                <property name="whatsThis" stdset="0">
-                                                    <string>Here you can choose a variant of selected keyboard layout. Layout variants usually represent different key maps for the same language. For example, Ukrainian layout might have four variants: basic, winkeys (as in Windows), typewriter (as in typewriters) and phonetic (each Ukrainian letter is placed on a transliterated latin one).
-</string>
-                                                </property>
-                                            </widget>
-                                        </hbox>
-                                    </widget>
-                                    <widget class="QLayoutWidget" row="4" column="1">
-                                        <property name="name">
-                                            <cstring>layout10</cstring>
-                                        </property>
-                                        <hbox>
-                                            <property name="name">
-                                                <cstring>unnamed</cstring>
-                                            </property>
-                                            <widget class="QPushButton">
-                                                <property name="name">
-                                                    <cstring>btnAdd</cstring>
-                                                </property>
-                                                <property name="text">
-                                                    <string>Add &gt;&gt;</string>
-                                                </property>
-                                            </widget>
-                                            <widget class="QPushButton">
-                                                <property name="name">
-                                                    <cstring>btnRemove</cstring>
-                                                </property>
-                                                <property name="text">
-                                                    <string>&lt;&lt; Remove</string>
-                                                </property>
-                                            </widget>
-                                            <widget class="QPushButton">
-                                                <property name="name">
-                                                    <cstring>btnUp</cstring>
-                                                </property>
-                                                <property name="sizePolicy">
-                                                    <sizepolicy>
-                                                        <hsizetype>0</hsizetype>
-                                                        <vsizetype>0</vsizetype>
-                                                        <horstretch>0</horstretch>
-                                                        <verstretch>0</verstretch>
-                                                    </sizepolicy>
-                                                </property>
-                                                <property name="text">
-                                                    <string></string>
-                                                </property>
-                                            </widget>
-                                            <widget class="QPushButton">
-                                                <property name="name">
-                                                    <cstring>btnDown</cstring>
-                                                </property>
-                                                <property name="sizePolicy">
-                                                    <sizepolicy>
-                                                        <hsizetype>0</hsizetype>
-                                                        <vsizetype>0</vsizetype>
-                                                        <horstretch>0</horstretch>
-                                                        <verstretch>0</verstretch>
-                                                    </sizepolicy>
-                                                </property>
-                                                <property name="text">
-                                                    <string></string>
-                                                </property>
-                                            </widget>
-                                        </hbox>
-                                    </widget>
-                                    <widget class="QListView" row="3" column="0" rowspan="4" colspan="1">
-                                        <column>
-                                            <property name="text">
-                                                <string></string>
-                                            </property>
-                                            <property name="clickable">
-                                                <bool>false</bool>
-                                            </property>
-                                            <property name="resizable">
-                                                <bool>false</bool>
-                                            </property>
-                                        </column>
-                                        <column>
-                                            <property name="text">
-                                                <string>Layout</string>
-                                            </property>
-                                            <property name="clickable">
-                                                <bool>false</bool>
-                                            </property>
-                                            <property name="resizable">
-                                                <bool>true</bool>
-                                            </property>
-                                        </column>
-                                        <column>
-                                            <property name="text">
-                                                <string>Keymap</string>
-                                            </property>
-                                            <property name="clickable">
-                                                <bool>false</bool>
-                                            </property>
-                                            <property name="resizable">
-                                                <bool>true</bool>
-                                            </property>
-                                        </column>
-                                        <property name="name">
-                                            <cstring>listLayoutsSrc</cstring>
-                                        </property>
-                                        <property name="minimumSize">
-                                            <size>
-                                                <width>260</width>
-                                                <height>0</height>
-                                            </size>
-                                        </property>
-                                        <property name="allColumnsShowFocus">
-                                            <bool>true</bool>
+                                        <property name="sizePolicy">
+                                            <sizepolicy>
+                                                <hsizetype>0</hsizetype>
+                                                <vsizetype>0</vsizetype>
+                                                <horstretch>0</horstretch>
+                                                <verstretch>0</verstretch>
+                                            </sizepolicy>
                                         </property>
-                                        <property name="whatsThis" stdset="0">
-                                            <string>This is the list of available keyboard layouts in your system. You can add layout to the active list by selecting it and pressing "Add" button.</string>
+                                        <property name="text">
+                                            <string></string>
                                         </property>
                                     </widget>
-                                </grid>
+                                </hbox>
                             </widget>
-                            <widget class="QLabel" row="1" column="0">
+                            <widget class="QLabel" row="8" column="0">
                                 <property name="name">
                                     <cstring>textLabel1_3</cstring>
                                 </property>
                                 <property name="text">
                                     <string>Command:</string>
                                 </property>
+                                <property name="buddy" stdset="0">
+                                    <cstring>editCmdLine</cstring>
+                                </property>
+                            </widget>
+                            <widget class="QListView" row="3" column="0" rowspan="5" colspan="2">
+                                <column>
+                                    <property name="text">
+                                        <string></string>
+                                    </property>
+                                    <property name="clickable">
+                                        <bool>false</bool>
+                                    </property>
+                                    <property name="resizable">
+                                        <bool>false</bool>
+                                    </property>
+                                </column>
+                                <column>
+                                    <property name="text">
+                                        <string>Layout</string>
+                                    </property>
+                                    <property name="clickable">
+                                        <bool>false</bool>
+                                    </property>
+                                    <property name="resizable">
+                                        <bool>true</bool>
+                                    </property>
+                                </column>
+                                <column>
+                                    <property name="text">
+                                        <string>Keymap</string>
+                                    </property>
+                                    <property name="clickable">
+                                        <bool>false</bool>
+                                    </property>
+                                    <property name="resizable">
+                                        <bool>true</bool>
+                                    </property>
+                                </column>
+                                <property name="name">
+                                    <cstring>listLayoutsSrc</cstring>
+                                </property>
+                                <property name="minimumSize">
+                                    <size>
+                                        <width>260</width>
+                                        <height>0</height>
+                                    </size>
+                                </property>
+                                <property name="allColumnsShowFocus">
+                                    <bool>true</bool>
+                                </property>
+                                <property name="whatsThis" stdset="0">
+                                    <string>This is the list of available keyboard layouts in your system. You can add layout to the active list by selecting it and pressing "Add" button.</string>
+                                </property>
                             </widget>
-                            <widget class="QLineEdit" row="1" column="1">
+                            <widget class="QLineEdit" row="8" column="1" rowspan="1" colspan="4">
                                 <property name="name">
                                     <cstring>editCmdLine</cstring>
                                 </property>
@@ -370,6 +327,96 @@
                                     <string>This is the command which is executed when switching to the selected layout. It may help you if you want to debug layout switching, or if you want to switch layouts without the help of KDE.</string>
                                 </property>
                             </widget>
+                            <widget class="QCheckBox" row="7" column="2" rowspan="1" colspan="3">
+                                <property name="name">
+                                    <cstring>chkLatin</cstring>
+                                </property>
+                                <property name="enabled">
+                                    <bool>false</bool>
+                                </property>
+                                <property name="text">
+                                    <string>Include latin layout</string>
+                                </property>
+                                <property name="whatsThis" stdset="0">
+                                    <string>If after you switch to this layout some keyboard shortcuts based on latin keys do not work try to enable this option.</string>
+                                </property>
+                            </widget>
+                            <widget class="QLabel" row="6" column="2">
+                                <property name="name">
+                                    <cstring>textLabel1_6</cstring>
+                                </property>
+                                <property name="text">
+                                    <string>Label:</string>
+                                </property>
+                                <property name="buddy" stdset="0">
+                                    <cstring>editDisplayName</cstring>
+                                </property>
+                            </widget>
+                            <widget class="QLineEdit" row="6" column="3">
+                                <property name="name">
+                                    <cstring>editDisplayName</cstring>
+                                </property>
+                                <property name="enabled">
+                                    <bool>false</bool>
+                                </property>
+                                <property name="maxLength">
+                                    <number>3</number>
+                                </property>
+                            </widget>
+                            <widget class="QLabel" row="5" column="2">
+                                <property name="name">
+                                    <cstring>textLabel1</cstring>
+                                </property>
+                                <property name="text">
+                                    <string>Layout variant:</string>
+                                </property>
+                                <property name="buddy" stdset="0">
+                                    <cstring>comboVariant</cstring>
+                                </property>
+                            </widget>
+                            <widget class="QComboBox" row="5" column="3">
+                                <property name="name">
+                                    <cstring>comboVariant</cstring>
+                                </property>
+                                <property name="whatsThis" stdset="0">
+                                    <string>Here you can choose a variant of selected keyboard layout. Layout variants usually represent different key maps for the same language. For example, Ukrainian layout might have four variants: basic, winkeys (as in Windows), typewriter (as in typewriters) and phonetic (each Ukrainian letter is placed on a transliterated latin one).
+</string>
+                                </property>
+                            </widget>
+                            <spacer row="5" column="4">
+                                <property name="name">
+                                    <cstring>spacer3</cstring>
+                                </property>
+                                <property name="orientation">
+                                    <enum>Horizontal</enum>
+                                </property>
+                                <property name="sizeType">
+                                    <enum>Expanding</enum>
+                                </property>
+                                <property name="sizeHint">
+                                    <size>
+                                        <width>210</width>
+                                        <height>20</height>
+                                    </size>
+                                </property>
+                            </spacer>
+                            <spacer row="6" column="4">
+                                <property name="name">
+                                    <cstring>spacer2</cstring>
+                                </property>
+                                <property name="orientation">
+                                    <enum>Horizontal</enum>
+                                </property>
+                                <property name="sizeType">
+                                    <enum>Expanding</enum>
+                                </property>
+                                <property name="sizeHint">
+                                    <size>
+                                        <width>210</width>
+                                        <height>20</height>
+                                    </size>
+                                </property>
+                            </spacer>
                         </grid>
                     </widget>
                 </grid>
@@ -624,7 +671,7 @@
                 </vbox>
             </widget>
         </widget>
-    </vbox>
+    </grid>
 </widget>
 <connections>
     <connection>
--- kdebase-3.5.2/kxkb/kxkbconfig.cpp	2006-03-17 05:17:41.000000000 -0500
+++ kdebase-3.5.2-new/kxkb/kxkbconfig.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -181,25 +181,38 @@
 	config->writeEntry("Options", m_options );
 
 	QStringList layoutList;
+	QStringList includeList;
+	QStringList displayNamesList;
+	
 	QValueList<LayoutUnit>::ConstIterator it;
 	for(it = m_layouts.begin(); it != m_layouts.end(); ++it) {
-		layoutList.append( (*it).toPair() );
-	}
-	
-	config->writeEntry("LayoutList", layoutList);
-	kdDebug() << "Saving Layouts: " << layoutList << endl;
-
-
- 	QStringList includeList;
-	for(QValueList<LayoutUnit>::ConstIterator it = m_layouts.begin(); it != m_layouts.end(); ++it) {
 		const LayoutUnit& layoutUnit = *it;
+		
+		layoutList.append( layoutUnit.toPair() );
+		
 		if( layoutUnit.includeGroup.isEmpty() == false ) {
 			QString incGroupUnit = QString("%1:%2").arg(layoutUnit.toPair(), layoutUnit.includeGroup);
 			includeList.append( incGroupUnit );
 		}
- 	}
- 	config->writeEntry("IncludeGroups", includeList);
+	
+		QString displayName( layoutUnit.displayName );
+		kdDebug() << " displayName " << layoutUnit.toPair() << " : " << displayName << endl;
+		if( displayName.isEmpty() == false && displayName != layoutUnit.layout ) {
+			displayName = QString("%1:%2").arg(layoutUnit.toPair(), displayName);
+			displayNamesList.append( displayName );
+		}
+	}
+	
+	config->writeEntry("LayoutList", layoutList);
+	kdDebug() << "Saving Layouts: " << layoutList << endl;
+ 	
+	config->writeEntry("IncludeGroups", includeList);
  	kdDebug() << "Saving includeGroups: " << includeList << endl;
+	
+//	if( displayNamesList.empty() == false )
+		config->writeEntry("DisplayNames", displayNamesList);
+// 	else
+// 		config->deleteEntry("DisplayNames");
 
 	config->writeEntry("Use", m_useKxkb);
 	config->writeEntry("ShowSingle", m_showSingle);
@@ -255,6 +268,40 @@
 }
 
 
+QString KxkbConfig::getDefaultDisplayName(const QString& code_)
+{
+	QString displayName;
+	
+	if( code_.length() <= 2 ) {
+		displayName = code_;
+	}
+	else {
+		int sepPos = code_.find(QRegExp("[-_]"));
+		QString leftCode = code_.mid(0, sepPos);
+		QString rightCode;
+		if( sepPos != -1 )
+			rightCode = code_.mid(sepPos+1);
+		
+		if( rightCode.length() > 0 )
+			displayName = leftCode.left(2) + rightCode.left(1).lower();
+		else
+			displayName = leftCode.left(3);
+	}
+	
+	return displayName;
+}
+
+QString KxkbConfig::getDefaultDisplayName(const LayoutUnit& layoutUnit, bool single)
+{
+	if( layoutUnit.variant == "" )
+		return getDefaultDisplayName( layoutUnit.layout );
+	
+	QString displayName = layoutUnit.layout.left(2);
+	if( single == false )
+		displayName += layoutUnit.variant.left(1);
+	return displayName;
+}
+
 /**
  * @brief Gets the single layout part of a layout(variant) string
  * @param[in] layvar String in form layout(variant) to parse
--- kdebase-3.5.2/kxkb/kxkbconfig.h	2006-03-17 05:17:41.000000000 -0500
+++ kdebase-3.5.2-new/kxkb/kxkbconfig.h	2006-04-14 16:18:25.000000000 -0400
@@ -111,7 +111,9 @@
 	void setDefaults();
 	
 	QStringList getLayoutStringList(/*bool compact*/);
-	
+	static QString getDefaultDisplayName(const QString& code_);
+	static QString getDefaultDisplayName(const LayoutUnit& layoutUnit, bool single=false);
+
 private:	
 	static const QMap<QString, QString> parseIncludesMap(const QStringList& pairList);
 };
--- kdebase-3.5.2/kxkb/pixmap.cpp	2006-03-17 05:17:41.000000000 -0500
+++ kdebase-3.5.2-new/kxkb/pixmap.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -11,6 +11,7 @@
 
 #include "pixmap.h"
 #include "x11helper.h"
+#include "kxkbconfig.h"
 
 
 static const int FLAG_MAX_WIDTH = 21;
@@ -53,7 +54,7 @@
 	QString displayName(displayName_);
 	
 	if( displayName.isEmpty() ) {
-		displayName = getDefaultDisplayName(code_);
+		displayName = KxkbConfig::getDefaultDisplayName(code_);
 	}
 	if( displayName.length() > 3 )
 		displayName = displayName.left(3);
@@ -110,29 +111,6 @@
 	return *pm;
 }
 
-QString LayoutIcon::getDefaultDisplayName(const QString& code_)
-{
-	QString displayName;
-	
-	if( code_.length() <= 2 ) {
-		displayName = code_;
-	}
-	else {
-		int sepPos = code_.find(QRegExp("[-_]"));
-		QString leftCode = code_.mid(0, sepPos);
-		QString rightCode;
-		if( sepPos != -1 )
-			rightCode = code_.mid(sepPos+1);
-		
-		if( rightCode.length() > 0 )
-			displayName = leftCode.left(2) + rightCode.left(1).lower();
-		else
-			displayName = leftCode.left(3);
-	}
-	
-	return displayName;
-}
-
 /**
 @brief Try to get country code from layout name in xkb before xorg 6.9.0
 */
@@ -151,10 +129,13 @@
 		else
 			if( layoutName.endsWith("/jp") )
 				flag = "jp";
+        else
+            if( layoutName == "trq" || layoutName == "trf" || layoutName == "tralt" )
+                flag = "tr";
 		else
 			if( layoutName.length() > 2 )
 				flag = "";
-			else
+		else
 				flag = layoutName;
 	}
 	else {
@@ -218,9 +199,8 @@
 			}
 		}
 	}
-
 	
-	return flag;
+    return flag;
 }
 
 
--- kdebase-3.5.2/kxkb/pixmap.h	2006-03-17 05:17:41.000000000 -0500
+++ kdebase-3.5.2-new/kxkb/pixmap.h	2006-04-14 16:18:25.000000000 -0400
@@ -20,7 +20,6 @@
 	QPixmap* createErrorPixmap();
 	void dimPixmap(QPixmap& pixmap);
 	QString getCountryFromLayoutName(const QString& layoutName);
-	QString getDefaultDisplayName(const QString& layoutName);
 	
   public:
 	static const QString& ERROR_CODE;
--- kdebase-3.5.2/kxkb/x11helper.cpp	2006-03-17 05:17:41.000000000 -0500
+++ kdebase-3.5.2-new/kxkb/x11helper.cpp	2006-04-14 16:18:25.000000000 -0400
@@ -23,7 +23,7 @@
 static const char* X11DirList[] =
     {
         XLIBDIR,
-        "/etc/X11",
+        "/etc/X11/",
         "/usr/share/X11/",
         "/usr/local/share/X11/",
         "/usr/X11R6/lib/X11/",
--- kdebase-3.5.2/libkonq/Makefile.am	2005-10-10 11:04:21.000000000 -0400
+++ kdebase-3.5.2-new/libkonq/Makefile.am	2006-04-14 16:18:20.000000000 -0400
@@ -21,7 +21,7 @@
 
 lib_LTLIBRARIES = libkonq.la
 libkonq_la_LDFLAGS = $(all_libraries) -version-info 6:0:2 -no-undefined
-libkonq_la_LIBADD = $(LIB_KPARTS)
+libkonq_la_LIBADD = $(LIB_KPARTS) $(LIBZ)
 
 libkonq_la_SOURCES = konq_popupmenu.cc knewmenu.cc \
    konq_xmlguiclient.cc\
--- kdebase-3.5.2/libkonq/konq_dirpart.cc	2006-03-17 05:17:42.000000000 -0500
+++ kdebase-3.5.2-new/libkonq/konq_dirpart.cc	2006-04-14 16:18:25.000000000 -0400
@@ -697,7 +697,7 @@
     m_dirPart->saveState( stream );
     bool hasFindPart = m_dirPart->findPart();
     stream << hasFindPart;
-    assert( ! ( hasFindPart && m_dirPart->className() == "KFindPart" ) );
+    assert( ! ( hasFindPart && !strcmp(m_dirPart->className(), "KFindPart") ) );
     if ( !hasFindPart )
         KParts::BrowserExtension::saveState( stream );
     else {
@@ -710,7 +710,7 @@
     m_dirPart->restoreState( stream );
     bool hasFindPart;
     stream >> hasFindPart;
-    assert( ! ( hasFindPart && m_dirPart->className() == "KFindPart" ) );
+    assert( ! ( hasFindPart && !strcmp(m_dirPart->className(), "KFindPart") ) );
     if ( !hasFindPart )
         // This calls openURL, that's why we don't want to call it in case of a find part
         KParts::BrowserExtension::restoreState( stream );
--- kdebase-3.5.2/libkonq/konq_operations.cc	2005-10-10 11:04:21.000000000 -0400
+++ kdebase-3.5.2-new/libkonq/konq_operations.cc	2006-04-14 16:18:25.000000000 -0400
@@ -650,19 +650,18 @@
     {
         connect( job, SIGNAL( result( KIO::Job * ) ),
                  SLOT( slotResult( KIO::Job * ) ) );
+        KIO::CopyJob *copyJob = dynamic_cast<KIO::CopyJob*>(job);
+        KonqIconViewWidget *iconView = dynamic_cast<KonqIconViewWidget*>(parent());
+        if (copyJob && iconView)
+        {
+            connect(copyJob, SIGNAL(aboutToCreate(KIO::Job *,const QValueList<KIO::CopyInfo> &)),
+                 this, SLOT(slotAboutToCreate(KIO::Job *,const QValueList<KIO::CopyInfo> &)));
+            connect(this, SIGNAL(aboutToCreate(const QPoint &, const QValueList<KIO::CopyInfo> &)),
+                 iconView, SLOT(slotAboutToCreate(const QPoint &, const QValueList<KIO::CopyInfo> &)));
+        }
     }
     else // for link
         slotResult( 0L );
-
-    KIO::CopyJob *copyJob = dynamic_cast<KIO::CopyJob*>(job);
-    KonqIconViewWidget *iconView = dynamic_cast<KonqIconViewWidget*>(parent());
-    if (copyJob && iconView)
-    {
-        connect(copyJob, SIGNAL(aboutToCreate(KIO::Job *,const QValueList<KIO::CopyInfo> &)),
-             this, SLOT(slotAboutToCreate(KIO::Job *,const QValueList<KIO::CopyInfo> &)));
-        connect(this, SIGNAL(aboutToCreate(const QPoint &, const QValueList<KIO::CopyInfo> &)),
-             iconView, SLOT(slotAboutToCreate(const QPoint &, const QValueList<KIO::CopyInfo> &)));
-    }
 }
 
 void KonqOperations::slotAboutToCreate(KIO::Job *, const QValueList<KIO::CopyInfo> &files)
--- kdebase-3.5.2/libkonq/konq_popupmenu.cc	2006-03-17 05:17:42.000000000 -0500
+++ kdebase-3.5.2-new/libkonq/konq_popupmenu.cc	2006-04-14 16:18:25.000000000 -0400
@@ -658,145 +658,138 @@
             }
         }
 
-        QStringList dirs = KGlobal::dirs()->findDirs( "data", "konqueror/servicemenus/" );
-        QStringList::ConstIterator dIt = dirs.begin();
-        QStringList::ConstIterator dEnd = dirs.end();
-
-        for (; dIt != dEnd; ++dIt )
+        // findAllResources() also removes duplicates
+        const QStringList entries = KGlobal::dirs()->findAllResources("data",
+                                                                      "konqueror/servicemenus/*.desktop",
+                                                                      false /* recursive */,
+                                                                      true /* unique */);
+        QStringList::ConstIterator eIt = entries.begin();
+        const QStringList::ConstIterator eEnd = entries.end();
+        for (; eIt != eEnd; ++eIt )
         {
-            QDir dir( *dIt );
-
-            QStringList entries = dir.entryList( "*.desktop", QDir::Files );
-            QStringList::ConstIterator eIt = entries.begin();
-            QStringList::ConstIterator eEnd = entries.end();
+            KSimpleConfig cfg( *eIt, true );
+            cfg.setDesktopGroup();
 
-            for (; eIt != eEnd; ++eIt )
+            if (!KIOSKAuthorizedAction(cfg))
             {
-                KSimpleConfig cfg( *dIt + *eIt, true );
-                cfg.setDesktopGroup();
+                continue;
+            }
 
-                if (!KIOSKAuthorizedAction(cfg))
-                {
+            if ( cfg.hasKey( "X-KDE-ShowIfRunning" ) )
+            {
+                const QString app = cfg.readEntry( "X-KDE-ShowIfRunning" );
+                if ( !kapp->dcopClient()->isApplicationRegistered( app.utf8() ) )
                     continue;
-                }
+            }
+            if ( cfg.hasKey( "X-KDE-ShowIfDcopCall" ) )
+            {
+                QString dcopcall = cfg.readEntry( "X-KDE-ShowIfDcopCall" );
+                const QCString app = dcopcall.section(' ', 0,0).utf8();
 
-                if ( cfg.hasKey( "X-KDE-ShowIfRunning" ) )
-                {
-                    const QString app = cfg.readEntry( "X-KDE-ShowIfRunning" );
-                    if ( !kapp->dcopClient()->isApplicationRegistered( app.utf8() ) )
-                        continue;
-                }
-		if ( cfg.hasKey( "X-KDE-ShowIfDcopCall" ) )
-		{
-		    QString dcopcall = cfg.readEntry( "X-KDE-ShowIfDcopCall" );
-		    const QCString app = dcopcall.section(' ', 0,0).utf8();
-
-		    //if( !kapp->dcopClient()->isApplicationRegistered( app ))
-		    //	continue; //app does not exist so cannot send call
-
-		    QByteArray dataToSend;
-		    QDataStream dataStream(dataToSend, IO_WriteOnly);
-		    dataStream << m_lstPopupURLs;
-
-		    QCString replyType;
-		    QByteArray replyData;
-		    QCString object =    dcopcall.section(' ', 1,-2).utf8();
-		    QString function =  dcopcall.section(' ', -1);
-		    if(!function.endsWith("(KURL::List)")) {
-			kdWarning() << "Desktop file " << *eIt << " contains an invalid X-KDE-ShowIfDcopCall - the function must take the exact parameter (KURL::List) and must be specified." << endl;
-			continue; //Be safe.
-		    }
-
-		    if(!kapp->dcopClient()->call( app, object,
-				    function.utf8(),
-				    dataToSend, replyType, replyData, true, 1000))
-			continue;
-		    if(replyType != "bool" || !replyData[0])
-			continue;
+                //if( !kapp->dcopClient()->isApplicationRegistered( app ))
+                //	continue; //app does not exist so cannot send call
 
-		}
-                if ( cfg.hasKey( "X-KDE-Protocol" ) )
-                {
-                    const QString protocol = cfg.readEntry( "X-KDE-Protocol" );
-                    if ( protocol != urlForServiceMenu.protocol() )
-                        continue;
+                QByteArray dataToSend;
+                QDataStream dataStream(dataToSend, IO_WriteOnly);
+                dataStream << m_lstPopupURLs;
+
+                QCString replyType;
+                QByteArray replyData;
+                QCString object =    dcopcall.section(' ', 1,-2).utf8();
+                QString function =  dcopcall.section(' ', -1);
+                if(!function.endsWith("(KURL::List)")) {
+                    kdWarning() << "Desktop file " << *eIt << " contains an invalid X-KDE-ShowIfDcopCall - the function must take the exact parameter (KURL::List) and must be specified." << endl;
+                    continue; //Be safe.
                 }
-                else if ( urlForServiceMenu.protocol() == "trash" || urlForServiceMenu.url().startsWith( "system:/trash" ) )
-                {
-                    // Require servicemenus for the trash to ask for protocol=trash explicitely.
-                    // Trashed files aren't supposed to be available for actions.
-                    // One might want a servicemenu for trash.desktop itself though.
+
+                if(!kapp->dcopClient()->call( app, object,
+                                              function.utf8(),
+                                              dataToSend, replyType, replyData, true, 1000))
+                    continue;
+                if(replyType != "bool" || !replyData[0])
                     continue;
-                }
 
-                if ( cfg.hasKey( "X-KDE-Require" ) )
-                {
-                    const QStringList capabilities = cfg.readListEntry( "X-KDE-Require" );
-                    if ( capabilities.contains( "Write" ) && !sWriting )
-                        continue;
-                }
-                if ( (cfg.hasKey( "Actions" ) || cfg.hasKey( "X-KDE-GetActionMenu") ) && cfg.hasKey( "ServiceTypes" ) )
+            }
+            if ( cfg.hasKey( "X-KDE-Protocol" ) )
+            {
+                const QString protocol = cfg.readEntry( "X-KDE-Protocol" );
+                if ( protocol != urlForServiceMenu.protocol() )
+                    continue;
+            }
+            else if ( urlForServiceMenu.protocol() == "trash" || urlForServiceMenu.url().startsWith( "system:/trash" ) )
+            {
+                // Require servicemenus for the trash to ask for protocol=trash explicitely.
+                // Trashed files aren't supposed to be available for actions.
+                // One might want a servicemenu for trash.desktop itself though.
+                continue;
+            }
+
+            if ( cfg.hasKey( "X-KDE-Require" ) )
+            {
+                const QStringList capabilities = cfg.readListEntry( "X-KDE-Require" );
+                if ( capabilities.contains( "Write" ) && !sWriting )
+                    continue;
+            }
+            if ( (cfg.hasKey( "Actions" ) || cfg.hasKey( "X-KDE-GetActionMenu") ) && cfg.hasKey( "ServiceTypes" ) )
+            {
+                const QStringList types = cfg.readListEntry( "ServiceTypes" );
+                const QStringList excludeTypes = cfg.readListEntry( "ExcludeServiceTypes" );
+                bool ok = false;
+
+                // check for exact matches or a typeglob'd mimetype if we have a mimetype
+                for (QStringList::ConstIterator it = types.begin();
+                     it != types.end() && !ok;
+                     ++it)
                 {
-                    const QStringList types = cfg.readListEntry( "ServiceTypes" );
-                    const QStringList excludeTypes = cfg.readListEntry( "ExcludeServiceTypes" );
-                    bool ok = false;
-
-                    // check for exact matches or a typeglob'd mimetype if we have a mimetype
-                    for (QStringList::ConstIterator it = types.begin();
-                         it != types.end() && !ok;
-                         ++it)
+                    // first check if we have an all mimetype
+                    bool checkTheMimetypes = false;
+                    if (*it == "all/all" ||
+                        *it == "allfiles" /*compat with KDE up to 3.0.3*/)
                     {
-                        // first check if we have an all mimetype
-                        bool checkTheMimetypes = false;
-                        if (*it == "all/all" ||
-                            *it == "allfiles" /*compat with KDE up to 3.0.3*/)
-                        {
-                            checkTheMimetypes = true;
-                        }
+                        checkTheMimetypes = true;
+                    }
 
-                        // next, do we match all files?
-                        if (!ok &&
-                            !isDirectory &&
-                            *it == "all/allfiles")
-                        {
-                            checkTheMimetypes = true;
-                        }
+                    // next, do we match all files?
+                    if (!ok &&
+                        !isDirectory &&
+                        *it == "all/allfiles")
+                    {
+                        checkTheMimetypes = true;
+                    }
 
-                        // if we have a mimetype, see if we have an exact or a type globbed match
-                        if (!ok &&
-                            (!m_sMimeType.isEmpty() &&
-                              *it == m_sMimeType) ||
-                            (!mimeGroup.isEmpty() &&
-                             ((*it).right(1) == "*" &&
-                              (*it).left((*it).find('/')) == mimeGroup)))
-                        {
-                            checkTheMimetypes = true;
-                        }
+                    // if we have a mimetype, see if we have an exact or a type globbed match
+                    if (!ok &&
+                        (!m_sMimeType.isEmpty() &&
+                         *it == m_sMimeType) ||
+                        (!mimeGroup.isEmpty() &&
+                         ((*it).right(1) == "*" &&
+                          (*it).left((*it).find('/')) == mimeGroup)))
+                    {
+                        checkTheMimetypes = true;
+                    }
 
-                        if (checkTheMimetypes)
+                    if (checkTheMimetypes)
+                    {
+                        ok = true;
+                        for (QStringList::ConstIterator itex = excludeTypes.begin(); itex != excludeTypes.end(); ++itex)
                         {
-                            ok = true;
-                            for (QStringList::ConstIterator itex = excludeTypes.begin(); itex != excludeTypes.end(); ++itex)
+                            if( ((*itex).right(1) == "*" && (*itex).left((*itex).find('/')) == mimeGroup) ||
+                                ((*itex) == m_sMimeType) )
                             {
-                                if( ((*itex).right(1) == "*" && (*itex).left((*itex).find('/')) == mimeGroup) ||
-                                    ((*itex) == m_sMimeType) )
-                                {
-                                    ok = false;
-                                    break;
-                                }
+                                ok = false;
+                                break;
                             }
                         }
                     }
+                }
 
-                    if ( ok )
-                    {
-                        const QString priority = cfg.readEntry("X-KDE-Priority");
-                        const QString submenuName = cfg.readEntry( "X-KDE-Submenu" );
-
-                        ServiceList* list = s.selectList( priority, submenuName );
-                        (*list) += KDEDesktopMimeType::userDefinedServices( *dIt + *eIt, cfg, url.isLocalFile(), m_lstPopupURLs );
-		    }
+                if ( ok )
+                {
+                    const QString priority = cfg.readEntry("X-KDE-Priority");
+                    const QString submenuName = cfg.readEntry( "X-KDE-Submenu" );
 
+                    ServiceList* list = s.selectList( priority, submenuName );
+                    (*list) += KDEDesktopMimeType::userDefinedServices( *eIt, cfg, url.isLocalFile(), m_lstPopupURLs );
                 }
             }
         }
--- kdebase-3.5.2/libkonq/konq_settings.cc	2005-10-10 11:04:21.000000000 -0400
+++ kdebase-3.5.2-new/libkonq/konq_settings.cc	2006-04-14 16:18:25.000000000 -0400
@@ -87,7 +87,7 @@
   m_highlightedTextColor = KGlobalSettings::highlightedTextColor();
   m_highlightedTextColor = config->readColorEntry( "HighlightedTextColor", &m_highlightedTextColor );
   m_itemTextBackground = config->readColorEntry( "ItemTextBackground" );
-  
+
   d->m_iconTextWidth = config->readNumEntry( "TextWidth", DEFAULT_TEXTWIDTH );
   if ( d->m_iconTextWidth == DEFAULT_TEXTWIDTH )
     d->m_iconTextWidth = QFontMetrics(m_standardFont).width("0000000000");
@@ -100,7 +100,7 @@
       m_iconTextHeight = 1;
   }
   m_bWordWrapText = ( m_iconTextHeight > 1 );
-  
+
   m_underlineLink = config->readBoolEntry( "UnderlineLinks", DEFAULT_UNDERLINELINKS );
   d->m_renameIconDirectly = config->readBoolEntry( "RenameIconDirectly", DEFAULT_RENAMEICONDIRECTLY );
   m_fileSizeInBytes = config->readBoolEntry( "DisplayFileSizeInBytes", DEFAULT_FILESIZEINBYTES );
@@ -128,9 +128,10 @@
     // First check in user's settings whether to embed or not
     // 1 - in the mimetype file itself
     KServiceType::Ptr serviceTypePtr = KServiceType::serviceType( serviceType );
-
+    bool hasLocalProtocolRedirect = false;
     if ( serviceTypePtr )
     {
+        hasLocalProtocolRedirect = !serviceTypePtr->property( "X-KDE-LocalProtocol" ).toString().isEmpty();
         kdDebug(1203) << serviceTypePtr->desktopEntryPath() << endl;
         KDesktopFile deFile( serviceTypePtr->desktopEntryPath(),
                              true /*readonly*/, "mime");
@@ -148,11 +149,16 @@
     if ( serviceTypeGroup == "inode" || serviceTypeGroup == "Browser" || serviceTypeGroup == "Konqueror" )
         return true; //always embed mimetype inode/*, Browser/* and Konqueror/*
     QMap<QString, QString>::ConstIterator it = m_embedMap.find( QString::fromLatin1("embed-")+serviceTypeGroup );
-    if ( it == m_embedMap.end() )
-        return (serviceTypeGroup=="image"); // embedding is false by default except for image/*
-    // Note: if you change the above default, also change kcontrol/filetypes/typeslistitem.cpp !
-    kdDebug(1203) << "KonqFMSettings::shouldEmbed: " << it.data() << endl;
-    return it.data() == QString::fromLatin1("true");
+    if ( it != m_embedMap.end() ) {
+        kdDebug(1203) << "KonqFMSettings::shouldEmbed: " << it.data() << endl;
+        return it.data() == QString::fromLatin1("true");
+    }
+    // 3 - if no config found, use default.
+    // Note: if you change those defaults, also change kcontrol/filetypes/typeslistitem.cpp !
+    // Embedding is false by default except for image/* and for zip, tar etc.
+    if ( serviceTypeGroup == "image" || hasLocalProtocolRedirect )
+        return true;
+    return false;
 }
 
 bool KonqFMSettings::showPreviewsInFileTips() const
--- kdebase-3.5.2/nsplugins/Makefile.am	2005-09-10 04:25:39.000000000 -0400
+++ kdebase-3.5.2-new/nsplugins/Makefile.am	2006-04-14 16:18:20.000000000 -0400
@@ -13,10 +13,13 @@
 libnsplugin_la_LDFLAGS = $(all_libraries) -avoid-version -module $(KDE_PLUGIN) -no-undefined
 libnsplugin_la_LIBADD  = -lkparts
 
-bin_PROGRAMS = nspluginscan
-nspluginscan_SOURCES = pluginscan.cpp
-nspluginscan_LDFLAGS =  $(KDE_RPATH) $(all_libraries) -export-dynamic
-nspluginscan_LDADD = $(LIB_KDEUI) $(LIB_KSYCOCA) -lXt
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = nspluginscan.la
+
+nspluginscan_la_SOURCES = pluginscan.cpp
+nspluginscan_la_LDFLAGS =  $(KDE_PLUGIN) $(all_libraries) -export-dynamic -module
+nspluginscan_la_LIBADD = $(LIB_KDEUI) $(LIB_KSYCOCA) -lXt
 
 kcm_nsplugins_la_SOURCES = kcm_nsplugins.cpp
 kcm_nsplugins_la_LDFLAGS = $(all_libraries) -module -avoid-version -no-undefined
--- kdebase-3.5.2/nsplugins/pluginscan.cpp	2006-01-19 12:01:49.000000000 -0500
+++ kdebase-3.5.2-new/nsplugins/pluginscan.cpp	2006-04-14 16:18:20.000000000 -0400
@@ -548,7 +548,7 @@
 };
 
 
-int main( int argc, char **argv )
+extern "C" KDE_EXPORT int kdemain( int argc, char **argv )
 {
     KAboutData aboutData( "nspluginscan", I18N_NOOP("nspluginscan"),
                           "0.3", "nspluginscan", KAboutData::License_GPL,
--- kdebase-3.5.2/nsplugins/viewer/Makefile.am	2005-09-10 04:25:39.000000000 -0400
+++ kdebase-3.5.2-new/nsplugins/viewer/Makefile.am	2006-04-14 16:18:20.000000000 -0400
@@ -1,12 +1,14 @@
 INCLUDES = -I$(top_srcdir)/nsplugins -I$(top_builddir)/nsplugins $(all_includes)
 METASOURCES = AUTO
 
-bin_PROGRAMS = nspluginviewer 
+bin_PROGRAMS = 
+lib_LTLIBRARIES = 
+kdeinit_LTLIBRARIES = nspluginviewer.la
 
-nspluginviewer_SOURCES = NSPluginCallbackIface.stub NSPluginClassIface.skel \
+nspluginviewer_la_SOURCES = NSPluginCallbackIface.stub NSPluginClassIface.skel \
 	nsplugin.cpp viewer.cpp kxt.cpp qxteventloop.cpp
-nspluginviewer_LDFLAGS = $(all_libraries) $(KDE_RPATH) -export-dynamic
-nspluginviewer_LDADD = $(LIB_KIO) $(LIB_KPARTS) -lXt
+nspluginviewer_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -export-dynamic -module
+nspluginviewer_la_LIBADD = $(LIB_KIO) $(LIB_KPARTS) -lXt
 
 NSPluginCallbackIface_DIR = $(srcdir)/..
 
--- kdebase-3.5.2/nsplugins/viewer/viewer.cpp	2006-01-19 12:01:49.000000000 -0500
+++ kdebase-3.5.2-new/nsplugins/viewer/viewer.cpp	2006-04-14 16:18:20.000000000 -0400
@@ -22,6 +22,9 @@
 
 */
 
+#if defined(__APPLE__) && !defined(RLIMIT_AS) && defined(RLIMIT_RSS)
+#define RLIMIT_AS RLIMIT_RSS
+#endif
 
 #include <config.h>
 
@@ -213,7 +216,7 @@
 #endif
 
 
-int main(int argc, char** argv)
+extern "C" KDE_EXPORT int kdemain(int argc, char** argv)
 {
     // nspluginviewer is a helper app, it shouldn't do session management at all
    setenv( "SESSION_MANAGER", "", 1 );
--- kdebase-3.5.2/startkde	2006-03-17 16:29:19.000000000 -0500
+++ kdebase-3.5.2-new/startkde	2006-04-14 16:18:20.000000000 -0400
@@ -3,6 +3,11 @@
 #  DEFAULT KDE STARTUP SCRIPT ( KDE-3.5.2 )
 #
 
+source "@FINKPREFIX@/bin/init.sh"
+
+[ -x @FINKPREFIX@/bin/remap-bad-apple-keys.pl ] && @FINKPREFIX@/bin/remap-bad-apple-keys.pl
+
+
 # When the X server dies we get a HUP signal from xinit. We must ignore it
 # because we still need to do some cleanup.
 trap 'echo GOT SIGHUP' HUP
@@ -257,20 +262,23 @@
 
 echo 'startkde: Starting up...'  1>&2
 
-# run KPersonalizer before the session, if this is the first login
-if test "$kpersonalizerrc_general_firstlogin" = "true"; then
-    # start only dcopserver, don't start whole kdeinit (takes too long)
-    echo 'startkde: Running kpersonalizer...'  1>&2
-    dcopserver
-    kwin --lock &
-    kpersonalizer --before-session
-    # handle kpersonalizer restarts (language change)
-    while test $? -eq 1; do
-        kpersonalizer --r --before-session
-    done
-    dcopquit kwin
-    dcopserver_shutdown --wait
-fi
+# on osx we skip this, the defaults are sane and most people
+# do bad things like "mac os menus" which makes it worse
+
+## run KPersonalizer before the session, if this is the first login
+#if test "$kpersonalizerrc_general_firstlogin" = "true"; then
+#    # start only dcopserver, don't start whole kdeinit (takes too long)
+#    echo 'startkde: Running kpersonalizer...'  1>&2
+#    dcopserver
+#    kwin --lock &
+#    kpersonalizer --before-session
+#    # handle kpersonalizer restarts (language change)
+#    while test $? -eq 1; do
+#        kpersonalizer --r --before-session
+#    done
+#    dcopquit kwin
+#    dcopserver_shutdown --wait
+#fi
 
 # the splashscreen and progress indicator
 case "$ksplashrc_ksplash_theme" in 
@@ -316,7 +324,29 @@
 # We only check for 255 which means that the ksmserver process could not be 
 # started, any problems thereafter, e.g. ksmserver failing to initialize, 
 # will remain undetected.
-test -n "$KDEWM" && KDEWM="--windowmanager $KDEWM"
+
+USE_PROXY=0
+if test -n "$KDEWM"; then
+  if test -z `expr "$KDEWM" : '\(.*quartz-wm.*\)'`; then
+    USE_PROXY=1
+  fi
+  KDEWM="--windowmanager $KDEWM"
+else
+  KDEWM="--windowmanager kwin"
+  USE_PROXY=1
+fi
+
+if test "$USE_PROXY" = "1"; then
+  if test -x /usr/X11R6/bin/quartz-wm; then
+    /usr/X11R6/bin/quartz-wm --only-proxy >/dev/null 2>&1 &
+  else
+    AUTOCUTSEL=`which autocutsel 2>/dev/null`
+    if test -n "$AUTOCUTSEL" && test -x "$AUTOCUTSEL"; then
+      $AUTOCUTSEL >/dev/null 2>&1 &
+    fi
+  fi
+fi
+
 kwrapper ksmserver $KDEWM 
 if test $? -eq 255; then
   # Startup error
