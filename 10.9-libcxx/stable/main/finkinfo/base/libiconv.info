Package: libiconv
Version: 1.16
Revision: 3
Description: Character set conversion library
License: LGPL
Maintainer: Fink Core Group <fink-core@lists.sourceforge.net>
Depends: base-files
BuildDepends: fink (>= 0.30.0)
Essential: yes
CustomMirror: <<
	Primary: http://ftpmirror.gnu.org/%n/
	Secondary: http://downloads.sourceforge.net/fink/
<<
Source: mirror:custom:libiconv-%v.tar.gz
Source-MD5: 7d2a800b952942bb2880efb00cfd524c
Source2: mirror:sourceforge:fink/gettext-0.20.2.tar.gz
#Source2: mirror:gnu:gettext/gettext-0.20.2.tar.gz
Source2-MD5: 30fec34a895fab4c02584449c500aac2
Source3: mirror:sourceforge:fink/gperf-3.1.tar.gz
#Source3: mirror:gnu:gperf/gperf-3.1.tar.gz
Source3-MD5: 9e251c0a618ad0824b51117d5d9db87e
PatchFile: %n.patch
PatchFile-MD5: 0680e630945155f90310754f063f099e
PatchScript: <<
	cd %b/..; patch -p0 < %{PatchFile}
<<
NoSetLDFLAGS: true
NoSetCPPFLAGS: true
### gperf builds with g++
GCC: 4.0
CompileScript: <<
#! /bin/sh -ex
### build gperf
cd %b/../gperf-3.1
./configure --prefix=%p
make
make -j1 check || exit 2

### Build our local gettext-runtime.
### If gettext gets updated, make sure these ./configure parameters 
### match the new package parameters (except build static only here).
### Not necessary, but will avoid unforeseen consequences.
cd %b/../gettext-0.20.2/gettext-runtime
EMACS=no CPPFLAGS="-I%b/../_inst%p/include" LDFLAGS="-L%b/../_inst%p/lib" am_cv_func_iconv=no ./configure \
	--prefix=%p \
	--infodir='${prefix}/share/info' \
	--mandir='%p/share/man' \
	--with-included-gettext \
	--disable-csharp \
	--disable-rpath \
	--disable-libasprintf \
	--disable-shared \
	--with-included-glib \
	--with-included-libcroco \
	--with-included-libxml \
	--with-included-libunistring \
	--without-git \
	--without-cvs \
	ac_cv_prog_AWK=/usr/bin/awk \
	ac_cv_path_GREP=/usr/bin/grep \
	ac_cv_path_SED=/usr/bin/sed
make
rm -rf %b/../_inst
make install DESTDIR=%b/../_inst

### now build iconv
cd %b/../libiconv-%v
make -f Makefile.devel GPERF=%b/../gperf-3.1/src/gperf
am_cv_func_iconv="yes"
am_cv_proto_iconv=""
export am_cv_func_iconv am_cv_proto_iconv
CPPFLAGS="-I%b/../_inst%p/include" LDFLAGS="-L%b/../_inst%p/lib" ./configure --prefix=%p --mandir='${prefix}/share/man' --enable-extra-encodings
find . -name Makefile | xargs perl -pi -e 's|\@LIBINTL_STATIC\@|%b/../_inst%p/lib/libintl.a -Wl,-framework,CoreFoundation|g'
make
<<
InfoTest: <<
	TestScript: make check || exit 2
<<
InstallScript: <<
mkdir -p %i/share/man %i/share/doc/%n
make install prefix=%i docdir=%i/share/doc/%n
perl -pi -e "s,^dependency_libs=.*,dependency_libs=' -L%p/lib'," %i/lib/libcharset.la %i/lib/libiconv.la
rm -rf %i/doc
rm -f %i/lib/charset.alias
<<
DocFiles: README* AUTHORS COPYING.LIB DESIGN NEWS NOTES THANKS
Shlibs: <<
	%p/lib/libcharset.1.dylib 2.0.0 %n (>= 1.7-7)
	%p/lib/libiconv.2.dylib 9.0.0 %n (>= 1.15-1)
<<
#
PostInstScript: <<
if [ -L %p/etc/alternatives/charset.alias ]; then
	update-alternatives --remove charset.alias %p/lib/charset.alias.libiconv
fi
<<
#
SplitOff: <<
	Package: libiconv-bin
	Essential: true
	Depends: libiconv (= %v-%r)
	Replaces: libiconv (<= 1.7-6)
	Files: bin share/doc/libiconv/*.html share/man
	Description: Executables for libiconv package
	DocFiles: README* AUTHORS COPYING.LIB DESIGN NEWS NOTES THANKS
<<
SplitOff2: <<
	Package: libiconv-dev
	Depends: libiconv (= %v-%r)
	Replaces: libiconv (<= 1.7-6)
	BuildDependsOnly: true
	Files: include lib/libcharset.dylib lib/libiconv.dylib lib/*.a lib/*.la
	Description: Developer files for libiconv package
	DocFiles: README* AUTHORS COPYING.LIB DESIGN NEWS NOTES THANKS
<<
DescDetail: <<
GNU libiconv provides an iconv() implemententation for systems that lack
it, or whose implementation cannot convert from/to Unicode.
<<
DescPackaging: <<
 Shared libraries are in libiconv for backward compatibility, to avoid
 breaking dpkg during an update.

 In order to guarantee that the gettext header files are present when 
 libiconv is built, we now compile gettext during the building of this
 package.  (Previously, the complicated interaction between gettext and
 libiconv was handled during fink's bootstrap process, but not afterwards.)

 Previous versions by Christoph Pfisterer.
<<
DescPort: <<
charset.alias is deleted because it is empty on Darwin anyway and
causes unnecessary conflicts between packages.

We patch around a recent change in the upstream Makefile which defeats
our build system.

2007-02-01 Benjamin Reed <rangerrick@fink.sourceforge.net>
* updated to 1.11
* included apple's patches to add UTF-8-MAC charset support

2010-06-10 Daniel Macks <dmacks@netspace.org>
* Make sure build doesn't see already-installed libiconv-dev. But
  apple's isn't always compatible. Just omit iconv when building
  gettext commands (only used locally while building libiconv) that
  would link aginst libiconv.

2013-08-22 Hanspeter Niederstrasser
* Update to 1.14
* Bump included gperf to latest 3.0.4
* Bump internal gettext to latest 0.18.3.1
* On 10.7+, modernize compiler wrapper
* Don't build genaliases headers for systems that we will not even use.
  Build is -jN safe afterwards.

2017-08-23 Jack Howarth
 With format string strictness, High Sierra also enforces that
 %n isn't used in dynamic format strings, but we should just
 disable its use on darwin in general. (libiconv-gettext.patch)
 
 PatchFile updated to solve build failure:
 In file included from ./iconv.c:71:
 In file included from ./converters.h:125:
 ./utf8mac.h:161:8: error: hexadecimal floating constant requires an exponent
        0x1.15, 0xA344,   0x1E15, 0xA346,   0x1E16, 0xA348,   0x1E17, 0xA34A,
 
 Patching solution for exponent described at 
 
 https://stackoverflow.com/questions/24288691/
 why-does-hexadecimal-floating-point-need-to-have-a-specified-exponent
<<
Homepage: http://www.gnu.org/software/libiconv/
