# -*- coding: ascii; tab-width: 4 -*-
Info2: <<
Package: ruby32
Version: 3.2.9
Revision: 1
Type: ruby (3.2)
Description: Interpreted, object-oriented language
License: BSD
Homepage: https://www.ruby-lang.org/
Maintainer: None <fink-devel@lists.sourceforge.net>

# Dependencies.
Depends: <<
	%N-shlibs (= %v-%r),
	gmp5-shlibs,
	libffi8-shlibs,
	libyaml-shlibs (>= 0.2.5-1),
	openssl300-shlibs,
	readline8-shlibs
<<
BuildDepends: <<
	bison,
	fink (>= 0.32),
	gmp5,
	libffi8,
	libyaml (>= 0.2.5-1),
	openssl300-dev,
	readline8
<<

# Unpack Phase.
Source: https://cache.ruby-lang.org/pub/ruby/3.2/ruby-%v.tar.xz
Source-Checksum: SHA256(cf6699d0084c588e7944d92e1a8edda28b1cc3ee471a1f0aebb4b3d32c9753b2)

# Patch Phase.
#* Includes Debian 0011-don-t-try-to-download-stuff-in-configure.patch
#* Includes upstream https://github.com/ruby/ruby/pull/12007
#* test-vm_dump.rb still fails on 26.0 and we also support older XCode
#  versions (cf. https://bugs.ruby-lang.org/issues/20631), and some
#  other tests likewise.
#* Skip an IPv6 wrong-family resolver test (not sure why it fails)
PatchFile: %n.patch
PatchFile-MD5: 977ec2a12c16749cadc2f118a34bf216
PatchScript: <<
	%{default_script}
	# Keep validator happy.
	perl -pi -e 's/-framework CoreFoundation/-Wl,-framework,CoreFoundation/' configure
	perl -pi -e 's/-framework Foundation/-Wl,-framework,Foundation/' configure
	perl -pi -e 's/-framework Security/-Wl,-framework,Security/' configure
	# This test doesn't work right in fink's build environment.
	perl -pi -e 's/ unless user//' test/ruby/test_file_exhaustive.rb
	# Testing sockets can be problematic.
	rm test/socket/test_socket.rb
	# Don't look for the unversioned 'gem' command
	perl -pi -e 's|\[\"gem\"|\[\"gem%type_raw[ruby]\"|g' lib/bundler/gem_helper.rb
	perl -pi -e 's|gem pristine|gem%type_raw[ruby]|g' lib/rubygems/basic_specification.rb lib/rubygems/commands/help_command.rb test/rubygems/test_gem.rb test/rubygems/test_gem_specification.rb test/rubygems/test_gem_stub_specification.rb
<<

# Compile Phase.
ConfigureParams: <<
	--program-suffix=%type_raw[ruby] \
	--docdir='${datarootdir}/doc/${PACKAGE}%type_pkg[ruby]' \
	--disable-install-capi \
	--enable-shared \
	--with-ruby-version=minor \
	--build=%m-apple-darwin \
	LIBS="-L%p/lib" \
	ac_cv_path_mkdir=/bin/mkdir ac_cv_path_install=/usr/bin/install ac_cv_path_GREP=/usr/bin/grep
<<

SetLDFLAGS: -Wl,-dead_strip_dylibs
CompileScript: <<
	./configure %c LIBPATHENV=DYLD_LIBRARY_PATH EXTLDFLAGS="-Wl,-dead_strip_dylibs -L%p/lib"
	make
<<

# Test Phase
InfoTest: <<
	TestSource: https://rubygems.org/downloads/bundler-2.4.5.gem
	TestSource-Checksum: SHA256(5af8faaf09666d59ccdf1a8e461f17bbc5c4e49badb2dcaee174659f8c87d44a)
	TestSource2: https://rubygems.org/downloads/rspec-support-3.13.6.gem
	TestSource2-Checksum: SHA256(2e8de3702427eab064c9352fe74488cc12a1bfae887ad8b91cba480ec9f8afb2)
	TestSource3: https://rubygems.org/downloads/diff-lcs-1.6.2.gem
	TestSource3-Checksum: SHA256(9ae0d2cba7d4df3075fe8cd8602a8604993efc0dfa934cff568969efb1909962)
	TestSource4: https://rubygems.org/downloads/rspec-mocks-3.13.7.gem
	TestSource4-Checksum: SHA256(0979034e64b1d7a838aaaddf12bf065ea4dc40ef3d4c39f01f93ae2c66c62b1c)
	TestSource5: https://rubygems.org/downloads/rspec-expectations-3.13.5.gem
	TestSource5-Checksum: SHA256(33a4d3a1d95060aea4c94e9f237030a8f9eae5615e9bd85718fe3a09e4b58836)
	TestSource6: https://rubygems.org/downloads/rspec-core-3.13.6.gem
	TestSource6-Checksum: SHA256(a8823c6411667b60a8bca135364351dda34cd55e44ff94c4be4633b37d828b2d)
	TestSource7: https://rubygems.org/downloads/rspec-3.13.2.gem
	TestSource7-Checksum: SHA256(206284a08ad798e61f86d7ca3e376718d52c0bc944626b2349266f239f820587)
	TestScript: <<
		#!/bin/sh -ev
		cp %b/../*.gem .bundle/cache
		# Change install_name of lib during tests since DYLD_LIBRARY_PATH doesn't work on 10.11+.
		install_name_tool -change %p/lib/libruby.%type_raw[ruby].dylib %b/libruby.%type_raw[ruby].dylib ruby%type_raw[ruby]
		/usr/bin/find .ext/%m-darwin* -name *.bundle -exec install_name_tool -change %p/lib/libruby.%type_raw[ruby].dylib %b/libruby.%type_raw[ruby].dylib {} \;
		install_name_tool -id %b/libruby.%type_raw[ruby].dylib libruby.%type_raw[ruby].dylib
		
		export LANG=en_US.UTF-8
		export PATH="%b:$PATH"
		export RUBYGEMS_PREVENT_UPDATE_SUGGESTION=1
		make check || exit 2
		
		# Put install_name back.
		install_name_tool -change %b/libruby.%type_raw[ruby].dylib %p/lib/libruby.%type_raw[ruby].dylib ruby%type_raw[ruby]
		/usr/bin/find .ext/%m-darwin* -name *.bundle -exec install_name_tool -change %b/libruby.%type_raw[ruby].dylib %p/lib/libruby.%type_raw[ruby].dylib {} \;
		install_name_tool -id %p/lib/libruby.%type_raw[ruby].dylib libruby.%type_raw[ruby].dylib
	<<
<<

# Install Phase.
InstallScript: <<
	make -j1 install DESTDIR=%d
	perl -pi -e 's| -lgmp||' %i/lib/ruby/%type_raw[ruby]/%m-darwin*/rbconfig.rb
<<
DocFiles: BSDL COPYING COPYING.ja ChangeLog GPL LEGAL NEWS.md README* sample

SplitOff2: <<
  Package: %N-dev
  Description: Ruby %type_raw[ruby] dev files (mkmf.rb, *.h and *.dylib)
  BuildDependsOnly: True
  Depends: %N (= %v-%r)
  Files: <<
    lib/ruby/%type_raw[ruby]/mkmf.rb
    lib/pkgconfig
    include
  <<
  DocFiles: BSDL COPYING COPYING.ja ChangeLog GPL LEGAL NEWS.md README*
<<

SplitOff3: <<
  Package: ri%type_pkg[ruby]
  Description: Ruby %type_raw[ruby] documentation
  Depends: %N (= %v-%r)
  Files: <<
    bin/ri%type_raw[ruby]
    share/ri/%type_raw[ruby]
  <<
  DocFiles: BSDL COPYING COPYING.ja ChangeLog GPL LEGAL NEWS.md README*
<<

SplitOff4: <<
  Package: %N-shlibs
  Depends: gmp5-shlibs
  Shlibs: %p/lib/libruby.%type_raw[ruby].dylib 3.2.0 %n (>= 3.2.0-1)
  Description: Ruby %type_raw[ruby] shared libraries
  Files: lib/libruby.%type_raw[ruby].dylib
  DocFiles: BSDL COPYING COPYING.ja ChangeLog GPL LEGAL NEWS.md README*
<<

DescDetail: <<
- It has many features to process text files and to do system
  management tasks (as in Perl).
- It is simple, straight-forward, extensible, and portable, and free.
- It has simple syntax, partially inspired by Eiffel and Ada.
- All data in Ruby is an object, not in the sense of Python or Perl,
  but in the sense of Smalltalk: no exceptions.
<<
DescPackaging: <<
The Ruby tcltk extension is packaged separately and links against Fink's X11
version of tcltk. It could be replaced with a version linked against an Aqua
tcltk if someone packaged it.

Packages should depend on ruby32 to run scripts. The shared library
does not provide many of the stdlib features, they are implemented in
the bundled extensions.

The extensions would link and probably run with Apple's libraries but
since Fink has its own version of ncurses, readline, etc. it should
always link with Fink's to get consistent results.

Move mkmf script into -dev to make extension configuration error out
instead of failing all tests.
<<
DescPort: <<
* Gem3.2 (from bundled rubygems-3.4.0) does an internet  check during gem
install. To skip it, set RUBYGEMS_PREVENT_UPDATE_SUGGESTION=1 during the
gem install.
<<
<<
