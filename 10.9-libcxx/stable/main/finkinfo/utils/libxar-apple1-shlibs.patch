diff -Nurd xar-xar-494.81.1.orig/xar/lib/archive.h xar-xar-494.81.1/xar/lib/archive.h
--- xar-xar-494.81.1.orig/xar/lib/archive.h	2023-01-23 19:43:41.000000000 -0500
+++ xar-xar-494.81.1/xar/lib/archive.h	2023-04-08 08:39:50.000000000 -0400
@@ -40,7 +40,7 @@
 #define _XAR_ARCHIVE_H_
 #include <zlib.h>
 #include <libxml/hash.h>
-#ifdef __APPLE__
+#if defined(__APPLE__) && !defined(NO_COMMONCRYPTO)
 #include <CommonCrypto/CommonDigest.h>
 #include <CommonCrypto/CommonDigestSPI.h>
 #else
diff -Nurd xar-xar-494.81.1.orig/xar/lib/hash.c xar-xar-494.81.1/xar/lib/hash.c
--- xar-xar-494.81.1.orig/xar/lib/hash.c	2023-01-23 19:43:41.000000000 -0500
+++ xar-xar-494.81.1/xar/lib/hash.c	2023-04-08 09:32:36.000000000 -0400
@@ -41,7 +41,7 @@
 #include <string.h>
 #include <sys/types.h>
 #include <zlib.h>
-#ifdef __APPLE__
+#if defined(__APPLE__) && !defined(NO_COMMONCRYPTO)
 #include <CommonCrypto/CommonDigest.h>
 #include <CommonCrypto/CommonDigestSPI.h>
 #else
@@ -58,7 +58,7 @@
 
 #pragma mark Hash Wrapper Object
 
-#ifdef __APPLE__
+#if defined(__APPLE__) && !defined(NO_COMMONCRYPTO)
 
 CCDigestRef digestRef_from_name(const char* name, unsigned int *outHashSize) {
     CCDigestRef result = NULL;
@@ -88,16 +88,16 @@
 	
     return result;
 }
-#endif // __APPLE__
+#endif // __APPLE__ && !NO_COMMONCRYPTO
 
 
 struct __xar_hash_t {
 	const char *digest_name;
 	void *context;
-#ifdef __APPLE__
+#if defined(__APPLE__) && !defined(NO_COMMONCRYPTO)
 	CCDigestRef digest;
 #else
-	EVP_MD_CTX digest;
+	EVP_MD_CTX *digest;
 	const EVP_MD *type;
 #endif
 	unsigned int length;
@@ -113,12 +113,13 @@
 	if( context )
 		HASH_CTX(hash)->context = context;
 	
-#ifdef __APPLE__
+#if defined(__APPLE__) && !defined(NO_COMMONCRYPTO)
 	HASH_CTX(hash)->digest = digestRef_from_name(digest_name, &HASH_CTX(hash)->length);
 #else
 	OpenSSL_add_all_digests();
 	HASH_CTX(hash)->type = EVP_get_digestbyname(digest_name);
-	EVP_DigestInit(&HASH_CTX(hash)->digest, HASH_CTX(hash)->type);
+	HASH_CTX(hash)->digest = EVP_MD_CTX_new();
+	EVP_DigestInit(HASH_CTX(hash)->digest, HASH_CTX(hash)->type);
 #endif
 	
 	HASH_CTX(hash)->digest_name = strdup(digest_name);
@@ -135,15 +136,15 @@
 }
 
 void xar_hash_update(xar_hash_t hash, void *buffer, size_t nbyte) {
-#ifdef __APPLE__
+#if defined(__APPLE__) && !defined(NO_COMMONCRYPTO)
 	CCDigestUpdate(HASH_CTX(hash)->digest, buffer, nbyte);
 #else
-	EVP_DigestUpdate(&HASH_CTX(hash)->digest, buffer, nbyte);
+	EVP_DigestUpdate(HASH_CTX(hash)->digest, buffer, nbyte);
 #endif
 }
 
 void *xar_hash_finish(xar_hash_t hash, size_t *nbyte) {
-#ifdef __APPLE__
+#if defined(__APPLE__) && !defined(NO_COMMONCRYPTO)
 	void *buffer = calloc(1, CC_SHA512_DIGEST_LENGTH); // current biggest digest size  This is what OpenSSL uses
 #else
 	void *buffer = calloc(1, EVP_MAX_MD_SIZE);
@@ -151,11 +152,11 @@
 	if( ! buffer )
 		return NULL;
 	
-#ifdef __APPLE__
+#if defined(__APPLE__) && !defined(NO_COMMONCRYPTO)
 	CCDigestFinal(HASH_CTX(hash)->digest, buffer);
 	CCDigestDestroy(HASH_CTX(hash)->digest);
 #else
-	EVP_DigestFinal(&HASH_CTX(hash)->digest, buffer, &HASH_CTX(hash)->length);
+	EVP_DigestFinal(HASH_CTX(hash)->digest, buffer, &HASH_CTX(hash)->length);
 #endif
 	
 	*nbyte = HASH_CTX(hash)->length;
diff -Nurd xar-xar-494.81.1.orig/xar/src/xar.c xar-xar-494.81.1/xar/src/xar.c
--- xar-xar-494.81.1.orig/xar/src/xar.c	2023-01-23 19:43:41.000000000 -0500
+++ xar-xar-494.81.1/xar/src/xar.c	2023-04-08 08:40:22.000000000 -0400
@@ -51,8 +51,8 @@
 #include <time.h>
 #include "xar_internal.h"
 #include "config.h"
-#include "filetree.h"
-#include "util.h"
+#include "../lib/filetree.h"
+#include "../lib/util.h"
 #define SYMBOLIC 1
 #define NUMERIC  2
 static int Perms = 0;
