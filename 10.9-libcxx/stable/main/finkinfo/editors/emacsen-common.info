Package: emacsen-common
Version: 3.0.8
Revision: 1
BuildDepends: fink (>= 0.32)
Suggests: emacsen
Source: mirror:debian:pool/main/e/%n/%n_%v.tar.xz
Source-Checksum: SHA256(6145aba63f38a611ce99ee2c46c4213d3f76aa4760df1544dd29217fa95c6feb)
SourceDirectory: %n-%v
# ConfFiles: %p/etc/emacs/site-start.el
PatchFile: %n.patch
PatchFile-Checksum: SHA256(1bc2385910e96102cb18976b0435df71285f2b892e6d2f50115d3fff8c11fad8)
PatchScript: sed 's|@PREFIX@|%p|g' <%{PatchFile} | patch -p1
DocFiles: debian/changelog debian-emacs-policy debian/copyright
CompileScript: <<
  perl -wc emacs-install
  perl -wc emacs-remove
  perl -wc emacs-package-install
  perl -wc emacs-package-remove
  perl -wc lib.pl
<<
InstallScript: <<
 mkdir -p %i/etc/emacs/site-start.d
 mkdir -p %i/etc/site-start.d
 mkdir -p %i/lib/%n/packages/install
 mkdir -p %i/lib/%n/packages/remove
 mkdir -p %i/lib/%n/packages/compat
 mkdir -p %i/var/lib/%n/state/flavor/installed
 mkdir -p %i/var/lib/%n/state/package/installed
 mkdir -p %i/share/doc/%n
 mkdir -p %i/share/emacs/site-lisp

 install -m 755 emacs-install %i/lib/%n/
 install -m 755 emacs-remove %i/lib/%n/
 install -m 755 emacs-package-install %i/lib/%n/
 install -m 755 emacs-package-remove %i/lib/%n/
 install -m 755 lib.pl %i/lib/%n/
 install -m 644 debian-startup.el %i/share/emacs/site-lisp/fink-startup.el
 install -m 644 compat/emacsen-common %i/lib/%n/packages/compat/

 install -m 755 emacsen-common.install %i/lib/%n/packages/install/emacsen-common
 install -m 755 emacsen-common.remove %i/lib/%n/packages/remove/emacsen-common 
<<
PreInstScript: <<
# When emacsen-common and add-ons are upgrading simultaneously,
# emacsen-common can be unpacked but not configured when an add-on's
# prerm runs. That causes the add-on's removal command to be skipped,
# which is wrong and can cause the upgrade to fail. For example
# https://bugs.debian.org/1106291
#
# For now, to ensure the removal commands are still run, remove all
# emacs flavors here, keeping track of which flavors are actually
# still installed in pending, and then restore them from the postinst,
# when emacsen-common is ready again.
#
# Normally, it would be unsafe to depend on emacsen-common files like
# this in the preinst, but our assumption for this mitigation is that
# since emacs flavors depend on emacsen-common and since they should
# have a installed/FLAVOR file if and only if they're "ready to go"
# (i.e. via their postinst configure), then the emacs-remove script
# will be available inside the loop.

mkdir -p %p/var/lib/emacsen-common/state/flavor/pending
for flavor in %p/var/lib/emacsen-common/state/flavor/installed/*[!~]; do
    case "$flavor" in
        */installed/\**) break ;; # no flavors
    esac
    flavor="$(basename "$flavor")"
    echo "Removing emacsen flavor $flavor during emacsen-common upgrade" 1>&2
    %p/lib/emacsen-common/emacs-remove "$flavor"
    touch "%p/var/lib/emacsen-common/state/flavor/pending/$flavor"
done

# The emacsen-common package is a special case; we can't call
# emacs-package-install from here since the new version hasn't been
# unpacked yet, so just do the important bit that it would have done.
installed_state_dir=%p/var/lib/emacsen-common/state/package/installed
if test -d "$installed_state_dir"
then
  rm -f "$installed_state_dir"/emacsen-common
fi
<<
PostInstScript: <<
mkdir -p %p/var/lib/emacsen-common

if [ -e /usr/local ]
then
  if [ ! -e /usr/local/share ]
  then
    if mkdir -p /usr/local/share 2>/dev/null
    then
      chown root:staff /usr/local/share
      chmod 2775 /usr/local/share
    fi
  fi

  if [ ! -e /usr/local/share/emacs ]
  then
    if mkdir /usr/local/share/emacs 2>/dev/null
    then
      chown root:staff /usr/local/share/emacs
      chmod 2775 /usr/local/share/emacs
    fi
  fi

  if [ ! -e /usr/local/share/emacs/site-lisp ]
  then
    if mkdir /usr/local/share/emacs/site-lisp 2>/dev/null
    then
      chown root:staff /usr/local/share/emacs/site-lisp
      chmod 2775 /usr/local/share/emacs/site-lisp
    fi
  fi
fi

# Convert installed-flavors to flavor/installed/*.
if [ -e %p/var/lib/emacsen-common/installed-flavors ]
then
  mkdir -p %p/var/lib/emacsen-common/state/flavor/installed
  for flavor in $(cat %p/var/lib/emacsen-common/installed-flavors)
  do
    touch "%p/var/lib/emacsen-common/state/flavor/installed/$flavor"
  done
  rm -f %p/var/lib/emacsen-common/installed-flavors
fi

if [ ! -e %p/var/lib/emacsen-common/state/flavor/installed ]
then
  if [ -e /usr/local/share/emacs ]
  then
    chmod 2775 /usr/local/share/emacs
  fi
  mkdir -p %p/var/lib/emacsen-common/state/flavor/installed
fi
%p/lib/emacsen-common/emacs-package-install --postinst emacsen-common

# Reinstall all flavors during upgrade.  See the comments in the
# preinst and https://bugs.debian.org/1106291

for flavor in %p/var/lib/emacsen-common/state/flavor/pending/*[!~]; do
    case "$flavor" in
        */pending/\**) break ;; # no flavors
    esac
    flavor="$(basename "$flavor")"
    echo "Reinstalling emacsen flavor $flavor after emacsen-common upgrade" 1>&2
    %p/lib/emacsen-common/emacs-install "$flavor"
    rm "%p/var/lib/emacsen-common/state/flavor/pending/$flavor"
done


# Clean up dead emacs info entry...                                                                         
#install-info --quiet --remove emacs
<<
PreRmScript: <<
%p/lib/emacsen-common/emacs-package-remove --prerm emacsen-common

rm -rf %p/var/lib/emacsen-common/state/flavor/pending

(rmdir /usr/local/share/emacs/site-lisp 2>/dev/null &&  rmdir /usr/local/share/emacs 2>/dev/null) || true
<<
PostRmScript: <<
if [ "$1" = purge ]
then
  if [ -e %p/var/lib/emacsen-common/state ]
  then
    rm -rf %p/var/lib/emacsen-common/state
    rmdir %p/var/lib/emacsen-common
  fi
fi
<<
#
Description: Common facilities for all emacsen
DescDetail: <<
 This package contains code that is needed by all the (x)emacs packages.

 It provides a unified mechanism for installing optional emacs-lisp 
 add-on packages, with facilities for byte-compiling code and making
 it available to all installed (x)emacs variants.
<<
DescPackaging: <<
Previously maintained by Christian Swinehart <cswinehart@users.sourceforge.net>
<<
DescPort: <<
 This package is derived from the Debian emacsen-common package, with a couple 
 of changes: 1) needs to be convinced to live under the fink prefix directory,
 and 2) elisp functions with debian in the name were changed to fink (e.g., 
 debian-startup became fink-startup).
<<
DescUsage: <<
 The only current documentation is the debian-emacs-policy paper, which gives
 a basic idea of what is required of emacs-maintainers and add-on package 
 maintainers in order to take advantage of the service.

 A fink-specific revision of the document will (hopefully) be forthcoming...
<<
License: GPL
Homepage: http://packages.debian.org/emacsen-common
Maintainer: None <fink-devel@lists.sourceforge.net>
