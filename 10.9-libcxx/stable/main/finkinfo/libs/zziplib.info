Package: zziplib
Version: 0.13.72
Revision: 1
BuildDepends: fink (>= 0.24.12), python3 (>= 3.5.9) | xcode (>= 11.4)
Depends: %N13-shlibs (= %v-%r)
Maintainer: Daniel Johnson <daniel@daniel-johnson.org>
Source: https://github.com/gdraheim/zziplib/archive/refs/tags/v%v.tar.gz
SourceRename: %n-%v.tar.gz

PatchScript: <<
  perl -pi -e 's/LD_LIBRARY_PATH/DYLD_FALLBACK_LIBRARY_PATH/g' test/Makefile.in
  # SET_TARGET_PROPERTIES adds ${FIXNUM} ("0.72") to filename, but not install_name.
  perl -pi -e 's/(VERNUM.)(...FIXNUM.)/$1/' zzip*/CMakeLists.txt
  # Fix extensions of existing docs pages
  for f in docs/*.htm; do mv $f ${f}l; done
  ln -s site.html docs/index.html
<<

CompileScript: <<
  #!/bin/sh -ev
  . %p/sbin/fink-buildenv-cmake.sh
  mkdir finkbuild
  pushd finkbuild
  cmake $FINK_CMAKE_ARGS -DZZIP_TESTCVE=OFF ..
  make -w
  mv docs/*.[hx]*ml ../docs
  popd
<<

# Floating point exception in test_65485_list_verbose_compressed_with_directory
InfoTest: TestScript: make -C finkbuild -j1 check || exit 1

# Recreate pkgconfig rule to wrap around system zlib (removed since 0.13.68)
InstallScript: <<
  #!/bin/sh -ev
  perl -pi -e 's/(Requires:) (zlib)/$1 zzip-zlib-config/' finkbuild/zzip/zziplib.pc
  make -C finkbuild install DESTDIR=%d
  cat > %i/lib/pkgconfig/zzip-zlib-config.pc << EOF
zlib_libs= -lz
zlib_cflags=

Name: zzip-zlib-config
Version: 1.3.2
Description: ZLib Config (for ZZipLib)
Libs: \${zlib_libs}
Cflags: \${zlib_cflags}
EOF
<<
SplitOff: <<
  Package: %N13-shlibs
  Files: lib/libzzip*0.13.dylib
  Shlibs: <<
    %p/lib/libzzip-0.13.dylib 13.0.0 %n (>= 0.13.72-1)
    %p/lib/libzzipfseeko-0.13.dylib 13.0.0 %n (>= 0.13.72-1)
    %p/lib/libzzipmmapped-0.13.dylib 13.0.0 %n (>= 0.13.72-1)
    %p/lib/libzzipwrap-0.13.dylib 13.0.0 %n (>= 0.13.72-1)
  <<
  DocFiles: COPYING.LIB ChangeLog README TODO 
<<
SplitOff2: <<
  Package: %N13-dev
  Conflicts: zziplib-dev
  Replaces: zziplib-dev
  Depends: %N13-shlibs (= %v-%r)
  BuildDependsOnly: true
  Files: include lib share
  DocFiles: COPYING.LIB ChangeLog README TODO
<<
DocFiles: COPYING.LIB ChangeLog README* TODO docs/*.{css,dbk,html,xml,png,MPL,ZLIB}
DescPackaging: <<
  Formerly maintained by Tim Seufert.
  0.13.72 switched to cmake build, requires Python 3.5+ either from
  systempython on Catalina or later (tested by minimum xcode version)
  or Fink (BDep on python3).
  Added zzip-zlib-config.pc back since pkg-config will not find system zlib.
<<
Description: Transparent access to ZIP files
Homepage: http://zziplib.sourceforge.net
License: LGPL
Source-MD5: 43555e7eafc5c1a1178a35e716c40500
