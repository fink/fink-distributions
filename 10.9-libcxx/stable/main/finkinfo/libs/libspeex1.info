Package: libspeex1
Version: 1.2.1
# libspeexdsp.dylib was pushed off to a separate upstream pkg at v=1.2.0
# but upstream looks EOL at 1.2.1, so we retain a monolithic pkg
Revision: 1
###
Depends: %N-shlibs (= %v-%r)
BuildDepends: <<
	fink-package-precedence,
	libogg (>= 1.1.3-1),
	pkgconfig
<<
Conflicts: speex, speex1, speex2, speex3
Replaces: speex, speex1, speex2, speex3
BuildDependsOnly: true
###
#Source: https://downloads.xiph.org/releases/speex/speex-%v.tar.gz
Source: https://ftp.osuosl.org/pub/xiph/releases/speex/speex-%v.tar.gz
Source-Checksum: SHA256(4b44d4f2b38a370a2d98a78329fefc56a0cf93d1c1be70029217baae6628feea)
#Source2: https://downloads.xiph.org/releases/speex/speexdsp-%v.tar.gz
Source2: https://ftp.osuosl.org/pub/xiph/releases/speex/speexdsp-%v.tar.gz
Source2-Checksum: SHA256(8c777343e4a6399569c72abc38a95b24db56882c83dbdb6c6424a5f4aeb54d3d)
# Each component is in own subdir from own tarball; we will handle
# each one independently.
NoSourceDirectory: true
###
PatchFile: %n.patch
PatchFile-MD5: e9fabcdf018e7089eaf2fbadee8c2649
PatchScript: <<
#!/bin/sh -ev
	# One of several hacks to make sure speex finds our local
	# speexdsp instead of a pre-installed one.
	%{default_script}

	# unified collection of DocFiles
	mkdir doc
	for f in AUTHORS COPYING ChangeLog NEWS README TODO; do
		cp speexdsp-%v/$f doc/$f-speex
		cp speex-%v/$f doc/$f-speexdsp
	done
<<
###
NoSetLDFLAGS: true
SetLIBS: -L%p/lib
###
DocFiles: doc/*
###
ConfigureParams: <<
	--with-pic \
	--enable-shared \
	--disable-static \
	--libdir=%p/lib/%N/lib \
	--docdir=%p/share/doc/%N
<<
#--infodir=%p/lib/%N/share/info
#--datarootdir=%p/lib/%N/share
#--includedir=%p/lib/%N/include
#--mandir=%p/lib/%N/share/man
#--bindir=%p/lib/%N/bin 
CompileScript: <<
#!/bin/sh -ev
	# Must build libspeexdsp first because libspeex needs it
	pushd speexdsp-%v
		./configure %c
		make
	popd
	pushd speex-%v
		./configure %c \
			SPEEXDSP_CFLAGS=-I%b/speexdsp-%v/include \
			SPEEXDSP_LIBS=%b/speexdsp-%v/libspeexdsp/libspeexdsp.la
		make
	popd
	fink-package-precedence --prohibit-bdep=%n .
<<
###
InstallScript: <<
#!/bin/sh -ev
	pushd speexdsp-%v
		/usr/bin/make -j1 -w install DESTDIR=%d
	popd
	pushd speex-%v
		/usr/bin/make -j1 -w install DESTDIR=%d
	popd
	/bin/mkdir -p %i/lib/pkgconfig
	### unhide the .pc files
	/bin/ln -s %p/lib/%N/lib/pkgconfig/speex.pc %i/lib/pkgconfig/speex.pc
	/bin/ln -s %p/lib/%N/lib/pkgconfig/speexdsp.pc %i/lib/pkgconfig/speexdsp.pc
	### unhide the unversioned dylibs
	/bin/ln -s %p/lib/%N/lib/libspeex.dylib %i/lib/libspeex.dylib
	/bin/ln -s %p/lib/%N/lib/libspeexdsp.dylib %i/lib/libspeexdsp.dylib
<<
Splitoff: <<
  Package: %N-shlibs
  Files: <<
    lib/%N/lib/libspeex.*.dylib lib/%N/lib/libspeexdsp.*.dylib
  <<
  Shlibs: <<
    %p/lib/%N/lib/libspeex.1.dylib 7.0.0 %n (>= 1.2-0.0rc1.1)
    %p/lib/%N/lib/libspeexdsp.1.dylib 7.0.0 %n (>= 1.2-0.0rc1.1)
  <<
  DocFiles: doc/*
<<
Splitoff2: <<
  Package: %N-bin
  Depends: %N-shlibs (>= %v-%r), libogg-shlibs (>= 1.1.3-1)
  Conflicts: speex, speex1-bin, speex2-bin, speex3-bin
  Replaces: speex, speex1-bin, speex2-bin, speex3-bin
  Files: <<
    bin
    share/man
  <<
  DocFiles: doc/*
<<
###
Description: Voice compression format (codec)
DescDetail: <<
  Speex is a patent-free compression format designed especially for speech. It
  is specialized for voice communications at low bit-rates in the
  8-32 kbps/channel range. Possible applications include Voice over IP (VoIP)
  applications, Internet audio streaming at low bit-rate, and archiving of
  speech data (e.g. voice mail).
<<
DescPackaging: <<
Beginning with speex-1.2beta3, upstream offloaded all the non-codec
components (preprocessor, echo cancellation, jitter buffer) to
libspeexdsp.1.dylib, but did not bump the install_name for
libspeex.1.dylib.  Since this creates an ABI conflict with the
previous Fink speex3-1.1.6 package, the package for 1.2beta3+ was
renamed libspeex1 and the libraries were moved to %p/lib/%N/lib to
avoid filename collisions.  The headers, autotools, and pkgconfig
files were kept in the usual locations.  Packages that BuildDepends on
libspeex1 might need to add -L%p/lib/libspeex1/lib to their linker
command (via LDFLAGS or LIBS or similar method).

As of %r = 0.0rc1.4, both the unversioned dylib and the .pc files are
placed in the standard locations and should not need any special flags
to find and link to libspeex.  Although the existing
Conflicts/Replaces should prevent mislinking, packages should
explicitly BuildDepends against this version to remove any chance of
linking against speex3.
<<
###
License: LGPL
Maintainer: Hanspeter Niederstrasser <nieder@users.sourceforge.net>
Homepage: https://www.speex.org/
