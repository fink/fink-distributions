# -*- coding: ascii; tab-width: 4; x-counterpart: extutils-makemaker-pm.patch -*-
Info2: <<
Package: extutils-makemaker-pm%type_pkg[perl]
Version: 7.76
Revision: 1

Type: perl (5.16.2 5.18.2 5.18.4 5.28.2 5.30.2 5.30.3 5.34.1)
Distribution: <<
	(%type_pkg[perl] = 5162) 10.9,
	(%type_pkg[perl] = 5162) 10.10,
	(%type_pkg[perl] = 5162) 10.11,
	(%type_pkg[perl] = 5162) 10.12,
	(%type_pkg[perl] = 5162) 10.13
<<
Description: Perl module to create a module Makefile
License: Artistic
Maintainer: Daniel Johnson <daniel@daniel-johnson.org>
DescPackaging: <<
	Previously maintained by
	Christian Schaffner <chris01@users.sourceforge.net>
	
	Eliminated -bin splitoff and used update-alternatives to
	allow binaries to coexist.

	Hack a ton of perl-interp sub-launching due to fink's arch tricks.
<<
DescPort: <<
	Patch makefile generator to remove -L/usr/local/lib from early
	in LDDLFLAGS (don't have non-fink mask fink)
	
	It appears that Cwd::cwd can't get the cwd from within fink's build
	environment but Cwd::getcwd can. Patch MakeMaker.pm to use getcwd.
	
	On 10.15, Apple hardened system-perl to disallow loading from relative
	paths. So patch INST_ARCHLIB to be an absolute path. The relative path
	test "CHILD INST_ARCHLIB" is patched to use full paths. See:
	https://github.com/Perl-Toolchain-Gang/ExtUtils-MakeMaker/issues/350
	This was working as of 7.62 but test-fail in 7.76.

	clang >= 12 has a new warning that triggers many times on perl's
	own headers, so turn off that warning on versions of perl prior to
	when perl cleaned themselves up.
<<

# Dependencies:
Depends: <<
	cpan-meta-pm%type_pkg[perl] (>= 2.150010-1),
	cpan-meta-requirements-pm (>= 2.121-1),
	cpan-meta-yaml-pm (>= 0.008-1),
	extutils-install-pm (>= 1.54-1),
	extutils-manifest-pm (>= 1.65-1),
	json-pp-pm (>= 2.27.200-1),
	perl%type_pkg[perl]-core,
	scalar-list-utils-pm%type_pkg[perl]
<<
BuildDepends: fink (>= 0.30.0)

Replaces: %{Ni}586-bin, %{Ni}588-bin
Provides: %N-bin

# Unpack Phase:
Source: mirror:cpan:modules/by-module/ExtUtils/ExtUtils-MakeMaker-%v.tar.gz
Source-Checksum: SHA256(30bcfd75fec4d512e9081c792f7cb590009d9de2fe285ffa8eec1be35a5ae7ca)

PatchFile: %{ni}.patch
PatchFile-MD5: 0ef8e27cc7512f3684e5fe4ffe690e1f
PatchFile2: %{ni}-sdk.patch
PatchFile2-MD5: 85ee1155dad347b1c994463d3a0494b7
PatchFile3: %{ni}-perl-interp.patch
PatchFile3-MD5: 2507949a298c675f4b965aaa08e247b6
PatchFile4: %{ni}-perl-headers-noise.patch
PatchFile4-MD5: 6346911b188fade39aac0168c4bc7f1b
PatchScript: <<
	#!/bin/bash -ev
	/usr/bin/sed 's|@PREFIX@|%p|g' < %{PatchFile} | patch -p1
 	sed -e 's,@ARCH@,-%m,g' %{PatchFile3} | patch -p1
 	patch -p1 < %{PatchFile4}
	darwin_vers=`uname -r | cut -d. -f1`
	darwin_vers_minor=`uname -r | cut -d. -f2`
	# only apply SDK fix for 10.14/10.15/11.0 (which hide system-headers) and their systemperl
	if [[ "$darwin_vers" -eq 18 && "$darwin_vers_minor" -le 5 && %type_num[perl] -eq 5182 ]]; then
	  patch -p1 < %{PatchFile2}
	fi
	if [[ "$darwin_vers" -eq 18 && "$darwin_vers_minor" -ge 6 && %type_num[perl] -eq 5184 ]]; then
	  patch -p1 < %{PatchFile2}
	fi
	if [[ "$darwin_vers" -eq 19 && %type_num[perl] -eq 5184 ]]; then
	  patch -p1 < %{PatchFile2}
	fi
	if [[ "$darwin_vers" -eq 20 && "$darwin_vers_minor" -le 3 && %type_num[perl] -eq 5282 ]]; then
	  patch -p1 < %{PatchFile2}
	fi
	if [[ "$darwin_vers" -eq 20 && "$darwin_vers_minor" -ge 4 && %type_num[perl] -eq 5302 ]]; then
	  patch -p1 < %{PatchFile2}
	fi
	if [[ "$darwin_vers" -eq 21 && %type_num[perl] -eq 5303 ]]; then
	  patch -p1 < %{PatchFile2}
	fi
	if [[ "$darwin_vers" -eq 22 && %type_num[perl] -eq 5303 ]]; then
	  patch -p1 < %{PatchFile2}
	fi
	if [[ "$darwin_vers" -eq 23 && "$darwin_vers_minor" -le 3 && %type_num[perl] -eq 5303 ]]; then
	  patch -p1 < %{PatchFile2}
	fi
	if [[ "$darwin_vers" -eq 23 && "$darwin_vers_minor" -ge 4 && %type_num[perl] -eq 5341 ]]; then
	  patch -p1 < %{PatchFile2}
	fi
	if [[ "$darwin_vers" -eq 24 && %type_num[perl] -eq 5341 ]]; then
	  patch -p1 < %{PatchFile2}
	fi
	if [[ "$darwin_vers" -eq 25 && %type_num[perl] -eq 5341 ]]; then
	  patch -p1 < %{PatchFile2}
	fi

	# Some boilerplate in perl headers on all perl versions trigger a
	# mile of compiler warnings that obscure debugging of actual
	# issues in modules being compiled. I'm not sure when this warning
	# was added to xocde, so I'm being conservative with applying a
	# patch to hide it. --dmacks
	if [[ "$darwin_vers" -ge 25 ]]; then
	  perl -pi -e 's/(-Wno-error=implicit-function-declaration)/\1 -Wno-compound-token-split-by-macro/' lib/ExtUtils/MM_Darwin.pm
	fi

	/usr/bin/sed -i '' "s/'\.\$perlflags\.'//" lib/ExtUtils/MM_Unix.pm
<<

CompileScript: <<
	#!/bin/bash -ev
	export BUILDING_AS_PACKAGE=1
	%{default_script}
<<

# Install Phase:
UpdatePOD: True
DocFiles: Changes CONTRIBUTING README
InstallScript: <<
	%{default_script}
	mv %i/share/man %i/lib/perl5/%type_raw[perl]
	/bin/mv %i/bin/instmodsh %i/bin/instmodsh-pm%type_pkg[perl]
<<
InfoTest: <<
	TestScript: <<
		#!/bin/bash -ev
		export ARCHFLAGS=""
		%{default_script}
	<<
<<

PostInstScript: update-alternatives --install %p/bin/instmodsh instmodsh %p/bin/instmodsh-pm%type_pkg[perl] %type_pkg[perl]

PreRmScript: update-alternatives --remove instmodsh %p/bin/instmodsh-pm%type_pkg[perl]

# Additional Info:
Homepage: https://metacpan.org/dist/ExtUtils-MakeMaker/
<<
