From 83812c7c3fca43f3e06cbbb2157c6820702ab945 Mon Sep 17 00:00:00 2001
From: Arthur Pastel <arthur.pastel@gmail.com>
Date: Tue, 10 Sep 2024 12:51:51 +0200
Subject: [PATCH] chore: fix utils test using a fake git repo

---
 tests/test_utils.py | 26 +++++++++++++++-----------
 1 file changed, 15 insertions(+), 11 deletions(-)

diff --git a/tests/test_utils.py b/tests/test_utils.py
index 5111718..72087ee 100644
--- a/tests/test_utils.py
+++ b/tests/test_utils.py
@@ -1,28 +1,32 @@
+import tempfile
+from contextlib import contextmanager
 from pathlib import Path
-from unittest.mock import patch
 
 from pytest_codspeed.utils import get_git_relative_path, get_git_relative_uri
 
 
+@contextmanager
+def TemporaryGitRepo():
+    with tempfile.TemporaryDirectory() as tmpdirname:
+        (Path(tmpdirname) / ".git").mkdir(parents=True)
+        yield tmpdirname
+
+
 def test_get_git_relative_path_found():
-    with patch.object(
-        Path, "exists", lambda self: str(self) == "/home/user/gitrepo/.git"
-    ):
-        path = Path("/home/user/gitrepo/folder/nested_folder")
+    with TemporaryGitRepo() as tmp_repo:
+        path = Path(tmp_repo) / "folder/nested_folder"
         assert get_git_relative_path(path) == Path("folder/nested_folder")
 
 
 def test_get_git_relative_path_not_found():
-    with patch.object(Path, "exists", lambda self: False):
-        path = Path("/home/user/gitrepo/folder")
+    with tempfile.TemporaryDirectory() as tmp_dir:
+        path = Path(tmp_dir) / "folder"
         assert get_git_relative_path(path) == path
 
 
 def test_get_git_relative_uri():
-    with patch.object(
-        Path, "exists", lambda self: str(self) == "/home/user/gitrepo/.git"
-    ):
-        pytest_rootdir = Path("/home/user/gitrepo/pytest_root")
+    with TemporaryGitRepo() as tmp_repo:
+        pytest_rootdir = Path(tmp_repo) / "pytest_root"
         uri = "testing/test_excinfo.py::TestFormattedExcinfo::test_fn"
         assert (
             get_git_relative_uri(uri, pytest_rootdir)
