Info2: <<
Package: fltk-backend-%type_pkg[ui]-oct%type_pkg[oct]
Type: ui (x11 aqua), oct(3.2.4)
Version: 3.2.4
Revision: 0.9000
Maintainer: Alexander Hansen <alexkhansen@users.sourceforge.net>
Description: X11-based graphics backend for octave%type_pkg[oct]
DescDetail:  <<
We build fltk-backend.oct separately to allow for variants that use Aqua and X11.
<<

# disable atlas on 10.7 distro file until atlas is available

Source: mirror:gnu:octave/octave-%v.tar.gz
Source-MD5: 90c39fa9e241ad2e978bcee4682a2ba9
SourceDirectory: octave-%v

BuildDepends: <<
	(%type_pkg[ui] = x11) fltk-x11, 
	(%type_pkg[ui] = x11) x11-dev,
	(%type_pkg[ui] = aqua) fltk13-aqua,
	arpack, glpk-dev, hdf5.7, readline5, libncurses5, fftw3 (>= 3.1.1-7), 
    libcurl4, , libftgl2, qhull6-dev, qrupdate,
	pcre, gcc46-compiler, suitesparse-metis, fink (>= 0.30.0), fink-package-precedence, sed, 
	graphicsmagick-dev, freetype219, libftgl2
<<
Depends: <<
	(%type_pkg[ui] = x11) fltk-x11-shlibs,  
	(%type_pkg[ui] = x11) x11,
	(%type_pkg[ui] = aqua) fltk13-aqua-shlibs,
	octave%type_pkg[oct]-shlibs
<<
BuildConflicts: coot-dev, broken-gcc, lammpi-dev, fort77, 4ti2-dev
GCC: 4.0
Conflicts: fltk-backend-aqua-oct%type_pkg[oct], fltk-backend-x11-oct%type_pkg[oct]
Replaces: fltk-backend-aqua-oct%type_pkg[oct], fltk-backend-x11-oct%type_pkg[oct]
UseMaxBuildJobs: true

PatchFile: octave.patch
PatchFile-MD5: efef1c4d103b5c87d25ad1a2d0671469
PatchFile3: octave-10.7.patch
PatchFile3-MD5: adf5439f08870b6f7ba0d9be7e85bb22
PatchFile2: fltk-backend-x11.patch
PatchFile2-MD5: 6dd5be3b8d199fb76a72997ea50d05d4

PatchScript: <<
	#!/bin/sh -ev
	cp doc/interpreter/octave.1 doc/interpreter/octave-%v.1
	cp doc/interpreter/octave-bug.1 doc/interpreter/octave-bug-%v.1
	cp doc/interpreter/octave-config.1 doc/interpreter/octave-config-%v.1
	cp doc/interpreter/mkoctfile.1 doc/interpreter/mkoctfile-%v.1
	sed -e 's/@OCTVERSION@/%v/g' %{PatchFile} | patch -p1 
	sed -i -e 's|@FINKPREFIX@|%p|g'   octave-forge* octaverc doc/interpreter/*.1 mkoctfile.in
	# fix lib name for qhull6
	perl -pi -e 's|(qhull[/.])|lib\1|g ; s|lqhull|lqhull6|' configure
	# wrong include dir for qhull6
	for f in `grep -l -r "qhull_a\.h" src`
		do sed -i.orig -e '/include/s|qhull/|lib&|' $f
	done
	# more patching by fangism
	# silence some warnings
	sed -i.orig -e '/ibasea/s|\*ibasea, ||' \
		-e '/ibasea/s| ibasea =.*||' \
		liboctave/oct-sort.cc
	# should this accompany -D_THREAD_SAFE? in CFLAGS,CXXFLAGS
	sed -i.orig '/#include.*Range\.h/i\
#define	_REENTRANT' liboctave/lo-specfun.cc
	# need size_t from <cstddef>
	sed -i.orig -e '/#define octave_oct_alloc_h/a\
using std::size_t;' liboctave/oct-alloc.h
	# needed by clang++, safe for g++: using-declaration as typedef
	for f in liboctave/DiagArray2.h liboctave/intNDArray.h
	do sed -i.orig -e '/using.*element_type;/s|using|& typename|' $f
	done
	# missing qualifier to dependent-name member-function
	sed -i.orig -e '/truncate_int/s|\(return\) \(truncate_int\)|\1 octave_int_base<T>::\2|' liboctave/oct-inttypes.h
    # Needed for 10.7 only, but may work on earlier OSes
	if [ "%type_pkg[ui]" = "aqua" ]
	then
		patch -p1 < %{PatchFile3}
	else
		patch -p1 < %{PatchFile2}
	fi
<<

SetLDFLAGS: -Wl,-dead_strip_dylibs
SetLIBS: -lGraphicsMagick -lmetis
ConfigureParams: <<
	F77=%p/bin/gfortran-fsf-4.6 --host=%m-apple-darwin --build=%m-apple-darwin \
	--infodir='${prefix}/share/info' --mandir='${prefix}/share/man' --libexecdir='${prefix}/lib' \
	--enable-shared --enable-dl  --without-mpi --with-hdf5 --with-fftw \
	(%type_pkg[ui] = x11 ) --with-x \
	(%type_pkg[ui] = x11 ) --x-libraries=/usr/X11/lib \ 
	(%type_pkg[ui] = x11 ) --x-includes=/usr/X11/include \ 
	(%type_pkg[ui] = x11 ) --without-framework-carbon \
	(%type_pkg[ui] = aqua ) --without-x \
	(%type_pkg[ui] = aqua ) --with-framework-carbon \
	--disable-static
<<
CompileScript: <<
 #!/bin/sh -ev
 export CFLAGS='-O3'
 export CXXFLAGS='-O3'
 export FFLAGS='-O3 -ff2c'
 a='--with-lapack=-Wl,-framework,Accelerate,-dylib_file,/System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libLAPACK.dylib:/System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libLAPACK.dylib --with-blas=-Wl,-framework,Accelerate,-dylib_file,/System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib:/System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib'
 FLIBDIR="%p/lib/gcc4.6/lib"
 ./configure FLIBS="${FLIBDIR}/libgfortran.dylib" %c $a
 make
 fink-package-precedence --depfile-ext='.d' --prohibit-bdep=octave,octave-atlas,octave%type_raw[oct]-dev,octave%type_raw[oct]-atlas-dev,octave305-dev,octave305-atlas-dev src
<<

InstallScript: <<
 mkdir -p %i/lib/octave/%type_raw[oct]/oct/%m-apple-darwin
 cp src/fltk_backend.oct %i/lib/octave/%type_raw[oct]/oct/%m-apple-darwin/
<<
DocFiles: COPYING
Homepage: http://www.octave.org/
License: GPL
DescPort: <<
	Aqua variant:
	Apply fix from http://lukassen.wordpress.com/2010/01/18/taming-snow-leopard-cgdisplaybitsperpixel-deprication/ ,
	with improvements from Peter O'Gorman and Daniel Macks, to display.cc to work around the lack of 
	CGDisplayBitsPerPixel on 10.7.
	X11 variant:
	Rip out #if defined ... #elif ... #endif branches in display.cc that don't pertain to X11.
<<
DescPackaging:  <<
	Currently we build all of octave and then only install fltk_backend.oct.  
<<
<<
