
--- startkde	3 Mar 2003 01:36:36 -0000	1.1.1.7
+++ startkde	3 Mar 2003 01:55:31 -0000	1.11
@@ -34,6 +34,10 @@
 # people's heads. We use colours from the standard KDE palette for those with
 # palettised displays.
 
+# we have to unset this for Darwin since it will screw up KDE's dynamic-loading
+unset DYLD_FORCE_FLAT_NAMESPACE
+test -d "@PREFIX@" && export PATH="@PREFIX@/bin:${PATH}"
+
 test "$XDM_MANAGED" || bkg="-solid #C0C0C0"
 xsetroot -cursor_name left_ptr $bkg
 
@@ -110,6 +114,11 @@
     export GS_LIB
 fi
 
+# if we're in Apple's X11 and the native window manager is available, use that
+if test -z "$KDEWM" && test -x /usr/X11R6/bin/quartz-wm; then
+    KDEWM="/usr/X11R6/bin/quartz-wm"
+fi
+
 # Link "tmp" resource to directory in /tmp
 # Creates a directory /tmp/kde-$USER and links $KDEHOME/tmp-$HOSTNAME to it.
 lnusertemp tmp >/dev/null
@@ -128,7 +137,11 @@
     # start only dcopserver, don't start whole kdeinit (takes too long)
     echo 'startkde: Running kpersonalizer...'  1>&2
     dcopserver
-    kwin &
+    if test -n "$KDEWM"; then
+        $KDEWM &
+    else
+        kwin &
+    fi
     kpersonalizer --before-session
     # handle kpersonalizer restarts (language change)
     while test $? -eq 1; do
@@ -139,7 +152,6 @@
     sleep 1
 fi
 
-# the splashscreen and progress indicator
 ksplash
 
 # We set LD_BIND_NOW to increase the efficiency of kdeinit.
RCS file: debian/konsole.links
diff -N debian/konsole.links
RCS file: doc/kaddressbook/index.cache.bz2
diff -N doc/kaddressbook/index.cache.bz2
--- kate/app/Makefile.am	12 Nov 2002 04:16:41 -0000	1.1.1.4
+++ kate/app/Makefile.am	26 Nov 2002 21:00:50 -0000	1.10
@@ -1,4 +1,4 @@
-lib_LTLIBRARIES = libkateinterfaces.la kate.la kwrite.la
+lib_LTLIBRARIES = libkateinterfaces.la kate.la kwrite.la libkwrite_main.la
 bin_PROGRAMS = kate kwrite
 
 libkateinterfaces_la_SOURCES = kateapp.cpp kateconfigdialog.cpp kateconfigplugindialogpage.cpp \
@@ -7,34 +7,35 @@
 	kateviewmanager.cpp kateviewspace.cpp \
 	kateIface.skel kategrepdialog.cpp katefiledialog.cpp katemailfilesdialog.cpp \
         kbookmarkhandler.cpp kactionselector.cpp katedockcontainer.cpp
+libkateinterfaces_la_LIBADD   = $(top_builddir)/kate/interfaces/libkateinterfacesprivate.la -lkscript $(top_builddir)/kate/lib/libkmultitabbar.la
+libkateinterfaces_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -avoid-version
 
-libkateinterfaces_la_LIBADD   = ../interfaces/libkateinterfacesprivate.la -lkscript ../lib/libkmultitabbar.la
-libkateinterfaces_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -module -avoid-version
-kate_la_SOURCES = katemain.cpp
-kate_la_LIBADD = libkateinterfaces.la
-kate_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -module -avoid-version 
-
-kwrite_la_SOURCES = kwritemain.cpp katefiledialog.cpp kwritedialogs.cpp
-kwrite_la_LIBADD   = -lktexteditor
-kwrite_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -module -avoid-version
+kate_la_SOURCES = kate_la_main.cpp
+kate_la_LIBADD  = libkateinterfaces.la
+kate_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -avoid-version -module
 
-kate_SOURCES = dummy_kate.cpp
-kate_LDADD = kate.la
-kate_LDFLAGS = $(KDE_RPATH) $(all_libraries)
+kate_la_main.cpp: katemain.cpp
+	cat katemain.cpp > kate_la_main.cpp
 
-kwrite_SOURCES = dummy_kwrite.cpp
-kwrite_LDADD = kwrite.la
-kwrite_LDFLAGS = $(KDE_RPATH) $(all_libraries)
+libkwrite_main_la_SOURCES = kwritemain.cpp katefiledialog.cpp kwritedialogs.cpp
+libkwrite_main_la_LIBADD  = -lktexteditor $(LIB_QT) -lkdecore -lDCOP -lkdeui -lkio -lkparts
+libkwrite_main_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -avoid-version
+
+kwrite_la_SOURCES = kwrite_la_main.cpp
+kwrite_la_LIBADD  = libkwrite_main.la
+kwrite_la_LDFLAGS = $(KDE_RPATH) $(all_libraries) -avoid-version -module
 
-dummy_kate_la.cpp:
-	echo > dummy_kate_la.cpp
+kwrite_la_main.cpp: kwrite_main.cpp
+	cat kwrite_main.cpp > kwrite_la_main.cpp
 
-dummy_kate.cpp:
-	echo > dummy_kate.cpp
+kate_SOURCES = katemain.cpp
+kate_LDADD = libkateinterfaces.la
+kate_LDFLAGS = $(KDE_RPATH) $(all_libraries)
+
+kwrite_SOURCES = kwrite_main.cpp
+kwrite_LDADD = libkwrite_main.la
+kwrite_LDFLAGS = $(KDE_RPATH) $(all_libraries)
 
-dummy_kwrite.cpp:
-	echo > dummy_kwrite.cpp
-                         
 METASOURCES = AUTO  
   
 INCLUDES= -I../interfaces -I$(srcdir)/../lib $(all_includes)
--- kate/app/kateviewmanager.cpp	20 Nov 2002 01:11:18 -0000	1.1.1.6
+++ kate/app/kateviewmanager.cpp	29 Mar 2003 02:33:52 -0000	1.2
@@ -41,6 +41,9 @@
 #include <kstdaction.h>
 #include <kstandarddirs.h>
 #include <qfileinfo.h>
+
+#include <kio/netaccess.h>
+
 #include <qlayout.h>
 #include <qobjectlist.h>
 #include <qstringlist.h>
@@ -806,6 +809,16 @@
 
     int i = 0;
     QString fn;
+    // check all remote files for existance in a syncrounous way
+    // so that the password dialog only appears ones for every remote source
+    while (scfg->hasKey(QString("File%1").arg(i)))
+    {
+      fn = scfg->readEntry( QString("File%1").arg( i ) );
+      if ( !fn.isEmpty() && !KURL( fn ).isLocalFile() )
+          KIO::NetAccess::exists(KURL( fn ), true);
+      i++;
+    }    
+    i = 0;
     while (scfg->hasKey(QString("File%1").arg(i)))
     {
       fn = scfg->readEntry( QString("File%1").arg( i ) );
RCS file: kate/app/kwrite_main.cpp
diff -N kate/app/kwrite_main.cpp
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ kate/app/kwrite_main.cpp	26 Nov 2002 21:00:50 -0000	1.1
@@ -0,0 +1,27 @@
+/*
+ *
+ * Copyright (c) 2001 Nick Hudson <skrll@netbsd.org>
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining a copy
+ * of this software and associated documentation files (the "Software"), to deal
+ * in the Software without restriction, including without limitation the rights
+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
+ * copies of the Software, and to permit persons to whom the Software is
+ * furnished to do so, subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice shall be included in
+ * all copies or substantial portions of the Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
+ * AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN
+ * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+extern "C" int kdemain(int, char* []);
+
+int main( int argc, char* argv[] )
+{
+        return kdemain(argc, argv);
+}
--- kate/app/kwritemain.cpp	3 Mar 2003 01:38:05 -0000	1.1.1.6
+++ kate/app/kwritemain.cpp	3 Mar 2003 01:55:31 -0000	1.3
@@ -538,7 +538,9 @@
   { 0, 0, 0}
 };
 
-int main(int argc, char **argv)
+extern "C" int kdemain(int, char**);
+
+int kdemain(int argc, char **argv)
 {
   KLocale::setMainCatalogue("kate");         //lukas: set this to have the kwritepart translated using kate message catalog
 
--- kate/lib/Makefile.am	14 Aug 2002 14:26:30 -0000	1.1.1.2
+++ kate/lib/Makefile.am	26 Nov 2002 21:00:51 -0000	1.2
@@ -5,7 +5,7 @@
 lib_LTLIBRARIES = libkmultitabbar.la 
 
 libkmultitabbar_la_SOURCES=kmultitabbar.cpp
-libkmultitabbar_la_LDFLAGS = $(all_libraries) -no-undefined
+libkmultitabbar_la_LDFLAGS = $(all_libraries) -no-undefined -avoid-version
 libkmultitabbar_la_LIBADD = $(LIB_KPARTS)
 
 METASOURCES = AUTO
--- kcheckpass/checkpass_pam.c	25 Jun 2002 02:03:44 -0000	1.1.1.1
+++ kcheckpass/checkpass_pam.c	21 Nov 2002 21:28:36 -0000	1.2
@@ -26,7 +26,12 @@
  *****************************************************************/
 #include <stdlib.h>
 #include <string.h>
+
+#ifdef HAVE_PAM_PAM_APPL_H
+#include <pam/pam_appl.h>
+#else
 #include <security/pam_appl.h>
+#endif
 
 static const char *PAM_username;
 static const char *PAM_password;
--- kcontrol/access/Makefile.am	1 Oct 2002 02:33:58 -0000	1.1.1.3
+++ kcontrol/access/Makefile.am	26 Nov 2002 21:00:51 -0000	1.7
@@ -4,16 +4,23 @@
 
 bin_PROGRAMS = kaccess
 
-kaccess_SOURCES = dummy.cpp
+kaccess_SOURCES = main.cpp
 kaccess_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-kaccess_LDADD = kaccess.la
+kaccess_LDADD = libkaccess_main.la
 
 kde_module_LTLIBRARIES = kcm_access.la
-lib_LTLIBRARIES = kaccess.la
+lib_LTLIBRARIES = kaccess.la libkaccess_main.la
 
-kaccess_la_SOURCES = kaccess.cpp main.cpp
-kaccess_la_LDFLAGS = $(all_libraries) -module -avoid-version
-kaccess_la_LIBADD = $(LIB_KDEUI)
+libkaccess_main_la_SOURCES = kaccess.cpp
+libkaccess_main_la_LDFLAGS = $(all_libraries) -avoid-version
+libkaccess_main_la_LIBADD  = $(LIB_KDEUI) $(LIB_QT) -lkdecore -lDCOP
+
+kaccess_la_SOURCES = kaccess_la_main.cpp
+kaccess_la_LDFLAGS = $(all_libraries) -avoid-version -module
+kaccess_la_LIBADD = libkaccess_main.la
+
+kaccess_la_main.cpp: main.cpp
+	cat main.cpp > kaccess_la_main.cpp
 
 kcm_access_la_SOURCES = kcmaccess.cpp 
 kcm_access_la_LDFLAGS  = $(all_libraries) -module -avoid-version -no-undefined
@@ -32,6 +39,3 @@
 messages:
 	$(XGETTEXT) $(kaccess_la_SOURCES) -o $(podir)/kaccess.pot
 	$(XGETTEXT) $(kcm_access_la_SOURCES) -o $(podir)/kcmaccess.pot
-
-dummy.cpp:
-	echo > dummy.cpp
--- kcontrol/ebrowsing/plugins/ikws/kuriikwsfilter.desktop	20 Nov 2002 01:11:26 -0000	1.1.1.7
+++ kcontrol/ebrowsing/plugins/ikws/kuriikwsfilter.desktop	29 Mar 2003 02:33:55 -0000	1.2
@@ -39,12 +39,12 @@
 Name[th]=ตัวกรองคำค้นหาบนอินเตอร์เน็ต
 Name[tr]=İnternetAnahtarKelimeSüzgeci
 Name[uk]=Фільтр ключових слів Інтернет
-Name[ven]=Filithara ya Khiimaipfi ya Inithanete 
-Name[vi]=Trình lọc các từ khoá Internet 
+Name[ven]=Filithara ya Khiimaipfi ya Inithanete
+Name[vi]=Trình lọc các từ khoá Internet
 Name[xh]=Amagama Angundoqo ecebo lokucoca ulwelo e Internet
 Name[zh_CN]=Internet 关键字过滤
 Name[zh_TW]=Internet 關鍵字過濾
 Name[zu]=Ihluzo lamagama abalulekile e-Internet
 X-KDE-Library=libkuriikwsfilter
-InitialPreference=2
+InitialPreference=1
 ServiceTypes=KURIFilter/Plugin
--- kcontrol/ebrowsing/plugins/ikws/kurisearchfilter.desktop	20 Nov 2002 01:11:26 -0000	1.1.1.8
+++ kcontrol/ebrowsing/plugins/ikws/kurisearchfilter.desktop	29 Mar 2003 02:33:55 -0000	1.2
@@ -38,11 +38,11 @@
 Name[tr]=TaramaKelimeSüzgeci
 Name[uk]=Фільтр ключових слів Інтернет
 Name[ven]=Filithara ya Khiimaipfi yau setsha
-Name[vi]=Trình tìm và lọc các từ khoá 
+Name[vi]=Trình tìm và lọc các từ khoá
 Name[xh]=Phendla Amagama Angundoqo Ecebo Lokucoca Ulwelo
 Name[zh_CN]=搜索关键字过滤
 Name[zh_TW]=搜索關鍵字過濾
 Name[zu]=Ihluzo lamagama abalulekile okusesha
 X-KDE-Library=libkurisearchfilter
 ServiceTypes=KURIFilter/Plugin
-InitialPreference=6
+InitialPreference=4
--- kcontrol/ebrowsing/plugins/localdomain/localdomainurifilter.desktop	20 Nov 2002 01:11:26 -0000	1.1.1.5
+++ kcontrol/ebrowsing/plugins/localdomain/localdomainurifilter.desktop	29 Mar 2003 02:33:57 -0000	1.2
@@ -28,4 +28,4 @@
 Name[zu]=Ihluzo Lendawo Yaseduze
 X-KDE-Library=liblocaldomainurifilter
 ServiceTypes=KURIFilter/Plugin
-InitialPreference=1
+InitialPreference=2
--- kcontrol/ebrowsing/plugins/shorturi/kshorturifilter.desktop	20 Nov 2002 01:11:26 -0000	1.1.1.6
+++ kcontrol/ebrowsing/plugins/shorturi/kshorturifilter.desktop	29 Mar 2003 02:33:59 -0000	1.2
@@ -40,4 +40,4 @@
 Name[zh_TW]=短 URI 過濾器
 X-KDE-Library=libkshorturifilter
 ServiceTypes=KURIFilter/Plugin
-InitialPreference=5
+InitialPreference=3
--- kcontrol/filetypes/filetypesview.cpp	3 Mar 2003 01:38:17 -0000	1.1.1.6
+++ kcontrol/filetypes/filetypesview.cpp	29 Mar 2003 02:34:01 -0000	1.2
@@ -21,6 +21,7 @@
 #include "filetypedetails.h"
 #include "filegroupdetails.h"
 #include "filetypesview.h"
+#include <ksycoca.h>
 
 FileTypesView::FileTypesView(QWidget *p, const char *name)
   : KCModule(p, name)
@@ -111,6 +112,8 @@
   m_widgetStack->raiseWidget( m_emptyWidget );
 
   QTimer::singleShot( 0, this, SLOT( init() ) ); // this takes some time
+
+  connect( KSycoca::self(), SIGNAL( databaseChanged() ), SLOT( slotDatabaseChanged() ) );
 }
 
 FileTypesView::~FileTypesView()
@@ -309,7 +312,7 @@
     setDirty(false);
 }
 
-bool FileTypesView::sync()
+bool FileTypesView::sync( QValueList<TypesListItem *>& itemsModified )
 {
   bool didIt = false;
   // first, remove those items which we are asked to remove.
@@ -336,6 +339,7 @@
     if (tli->isDirty()) {
       kdDebug() << "Entry " << tli->name() << " is dirty. Saving." << endl;
       tli->sync();
+      itemsModified.append( tli );
       didIt = true;
     }
   }
@@ -350,12 +354,34 @@
 
 void FileTypesView::save()
 {
-  // only send dcop signal if sync() was necessary.
-  if (sync()) {
+  m_itemsModified.clear();
+  if (sync(m_itemsModified)) {
+    // only send dcop signal if sync() was necessary.
     DCOPClient *dcc = kapp->dcopClient();
     if ( !dcc->isAttached() )
 	dcc->attach();
     dcc->send("kded", "kbuildsycoca", "recreate()", QByteArray());
+    // send() returns immediately. This means we don't have to block the UI
+    // while kbuildsycoca runs, unlike KOpenWithDlg.
+    // We'll update the mimetype object when databaseChanged() is emitted.
+  }
+}
+
+void FileTypesView::slotDatabaseChanged()
+{
+  if ( KSycoca::self()->isChanged( "mime" ) )
+  {
+    // ksycoca has new KMimeTypes objects for us, make sure to update
+    // our 'copies' to be in sync with it. Not important for OK, but
+    // important for Apply (how to differenciate those 2?).
+    // See BR 35071.
+    QValueList<TypesListItem *>::Iterator it = m_itemsModified.begin();
+    for( ; it != m_itemsModified.end(); ++it ) {
+        QString name = (*it)->name();
+        if ( removedList.find( name ) == removedList.end() ) // if not deleted meanwhile
+            (*it)->refresh();
+    }
+    m_itemsModified.clear();
   }
 }
 
--- kcontrol/filetypes/filetypesview.h	25 Jun 2002 02:03:45 -0000	1.1.1.1
+++ kcontrol/filetypes/filetypesview.h	29 Mar 2003 02:34:02 -0000	1.2
@@ -28,8 +28,6 @@
   FileTypesView(QWidget *p = 0, const char *name = 0);
   ~FileTypesView();
 
-  bool sync();
-
   void load();
   void save();
   void defaults();
@@ -46,8 +44,11 @@
   void slotFilter(const QString &patternFilter);
   void setDirty(bool state);
 
+  void slotDatabaseChanged();
+
 protected:
-    void readFileTypes();
+  void readFileTypes();
+  bool sync( QValueList<TypesListItem *>& itemsModified );
 
 private:
   KListView *typesLV;
@@ -65,6 +66,9 @@
   QPtrList<TypesListItem> m_itemList;
   QSplitter *m_splitter;
   QWidget *m_left;
+
+  QValueList<TypesListItem *> m_itemsModified;
+
 };
 
 #endif
--- kcontrol/filetypes/keditfiletype.cpp	25 Jun 2002 02:03:45 -0000	1.1.1.1
+++ kcontrol/filetypes/keditfiletype.cpp	29 Mar 2003 02:34:03 -0000	1.2
@@ -25,7 +25,7 @@
 #include <kdebug.h>
 #include <kcmdlineargs.h>
 #include <klocale.h>
-#include <kglobal.h>
+#include <ksycoca.h>
 
 FileTypeDialog::FileTypeDialog( KMimeType::Ptr mime )
   : KDialogBase( 0L, 0, true, QString::null, /* Help | */ Cancel | Apply | Ok,
@@ -42,6 +42,8 @@
   connect(m_details, SIGNAL(changed(bool)), this, SLOT(clientChanged(bool)));
   // TODO setHelp()
   enableButton(Apply, false);
+
+  connect( KSycoca::self(), SIGNAL( databaseChanged() ), SLOT( slotDatabaseChanged() ) );
 }
 
 void FileTypeDialog::save()
@@ -69,6 +71,14 @@
   // enable/disable buttons
   enableButton(User1, state);
   enableButton(Apply, state);
+}
+
+void FileTypeDialog::slotDatabaseChanged()
+{
+  if ( KSycoca::self()->isChanged( "mime" ) )
+  {
+      m_item->refresh();
+  }
 }
 
 #include "keditfiletype.moc"
--- kcontrol/filetypes/keditfiletype.h	25 Jun 2002 02:03:45 -0000	1.1.1.1
+++ kcontrol/filetypes/keditfiletype.h	29 Mar 2003 02:34:03 -0000	1.2
@@ -38,6 +38,7 @@
   virtual void slotApply();
   virtual void slotOk();
   void clientChanged(bool state);
+  void slotDatabaseChanged();
 
 protected:
   void save();
--- kcontrol/filetypes/typeslistitem.cpp	5 Nov 2002 00:15:17 -0000	1.1.1.4
+++ kcontrol/filetypes/typeslistitem.cpp	29 Mar 2003 02:34:03 -0000	1.2
@@ -133,23 +133,23 @@
     if ((m_mimetype->name() != name()) &&
         (name() != "application/octet-stream"))
     {
-      kdDebug() << "Mimetype Name Dirty :" << m_mimetype->name() << " name()=" << name() << endl;
+      kdDebug() << "Mimetype Name Dirty: old=" << m_mimetype->name() << " name()=" << name() << endl;
       return true;
     }
     if (m_mimetype->comment(QString(), false) != m_comment)
     {
-      kdDebug() << "Mimetype Comment Dirty :" << m_mimetype->comment(QString(),false) << " m_comment=" << m_comment << endl;
+      kdDebug() << "Mimetype Comment Dirty: old=" << m_mimetype->comment(QString(),false) << " m_comment=" << m_comment << endl;
       return true;
     }
     if (m_mimetype->icon(QString(), false) != m_icon)
     {
-      kdDebug() << "Mimetype Icon Dirty :" << m_mimetype->icon(QString(),false) << " m_icon=" << m_icon << endl;
+      kdDebug() << "Mimetype Icon Dirty: old=" << m_mimetype->icon(QString(),false) << " m_icon=" << m_icon << endl;
       return true;
     }
 
     if (m_mimetype->patterns() != m_patterns)
     {
-      kdDebug() << "Mimetype Patterns Dirty :" << m_mimetype->patterns().join(";")
+      kdDebug() << "Mimetype Patterns Dirty: old=" << m_mimetype->patterns().join(";")
                 << " m_patterns=" << m_patterns.join(";") << endl;
       return true;
     }
@@ -164,13 +164,13 @@
 
     if (oldAppServices != m_appServices)
     {
-      kdDebug() << "App Services Dirty :" << oldAppServices.join(";")
+      kdDebug() << "App Services Dirty: old=" << oldAppServices.join(";")
                 << " m_appServices=" << m_appServices.join(";") << endl;
       return true;
     }
     if (oldEmbedServices != m_embedServices)
     {
-      kdDebug() << "Embed Services Dirty :" << oldEmbedServices.join(";")
+      kdDebug() << "Embed Services Dirty: old=" << oldEmbedServices.join(";")
                 << " m_embedServices=" << m_embedServices.join(";") << endl;
       return true;
     }
@@ -224,7 +224,7 @@
 
   m_bNewItem = false;
 
-  KSimpleConfig profile("profilerc");
+  KConfig profile("profilerc", false, false);
 
   // Deleting current contents in profilerc relating to
   // this service type
@@ -324,7 +324,7 @@
   }
 }
 
-void TypesListItem::saveServices( KSimpleConfig & profile, QStringList services, const QString & genericServiceType )
+void TypesListItem::saveServices( KConfig & profile, QStringList services, const QString & genericServiceType )
 {
   QStringList::Iterator it(services.begin());
   for (int i = services.count(); it != services.end(); ++it, i--) {
@@ -402,4 +402,10 @@
     if ( n == "application/x-desktop" )
         return true;
     return false;
+}
+
+void TypesListItem::refresh()
+{
+    kdDebug() << "TypesListItem refresh " << name() << endl;
+    m_mimetype = KMimeType::mimeType( name() );
 }
--- kcontrol/filetypes/typeslistitem.h	29 Oct 2002 03:02:59 -0000	1.1.1.3
+++ kcontrol/filetypes/typeslistitem.h	29 Mar 2003 02:34:04 -0000	1.2
@@ -56,16 +56,17 @@
   bool isDirty() const;
   void sync();
   void setup();
+  void refresh(); // update m_mimetype from ksycoca when Apply is pressed
 
   static bool defaultEmbeddingSetting(  const QString& major );
 
 private:
   void getServiceOffers( QStringList & appServices, QStringList & embedServices ) const;
-  void saveServices( KSimpleConfig & profile, QStringList services, const QString & servicetype2 );
-  KMimeType::Ptr m_mimetype;
+  void saveServices( KConfig & profile, QStringList services, const QString & servicetype2 );
   void initMeta( const QString & major );
   void init(KMimeType::Ptr mimetype);
 
+  KMimeType::Ptr m_mimetype;
   unsigned int groupCount:16; // shared between saveServices and sync
   unsigned int m_autoEmbed:2; // 0 yes, 1 no, 2 use group setting
   unsigned int metaType:1;
--- kcontrol/info/Makefile.am	25 Jun 2002 02:03:45 -0000	1.1.1.1
+++ kcontrol/info/Makefile.am	24 Nov 2002 07:11:28 -0000	1.4
@@ -2,7 +2,7 @@
 
 kcm_info_la_SOURCES = main.cpp memory.cpp
 
-kcm_info_la_LDFLAGS = $(all_libraries) -module -avoid-version -no-undefined
+kcm_info_la_LDFLAGS = $(all_libraries) -module -avoid-version -no-undefined $(FRAMEWORK_COREAUDIO)
 kcm_info_la_LIBADD = $(LIBALIB) $(LIB_KDEUI) $(LIB_TRU64_MACH) $(LIBCFG) $(LIBODM) $(LIBKSTAT) $(LIBDEVINFO)
 
 INCLUDES= $(all_includes)
--- kcontrol/info/info.cpp	14 Jan 2003 20:08:39 -0000	1.1.1.4
+++ kcontrol/info/info.cpp	15 Mar 2003 01:31:16 -0000	1.6
@@ -50,8 +50,6 @@
 					    KInfoListWidget::ErrorString */
 static bool	sorting_allowed;	/* is sorting allowed by user ? */
 
-
-
 #if defined(__linux__)
 # define DEFAULT_ERRORSTRING QString("") /* i18n("Maybe the proc-filesystem is not enabled in Linux-Kernel.") */
 #elif defined(hpux)
@@ -60,10 +58,6 @@
 #define DEFAULT_ERRORSTRING  i18n("Maybe this system is not completely supported yet :-(")
 #endif
 
-
-
-
-
 /* easier to read with such a define ! */
 #define I18N_MAX(txt,in,fm,maxw) \
     { int n = fm.width(txt=in); if (n>maxw) maxw=n; }
@@ -118,7 +112,6 @@
     { "OwnerGrabButtonMask",	OwnerGrabButtonMask },
     { 0L, 0 }};
 
-
 static QListViewItem* XServer_fill_screen_info( QListViewItem *lBox, QListViewItem *last,
 	    Display *dpy, int scr, int default_scr)
 {
@@ -472,6 +465,8 @@
 #include "info_svr4.cpp"
 #elif _AIX
 #include "info_aix.cpp"
+#elif defined(__APPLE__)
+#include "info_osx.cpp"
 #else
 #include "info_generic.cpp"	/* Default for unsupportet systems.... */
 #endif
RCS file: kcontrol/info/info_osx.cpp
diff -N kcontrol/info/info_osx.cpp
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ kcontrol/info/info_osx.cpp	25 Jun 2002 02:06:13 -0000	1.1
@@ -0,0 +1,163 @@
+/*
+ * kdebase3-3.0.1-3.patch,v 1.2 2002/06/24 01:48:12 ranger Exp
+ *
+ * info_fbsd.cpp is part of the KDE program kcminfo.  This displays
+ * various information about the system (hopefully a FreeBSD system)
+ * it's running on.
+ */
+
+#define INFO_CPU_AVAILABLE
+//#define INFO_IRQ_AVAILABLE
+//#define INFO_DMA_AVAILABLE
+//#define INFO_PCI_AVAILABLE
+//#define INFO_IOPORTS_AVAILABLE
+#define INFO_SOUND_AVAILABLE
+#define INFO_DEVICES_AVAILABLE
+#define INFO_SCSI_AVAILABLE
+#define INFO_PARTITIONS_AVAILABLE
+#define INFO_XSERVER_AVAILABLE
+
+/*
+ * all following functions should return TRUE, when the Information
+ * was filled into the lBox-Widget. Returning FALSE indicates that
+ * information was not available.
+ */
+
+#include <sys/types.h>
+#include <sys/sysctl.h>
+
+#include <fstab.h>
+#include <stdio.h>
+#include <stdlib.h>
+
+#include <iostream.h>
+
+#include <qdict.h>
+#include <qfile.h>
+#include <qfontmetrics.h>
+#include <qptrlist.h>
+#include <qstring.h>
+#include <qtextstream.h>
+
+#include <kdebug.h>
+
+#include <mach/mach.h>
+#include <mach-o/arch.h>
+
+#ifdef HAVE_COREAUDIO
+#include <CoreAudio/CoreAudio.h>
+#endif
+
+#include <machine/limits.h>
+
+bool GetInfo_CPU (QListView *lBox)
+{
+
+	QString cpustring;
+
+        kern_return_t ret;
+        struct host_basic_info basic_info;
+        unsigned int count=HOST_BASIC_INFO_COUNT;
+
+        ret=host_info(mach_host_self(), HOST_BASIC_INFO, 
+                (host_info_t)&basic_info, &count);
+        if (ret != KERN_SUCCESS) {
+		kdDebug() << "unable to get host information from mach" << endl;
+		return false;
+        } else {
+		kdDebug() << "got Host Info: (" << basic_info.avail_cpus << ") CPUs available" << endl;
+        	const NXArchInfo *archinfo;
+        	archinfo=NXGetArchInfoFromCpuType(basic_info.cpu_type, basic_info.cpu_subtype);
+		new QListViewItem(lBox, i18n("Kernel is configured for %1 CPUs").arg(basic_info.max_cpus));
+		for (int i = 1; i <= basic_info.avail_cpus; i++) {
+			cpustring = i18n("CPU %1: %2").arg(i).arg(archinfo->description);
+			new QListViewItem(lBox, cpustring);
+		}
+		return true;
+	}
+	return false;
+}
+
+bool GetInfo_IRQ (QListView *)
+{
+	return false;
+}
+
+bool GetInfo_DMA (QListView *)
+{
+	return false;
+}
+
+bool GetInfo_PCI (QListView *)
+{
+	return false;
+}
+
+bool GetInfo_IO_Ports (QListView *)
+{
+	return false;
+}
+
+bool GetInfo_Sound (QListView *lBox)
+{
+#ifdef HAVE_COREAUDIO
+#define kMaxStringSize 1024
+	OSStatus status;
+	AudioDeviceID gOutputDeviceID;
+	unsigned long propertySize;
+	char deviceName[kMaxStringSize];
+	char manufacturer[kMaxStringSize];
+	propertySize = sizeof(gOutputDeviceID);
+	status = AudioHardwareGetProperty(kAudioHardwarePropertyDefaultOutputDevice, &propertySize, &gOutputDeviceID);
+	if (status) {
+		kdDebug() << "get default output device failed, status = " << (int)status << endl;
+		return false;
+	}
+
+	if (gOutputDeviceID != kAudioDeviceUnknown) {
+
+		propertySize = kMaxStringSize;
+
+		/* Device Name */
+		status = AudioDeviceGetProperty(gOutputDeviceID, 1, 0, kAudioDevicePropertyDeviceName, &propertySize, deviceName);
+		if (status) {
+			kdDebug() << "get device name failed, status = " << (int)status << endl;
+			return false;
+		}
+		new QListViewItem(lBox, i18n("Device Name: %1").arg(deviceName));
+
+		/* Manufacturer */
+		status = AudioDeviceGetProperty(gOutputDeviceID, 1, 0, kAudioDevicePropertyDeviceManufacturer, &propertySize, manufacturer);
+		if (status) {
+			kdDebug() << "get manufacturer failed, status = " << (int)status << endl;
+			return false;
+		}
+		new QListViewItem(lBox, i18n("Manufacturer: %1").arg(manufacturer));
+		return true;
+	} else {
+		return false;
+	}
+#else
+	return false;
+#endif
+}
+
+bool GetInfo_SCSI (QListView *lbox)
+{
+	return false;
+}
+
+bool GetInfo_Partitions (QListView *lbox)
+{
+	return false;
+}
+
+bool GetInfo_XServer_and_Video (QListView *lBox)
+{
+	return GetInfo_XServer_Generic( lBox );
+}
+
+bool GetInfo_Devices (QListView *lbox)
+{
+	return false;
+}
--- kcontrol/info/memory.cpp	1 Oct 2002 02:34:08 -0000	1.1.1.4
+++ kcontrol/info/memory.cpp	1 Oct 2002 03:01:46 -0000	1.5
@@ -431,6 +431,8 @@
 
 #ifdef __linux__
 #include "memory_linux.cpp"
+#elif defined(__APPLE__)
+#include "memory_osx.cpp"
 #elif sgi
 #include "memory_sgi.cpp"
 #elif defined(__svr4__) && defined(sun)
RCS file: kcontrol/info/memory_osx.cpp
diff -N kcontrol/info/memory_osx.cpp
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ kcontrol/info/memory_osx.cpp	25 Jun 2002 02:06:13 -0000	1.1
@@ -0,0 +1,72 @@
+#include <unistd.h>
+#include <stdlib.h>
+#include <qfile.h>
+#include <mach/mach_init.h>
+#include <mach/mach_host.h>
+#include <mach/host_info.h>
+#include <sys/stat.h>
+#include <dirent.h>
+#include <kdebug.h>
+
+void KMemoryWidget::update()
+{
+
+	vm_statistics_data_t vm_info;
+	mach_msg_type_number_t info_count;
+	DIR *dirp;
+	struct dirent *dp;
+	off_t total;
+
+	info_count = HOST_VM_INFO_COUNT;
+	if (host_statistics(mach_host_self (), HOST_VM_INFO, (host_info_t)&vm_info, &info_count)) {
+		kdDebug() << "could not get memory statistics" << endl;
+		return;
+	}
+
+	Memory_Info[TOTAL_MEM]    = (vm_info.active_count + vm_info.inactive_count +
+		vm_info.free_count + vm_info.wire_count) * vm_page_size;
+	Memory_Info[FREE_MEM]     = vm_info.free_count * vm_page_size;
+	Memory_Info[SHARED_MEM]   = NO_MEMORY_INFO;
+	Memory_Info[BUFFER_MEM]   = NO_MEMORY_INFO;
+	Memory_Info[CACHED_MEM]   = NO_MEMORY_INFO;
+
+	dirp = opendir("/private/var/vm");
+	if (!dirp) {
+		kdDebug() << "unable to open /private/var/vm" << endl;
+		return;
+	}
+
+	total = 0;
+
+	while ((dp = readdir (dirp)) != NULL) {
+		struct stat sb;
+		char fname [MAXNAMLEN];
+
+		if (strncmp (dp->d_name, "swapfile", 8))
+			continue;
+
+		strcpy (fname, "/private/var/vm/");
+		strcat (fname, dp->d_name);
+		if (stat (fname, &sb) < 0)
+			continue;
+
+		total += sb.st_size;
+	}
+	closedir (dirp);
+
+	info_count = HOST_VM_INFO_COUNT;
+	if (host_statistics (mach_host_self (), HOST_VM_INFO,
+		(host_info_t) &vm_info, &info_count)) {
+			kdDebug() << "unable to get VM info" << endl;
+	}
+
+	Memory_Info[SWAP_MEM]     = total;
+	// off_t used = (vm_info.pageouts - vm_info.pageins) * vm_page_size;
+	Memory_Info[FREESWAP_MEM] = NO_MEMORY_INFO;
+
+	/* free = vm_info.free_count * vm_page_size;
+	   used = vm_info.active_count * vm_page_size;
+	   total = (vm_info.active_count + vm_info.inactive_count +
+		vm_info.free_count + vm_info.wire_count) * vm_page_size; */
+
+}
--- kcontrol/kcontrol/Makefile.am	4 Jan 2003 04:47:31 -0000	1.1.1.6
+++ kcontrol/kcontrol/Makefile.am	4 Jan 2003 05:34:12 -0000	1.10
@@ -22,43 +22,69 @@
 
 SUBDIRS = . pics
 
-CLEANFILES = dummy.cpp
-
 bin_PROGRAMS = kcontrol kcmshell kcminit
-lib_LTLIBRARIES = kcontrol.la kcmshell.la kcminit.la
+lib_LTLIBRARIES = libkcontrol_main.la kcontrol.la libkcmshell_main.la kcmshell.la libkcminit_main.la kcminit.la
 
-kcontrol_la_SOURCES = main.cpp toplevel.cpp indexwidget.cpp searchwidget.cpp \
+libkcontrol_main_la_SOURCES = main.cpp toplevel.cpp indexwidget.cpp searchwidget.cpp \
 	helpwidget.cpp moduleinfo.cpp modules.cpp proxywidget.cpp \
 	modloader.cpp dockcontainer.cpp aboutwidget.cpp global.cpp \
 	quickhelp.cpp moduletreeview.cpp moduleiconview.cpp \
 	kecdialog.cpp kcrootonly.cpp moduleIface.cpp moduleIface.skel
+libkcontrol_main_la_LIBADD  = $(LIB_KDEUI) $(LIB_KSYCOCA) $(LIB_QT) -lkdecore -lDCOP -lkdefx
+libkcontrol_main_la_LDFLAGS = $(all_libraries) -avoid-version
+
+kcontrol_la_SOURCES = kcontrol_la_main.cpp
+kcontrol_la_LIBADD  = libkcontrol_main.la
+kcontrol_la_LDFLAGS = $(all_libraries) -avoid-version -module
 
-kcontrol_la_LIBADD  = $(LIB_KDEUI) $(LIB_KSYCOCA)
-kcontrol_la_LDFLAGS = $(all_libraries) -module -avoid-version
+kcontrol_la_main.cpp: stub_main.cpp
+	cat stub_main.cpp > kcontrol_la_main.cpp
 
-kcmshell_la_SOURCES = kcmshell.cpp moduleinfo.cpp modloader.cpp kecdialog.cpp \
+libkcmshell_main_la_SOURCES = kcmshell.cpp moduleinfo.cpp modloader.cpp kecdialog.cpp \
 			proxywidget.cpp kcdialog.cpp global.cpp \
 			kcdialog.skel
-kcmshell_la_LIBADD = $(LIB_KDEUI) $(LIB_KSYCOCA)
-kcmshell_la_LDFLAGS = $(all_libraries) -module -avoid-version
+libkcmshell_main_la_LIBADD = $(LIB_KDEUI) $(LIB_KSYCOCA) $(LIB_QT) -lkdecore -lDCOP
+libkcmshell_main_la_LDFLAGS = $(all_libraries) -avoid-version
+
+kcmshell_la_SOURCES = kcmshell_la_main.cpp
+kcmshell_la_LIBADD = libkcmshell_main.la
+kcmshell_la_LDFLAGS = $(all_libraries) -avoid-version -module
+
+kcmshell_la_main.cpp: stub_main.cpp
+	cat stub_main.cpp > kcmshell_la_main.cpp
+
+libkcminit_main_la_SOURCES = kcminit.cpp global.cpp
+libkcminit_main_la_LIBADD  = $(LIB_KDEUI) $(LIB_KSYCOCA) $(LIB_QT) -lkdecore -lDCOP
+libkcminit_main_la_LDFLAGS = $(all_libraries) -avoid-version
 
+kcminit_la_SOURCES = kcminit_la_main.cpp
+kcminit_la_LIBADD  = libkcminit_main.la
+kcminit_la_LDFLAGS = $(all_libraries) -avoid-version -module
 
-kcminit_la_SOURCES = kcminit.cpp global.cpp
-kcminit_la_LIBADD   = $(LIB_KDEUI) $(LIB_KSYCOCA)
-kcminit_la_LDFLAGS = $(all_libraries) -module -avoid-version
+kcminit_la_main.cpp: stub_main.cpp
+	cat stub_main.cpp > kcminit_la_main.cpp
 
-kcontrol_SOURCES = dummy.cpp
-kcontrol_LDADD = kcontrol.la
+kcontrol_SOURCES = kcontrol_main.cpp
+kcontrol_LDADD = libkcontrol_main.la
 kcontrol_LDFLAGS = $(all_libraries) $(KDE_RPATH) -export-dynamic
 
-kcmshell_SOURCES = dummy.cpp
-kcmshell_LDADD = kcmshell.la
+kcontrol_main.cpp: stub_main.cpp
+	cat stub_main.cpp > kcontrol_main.cpp
+
+kcmshell_SOURCES = kcmshell_main.cpp
+kcmshell_LDADD = libkcmshell_main.la
 kcmshell_LDFLAGS = $(all_libraries) $(KDE_RPATH) -export-dynamic
 
-kcminit_SOURCES = dummy.cpp
-kcminit_LDADD = kcminit.la
+kcmshell_main.cpp: stub_main.cpp
+	cat stub_main.cpp > kcmshell_main.cpp
+
+kcminit_SOURCES = kcminit_main.cpp
+kcminit_LDADD = libkcminit_main.la
 kcminit_LDFLAGS = $(all_libraries) $(KDE_RPATH) -export-dynamic
 
+kcminit_main.cpp: stub_main.cpp
+	cat stub_main.cpp > kcminit_main.cpp
+
 rccontroldir = $(kde_datadir)/kcontrol
 rccontrol_DATA = kcontrolui.rc
 rcinfodir = $(kde_datadir)/kinfocenter
@@ -81,6 +107,3 @@
 
 messages: rc.cpp
 	$(XGETTEXT) *.cpp -o $(podir)/kcontrol.pot
-
-dummy.cpp:
-	echo > dummy.cpp
--- kcontrol/kcontrol/kcminit.cpp	25 Jun 2002 02:03:45 -0000	1.1.1.1
+++ kcontrol/kcontrol/kcminit.cpp	26 Nov 2002 21:00:51 -0000	1.2
@@ -59,7 +59,9 @@
     return false;
 }
 
-int main(int argc, char *argv[])
+extern "C" int kdemain(int, char**);
+
+int kdemain(int argc, char *argv[])
 {
   KLocale::setMainCatalogue("kcontrol");
   KAboutData aboutData( "kcminit", I18N_NOOP("KCMInit"),
--- kcontrol/kcontrol/kcmshell.cpp	14 Aug 2002 14:29:19 -0000	1.1.1.2
+++ kcontrol/kcontrol/kcmshell.cpp	26 Nov 2002 21:00:51 -0000	1.2
@@ -129,8 +129,9 @@
         quit();
 }
 
+extern "C" int kdemain(int, char**);
 
-int main(int _argc, char *_argv[])
+int kdemain(int _argc, char *_argv[])
 {
     KAboutData aboutData( "kcmshell", I18N_NOOP("KDE Control Module"),
                           KCONTROL_VERSION,
--- kcontrol/kcontrol/main.cpp	1 Oct 2002 02:34:11 -0000	1.1.1.4
+++ kcontrol/kcontrol/main.cpp	26 Nov 2002 21:00:51 -0000	1.2
@@ -86,7 +86,9 @@
   delete toplevel;
 }
 
-int main(int argc, char *argv[])
+extern "C" int kdemain(int, char**);
+
+int kdemain(int argc, char **argv)
 {
   KLocale::setMainCatalogue("kcontrol");
   KAboutData aboutKControl( "kcontrol", I18N_NOOP("KDE Control Center"),
--- kcontrol/kcontrol/modules.cpp	14 Aug 2002 14:29:19 -0000	1.1.1.3
+++ kcontrol/kcontrol/modules.cpp	29 Mar 2003 02:34:08 -0000	1.2
@@ -164,7 +164,16 @@
   QString cmd = service()->exec().stripWhiteSpace();
   bool kdeshell = false;
   if (cmd.left(5) == "kdesu")
+    {
     cmd = cmd.remove(0,5).stripWhiteSpace();
+    // remove all kdesu switches
+    while( cmd.length() > 1 && cmd[ 0 ] == '-' )
+	{
+	int pos = cmd.find( ' ' );
+	cmd = cmd.remove( 0, pos ).stripWhiteSpace();
+	}
+    }
+    
   if (cmd.left(8) == "kcmshell")
     {
       cmd = cmd.remove(0,8).stripWhiteSpace();
RCS file: kcontrol/kcontrol/stub_main.cpp
diff -N kcontrol/kcontrol/stub_main.cpp
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ kcontrol/kcontrol/stub_main.cpp	26 Nov 2002 21:00:51 -0000	1.1
@@ -0,0 +1,28 @@
+/*
+ *
+ * Copyright (c) 2001 Nick Hudson <skrll@netbsd.org>
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining a copy
+ * of this software and associated documentation files (the "Software"), to deal
+ * in the Software without restriction, including without limitation the rights
+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
+ * copies of the Software, and to permit persons to whom the Software is
+ * furnished to do so, subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice shall be included in
+ * all copies or substantial portions of the Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
+ * AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN
+ * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+extern "C" int kdemain(int, char* []);
+
+int main( int argc, char* argv[] )
+{
+        return kdemain(argc, argv);
+}
+
--- kcontrol/kfontinst/kfontinst/FontEngine.cpp	10 Dec 2002 16:41:01 -0000	1.1.1.5
+++ kcontrol/kfontinst/kfontinst/FontEngine.cpp	10 Dec 2002 18:10:21 -0000	1.6
@@ -26,6 +26,8 @@
 // (C) Craig Drummond, 2001
 ////////////////////////////////////////////////////////////////////////////////
 
+#include "config.h"
+
 #include "FontEngine.h"
 #if !defined KFI_THUMBNAIL && !defined KFI_METAINFO
 #include "KfiGlobal.h"
--- kcontrol/kio/cache.cpp	14 Jan 2003 20:08:54 -0000	1.1.1.5
+++ kcontrol/kio/cache.cpp	29 Mar 2003 02:34:10 -0000	1.2
@@ -39,8 +39,8 @@
 
 #include "cache.h"
 
-KCacheConfigDialog::KCacheConfigDialog( QWidget* parent, const char* name )
-                   :KCModule( parent, name )
+KCacheConfigDialog::KCacheConfigDialog( QWidget* parent )
+                   :KCModule( parent, "kcmkio" )
 {
     QVBoxLayout* mainLayout = new QVBoxLayout( this, KDialog::marginHint(),
                                                KDialog::spacingHint() );
--- kcontrol/kio/cache.h	14 Jan 2003 20:08:54 -0000	1.1.1.3
+++ kcontrol/kio/cache.h	29 Mar 2003 02:34:10 -0000	1.2
@@ -37,7 +37,7 @@
     Q_OBJECT
 
 public:
-    KCacheConfigDialog( QWidget* parent = 0, const char* name = 0 );
+    KCacheConfigDialog( QWidget* parent = 0 );
     ~KCacheConfigDialog();
 
     virtual void load();
--- kcontrol/kio/kcookiesmain.cpp	13 Mar 2003 02:59:43 -0000	1.1.1.5
+++ kcontrol/kio/kcookiesmain.cpp	29 Mar 2003 02:34:10 -0000	1.2
@@ -16,8 +16,8 @@
 #include "kcookiespolicies.h"
 #include "kcookiesmanagement.h"
 
-KCookiesMain::KCookiesMain(QWidget *parent, const char *name)
-  : KCModule(parent, name)
+KCookiesMain::KCookiesMain(QWidget *parent)
+  : KCModule(parent, "kcmkio")
 {
     management = 0;
 
--- kcontrol/kio/kcookiesmain.h	25 Jun 2002 02:03:46 -0000	1.1.1.1
+++ kcontrol/kio/kcookiesmain.h	29 Mar 2003 02:34:10 -0000	1.2
@@ -17,7 +17,7 @@
 {
     Q_OBJECT
 public:
-    KCookiesMain(QWidget *parent = 0L, const char *name = 0L);
+    KCookiesMain(QWidget *parent = 0L);
     ~KCookiesMain();
 
     virtual void load();
--- kcontrol/kio/main.cpp	26 Nov 2002 22:16:50 -0000	1.1.1.4
+++ kcontrol/kio/main.cpp	29 Mar 2003 02:34:11 -0000	1.2
@@ -141,7 +141,7 @@
 
 
 LanBrowser::LanBrowser(QWidget *parent)
-:KCModule(parent,"kcmlanbrowser")
+:KCModule(parent,"kcmkio")
 ,layout(this)
 ,tabs(this)
 {
--- kcontrol/konq/rootopts.cpp	20 Nov 2002 01:12:28 -0000	1.1.1.7
+++ kcontrol/konq/rootopts.cpp	29 Mar 2003 02:34:15 -0000	1.2
@@ -681,9 +681,12 @@
             kdDebug() << "The trash is currently on the desktop" << endl;
             // Either the Trash field wasn't changed (-> need to update it)
             if ( newTrashURL.cmp( trashURL, true ) )
-            {
+			{
+                QString urlDesktop = urDesktop->url();
+                if ( urlDesktop.at(urlDesktop.length()-1)!='/')
+                    urlDesktop+="/";
                 // Hack. It could be in a subdir inside desktop. Hmmm... Argl.
-                urTrash->setURL( urDesktop->url() + trashURL.fileName() );
+                urTrash->setURL( urlDesktop + trashURL.fileName() );
                 kdDebug() << "The trash is moved with the desktop" << endl;
                 trashMoved = true;
             }
--- kcontrol/konqhtml/khtml_plugins.desktop	20 Nov 2002 01:12:28 -0000	1.1.1.6
+++ kcontrol/konqhtml/khtml_plugins.desktop	29 Mar 2003 02:34:16 -0000	1.2
@@ -8,6 +8,8 @@
 X-KDE-ModuleType=Library
 X-KDE-Library=konqhtml
 X-KDE-FactoryName=khtml_plugins
+X-KDE-Init=nsplugin
+X-KDE-ParentApp=kcontrol
 
 Name=Plugins
 Name[af]=Inprop modules
--- kdeprint/kjobviewer/Makefile.am	25 Jun 2002 02:03:49 -0000	1.1.1.1
+++ kdeprint/kjobviewer/Makefile.am	21 Feb 2003 21:42:06 -0000	1.6
@@ -1,16 +1,23 @@
 INCLUDES = $(all_includes)
 
 bin_PROGRAMS = kjobviewer
-lib_LTLIBRARIES = kjobviewer.la
+lib_LTLIBRARIES = kjobviewer.la libkjobviewer_main.la
 
-kjobviewer_SOURCES = dummy.cpp
-kjobviewer_LDADD = kjobviewer.la
+libkjobviewer_main_la_SOURCES = kjobviewer.cpp
+libkjobviewer_main_la_LIBADD  = -lkdeprint_management $(LIB_KDEUI) $(LIB_QT) -lkdecore -lDCOP -lkdeprint
+libkjobviewer_main_la_LDFLAGS = $(KDE_RPATH) $(all_libraries)
+libkjobviewer_main_la_METASOURCES = AUTO
+
+kjobviewer_SOURCES = main.cpp
+kjobviewer_LDADD   = libkjobviewer_main.la
 kjobviewer_LDFLAGS = $(KDE_RPATH) $(all_libraries)
 
-kjobviewer_la_SOURCES = kjobviewer.cpp main.cpp
-kjobviewer_la_METASOURCES = AUTO
-kjobviewer_la_LIBADD = -lkdeprint_management $(LIB_KDEUI)
-kjobviewer_la_LDFLAGS = -module -avoid-version $(all_libraries) $(KDE_RPATH)
+kjobviewer_la_SOURCES = main_la.cpp
+kjobviewer_la_LIBADD  = libkjobviewer_main.la
+kjobviewer_la_LDFLAGS = -avoid-version $(all_libraries) $(KDE_RPATH) -module
+
+main_la.cpp: main.cpp
+	cat main.cpp > main_la.cpp
 
 noinst_HEADERS = kjobviewer.h
 
@@ -22,8 +29,8 @@
 desktop_DATA = kjobviewer.desktop
 desktopdir = $(kde_appsdir)/Utilities
 
-dummy.cpp:
-	echo > dummy.cpp
+dummy.cpp: main.cpp
+	cat main.cpp > dummy.cpp
 
 messages: rc.cpp
 	$(XGETTEXT) *.cpp -o $(podir)/kjobviewer.pot
--- kdeprint/kjobviewer/kjobviewer.cpp	3 Mar 2003 01:40:00 -0000	1.1.1.4
+++ kdeprint/kjobviewer/kjobviewer.cpp	29 Mar 2003 02:34:21 -0000	1.2
@@ -89,6 +89,7 @@
 
 void JobTray::contextMenuAboutToShow(KPopupMenu *menu)
 {
+#if 0
 	unsigned int n(0);
 	for (; n<menu->count(); n++)
 	{
@@ -100,6 +101,7 @@
 	}
 
 	menu->insertItem(SmallIcon("exit"), i18n("&Quit" ), kapp, SLOT(quit()), 0, -1, n);
+#endif
 }
 
 //-------------------------------------------------------------
--- kdeprint/kprinter/Makefile.am	10 Jul 2002 03:20:23 -0000	1.1.1.2
+++ kdeprint/kprinter/Makefile.am	21 Feb 2003 21:42:06 -0000	1.6
@@ -1,21 +1,28 @@
 INCLUDES = $(all_includes)
 
 bin_PROGRAMS = kprinter
-lib_LTLIBRARIES = kprinter.la
+lib_LTLIBRARIES = kprinter.la libkprinter_main.la
 
-kprinter_SOURCES = dummy.cpp
-kprinter_LDADD = kprinter.la
+libkprinter_main_la_SOURCES = printwrapper.cpp
+libkprinter_main_la_LIBADD  = -lkdeprint $(LIB_QT) -lkdecore -lDCOP -lkdeui -lkio
+libkprinter_main_la_LDFLAGS = -avoid-version $(all_libraries) $(KDE_RPATH)
+libkprinter_main_la_METASOURCES = AUTO
+
+kprinter_SOURCES = main.cpp
+kprinter_LDADD   = libkprinter_main.la
 kprinter_LDFLAGS = $(KDE_RPATH) $(all_libraries)
 
-kprinter_la_SOURCES = main.cpp printwrapper.cpp
-kprinter_la_LIBADD = -lkdeprint
-kprinter_la_LDFLAGS = -module -avoid-version $(all_libraries) $(KDE_RPATH)
-kprinter_METASOURCES = AUTO
+kprinter_la_SOURCES = main_la.cpp
+kprinter_la_LIBADD  = libkprinter_main.la
+kprinter_la_LDFLAGS = -avoid-version $(all_libraries) $(KDE_RPATH) -module
+
+main_la.cpp: main.cpp
+	cat main.cpp > main_la.cpp
 
 noinst_HEADERS = printwrapper.h
 
 messages:
 	$(XGETTEXT) *.cpp -o $(podir)/kprinter.pot
 
-dummy.cpp:
-	echo > dummy.cpp
+dummy.cpp: main.cpp
+	cat main.cpp > dummy.cpp
--- kdesktop/Makefile.am	1 Oct 2002 02:35:37 -0000	1.1.1.3
+++ kdesktop/Makefile.am	26 Nov 2002 21:00:51 -0000	1.3
@@ -1,10 +1,6 @@
 ## Makefile.am of kdebase/kdesktop
 
 INCLUDES = -I$(top_srcdir)/kcontrol/background -I$(top_srcdir)/libkonq $(all_includes)
-kdesktop_la_LDFLAGS  = $(KDE_RPATH) $(all_libraries) -module -avoid-version
-kdesktop_la_LIBADD   = $(top_builddir)/libkonq/libkonq.la $(top_builddir)/kcontrol/background/libbgnd.la 
-kdesktop_LDFLAGS  = $(all_libraries) $(KDE_RPATH)
-kdesktop_LDADD    = kdesktop.la
 
 SUBDIRS = . lock pics patterns programs init kwebdesktop
 
@@ -12,15 +8,29 @@
 
 bin_PROGRAMS = kdesktop
 bin_SCRIPTS = kdeeject
-lib_LTLIBRARIES = kdesktop.la
+lib_LTLIBRARIES = kdesktop.la libkdesktop_main.la
 
-kdesktop_la_SOURCES = main.cc krootwm.cc xautolock.cc kdiconview.cc desktop.cc \
+libkdesktop_main_la_LDFLAGS  = $(KDE_RPATH) $(all_libraries) -avoid-version
+libkdesktop_main_la_LIBADD   = $(top_builddir)/libkonq/libkonq.la $(top_builddir)/kcontrol/background/libbgnd.la 
+libkdesktop_main_la_SOURCES = main.cc krootwm.cc xautolock.cc kdiconview.cc desktop.cc \
 	lockeng.cc KDesktopIface.skel \
 	bgmanager.cc init.cc KScreensaverIface.skel \
 	minicli.cpp KBackgroundIface.skel pixmapserver.cc kcustommenu.cc \
 	startupid.cpp
 
-kdesktop_SOURCES = dummy.cc
+kdesktop_la_LDFLAGS = $(KDE_RPATH) $(all_libraries) -avoid-version -module
+kdesktop_la_LIBADD  = libkdesktop_main.la
+kdesktop_la_SOURCES = kdesktop_la_main.cpp
+
+kdesktop_la_main.cpp: stub_main.cpp
+	cat stub_main.cpp > kdesktop_la_main.cpp
+
+kdesktop_LDFLAGS  = $(all_libraries) $(KDE_RPATH)
+kdesktop_LDADD    = libkdesktop_main.la
+kdesktop_SOURCES  = kdesktop_main.cpp
+
+kdesktop_main.cpp: stub_main.cpp
+	cat stub_main.cpp > kdesktop_main.cpp
 
 include_HEADERS = KDesktopIface.h KScreensaverIface.h KBackgroundIface.h
 
--- kdesktop/main.cc	1 Dec 2002 15:24:10 -0000	1.1.1.4
+++ kdesktop/main.cc	1 Dec 2002 15:43:46 -0000	1.3
@@ -77,7 +77,9 @@
         kapp->quit(); // turn catchable signals into clean shutdown
 }
 
-int main( int argc, char **argv )
+extern "C" int kdemain(int, char**);
+
+int kdemain( int argc, char **argv )
 {
     //setup signal handling
     signal(SIGTERM, signalHandler);
--- kdesktop/minicli.cpp	3 Mar 2003 01:40:03 -0000	1.1.1.7
+++ kdesktop/minicli.cpp	29 Mar 2003 02:34:24 -0000	1.2
@@ -80,15 +80,12 @@
                                      "of the resource you want to open. This can be a remote URL "
                                      "like \"www.kde.org\" or a local one like \"~/.kderc\""));
     m_runCombo->setDuplicatesEnabled( false );
-    connect( m_runCombo, SIGNAL( textChanged( const QString& ) ),
-             SLOT( slotCmdChanged(const QString&) ) );
-    connect( m_runCombo,SIGNAL(returnPressed(const QString&)),this,SLOT(accept()));
+    m_runCombo->setTrapReturnKey( true );
 
     label->setBuddy(m_runCombo);
     m_runCombo->setFixedWidth( m_runCombo->fontMetrics().width('W') * 23 );
 
     m_parseTimer = new QTimer(this);
-    connect(m_parseTimer, SIGNAL(timeout()), SLOT(slotParseTimer()));
 
     m_bAdvanced = false;
     mpAdvanced = 0;
@@ -102,20 +99,19 @@
     if (!kapp->authorize("shell_access"))
        m_btnOptions->hide();
     bbLay->addWidget( m_btnOptions );
-    connect( m_btnOptions, SIGNAL(clicked()), SLOT(slotAdvanced()) );
+
     bbLay->addStretch( 1 );
 
-    btnRun = new KPushButton( KGuiItem( i18n( "&Run" ), "run" ), btnBox );
-    bbLay->addWidget( btnRun );
-    btnRun->setDefault( true );
-    connect( btnRun, SIGNAL(clicked()), this, SLOT(accept()) );
+    m_btnRun = new KPushButton( KGuiItem( i18n( "&Run" ), "run" ), btnBox );
+    bbLay->addWidget( m_btnRun );
+    m_btnRun->setDefault( true );
 
     m_btnCancel = new KPushButton( KStdGuiItem::cancel(), btnBox );
     bbLay->addWidget( m_btnCancel );
-    connect(m_btnCancel, SIGNAL(clicked()), this, SLOT(reject()));
+
     m_vbox->addWidget( btnBox, 3, 0 );
 
-    btnRun->setEnabled(!m_runCombo->currentText().isEmpty());
+    m_btnRun->setEnabled(!m_runCombo->currentText().isEmpty());
     // Very important, to get the size right before showing
     m_vbox->activate();
 
@@ -123,13 +119,18 @@
     m_IconName = QString::null;
     m_FocusWidget = 0;
 
+    connect( m_btnRun, SIGNAL(clicked()), this, SLOT(accept()) );
+    connect( m_btnCancel, SIGNAL(clicked()), this, SLOT(reject()) );
+    connect( m_btnOptions, SIGNAL(clicked()), SLOT(slotAdvanced()) );
+    connect( m_parseTimer, SIGNAL(timeout()), SLOT(slotParseTimer()) );
+
+    connect( m_runCombo, SIGNAL( textChanged( const QString& ) ),
+             SLOT( slotCmdChanged(const QString&) ) );
+    connect( m_runCombo, SIGNAL( activated( const QString& ) ),
+             m_btnRun, SLOT( animateClick() ) );
+
     loadConfig();
     KWin::setState( winId(), NET::StaysOnTop );
-
-    finalFilters = KURIFilter::self()->pluginNames();
-    finalFilters.remove("kuriikwsfilter");
-    middleFilters = finalFilters;
-    middleFilters.remove("localdomainurifilter");
 }
 
 Minicli::~Minicli()
@@ -160,6 +161,12 @@
         m_runCombo->completionObject()->setItems( compList );
     int mode = config->readNumEntry( "CompletionMode", KGlobalSettings::completionMode() );
     m_runCombo->setCompletionMode( (KGlobalSettings::Completion) mode );
+
+    finalFilters = KURIFilter::self()->pluginNames();
+    finalFilters.remove("kuriikwsfilter");
+
+    middleFilters = finalFilters;
+    middleFilters.remove("localdomainurifilter");
 }
 
 void Minicli::saveConfig()
@@ -175,15 +182,17 @@
 
 void Minicli::accept()
 {
-    int ret = runCommand();
-
-    if( ret > 0 )
+    hide();
+    if( runCommand() == 1 )
+    {
+        exec();
         return;
+    }
 
     m_runCombo->addToHistory( m_runCombo->currentText().stripWhiteSpace() );
     reset();
-    QDialog::accept();
     saveConfig();
+    QDialog::accept();
 }
 
 void Minicli::reject()
@@ -206,7 +215,7 @@
     m_runCombo->setFocus();
     m_runCombo->reset();
     m_runCombo->blockSignals( block );
-    btnRun->setEnabled( false );
+    m_btnRun->setEnabled( false );
 
     m_FocusWidget = 0;
 }
@@ -251,8 +260,8 @@
        if (i != -1)
           cmdNoArgs.truncate(i);
     }
-    
-  
+
+
     bool useTerminal = false;
     if (mpAdvanced)
     {
@@ -264,15 +273,17 @@
         else
         {
             terminalAppList.remove(cmdNoArgs);
- 
+
             if (useTerminal = mpAdvanced->terminal())
                 terminalAppList.append(cmdNoArgs);
+            else
+                useTerminal = terminalAppList.contains(cmdNoArgs);
 
             /*Now the terminalAppList will contain cmdNoArgs iff the checkbox is marked
               (provided it is seen by the user)*/
         }
     }
-  
+
     if (!kapp->authorize("shell_access"))
        useTerminal = false;
 
@@ -478,7 +489,7 @@
 void Minicli::slotCmdChanged(const QString& text)
 {
     bool state = text.isEmpty();
-    btnRun->setEnabled( !state );
+    m_btnRun->setEnabled( !state );
     if ( state )
     {
         // Reset values to default
@@ -499,7 +510,7 @@
         if (i != -1)
             cmdNoArgs.truncate(i);
       }
-    
+
       // Look if the new app is a TerminalApp
       if (mpAdvanced)
         mpAdvanced->slotTerminal(terminalAppList.contains(cmdNoArgs));
@@ -543,7 +554,6 @@
         m_FocusWidget = focusWidget();
         if( m_FocusWidget )
             m_FocusWidget->setFocus();
-        mpAdvanced->adjustSize();
     }
     else
     {
@@ -553,7 +563,6 @@
             m_FocusWidget->setFocus();
         mpAdvanced->setMaximumSize(0, 0);
         mpAdvanced->setEnabled( false );
-        mpAdvanced->adjustSize();
     }
 }
 
--- kdesktop/minicli.h	5 Nov 2002 00:17:19 -0000	1.1.1.5
+++ kdesktop/minicli.h	29 Mar 2003 02:34:25 -0000	1.2
@@ -76,7 +76,7 @@
     KHistoryCombo* m_runCombo;
     KURIFilterData* m_filterData;
     QWidget* m_FocusWidget;
-    QPushButton* btnRun;
+    QPushButton* m_btnRun;
     QGridLayout *m_vbox;
     QStringList terminalAppList;
 
RCS file: kdesktop/stub_main.cpp
diff -N kdesktop/stub_main.cpp
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ kdesktop/stub_main.cpp	26 Nov 2002 21:00:51 -0000	1.1
@@ -0,0 +1,28 @@
+/*
+ *
+ * Copyright (c) 2001 Nick Hudson <skrll@netbsd.org>
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining a copy
+ * of this software and associated documentation files (the "Software"), to deal
+ * in the Software without restriction, including without limitation the rights
+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
+ * copies of the Software, and to permit persons to whom the Software is
+ * furnished to do so, subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice shall be included in
+ * all copies or substantial portions of the Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
+ * AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN
+ * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+extern "C" int kdemain(int, char* []);
+
+int main( int argc, char* argv[] )
+{
+        return kdemain(argc, argv);
+}
+
--- kdm/backend/client.c	3 Mar 2003 01:40:17 -0000	1.1.1.4
+++ kdm/backend/client.c	3 Mar 2003 01:55:31 -0000	1.3
@@ -38,6 +38,7 @@
  * user verification and session initiation.
  */
 
+#include <config.h>
 #include "dm.h"
 #include "dm_auth.h"
 #include "dm_error.h"
@@ -59,7 +60,11 @@
 # endif
 #endif
 #ifdef USE_PAM
-# include <security/pam_appl.h>
+#ifdef HAVE_PAM_PAM_APPL_H
+#include <pam/pam_appl.h>
+#else
+#include <security/pam_appl.h>
+#endif
 #elif defined(AIXV3) /* USE_PAM */
 # include <login.h>
 # include <usersec.h>
--- kdm/backend/dm.h	29 Oct 2002 03:04:57 -0000	1.1.1.4
+++ kdm/backend/dm.h	29 Oct 2002 03:39:31 -0000	1.4
@@ -41,6 +41,10 @@
 #ifndef _DM_H_
 #define _DM_H_ 1
 
+#ifdef __APPLE__
+#define CSRG_BASED
+#endif
+
 #include "greet.h"
 
 #include <X11/Xos.h>
--- kdm/kfrontend/kgreeter.cpp	4 Jan 2003 04:50:24 -0000	1.1.1.7
+++ kdm/kfrontend/kgreeter.cpp	29 Mar 2003 02:34:27 -0000	1.2
@@ -36,6 +36,7 @@
 #include <qaccel.h>
 #include <qcursor.h>
 #include <qheader.h>
+#include <qstyle.h>
 
 #include <klocale.h>
 #include <kglobal.h>
@@ -69,13 +70,6 @@
 #include <strings.h>
 
 
-class GreeterListViewItem : public KListViewItem {
-public:
-    GreeterListViewItem( KListView* parent, const QString& text )
-	: KListViewItem( parent, text ) {};
-    QString login;
-};
-
 void
 KLoginLineEdit::focusOutEvent( QFocusEvent *e )
 {
@@ -84,6 +78,41 @@
 }
 
 
+class UserListView : public KListView {
+public:
+    UserListView( QWidget* parent = 0, const char *name = 0 )
+	: KListView( parent, name )
+	, cachedSizeHint( -1, 0 )
+    {
+	setSizePolicy( QSizePolicy::Preferred, QSizePolicy::Ignored );
+	header()->hide();
+	addColumn( QString::null );
+	setColumnAlignment( 0, AlignVCenter );
+	setResizeMode( QListView::LastColumn );
+    }
+
+    mutable QSize cachedSizeHint;
+
+protected:
+    virtual QSize sizeHint() const
+    {
+	if (!cachedSizeHint.isValid()) {
+	    constPolish();
+	    uint maxw = 0;
+	    for (QListViewItem *itm = firstChild(); itm; itm = itm->nextSibling()) {
+		uint thisw = itm->width( fontMetrics(), this, 0 );
+		if (thisw > maxw)
+		    maxw = thisw;
+	    }
+	    cachedSizeHint.setWidth(
+		style().pixelMetric( QStyle::PM_ScrollBarExtent ) +
+		frameWidth() * 2 + maxw );
+	}
+	return cachedSizeHint;
+    }
+};
+
+
 KGreeter::KGreeter()
   : inherited( 0, 0, true )
   , user_view( 0 )
@@ -105,11 +134,7 @@
 	main_grid->addWidget( welcomeLabel, 0, 1 );
     }
     if (kdmcfg->_showUsers != SHOW_NONE) {
-	user_view = new KListView( winFrame );
-	user_view->setSizePolicy( QSizePolicy( QSizePolicy::Preferred, QSizePolicy::Ignored ) );
-	user_view->addColumn(QString::null);
-	user_view->setResizeMode(QListView::LastColumn);
-	user_view->header()->hide();
+	user_view = new UserListView( winFrame );
 	insertUsers( user_view );
 	main_grid->addMultiCellWidget(user_view, 0, 3, 0, 0);
 	connect( user_view, SIGNAL(clicked( QListViewItem * )),
@@ -275,8 +300,24 @@
     delete stsfile;
 }
 
+class UserListViewItem : public KListViewItem {
+public:
+    UserListViewItem( UserListView *parent, const QString &text,
+			 const QPixmap &pixmap, const QString &username )
+	: KListViewItem( parent )
+	, login( username )
+    {
+	setPixmap( 0, pixmap );
+	setMultiLinesEnabled( true );
+	setText( 0, text );
+	parent->cachedSizeHint.setWidth( -1 );
+    }
+
+    QString login;
+};
+
 void
-KGreeter::insertUser( KListView *listview, const QImage &default_pix,
+KGreeter::insertUser( UserListView *listview, const QImage &default_pix,
 		      const QString &username, struct passwd *ps )
 {
     QImage p;
@@ -296,17 +337,17 @@
     else
 	p = p.smoothScale( 48, 48, QImage::ScaleMin );
     QString realname = QFile::decodeName( ps->pw_gecos );
-    realname = realname.left(realname.find(","));
-    QString userlabel = realname.isEmpty() ?
-				username :
-				realname + "\n" + username;
-    GreeterListViewItem *item = new GreeterListViewItem( listview, userlabel );
-    item->setPixmap( 0, QPixmap( p ) );
-    item->login = username;
+    realname.truncate( realname.find( ',' ) );
+    if (realname.isEmpty())
+	new UserListViewItem( listview, username, QPixmap( p ), username );
+    else {
+	realname.append( "\n" ).append( username );
+	new UserListViewItem( listview, realname, QPixmap( p ), username );
+    }
 }
 
 void
-KGreeter::insertUsers( KListView *listview )
+KGreeter::insertUsers( UserListView *listview )
 {
     QImage default_pix(
 	locate( "user_pic", QString::fromLatin1("default.png") ) );
@@ -372,7 +413,7 @@
 	QString login = loginEdit->text();
 	QListViewItem *item;
 	for (item = user_view->firstChild(); item; item = item->nextSibling())
-	    if (((GreeterListViewItem *)item)->login == login) {
+	    if (((UserListViewItem *)item)->login == login) {
 		user_view->setCurrentItem( item );
 		user_view->ensureItemVisible( item );
 		break;
@@ -385,7 +426,7 @@
 KGreeter::slot_user_name( QListViewItem *item )
 {
     if (item) {
-	loginEdit->setText( ((GreeterListViewItem *)item)->login );
+	loginEdit->setText( ((UserListViewItem *)item)->login );
 	passwdEdit->erase();
 	passwdEdit->setFocus();
 	load_wm();
@@ -816,6 +857,7 @@
 	GSendInt( G_SetupDpy );
 	GRecvInt();
     }
+
     QDesktopWidget *dsk = kapp->desktop();
     QRect scr = dsk->screenGeometry(
 	kdmcfg->_greeterScreen == -1 ?
@@ -838,7 +880,7 @@
     if (dsk->screenNumber( QCursor::pos() ) !=
 	dsk->screenNumber( grt.center() ))
 	QCursor::setPos( grt.center() );
-    XUndefineCursor( dpy, RootWindow( dpy, DefaultScreen( dpy ) ) );
+    dsk->setCursor( Qt::ArrowCursor );
     Debug ("entering event loop\n");
     kgreeter->exec();
     delete kgreeter;
--- kdm/kfrontend/kgreeter.h	29 Oct 2002 03:05:00 -0000	1.1.1.3
+++ kdm/kfrontend/kgreeter.h	29 Mar 2003 02:34:28 -0000	1.2
@@ -81,6 +81,8 @@
 };
 
 
+class UserListView;
+
 class KGreeter : public FDialog {
     Q_OBJECT
     typedef FDialog inherited;
@@ -111,8 +113,8 @@
 
 private:
     void set_wm( const char * );
-    void insertUsers( KListView * );
-    void insertUser( KListView *, const QImage &, const QString &, struct passwd * );
+    void insertUsers( UserListView * );
+    void insertUser( UserListView *, const QImage &, const QString &, struct passwd * );
     void MsgBox( QMessageBox::Icon typ, QString msg ) { KFMsgBox::box( this, typ, msg ); }
     void Inserten( QPopupMenu *mnu, const QString& txt, const char *member );
     bool verifyUser( bool );
@@ -122,7 +124,7 @@
     WmStat		wmstat;
     QString		enam;
     KSimpleConfig	*stsfile;
-    KListView		*user_view;
+    UserListView	*user_view;
     KdmClock		*clock;
     QLabel		*pixLabel;
     QLabel		*loginLabel, *passwdLabel, *sessargLabel;
--- khotkeys/khotkeys/Makefile.am	25 Jun 2002 02:03:52 -0000	1.1.1.1
+++ khotkeys/khotkeys/Makefile.am	26 Nov 2002 21:00:52 -0000	1.5
@@ -1,15 +1,25 @@
 # $Id: Makefile.am,v 1.12 2002/02/12 14:32:08 ellis Exp $
 
 bin_PROGRAMS = khotkeys
-lib_LTLIBRARIES = khotkeys.la
+lib_LTLIBRARIES = khotkeys.la libkhotkeys_main.la
 
-khotkeys_la_SOURCES = khotkeys.cpp main.cpp khotkeys.skel
-khotkeys_la_LIBADD   = ../shared/libshared.la $(LIB_KSYCOCA)
-khotkeys_la_LDFLAGS = $(all_libraries) -module -avoid-version
+libkhotkeys_main_la_SOURCES = khotkeys.cpp main.cpp khotkeys.skel
+libkhotkeys_main_la_LIBADD  = ../shared/libshared.la $(LIB_KSYCOCA) $(LIB_QT) -lkdecore -lDCOP
+libkhotkeys_main_la_LDFLAGS = $(all_libraries) -avoid-version
 
-khotkeys_SOURCES = dummy.cpp
-khotkeys_LDADD   = khotkeys.la
+khotkeys_la_SOURCES = khotkeys_la_main.cpp
+khotkeys_la_LIBADD  = libkhotkeys_main.la
+khotkeys_la_LDFLAGS = $(all_libraries) -avoid-version -module
+
+khotkeys_la_main.cpp: stub_main.cpp
+	cat stub_main.cpp > khotkeys_la_main.cpp
+
+khotkeys_SOURCES = khotkeys_main.cpp
+khotkeys_LDADD = libkhotkeys_main.la
 khotkeys_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+
+khotkeys_main.cpp: stub_main.cpp
+	cat stub_main.cpp > khotkeys_main.cpp
 
 autostart_DATA = khotkeys.desktop
 autostartdir = $(prefix)/share/autostart
--- khotkeys/khotkeys/main.cpp	25 Jun 2002 02:03:52 -0000	1.1.1.1
+++ khotkeys/khotkeys/main.cpp	26 Nov 2002 21:00:52 -0000	1.2
@@ -28,8 +28,9 @@
 // for multihead
 int khotkeys_screen_number = 0;
 
+extern "C" int kdemain(int, char**);
 
-int main( int argc, char** argv )
+int kdemain( int argc, char** argv )
 {                             // no need to i18n these, no GUI
     {
 	// multiheaded hotkeys
RCS file: khotkeys/khotkeys/stub_main.cpp
diff -N khotkeys/khotkeys/stub_main.cpp
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ khotkeys/khotkeys/stub_main.cpp	26 Nov 2002 21:00:52 -0000	1.1
@@ -0,0 +1,28 @@
+/*
+ *
+ * Copyright (c) 2001 Nick Hudson <skrll@netbsd.org>
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining a copy
+ * of this software and associated documentation files (the "Software"), to deal
+ * in the Software without restriction, including without limitation the rights
+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
+ * copies of the Software, and to permit persons to whom the Software is
+ * furnished to do so, subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice shall be included in
+ * all copies or substantial portions of the Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
+ * AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN
+ * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+extern "C" int kdemain(int, char* []);
+
+int main( int argc, char* argv[] )
+{
+        return kdemain(argc, argv);
+}
+
--- kicker/Makefile.am	10 Jul 2002 03:21:29 -0000	1.1.1.2
+++ kicker/Makefile.am	29 Nov 2002 18:19:36 -0000	1.6
@@ -3,18 +3,22 @@
 SUBDIRS = share core ui buttons . proxy taskmanager taskbar applets extensions menuext data
 
 bin_PROGRAMS = kicker
-lib_LTLIBRARIES = kicker.la
+lib_LTLIBRARIES = kicker.la libkicker_shared.la
 
-CLEANFILES = dummy.cpp dummy_la.cpp
+CLEANFILES = libkicker_shared_la_dummy.cpp kicker_la_dummy.cpp kicker_dummy.cpp
 
-kicker_la_LIBADD = core/libkicker_core.la  buttons/libkicker_buttons.la \
+libkicker_shared_la_LIBADD = core/libkicker_core.la  buttons/libkicker_buttons.la \
 	ui/libkicker_ui.la share/libkickermain.la $(LIB_KIO) 
 
-kicker_la_SOURCES = dummy.cpp
-kicker_la_LDFLAGS = $(KDE_PLUGIN) -no-undefined -module $(all_libraries)
+libkicker_shared_la_SOURCES = libkicker_shared_la_dummy.cpp
+libkicker_shared_la_LDFLAGS = $(KDE_RPATH) -no-undefined -avoid-version $(all_libraries)
 
-kicker_LDADD = kicker.la
-kicker_SOURCES = dummy_la.cpp
+kicker_la_LIBADD  = libkicker_shared.la
+kicker_la_SOURCES = kicker_la_dummy.cpp
+kicker_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -module -avoid-version
+
+kicker_LDADD = libkicker_shared.la
+kicker_SOURCES = kicker_dummy.cpp
 kicker_LDFLAGS = $(all_libraries) $(KDE_RPATH)
 
 autostart_DATA = panel.desktop
@@ -26,7 +30,7 @@
 messages:
 	$(XGETTEXT) share/*.cpp buttons/*.cpp core/*.cpp ui/*.cpp -o $(podir)/kicker.pot
 
-dummy.cpp dummy_la.cpp:
+libkicker_shared_la_dummy.cpp kicker_la_dummy.cpp kicker_dummy.cpp:
 	echo > $@
         
 updatedir = $(kde_datadir)/kconf_update
--- kicker/applets/launcher/Makefile.am	4 Jan 2003 04:50:34 -0000	1.1.1.3
+++ kicker/applets/launcher/Makefile.am	4 Jan 2003 05:34:15 -0000	1.3
@@ -13,8 +13,8 @@
 
 EXTRA_DIST = $(lnk_DATA)
 
-launcher_panelapplet_la_LDFLAGS = -module $(KDE_PLUGIN) $(all_libraries)
-launcher_panelapplet_la_LIBADD = ../../kicker.la $(LIB_KSYCOCA) $(LIB_KDEUI)
+launcher_panelapplet_la_LDFLAGS = $(all_libraries) -module  $(KDE_PLUGIN)
+launcher_panelapplet_la_LIBADD = ../../libkicker_shared.la $(LIB_KSYCOCA) $(LIB_KDEUI) 
 
 messages:
 	$(XGETTEXT) *.cpp *.h -o $(podir)/quicklauncher.pot
--- kicker/applets/lockout/Makefile.am	4 Jan 2003 04:50:34 -0000	1.1.1.2
+++ kicker/applets/lockout/Makefile.am	4 Jan 2003 05:34:16 -0000	1.3
@@ -4,7 +4,7 @@
 kde_module_LTLIBRARIES = lockout_panelapplet.la
 
 lockout_panelapplet_la_SOURCES = lockout.cpp
-lockout_panelapplet_la_LDFLAGS = -module $(KDE_PLUGIN) $(all_libraries)
+lockout_panelapplet_la_LDFLAGS = -module $(KDE_PLUGIN) $(all_libraries) -no-undefined
 lockout_panelapplet_la_LIBADD = $(LIB_KSYCOCA)
 
 noinst_HEADERS = lockout.h
--- kicker/extensions/childpanel/Makefile.am	4 Jan 2003 04:50:50 -0000	1.1.1.2
+++ kicker/extensions/childpanel/Makefile.am	4 Jan 2003 05:34:17 -0000	1.3
@@ -5,7 +5,7 @@
 childpanel_panelextension_la_SOURCES = childpanelextension.cpp childpanelextension.skel
 childpanel_panelextension_la_METASOURCES = AUTO
 childpanel_panelextension_la_LDFLAGS = -module $(KDE_PLUGIN) $(all_libraries)
-childpanel_panelextension_la_LIBADD = $(LIB_KDEUI) $(LIB_KSYCOCA) ../../kicker.la
+childpanel_panelextension_la_LIBADD = $(LIB_KDEUI) $(LIB_KSYCOCA) ../../libkicker_shared.la
 
 noinst_HEADERS = childpanelextension.h
 
--- kicker/menuext/kdeprint/Makefile.am	25 Jun 2002 02:03:52 -0000	1.1.1.1
+++ kicker/menuext/kdeprint/Makefile.am	24 Nov 2002 07:11:30 -0000	1.4
@@ -4,7 +4,7 @@
 
 kickermenu_kdeprint_la_SOURCES = print_mnu.cpp
 kickermenu_kdeprint_la_LDFLAGS = $(all_libraries) -module -avoid-version
-kickermenu_kdeprint_la_LIBADD = $(LIB_KDEUI) $(LIB_KIO) -lkdeprint
+kickermenu_kdeprint_la_LIBADD = $(LIB_KDEUI) $(LIB_KIO) -lkdeprint $(LIB_QT) -lkdecore
 
 kickermenu_kdeprint_la_METASOURCES = AUTO
 
--- kicker/menuext/konsole/Makefile.am	14 Aug 2002 14:30:12 -0000	1.1.1.1
+++ kicker/menuext/konsole/Makefile.am	24 Nov 2002 07:11:31 -0000	1.4
@@ -4,7 +4,7 @@
 
 kickermenu_konsole_la_SOURCES = konsole_mnu.cpp konsolebookmarkhandler.cpp konsolebookmarkmenu.cpp
 kickermenu_konsole_la_LDFLAGS = $(all_libraries) -module -avoid-version
-kickermenu_konsole_la_LIBADD = $(LIB_KDEUI) $(LIB_KIO)
+kickermenu_konsole_la_LIBADD = $(LIB_KDEUI) $(LIB_KIO) $(LIB_QT) -lkdecore
 
 kickermenu_konsole_la_METASOURCES = AUTO
 
--- kicker/menuext/prefmenu/Makefile.am	10 Jul 2002 03:22:41 -0000	1.1.1.1
+++ kicker/menuext/prefmenu/Makefile.am	24 Nov 2002 07:11:31 -0000	1.4
@@ -3,7 +3,7 @@
 kde_module_LTLIBRARIES = kickermenu_prefmenu.la
 
 kickermenu_prefmenu_la_SOURCES = prefmenu.cpp
-kickermenu_prefmenu_la_LDFLAGS = $(all_libraries) -module -avoid-version
+kickermenu_prefmenu_la_LDFLAGS = $(all_libraries) -module -avoid-version -undefined suppress -flat_namespace
 kickermenu_prefmenu_la_LIBADD = $(LIB_KDEUI) $(top_builddir)/kicker/ui/libkicker_ui.la
 
 kickermenu_prefmenu_la_METASOURCES = AUTO
--- kicker/menuext/recentdocs/Makefile.am	10 Jul 2002 03:22:42 -0000	1.1.1.1
+++ kicker/menuext/recentdocs/Makefile.am	24 Nov 2002 07:11:31 -0000	1.4
@@ -3,7 +3,7 @@
 kde_module_LTLIBRARIES = kickermenu_recentdocs.la
 
 kickermenu_recentdocs_la_SOURCES = recentdocsmenu.cpp
-kickermenu_recentdocs_la_LDFLAGS = $(all_libraries) -module -avoid-version
+kickermenu_recentdocs_la_LDFLAGS = $(all_libraries) -module -avoid-version -undefined suppress -flat_namespace
 kickermenu_recentdocs_la_LIBADD = $(LIB_KDEUI) $(top_builddir)/kicker/ui/libkicker_ui.la
 
 kickermenu_recentdocs_la_METASOURCES = AUTO
--- kicker/proxy/Makefile.am	25 Jun 2002 02:03:52 -0000	1.1.1.1
+++ kicker/proxy/Makefile.am	26 Nov 2002 21:00:52 -0000	1.3
@@ -3,32 +3,48 @@
 CLEANFILES = dummy.cpp
 
 bin_PROGRAMS = appletproxy extensionproxy
-lib_LTLIBRARIES = appletproxy.la extensionproxy.la
+lib_LTLIBRARIES = libappletproxy_main.la appletproxy.la libextensionproxy_main.la extensionproxy.la
 
-appletproxy_la_LIBADD = $(LIB_KDEUI) ../share/libkickermain.la
-appletproxy_la_SOURCES = appletproxy.cpp
-appletproxy_la_METASOURCES = appletproxy.moc
-appletproxy_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -module -avoid-version
+libappletproxy_main_la_LIBADD = $(LIB_KDEUI) ../share/libkickermain.la
+libappletproxy_main_la_SOURCES = appletproxy.cpp
+libappletproxy_main_la_METASOURCES = appletproxy.moc
+libappletproxy_main_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -avoid-version
+
+appletproxy_la_LIBADD  = libappletproxy_main.la
+appletproxy_la_SOURCES = appletproxy_la_main.cpp
+appletproxy_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -avoid-version -module
 
-appletproxy_LDADD = appletproxy.la
-appletproxy_SOURCES = dummy.cpp
+appletproxy_la_main.cpp: stub_main.cpp
+	cat stub_main.cpp > appletproxy_la_main.cpp
+
+appletproxy_LDADD = libappletproxy_main.la
+appletproxy_SOURCES = appletproxy_main.cpp
 appletproxy_LDFLAGS = $(all_libraries) $(KDE_RPATH)
 
-extensionproxy_la_LIBADD = $(LIB_KDEUI) ../share/libkickermain.la
-extensionproxy_la_SOURCES = extensionproxy.cpp
-extensionproxy_la_METASOURCES = extensionproxy.moc
-extensionproxy_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -module -avoid-version
+appletproxy_main.cpp: stub_main.cpp
+	cat stub_main.cpp > appletproxy_main.cpp
+
+libextensionproxy_main_la_LIBADD = $(LIB_KDEUI) ../share/libkickermain.la
+libextensionproxy_main_la_SOURCES = extensionproxy.cpp
+libextensionproxy_main_la_METASOURCES = extensionproxy.moc
+libextensionproxy_main_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -avoid-version
+
+extensionproxy_la_LIBADD = libextensionproxy_main.la
+extensionproxy_la_SOURCES = extensionproxy_la_main.cpp
+extensionproxy_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -avoid-version -module
+
+extensionproxy_la_main.cpp: stub_main.cpp
+	cat stub_main.cpp > extensionproxy_la_main.cpp
 
-extensionproxy_LDADD = extensionproxy.la
-extensionproxy_SOURCES = dummy.cpp
+extensionproxy_LDADD = libextensionproxy_main.la
+extensionproxy_SOURCES = extensionproxy_main.cpp
 extensionproxy_LDFLAGS = $(all_libraries) $(KDE_RPATH)
 
+extensionproxy_main.cpp: stub_main.cpp
+	cat stub_main.cpp > extensionproxy_main.cpp
+
 noinst_HEADERS = appletproxy.h extensionproxy.h
 
 messages:
 	$(XGETTEXT) appletproxy.cpp -o $(podir)/appletproxy.pot
 	$(XGETTEXT) extensionproxy.cpp -o $(podir)/extensionproxy.pot
-
-dummy.cpp:
-	echo > dummy.cpp
-
--- kicker/proxy/appletproxy.cpp	10 Jul 2002 03:22:43 -0000	1.1.1.2
+++ kicker/proxy/appletproxy.cpp	26 Nov 2002 21:00:52 -0000	1.2
@@ -67,7 +67,9 @@
   { 0, 0, 0}
 };
 
-int main( int argc, char ** argv )
+extern "C" int kdemain(int, char**);
+
+int kdemain( int argc, char ** argv )
 {
     KAboutData aboutData( "appletproxy", I18N_NOOP("Panel applet proxy.")
                           , "v0.1.0"
--- kicker/proxy/extensionproxy.cpp	10 Jul 2002 03:22:44 -0000	1.1.1.2
+++ kicker/proxy/extensionproxy.cpp	26 Nov 2002 21:00:52 -0000	1.2
@@ -54,7 +54,9 @@
   { 0, 0, 0}
 };
 
-int main( int argc, char ** argv )
+extern "C" int kdemain(int, char**);
+
+int kdemain( int argc, char ** argv )
 {
     KAboutData aboutData( "extensionproxy", I18N_NOOP("Panel extension proxy.")
                           , "v0.1.0"
RCS file: kicker/proxy/stub_main.cpp
diff -N kicker/proxy/stub_main.cpp
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ kicker/proxy/stub_main.cpp	26 Nov 2002 21:00:52 -0000	1.1
@@ -0,0 +1,28 @@
+/*
+ *
+ * Copyright (c) 2001 Nick Hudson <skrll@netbsd.org>
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining a copy
+ * of this software and associated documentation files (the "Software"), to deal
+ * in the Software without restriction, including without limitation the rights
+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
+ * copies of the Software, and to permit persons to whom the Software is
+ * furnished to do so, subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice shall be included in
+ * all copies or substantial portions of the Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
+ * AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN
+ * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+extern "C" int kdemain(int, char* []);
+
+int main( int argc, char* argv[] )
+{
+        return kdemain(argc, argv);
+}
+
--- kicker/share/Makefile.am	25 Jun 2002 02:03:52 -0000	1.1.1.1
+++ kicker/share/Makefile.am	24 Nov 2002 07:11:32 -0000	1.2
@@ -5,7 +5,7 @@
 libkickermain_la_SOURCES = pluginloader.cpp appletinfo.cpp panner.cpp fittslawframe.cpp menuinfo.cpp
 libkickermain_la_METASOURCES = AUTO
 
-libkickermain_la_LDFLAGS = $(all_libraries) -version-info 1:0:0 -module -no-undefined
+libkickermain_la_LDFLAGS = $(all_libraries) -version-info 1:0:0 -no-undefined
 libkickermain_la_LIBADD = $(LIB_KDECORE) $(LIB_KDEUI) $(top_builddir)/libkonq/libkonq.la
 
 messages:
--- kicker/taskmanager/Makefile.am	25 Jun 2002 02:03:52 -0000	1.1.1.1
+++ kicker/taskmanager/Makefile.am	24 Nov 2002 07:11:32 -0000	1.2
@@ -4,7 +4,7 @@
 libtaskmanager_la_SOURCES = tasklmbmenu.cpp taskrmbmenu.cpp taskmanager.cpp
 libtaskmanager_la_METASOURCES = AUTO
 
-libtaskmanager_la_LDFLAGS = $(all_libraries) -version-info 1:0:0 -module -no-undefined
+libtaskmanager_la_LDFLAGS = $(all_libraries) -version-info 1:0:0 -no-undefined
 libtaskmanager_la_LIBADD = $(LIB_KDECORE)
 
 messages:
--- kioslave/Makefile.am	29 Oct 2002 03:05:23 -0000	1.1.1.4
+++ kioslave/Makefile.am	29 Oct 2002 03:39:31 -0000	1.6
@@ -8,10 +8,14 @@
 SMB_SUBDIR=smb
 endif
 
+if include_kioslave_nfs
+NFS_SUBDIR=nfs
+endif
+
 if include_devicesdir
 DEVICES_SUBDIR=devices
 endif
 
-
-SUBDIRS = about cgi floppy filter fish info mac man nfs nntp pop3 imap4 smtp \
-  smbro sftp tar zip finger thumbnail $(LDAP_SUBDIR) $(SMB_SUBDIR) $(DEVICES_SUBDIR)
+SUBDIRS = about cgi floppy filter fish info mac man nntp pop3 imap4 smtp \
+	smbro sftp tar zip finger thumbnail $(LDAP_SUBDIR) $(SMB_SUBDIR) \
+	$(NFS_SUBDIR) $(DEVICES_SUBDIR)
--- kioslave/devices/configure.in.in	29 Oct 2002 03:05:23 -0000	1.1.1.2
+++ kioslave/devices/configure.in.in	11 Nov 2002 20:56:20 -0000	1.2
@@ -7,6 +7,9 @@
     Linux)
         DEVICESDIR=devices
         ;;
+    Darwin)
+        DEVICESDIR=devices
+        ;;
     *)
         DEVICESDIR=
         ;;
--- kioslave/devices/kdedmodule/Makefile.am	29 Oct 2002 03:05:23 -0000	1.1.1.2
+++ kioslave/devices/kdedmodule/Makefile.am	25 Mar 2003 18:16:37 -0000	1.6
@@ -3,7 +3,7 @@
 INCLUDES = $(all_includes)
 kded_mountwatcher_la_SOURCES = mountwatcher.cpp mountwatcher.skel disklist.cpp disks.cpp
 kded_mountwatcher_la_LDFLAGS = $(all_libraries) -module -avoid-version
-kded_mountwatcher_la_LIBADD = $(LIB_KSYCOCA)
+kded_mountwatcher_la_LIBADD = $(LIB_KSYCOCA) $(LIB_QT) -lDCOP -lkdecore
 
 METASOURCES = AUTO
 
--- kioslave/fish/fish.cpp	13 Mar 2003 03:01:49 -0000	1.1.1.7
+++ kioslave/fish/fish.cpp	29 Mar 2003 02:34:30 -0000	1.7
@@ -244,7 +244,7 @@
     sendLen = -1;
     connectionAuth.keepPassword = true;
     connectionAuth.url.setProtocol("fish");
-    epoch.setTime_t(0);
+    epoch.setTime_t(0, Qt::UTC);
     outBufPos = -1;
     outBuf = NULL;
     outBufLen = 0;
@@ -282,6 +282,7 @@
 
     myDebug( << "connecting to: " << connectionUser << "@" << connectionHost << ":" << connectionPort << endl);
     sendCommand(FISH_FISH);
+    sendCommand(FISH_VER);
     if (connectionStart()) {
         error(ERR_COULD_NOT_CONNECT,thisFn);
         shutdownConnection();
@@ -620,6 +621,7 @@
 void fishProtocol::shutdownConnection(bool forced){
     if (childPid) {
         kill(childPid,SIGTERM);
+        wait(NULL);
         childPid = 0;
         close(childFd);
         childFd = -1;
@@ -1025,7 +1027,6 @@
         bool wasSize = false;
         if (fishCommand == FISH_STOR) fishCommand = (hasAppend?FISH_APPEND:FISH_WRITE);
         if (fishCommand == FISH_FISH) {
-            sendCommand(FISH_VER);
             connected();
         } else if (fishCommand == FISH_LIST) {
             if (listReason == LIST) {
--- kioslave/fish/fish.pl	20 Nov 2002 01:13:50 -0000	1.1.1.3
+++ kioslave/fish/fish.pl	29 Mar 2003 02:34:31 -0000	1.2
@@ -42,7 +42,7 @@
     next if !length($_) || substr($_,0,1) ne '#';
     s/^#//;
     /^VER / && do {
-        print "VER 0.0.2 copy append lscount lsmime\n### 200\n";
+        print "VER 0.0.2 copy append lscount lslinks lsmime\n### 200\n";
         next;
     };
     /^PWD$/ && do {
--- kioslave/floppy/kio_floppy.cpp	1 Oct 2002 02:36:13 -0000	1.1.1.4
+++ kioslave/floppy/kio_floppy.cpp	29 Mar 2003 02:34:34 -0000	1.2
@@ -218,7 +218,7 @@
       error( KIO::ERR_DOES_NOT_EXIST, url.prettyURL());
    }
    //no disk
-   else if (line.contains("not configured"))
+   else if ((line.contains("not configured")) || (line.contains("No such device")))
    {
       error( KIO::ERR_COULD_NOT_STAT, url.prettyURL()+i18n("\nThere is probably no disk in the drive %1").arg(drive));
    }
--- kioslave/info/LICENSE	25 Jun 2002 02:03:52 -0000	1.1.1.1
+++ kioslave/info/LICENSE	29 Mar 2003 02:34:36 -0000	1.2
@@ -1,3 +1,9 @@
+The following license is applicable to all files in this directory, with the
+exception of kde-info2html and kde-info2html.conf which are licensed under the GPL,
+since they are based on GPL work.
+
+LICENSE:
+
 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
--- kioslave/info/kde-info2html	20 Nov 2002 01:13:52 -0000	1.1.1.4
+++ kioslave/info/kde-info2html	29 Mar 2003 02:34:36 -0000	1.2
@@ -16,6 +16,9 @@
 #   Changes for the KDE Help Center (c) 1999 Matthias ELter
 #                                           (me@kde.org)
 #
+# LICENSE
+#   GPL
+#
 # HISTORY
 #   11.10.93  V 1.0
 #   14.10.93  V 1.0a  some comments added
@@ -436,7 +439,7 @@
   #-- print the HTML Text
   print <<EOF;
 <a href="info:/$LinkFileEsc/$LinkTag">
-#   $LinkTypeText
+   $LinkTypeText
   <em>($LinkFile)</em> <strong>$LinkRef</strong>
 </a>
 EOF
@@ -561,8 +564,10 @@
     }
     else {                   #--  a normal line, just replace cross refs
       $Line = &ParsCrossRefs($prev,$_,$BaseInfoFile);
-      if ($Line =~ /^DONTPRINTYET (.*)$/) {
-	  $prev = $1;
+      if ($Line =~ /^DONTPRINTYET /) {
+	  $prev = $Line;
+	  $prev =~ s/^DONTPRINTYET //;
+	  chomp $prev;
       } else {
 	  $prev = $Line;
 	  $Line =~ s!- (Variable|Function|Macro|Command|Special Form|User Option):.*$!<em>$&</em>!;
--- kioslave/info/kde-info2html.conf	25 Jun 2002 02:03:52 -0000	1.1.1.1
+++ kioslave/info/kde-info2html.conf	29 Mar 2003 02:34:37 -0000	1.2
@@ -31,4 +31,4 @@
 
 
 #-- URL for documentation of info2html
-$DOC_URL = 'http://iamwww.unibe.ch/work/docs/info2html/info2html.html';
+$DOC_URL = 'http://info2html.sf.net/';
--- kioslave/ldap/configure.in.in	14 Jan 2003 20:11:09 -0000	1.1.1.3
+++ kioslave/ldap/configure.in.in	21 Feb 2003 21:42:07 -0000	1.9
@@ -19,7 +19,7 @@
   fi
   if test $with_ldap = FOUND ; then
     with_ldap=NOTFOUND
-    for ext in la so sl a ; do
+    for ext in la so sl a dylib ; do
       AC_FIND_FILE(libldap.$ext, $kde_libraries /usr/lib /usr/local/lib,
         ldap_libdir)
       if test -r $ldap_libdir/libldap.$ext ; then
@@ -37,6 +37,12 @@
 
 case "$with_ldap" in
 no) AC_MSG_RESULT(no) ;;
+framework)
+  LDAP_LIBS="-Xlinker -framework -Xlinker LDAP"
+  AC_DEFINE_UNQUOTED(HAVE_LIBLDAP, 1, [Define if you have LDAP libraries])
+  LDAP_SUBDIR="ldap"
+  AC_MSG_RESULT(Apple framework)
+  ;;
 NOTFOUND) AC_MSG_RESULT(searched but not found) ;;
 *)
   if test "x$with_ldap" = "xFOUND" ; then
--- kioslave/nfs/README	25 Jun 2002 02:03:52 -0000	1.1.1.1
+++ kioslave/nfs/README	16 Sep 2002 14:52:42 -0000	1.4
@@ -1,3 +1,29 @@
 this is an ioslave for KDE 2 for NFS, version 2.
 
 Alex
+
+Darwin notes --
+
+It looks like there are C++ type issues with the Darwin headers
+(try building, you'll see the "too many arguments to function" stuff)
+
+The problem seems to be <rpc/clnt.h> having definitions that don't
+play nice with C++.  The client rpc handle does a bunch of void stuff
+in the struct which is fine in C but makes an empty arg list in C++.
+
+typedef struct {
+        AUTH    *cl_auth;                       /* authenticator */
+        struct clnt_ops {
+                enum clnt_stat  (*cl_call)();   /* call remote procedure */
+                void            (*cl_abort)();  /* abort a call */
+                void            (*cl_geterr)(); /* get specific error code */
+                bool_t          (*cl_freeres)(); /* frees results */
+                void            (*cl_destroy)();/* destroy this structure */
+                bool_t          (*cl_control)();/* the ioctl() of rpc */
+        } *cl_ops;
+        caddr_t                 cl_private;     /* private stuff */
+} CLIENT;
+
+
+The only solution is to probably reimplement clnt.h locally to fix
+these (wrapping the "#include <rpc/rpc.h>" in an extern "C" isn't enough).
RCS file: kioslave/nfs/configure.in.in
diff -N kioslave/nfs/configure.in.in
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ kioslave/nfs/configure.in.in	18 Dec 2002 17:11:17 -0000	1.3
@@ -0,0 +1,12 @@
+AC_MSG_CHECKING(whether to compile NFS support)
+AC_ARG_WITH(nfs,
+[  --without-nfs           Disable NFS kioslave [default=no]],
+	with_nfs=$withval, with_nfs=yes
+)dnl
+
+if test `uname -s` = "Darwin"; then
+	with_nfs=no
+fi
+
+AC_MSG_RESULT($withval)
+AM_CONDITIONAL(include_kioslave_nfs, test "$with_nfs" = "yes")
--- kioslave/smbro/kio_smb.cpp	29 Oct 2002 03:05:32 -0000	1.1.1.5
+++ kioslave/smbro/kio_smb.cpp	29 Mar 2003 02:34:40 -0000	1.2
@@ -74,7 +74,7 @@
      fprintf(stderr, "Usage: kio_smb protocol domain-socket1 domain-socket2\n");
      exit(-1);
   }
-  //kdDebug(KIO_SMB) << "Smb: kdemain: starting" << endl;
+  kdDebug(KIO_SMB) << "Smb: kdemain: starting" << endl;
 
   SmbProtocol slave(argv[2], argv[3]);
   slave.dispatchLoop();
@@ -95,9 +95,9 @@
       s+="/"+(*it);
       if ((!d.exists(s)) && (!d.mkdir(s)))
             return -1;
-   };
+   }
    return 0;
-};
+}
 
 void SmbProtocol::getShareAndPath(const KURL& url, QString& share, QString& rest)
 {
@@ -130,14 +130,14 @@
             share=(*it);
          else
             rest=rest+"\\"+(*it);
-      };
+      }
       i++;
-   };
+   }
    if ((rest.isEmpty()) && (!share.isEmpty()) && (path[path.length()-1]=='/'))
       rest="\\";
 
    kdDebug(KIO_SMB)<<"getShareAndPath: path: -"<<path<<"-  share: -"<<share<<"-  rest: -"<<rest<<"-"<<endl;
-};
+}
 
 QString my_unscramble(const QString& secret)
 {
@@ -154,7 +154,7 @@
       plain[i] = QChar((uchar)((num - 17) ^ 173)); // restore
    }
    return plain;
-};
+}
 
 QString my_scramble(const QString& plain)
 {
@@ -174,7 +174,7 @@
       scrambled += (char)(a3+'0');
    }
    return scrambled;
-};
+}
 
 SmbProtocol::SmbProtocol (const QCString &pool, const QCString &app )
 :SlaveBase( "smb", pool, app )
@@ -190,6 +190,7 @@
 ,m_user("")
 ,m_defaultWorkgroup("")
 ,m_currentWorkgroup("")
+,m_usefulLineFound(false)
 {
    kdDebug(KIO_SMB)<<"Smb::Smb: -"<<pool<<"-"<<endl;
    m_processes.setAutoDelete(true);
@@ -228,11 +229,11 @@
       delete [] m_stdoutBuffer;
    m_processes.clear();
    m_stdoutBuffer=0;
-};
+}
 
 int SmbProtocol::readOutput(int fd)
 {
-   //kdDebug(KIO_SMB)<<"Smb::readStdout"<<endl;
+//   kdDebug(KIO_SMB)<<"Smb::readStdout"<<endl;
    //if (m_mtool==0) return 0;
 
    static char buffer[16*1024];
@@ -241,21 +242,77 @@
 
    //+1 gives us room for a terminating 0
    char *newBuffer=new char[length+m_stdoutSize+1];
-   //kdDebug(KIO_SMB)<<"Smb::readStdout(): length: "<<length<<", m_stdoutSize: "<<m_stdoutSize<<" + 1 = "<<length+m_stdoutSize+1<<endl;
+   kdDebug(KIO_SMB)<<"Smb::readStdout(): length: "<<length<<", m_stdoutSize: "<<m_stdoutSize<<" + 1 = "<<length+m_stdoutSize+1<<endl;
    if (m_stdoutBuffer!=0)
    {
       memcpy(newBuffer, m_stdoutBuffer, m_stdoutSize);
-   };
-   memcpy(newBuffer+m_stdoutSize, buffer, length);
+   }
+
+   char *src=buffer;
+   char *dest=newBuffer+m_stdoutSize;
+   char currentC;
+   for (int i=0; i<length; i++)
+   {
+      //I'm sure I could write this all together in one line...
+      //something like *dest++=(*src=='\r'?'\n':*src++);
+      currentC=*src;
+      if (currentC=='\r')
+//         currentC='~';
+         currentC='\n';
+
+      *dest=currentC;
+
+      dest++;
+      src++;
+   }
+//   memcpy(newBuffer+m_stdoutSize, buffer, length);
+
    m_stdoutSize+=length;
    newBuffer[m_stdoutSize]='\0';
    if (m_stdoutBuffer!=0)
    {
       delete [] m_stdoutBuffer;
-   };
+   }
    m_stdoutBuffer=newBuffer;
+
+   //m_stdoutBuffer is definitely 0-terminated
+   if (m_usefulLineFound==false)
+   {
+      char *tmpBuffer=m_stdoutBuffer;
+      while (1)
+      {
+         char *eol=strchr(tmpBuffer,'\n');
+         if (eol==0)
+            break;
+         if (eol==tmpBuffer)
+         {
+            tmpBuffer=eol+1;
+            continue;
+         }
+         //the line contains something
+         *eol='\0';   //easier searching
+
+         int lineLength=strlen(tmpBuffer);
+         char searchString[16];
+         strcpy(searchString,"smb: \\>");
+         if (lineLength<16)
+            searchString[lineLength]='\0';
+
+         char* prompt=strstr(tmpBuffer,searchString);
+
+         *eol='\n';   //restore it
+         if (prompt!=tmpBuffer)
+         {
+            m_usefulLineFound=true;
+            break;
+         }
+         tmpBuffer=eol+1;   // the next line
+         if (*tmpBuffer=='\0')
+            break;
+      }
+   }
    return length;
-};
+}
 
 void SmbProtocol::clearBuffer()
 {
@@ -263,22 +320,26 @@
    if (m_stdoutBuffer!=0)
       delete [] m_stdoutBuffer;
    m_stdoutBuffer=0;
-};
+   m_usefulLineFound=false;
+}
 
 bool SmbProtocol::stopAfterError(const KURL& url, bool notSureWhetherErrorOccured, bool onlyCheckForExistance)
 {
+   kdDebug(KIO_SMB)<<"stopAfterError()"<<endl;
    if (wasKilled())
    {
+      kdDebug(KIO_SMB)<<"stopAfterError() 1"<<endl;
       finished();
       return true;
-   };
+   }
    if (m_stdoutSize==0)
    {
+      kdDebug(KIO_SMB)<<"stopAfterError() 2"<<endl;
       //error(KIO::ERR_UNKNOWN,"");
       //error( KIO::ERR_CONNECTION_BROKEN, m_currentHost);
       error( KIO::ERR_CANNOT_LAUNCH_PROCESS, "smbclient"+i18n("\nMake sure that the samba package is installed properly on your system."));
       return true;
-   };
+   }
 
    QString outputString = QString::fromLocal8Bit(m_stdoutBuffer);
 
@@ -286,53 +347,64 @@
    if ((outputString.contains("Connection to")) && (outputString.contains("failed"))
        && (outputString.contains("error connecting")) && (outputString.contains("(Connection refused")))
    {
+      kdDebug(KIO_SMB)<<"stopAfterError() 3"<<endl;
       error( KIO::ERR_COULD_NOT_CONNECT, m_currentHost+i18n("\nThere is probably no SMB service running on this host."));
    }
    else if (outputString.contains("smbclient not found"))
    {
+      kdDebug(KIO_SMB)<<"stopAfterError() 4"<<endl;
       error( KIO::ERR_CANNOT_LAUNCH_PROCESS, "smbclient"+i18n("\nMake sure that the samba package is installed properly on your system."));
    }
    //host not found
    else if ((outputString.contains("Connection to")) && (outputString.contains("failed")))
    {
+      kdDebug(KIO_SMB)<<"stopAfterError() 5"<<endl;
       error( KIO::ERR_COULD_NOT_CONNECT, m_currentHost);
    }
    else if (outputString.contains("ERRDOS - ERRnomem"))
    {
+      kdDebug(KIO_SMB)<<"stopAfterError() 6"<<endl;
       error( KIO::ERR_INTERNAL_SERVER, m_currentHost);
    }
    //wrong password
    else if (outputString.contains("ERRSRV - ERRbadpw"))
    {
       //we should never get here
+      kdDebug(KIO_SMB)<<"stopAfterError() 7"<<endl;
       error( KIO::ERR_COULD_NOT_STAT, m_currentHost+i18n("\nInvalid user/password combination."));
    }
    else if ((outputString.contains("ERRDOS")) && (outputString.contains("ERRnoaccess")))
    {
       //we should never get here
+      kdDebug(KIO_SMB)<<"stopAfterError() 8"<<endl;
       error( KIO::ERR_COULD_NOT_STAT, m_currentHost+i18n("\nInvalid user/password combination."));
    }
    //file not found
    else if ((outputString.contains("ERRDOS")) && (outputString.contains("ERRbadfile")) && (onlyCheckForExistance==false))
    {
-      //kdDebug(KIO_SMB)<<"Smb::stopAfterError() contains both, reporting error"<<endl;
+      kdDebug(KIO_SMB)<<"stopAfterError() 9"<<endl;
+      kdDebug(KIO_SMB)<<"Smb::stopAfterError() contains both, reporting error"<<endl;
       error( KIO::ERR_DOES_NOT_EXIST, url.prettyURL());
    }
    else if (outputString.contains("Broken pipe"))
    {
+      kdDebug(KIO_SMB)<<"stopAfterError() 10"<<endl;
       error( KIO::ERR_CONNECTION_BROKEN, m_currentHost);
    }
    else if (notSureWhetherErrorOccured)
    {
+      kdDebug(KIO_SMB)<<"stopAfterError() 11"<<endl;
       return false;
    }
    else
    {
+      kdDebug(KIO_SMB)<<"stopAfterError() 12"<<endl;
       kdDebug(KIO_SMB)<<"Smb::stopAfterError() -"<<m_stdoutBuffer<<"-"<<endl;
-      error( KIO::ERR_UNKNOWN, i18n("Hmm..."));
-   };
+      error( KIO::ERR_UNKNOWN, i18n("Couldn't parse response message."));
+   }
+   kdDebug(KIO_SMB)<<"stopAfterError() 13"<<endl;
    return true;
-};
+}
 
 SmbProtocol::SmbReturnCode SmbProtocol::waitUntilStarted(ClientProcess *proc, const QString& password, const char* prompt)
 {
@@ -360,7 +432,7 @@
          if (alreadyEnteredPassword)
             return SMB_WRONGPASSWORD;
          return SMB_ERROR;
-      };
+      }
 
       if (stdoutEvent)
       {
@@ -443,7 +515,7 @@
          }
          else
             return SMB_ERROR;  // :-(
-      };
+      }
       if (stdoutEvent)
       {
          int result=readOutput(shareLister->fd());
@@ -467,11 +539,11 @@
                char c;
                ::read(shareLister->fd(),&c,1);
                alreadyEnteredPassword=true;
-            };
-         };
-      };
-   };
-};
+            }
+         }
+      }
+   }
+}
 
 bool SmbProtocol::getAuth(AuthInfo& auth, const QString& server, const QString& wg, const QString& share, const QString& realm, const QString& user, bool& firstLoop)
 {
@@ -487,12 +559,12 @@
    {
       cl+="."+i18n("Workgroup");
       c+="."+wg;
-   };
+   }
    if (!share.isEmpty())
    {
       cl+="/"+i18n("Share");
       c+="/"+share;
-   };
+   }
    auth.comment=c;
    auth.commentLabel=cl;
    if (firstLoop)
@@ -500,11 +572,11 @@
       firstLoop=false;
       if (checkCachedAuthentication(auth))
          return true;
-   };
+   }
    if (openPassDlg(auth))
       return true;
    return false;
-};
+}
 
 void SmbProtocol::listShares()
 {
@@ -523,7 +595,7 @@
       error( KIO::ERR_CANNOT_LAUNCH_PROCESS, "smbclient"+i18n("\nMake sure that the samba package is installed properly on your system."));
       delete proc;
       return;
-   };
+   }
    QString password(m_password);
    QString user(m_user);
 
@@ -558,58 +630,16 @@
             error( KIO::ERR_CANNOT_LAUNCH_PROCESS, "smbclient"+i18n("\nMake sure that the samba package is installed properly on your system."));
             delete proc;
             return;
-         };
+         }
       }
       else break;
-/*    authInfo.url=KURL("smb://"+m_nmbName);
-      authInfo.username = user;
-      authInfo.keepPassword=true;
-      authInfo.realmValue=user+"_"+QString(m_nmbName);
-      if (m_currentWorkgroup.isEmpty())
-      {
-         authInfo.commentLabel=i18n("Server:");
-         authInfo.comment=QString(m_nmbName);
-      }
-      else
-      {
-         authInfo.commentLabel=i18n("Server, Workgroup:");
-         authInfo.comment=QString(m_nmbName)+", "+m_currentWorkgroup;
-      };
-      bool hasAuth=false;
-      if (firstLoop)
-      {
-         hasAuth=checkCachedAuthentication(authInfo);
-         firstLoop=false;
-      };
-      if ((hasAuth) || (openPassDlg(authInfo)))
-      {
-         ai=authInfo;
-         user = authInfo.username;
-         password = authInfo.password;
-         proc=new ClientProcess();
-         QCStringList tmpArgs;
-         tmpArgs<<QCString("-L")+m_nmbName;
-         if (!user.isEmpty())
-            tmpArgs<<QCString("-U")+user.local8Bit();
-         if (!m_ip.isEmpty())
-            args<<QCString("-I")+m_ip;
-         if (!m_currentWorkgroup.isEmpty())
-            tmpArgs<<QCString("-W")+m_currentWorkgroup.local8Bit();
-         if (!proc->start("smbclient",tmpArgs))
-         {
-            error( KIO::ERR_CANNOT_LAUNCH_PROCESS, "smbclient"+i18n("\nMake sure that the samba package is installed properly on your system."));
-            delete proc;
-            return;
-         };
-      }
-      else break;*/
-   };
+   }
    //here smbclient has already exited
    if (proc!=0)
    {
       delete proc;
       proc=0;
-   };
+   }
 
    KURL url("smb://"+m_currentHost);
    //no error handling has happened up to now
@@ -623,7 +653,7 @@
    {
       error(ERR_USER_CANCELED,"");
       return;
-   };
+   }
 
    if (stopAfterError(url,true))
       return;
@@ -654,7 +684,7 @@
             mode=1;
             shareNamePos=line.find("Sharename");
             typePos=line.find("Type");
-         };
+         }
       }
       else if (mode==1)
       {
@@ -704,15 +734,15 @@
 
                listEntry( entry, false);
                totalNumber++;
-            };
-         };
-      };
-   };
+            }
+         }
+      }
+   }
    totalSize( totalNumber);
    listEntry( entry, true ); // ready
 
    finished();
-};
+}
 
 void SmbProtocol::listDir( const KURL& _url)
 {
@@ -731,7 +761,7 @@
    {
       listWorkgroups();
       return;
-   };
+   }
 
    if (_url.path()[_url.path().length()-1]!='/')
    {
@@ -740,7 +770,7 @@
       redirection(url);
       finished();
       return;
-   };
+   }
 
    QString share;
    QString smbPath;
@@ -752,20 +782,20 @@
       kdDebug(KIO_SMB)<<"Smb::listDir() listHosts()"<<endl;
       listHosts();
       return;
-   };
+   }
 
    if (share.isEmpty())
    {
       listShares();
       return;
-   };
+   }
 
    ClientProcess *proc=getProcess(m_currentHost, share);
    if (proc==0)
    {
       kdDebug(KIO_SMB)<<"Smb::listDir() proc==0"<<endl;
       return;
-   };
+   }
 
    QCString command=QCString("dir \"")+smbPath.local8Bit()+QCString("\\*\"\n");
    kdDebug(KIO_SMB)<<"Smb::listDir(): executing command: -"<<command<<"-"<<endl;
@@ -775,7 +805,7 @@
       kdDebug(KIO_SMB)<<"Smb::listDir() could not ::write()"<<endl;
       error(ERR_CONNECTION_BROKEN,m_currentHost);
       return;
-   };
+   }
 
    clearBuffer();
 
@@ -790,55 +820,80 @@
          kdDebug(KIO_SMB)<<"Smb::listDir(): smbclient exited "<<exitStatus<<endl;
          stopAfterError(_url,false);
          return;
-      };
+      }
       bool stdoutEvent;
       result=proc->select(1,0,&stdoutEvent);
       if (stdoutEvent)
       {
          readOutput(proc->fd());
-         //kdDebug(KIO_SMB)<<"Smb::listDir(): read: -"<<m_stdoutBuffer<<"-"<<endl;
+//         kdDebug(KIO_SMB)<<"Smb::listDir(): read: -"<<m_stdoutBuffer<<"-"<<endl;
          //don't search the whole buffer, only the last 12 bytes
          if (m_stdoutSize>12)
          {
-            if (strstr(m_stdoutBuffer+m_stdoutSize-12,"\nsmb: \\>")!=0)
+            if ((strstr(m_stdoutBuffer+m_stdoutSize-12,"\nsmb: \\>")!=0) && (m_usefulLineFound==true))
+//            if (strstr(m_stdoutBuffer+m_stdoutSize-12,"\nsmb: \\>")!=0)
+            {
                loopFinished=true;
-         };
-      };
+               kdDebug()<<"offset: "<<int(strstr(m_stdoutBuffer+m_stdoutSize-12,"\nsmb: \\>")-m_stdoutBuffer)<<endl;
+            }
+//               loopFinished=true;
+//            if (strstr(m_stdoutBuffer+m_stdoutSize-12,"\rsmb: \\>")!=0)
+//               loopFinished=true;
+         }
+      }
    } while (!loopFinished);
-//   kdDebug(KIO_SMB)<<"Smb::listDir(): read: -"<<m_stdoutBuffer<<"-"<<endl;
+   kdDebug(KIO_SMB)<<"Smb::listDir(): reading done: -"<<m_stdoutBuffer<<"-"<<endl;
 
    //check the output from smbclient whether an error occured
    if (stopAfterError(_url,true))
       return;
+   kdDebug(KIO_SMB)<<"Smb::listDir(): no error detected"<<endl;
 
    QString outputString = QString::fromLocal8Bit(m_stdoutBuffer);
+
    QTextIStream output(&outputString);
    QString line;
 
    int totalNumber(0);
    UDSEntry entry;
 
+//   int endOfLine=0;
    while (!output.atEnd())
+//   while (1)
    {
+/*      int eol=outputString.find('\n',endOfLine);
+      if (eol==-1)
+         eol=outputString.find('\r',endOfLine);
+      if (eol==-1)
+         break;
+
+      kdDebug(KIO_SMB)<<" eol: "<<eol<<" endOfLIne: "<<endOfLine<<endl;
+
+      line=outputString.mid(endOfLine,eol-endOfLine);
+      endOfLine=eol+1;*/
+
       line=output.readLine();
+
 //      kdDebug(KIO_SMB)<<"Smb::listDir(): line: -"<<line<<"-"<<endl;
-      if (line.isEmpty())
-         break;
+//      if (line.isEmpty())
+//         break;
       StatInfo info=createStatInfo(line);
+//      kdDebug(KIO_SMB)<<"Smb::listDir(): after createStatInfo()"<<endl;
       if (info.isValid)
       {
          entry.clear();
          createUDSEntry(info,entry);
-         //kdDebug(KIO_SMB)<<"Smb::listDir(): creating UDSEntry"<<endl;
+//         kdDebug(KIO_SMB)<<"Smb::listDir(): creating UDSEntry"<<endl;
          listEntry( entry, false);
          totalNumber++;
-      };
-   };
+      }
+//      kdDebug(KIO_SMB)<<"Smb::listDir(): loop done"<<endl;
+   }
    totalSize( totalNumber);
    listEntry( entry, true ); // ready
    finished();
-   //kdDebug(KIO_SMB)<<"Smb::listDir() ends"<<endl;
-};
+//   kdDebug(KIO_SMB)<<"Smb::listDir() ends"<<endl;
+}
 
 void SmbProtocol::mkdir( const KURL& url, int)
 {
@@ -854,7 +909,7 @@
    {
       kdDebug(KIO_SMB)<<"Smb::mkdir() file not found"<<endl;
       return;
-   };
+   }
 
    ClientProcess *proc=getProcess(m_currentHost, share);
 
@@ -865,7 +920,7 @@
    {
       error(ERR_CONNECTION_BROKEN,m_currentHost);
       return;
-   };
+   }
 
    clearBuffer();
    bool loopFinished(false);
@@ -880,8 +935,7 @@
    } while (!loopFinished);
    clearBuffer();
    finished();
-
-};
+}
 
 void SmbProtocol::del( const KURL& url, bool isfile)
 {
@@ -898,7 +952,7 @@
    {
       kdDebug(KIO_SMB)<<"Smb::del() file not found"<<endl;
       return;
-   };
+   }
    ClientProcess *proc=getProcess(m_currentHost, share);
 
    QCString command;
@@ -914,7 +968,7 @@
    {
       error(ERR_CONNECTION_BROKEN,m_currentHost);
       return;
-   };
+   }
 
    clearBuffer();
    bool loopFinished(false);
@@ -929,7 +983,7 @@
    } while (!loopFinished);
    clearBuffer();
    finished();
-};
+}
 
 
 void SmbProtocol::createUDSEntry(const StatInfo& info, UDSEntry& entry)
@@ -954,7 +1008,7 @@
    atom.m_uds = KIO::UDS_FILE_TYPE;
    atom.m_long =(info.isDir?S_IFDIR:S_IFREG);
    entry.append( atom );
-};
+}
 
 StatInfo SmbProtocol::createStatInfo(const QString line)
 {
@@ -971,12 +1025,12 @@
    //version 2.0.5 to at least 2.2.0 has at least 8 characters
    //version 2.2.2 has at least 7 characters
    int startOfData=line.find(QRegExp("    [SADR ][SADR ][SADR ] [ \\d][ \\d][ \\d][ \\d][ \\d][ \\d]\\d+  [A-Z][a-z][a-z] [A-Z][a-z][a-z] [ \\d]\\d"));
-   //kdDebug(KIO_SMB)<<"createStatInfo: regexp at: "<<startOfData<<endl;
+//   kdDebug(KIO_SMB)<<"createStatInfo: regexp at: "<<startOfData<<endl;
    if (startOfData==-1)
    {
       info.isValid=false;
       return info;
-   };
+   }
 
    info.isValid=true;
    name=line.mid(2,startOfData-2);
@@ -990,7 +1044,7 @@
    {
       info.isValid=false;
       return info;
-   };
+   }
 
    //kdDebug(KIO_SMB)<<"createStatInfo: name: -"<<name<<"-"<<endl;
 
@@ -1011,7 +1065,7 @@
       size=line.mid(startOfData+7,9+sizeOffset);
       info.size=size.toInt();
       //kdDebug(KIO_SMB)<<"createStatInfo: size: -"<<size<<"-"<<endl;
-   };
+   }
 
    info.name=name;
 
@@ -1047,13 +1101,13 @@
    else
       info.mode = S_IRUSR | S_IRGRP | S_IROTH;
 
-   //kdDebug(KIO_SMB)<<"Smb::createUDSEntry() ends"<<endl;
+//   kdDebug(KIO_SMB)<<"Smb::createUDSEntry() ends"<<endl;
    return info;
-};
+}
 
 StatInfo SmbProtocol::_stat(const KURL& url, bool onlyCheckForExistance)
 {
-   //kdDebug(KIO_SMB)<<"Smb::_stat() prettyURL(): -"<<url.prettyURL()<<"-"<<endl;
+   kdDebug(KIO_SMB)<<"Smb::_stat() prettyURL(): -"<<url.prettyURL()<<"-"<<endl;
    kdDebug(KIO_SMB)<<"Smb::_stat() local8() : -"<<url.path().local8Bit()<<"-"<<endl;
    StatInfo info;
 
@@ -1073,14 +1127,14 @@
       info.isDir=true;
       info.isValid=true;
       return info;
-   };
+   }
 
    ClientProcess *proc=getProcess(m_currentHost, share);
    if (proc==0)
    {
       info.isValid=false;
       return info;
-   };
+   }
 
    QCString command=QCString("dir \"")+smbPath.local8Bit()+QCString("\"\n");
    kdDebug(KIO_SMB)<<"Smb::_stat(): executing command: -"<<command<<"-"<<endl;
@@ -1090,7 +1144,7 @@
       error(ERR_CONNECTION_BROKEN,m_currentHost);
       info.isValid=false;
       return info;
-   };
+   }
 
 
    clearBuffer();
@@ -1106,7 +1160,7 @@
          stopAfterError(url,false);
          info.isValid=false;
          return info;
-      };
+      }
       bool stdoutEvent;
       result=proc->select(1,0,&stdoutEvent);
       if (stdoutEvent)
@@ -1115,10 +1169,14 @@
          //don't search the whole buffer, only the last 12 bytes
          if (m_stdoutSize>12)
          {
-            if (strstr(m_stdoutBuffer+m_stdoutSize-12,"\nsmb: \\>")!=0)
-            loopFinished=true;
-         };
-      };
+            if ((strstr(m_stdoutBuffer+m_stdoutSize-12,"\nsmb: \\>")!=0) && (m_usefulLineFound==true))
+//            if (strstr(m_stdoutBuffer+m_stdoutSize-12,"\nsmb: \\>")!=0)
+            {
+               loopFinished=true;
+               kdDebug()<<"offset: "<<int(strstr(m_stdoutBuffer+m_stdoutSize-12,"\nsmb: \\>")-m_stdoutBuffer)<<endl;
+            }
+         }
+      }
    } while (!loopFinished);
    kdDebug(KIO_SMB)<<"Smb::_stat(): read: -"<<m_stdoutBuffer<<"-"<<endl;
 
@@ -1127,7 +1185,7 @@
       kdDebug(KIO_SMB)<<"stopAfterError() returned true"<<endl;
       info.isValid=false;
       return info;
-   };
+   }
 
    QString outputString = QString::fromLocal8Bit(m_stdoutBuffer);
    QTextIStream output(&outputString);
@@ -1136,7 +1194,13 @@
    while (!output.atEnd())
    {
       line=output.readLine();
-      if (lineNumber==1)
+      kdDebug(KIO_SMB)<<"line -"<<line<<"-"<<endl;
+      int startOfData=line.find(QRegExp("    [SADR ][SADR ][SADR ] [ \\d][ \\d][ \\d][ \\d][ \\d][ \\d]\\d+  [A-Z][a-z][a-z] [A-Z][a-z][a-z] [ \\d]\\d"));
+      if (startOfData!=-1)
+      {
+         return createStatInfo(line);
+      }
+/*      if ((line.find("smb: \\>")==-1) && (line.find("dir \"")!=0))
       {
          if (line.contains("ERRbadfile") || (line.contains("File not found")))
          {
@@ -1147,12 +1211,13 @@
          else
          {
             return createStatInfo(line);
-         };
-      };
+         }
+      }*/
       lineNumber++;
-   };
+   }
+   info.isValid=false;
    return info;
-};
+}
 
 void SmbProtocol::stat( const KURL & url)
 {
@@ -1160,12 +1225,12 @@
 
    if (url.url()=="smb://")
    {
-      //kdDebug(KIO_SMB)<<"Smb::stat(): host.isEmpty()"<<endl;
+      kdDebug(KIO_SMB)<<"Smb::stat(): host.isEmpty()"<<endl;
       error(ERR_UNKNOWN_HOST,i18n("\nTo access the shares of a host, use smb://hostname\n\
 To get a list of all hosts use lan:/ or rlan:/ .\n\
 See the KDE Control Center under Network, LANBrowsing for more information."));
       return;
-   };
+   }
    StatInfo info=this->_stat(url);
    if (!info.isValid)
       return;
@@ -1183,7 +1248,7 @@
    {
       error(ERR_CANNOT_OPEN_FOR_WRITING,url.url());
       return;
-   };
+   }
    QString share;
    QString smbPath;
    getShareAndPath(url,share,smbPath);
@@ -1201,7 +1266,7 @@
       //perror("creating fifo failed: ");
       error(ERR_CANNOT_OPEN_FOR_WRITING,url.path()+i18n("\nCould not create required pipe %1.").arg(fifoName));
       return;
-   };
+   }
    QCString command=QCString("put ")+fifoName+QCString(" \"")+smbPath.local8Bit()+QCString("\"\n");
    kdDebug(KIO_SMB)<<"Smb::put(): executing command: -"<<command<<"-"<<endl;
 
@@ -1210,7 +1275,7 @@
       remove(fifoName);
       error(ERR_CONNECTION_BROKEN,m_currentHost);
       return;
-   };
+   }
    clearBuffer();
    bool loopFinished(false);
    //read the terminal echo
@@ -1222,7 +1287,7 @@
       {
          if (memchr(m_stdoutBuffer,'\n',m_stdoutSize)!=0)
             loopFinished=true;
-      };
+      }
    } while (!loopFinished);
 
    clearBuffer();
@@ -1240,8 +1305,8 @@
                 "Visit http://lisa-home.sourceforge.net/smbclientpatch.html "
                 "and follow the instructions there."));
          return;
-      };
-   };
+      }
+   }
 
    int fifoFD=open(fifoName,O_RDWR|O_NONBLOCK);
    if (fifoFD==-1)
@@ -1251,7 +1316,7 @@
       error(ERR_CANNOT_OPEN_FOR_WRITING,url.path()+i18n("\nCould not create required pipe %1.").arg(fifoName));
       remove(fifoName);
       return;
-   };
+   }
 
    //now we have it, now we can make it blocking again
    int flags=fcntl(fifoFD,F_GETFL,0);
@@ -1261,7 +1326,7 @@
       error(ERR_CANNOT_OPEN_FOR_WRITING,url.path()+i18n("\nCould not fcntl() pipe %1.").arg(fifoName));
       remove(fifoName);
       return;
-   };
+   }
    flags&=~O_NONBLOCK;
    if (fcntl(fifoFD,F_SETFL,flags)<0)
    {
@@ -1269,7 +1334,7 @@
       error(ERR_CANNOT_OPEN_FOR_WRITING,url.path()+i18n("\nCould not fcntl() pipe %1.").arg(fifoName));
       remove(fifoName);
       return;
-   };
+   }
 
    kdDebug(KIO_SMB)<<"Smb::put() opened fifo: -"<<command<<"-"<<endl;
 
@@ -1290,7 +1355,7 @@
          /*loopFinished=true;
          kdDebug(KIO_SMB)<<"Smb::get(): smbclient exited with status "<<exitStatus<<endl;
          break;*/
-      };
+      }
 
       dataReq();
       result=readData(array);
@@ -1317,8 +1382,8 @@
                kdDebug(KIO_SMB)<<"Smb::put() errno="<<errno<<endl;
                loopFinished=true;
                bytesLeft=0;
-            };
-         };
+            }
+         }
       }
       else loopFinished=true;
    } while(!loopFinished);
@@ -1336,7 +1401,7 @@
    if (stopAfterError(url,true))
       return;
    finished();
-};
+}
 
 
 void SmbProtocol::get( const KURL& url )
@@ -1355,7 +1420,7 @@
       kdDebug(KIO_SMB)<<"Smb::get() file not found"<<endl;
       error(ERR_CANNOT_OPEN_FOR_READING,url.url());
       return;
-   };
+   }
 
    totalSize( info.size);
 
@@ -1363,7 +1428,7 @@
    if (proc==0)
    {
       return;
-   };
+   }
 
    QCString fifoName;
    fifoName.sprintf("/tmp/kio_smb_%d_%d_%ld",getpid(),getuid(),time(0));
@@ -1374,7 +1439,7 @@
       //perror("creating fifo failed: ");
       error(ERR_CANNOT_OPEN_FOR_READING,url.path()+i18n("\nCould not create required pipe %1.").arg(fifoName));
       return;
-   };
+   }
 
    QCString command=QCString("get \"")+smbPath.local8Bit()+QCString("\" ")+fifoName+"\n";
    kdDebug(KIO_SMB)<<"Smb::get(): executing command: -"<<command<<"-"<<endl;
@@ -1383,7 +1448,7 @@
    {
       error(ERR_CONNECTION_BROKEN,m_currentHost);
       return;
-   };
+   }
 
    clearBuffer();
    bool loopFinished(false);
@@ -1407,7 +1472,7 @@
       remove(fifoName);
       return;
 
-   };
+   }
 
    //now we have it, now we can make it blocking again
    int flags=fcntl(fifoFD,F_GETFL,0);
@@ -1417,7 +1482,7 @@
       error(ERR_CANNOT_OPEN_FOR_READING,url.path()+i18n("\nCould not fcntl() pipe %1.").arg(fifoName));
       remove(fifoName);
       return;
-   };
+   }
    flags&=~O_NONBLOCK;
    if (fcntl(fifoFD,F_SETFL,flags)<0)
    {
@@ -1425,23 +1490,8 @@
       error(ERR_CANNOT_OPEN_FOR_READING,url.path()+i18n("\nCould not fcntl() pipe %1.").arg(fifoName));
       remove(fifoName);
       return;
-   };
-
-   //now read from the fifo
-   //this might evetually block :-(
-   //but actually I don't know why this should happen
-   //we entered "get some_file /tmp/the_fifo" into smbclient
-   //the fifo /tmp/the_fifo exists and the remote some_file exists too,
-   //we checked this with the _stat() call, so why should it not work ?
-/*   FILE * fifo=fopen(fifoName,"r");
-   if (fifo==0)
-   {
-      //hmm, how should we get here ?
-      error(ERR_CANNOT_OPEN_FOR_READING,url.path()+i18n("\nCould not create required pipe %1.").arg(fifoName));
-      return;
-   };
+   }
 
-   int fifoFD=fileno(fifo);*/
    char buf[32*1024];
 
    kdDebug(KIO_SMB)<<"Smb::get() opened fifo: -"<<command<<"-"<<endl;
@@ -1461,10 +1511,7 @@
          close(fifoFD);
          remove(fifoName);
          return;
-         /*loopFinished=true;
-         kdDebug(KIO_SMB)<<"Smb::get(): smbclient exited with status "<<exitStatus<<endl;
-         break;*/
-      };
+      }
 
       struct timeval tv;
       tv.tv_sec=1;
@@ -1472,8 +1519,11 @@
       fd_set readFDs;
       FD_ZERO(&readFDs);
       FD_SET(fifoFD,&readFDs);
-      result=select(fifoFD+1,&readFDs,0,0,&tv);
-      if (wasKilled())
+      FD_SET(proc->fd(), &readFDs);
+      result=select(proc->fd()>fifoFD?proc->fd()+1:fifoFD+1,&readFDs,0,0,&tv);
+      if (FD_ISSET(proc->fd(), &readFDs))
+         readOutput(proc->fd());
+      else if (wasKilled())
          loopFinished=true;
       else if (result==1)
       {
@@ -1482,12 +1532,12 @@
             loopFinished=true;
          else
          {
-            //kdDebug(KIO_SMB)<<"Smb::get(): read "<<i<<" bytes now, gives "<<bytesRead<<" overall"<<endl;
+            kdDebug(KIO_SMB)<<"Smb::get(): read "<<i<<" bytes now, gives "<<bytesRead<<" overall"<<endl;
             bytesRead+=i;
             array.setRawData(buf, i);
             data( array );
             array.resetRawData(buf,i);
-	    processedSize(bytesRead);
+            processedSize(bytesRead);
          }
       }
       else if (result<0)
@@ -1496,7 +1546,7 @@
 
    close(fifoFD);
 
-   clearBuffer();
+//   clearBuffer();
    bool stdoutEvent;
    result=proc->select(1,0,&stdoutEvent);
    if (stdoutEvent)
@@ -1559,7 +1609,7 @@
             line=line.left(line.find("__MSBROWSE__")-1);
             line=line.stripWhiteSpace();
             masterBrowser="";
-            for (int i=0; i<line.length(); i++)
+            for (uint i=0; i<line.length(); i++)
                if ((line[i].isDigit()) || (line[i]=='.'))
                   masterBrowser+=line[i].latin1();
             break;
@@ -1597,7 +1647,7 @@
       kdDebug(KIO_SMB)<<"Smb::searchWorkgroup() could not start smbclient"<<endl;
       delete proc;
       return false;
-   };
+   }
    QString password(m_password);
    QString user(m_user);
 
@@ -1634,16 +1684,16 @@
             error( KIO::ERR_CANNOT_LAUNCH_PROCESS, "smbclient"+i18n("\nMake sure that the samba package is installed properly on your system."));
             delete proc;
             return false;
-         };
+         }
       }
       else break;
-   };
+   }
    //here smbclient has already exited
    if (proc!=0)
    {
       delete proc;
       proc=0;
-   };
+   }
 
    KURL url("smb:/");
    //no error handling has happened up to now
@@ -1657,7 +1707,7 @@
    {
       error(ERR_USER_CANCELED,"");
       return false;
-   };
+   }
 
    if (stopAfterError(url,true))
       return false;
@@ -1684,7 +1734,7 @@
             mode=1;
             wgPos=line.find("Workgroup");
             masterPos=line.find("Master");
-         };
+         }
       }
       else if (mode==1)
       {
@@ -1695,7 +1745,7 @@
          else
          {
             return false;
-         };
+         }
       }
       else if (mode==2)
       {
@@ -1716,11 +1766,11 @@
                end--;
             master=master.left(end+1);
             m_workgroups[name.upper()]=master.upper();
-         };
-      };
-   };
+         }
+      }
+   }
    return true;
-};
+}
 
 void SmbProtocol::listWorkgroups()
 {
@@ -1769,7 +1819,7 @@
    listEntry( entry, true ); // ready
 
    finished();
-};
+}
 
 
 void SmbProtocol::listHosts()
@@ -1791,7 +1841,7 @@
       kdDebug(KIO_SMB)<<"Smb::listHosts() could not start smbclient"<<endl;
       delete proc;
       return;
-   };
+   }
    QString password(m_password);
    QString user(m_user);
 
@@ -1824,16 +1874,16 @@
             error( KIO::ERR_CANNOT_LAUNCH_PROCESS, "smbclient"+i18n("\nMake sure that the samba package is installed properly on your system."));
             delete proc;
             return;
-         };
+         }
       }
       else break;
-   };
+   }
    //here smbclient has already exited
    if (proc!=0)
    {
       delete proc;
       proc=0;
-   };
+   }
 
    KURL url("smb:/");
    //no error handling has happened up to now
@@ -1847,7 +1897,7 @@
    {
       error(ERR_USER_CANCELED,"");
       return;
-   };
+   }
 
    if (stopAfterError(url,true))
       return;
@@ -1877,7 +1927,7 @@
             mode=1;
             serverPos=line.find("Server");
             commentPos=line.find("Comment");
-         };
+         }
       }
       else if (mode==1)
       {
@@ -1888,7 +1938,7 @@
          else
          {
             return;
-         };
+         }
       }
       else if (mode==2)
       {
@@ -1928,14 +1978,14 @@
 
             listEntry( entry, false);
             totalNumber++;
-         };
-      };
-   };
+         }
+      }
+   }
    totalSize( totalNumber);
    listEntry( entry, true ); // ready
 
    finished();
-};
+}
 
 QCString SmbProtocol::getNmbName(QCString ipString)
 {
@@ -1964,12 +2014,12 @@
          if (exitStatus!=-1)
          {
             kdDebug(KIO_SMB)<<"Smb::getNmbName() nmblookup exited with exitcode "<<exitStatus<<endl;
-         };
+         }
          if (stdoutEvent)
          {
             readOutput(proc->fd());
          }
-      };
+      }
       //now parse the output
       QString outputString = QString::fromLocal8Bit(m_stdoutBuffer);
       QTextIStream output(&outputString);
@@ -1986,13 +2036,13 @@
             line=line.stripWhiteSpace();
             nmbName=line.local8Bit();
             break;
-         };
-      };
+         }
+      }
       clearBuffer();
-   };
+   }
    delete proc;
    return nmbName;
-};
+}
 
 void SmbProtocol::setHost(const QString& host, int /*port*/, const QString& /*user*/, const QString& /*pass*/)
 {
@@ -2025,7 +2075,7 @@
       QCString tmp=getNmbName(ipString);
       if (!tmp.isEmpty())
          nmbName=tmp;
-   };
+   }
    kdDebug(KIO_SMB)<<"Smb::setHost() nmbName is -"<<nmbName<<"-"<<endl;
 
    if (host==m_currentHost) return;
@@ -2075,7 +2125,7 @@
    {
       error( KIO::ERR_CANNOT_LAUNCH_PROCESS, "smbclient"+i18n("\nMake sure that the samba package is installed properly on your system."));
       return 0;
-   };
+   }
    QString password(m_password);
    QString user(m_user);
 
@@ -2118,8 +2168,8 @@
          //we don't want to care in the calling code
          error(ERR_USER_CANCELED,"");
          return 0;
-      };
-   };
+      }
+   }
    if (result==SMB_ERROR)
    {
       KURL url("smb://"+host+"/"+share);
@@ -2133,7 +2183,7 @@
    if (!ai.username.isEmpty()) //we used the AuthInfo
       cacheAuthentication(ai);
    return proc;
-};
+}
 
 
 void SmbProtocol::special( const QByteArray & data)
@@ -2174,24 +2224,24 @@
             opts+="username=";
             opts+=user.local8Bit();
             kdDebug(KIO_SMB)<<"Smb::special() user -"<<user.local8Bit()<<"-"<<endl;
-         };
+         }
          if (!password.isEmpty())
          {
             opts+=",password=";
             opts+=password.local8Bit();
-         };
+         }
          if (opts!="-o")
          {
             args<<opts;
             kdDebug(KIO_SMB)<<"Smb::special() adding opts"<<endl;
-         };
+         }
          kdDebug(KIO_SMB)<<"Smb::special() opts-"<<opts<<"-"<<endl;
          if (!proc->start("smbmount",args))
          {
             error( KIO::ERR_CANNOT_LAUNCH_PROCESS, "smbmount"+i18n("\nMake sure that the samba package is installed properly on your system."));
             delete proc;
             return;
-         };
+         }
 
          bool firstLoop=true;
          AuthInfo ai;
@@ -2226,36 +2276,36 @@
                   opts+="username=";
                   opts+=user.local8Bit();
                   kdDebug(KIO_SMB)<<"Smb::special() user -"<<user.local8Bit()<<"-"<<endl;
-               };
+               }
                if (!password.isEmpty())
                {
                   opts+=",password=";
                   opts+=password.local8Bit();
-               };
+               }
                if (opts!="-o")
                {
                   tmpArgs<<opts;
                   kdDebug(KIO_SMB)<<"Smb::special() adding opts"<<endl;
-               };
+               }
                if (!proc->start("smbmount",tmpArgs))
                {
                   error( KIO::ERR_CANNOT_LAUNCH_PROCESS, "smbmount"+i18n("\nMake sure that the samba package is installed properly on your system."));
                   delete proc;
                   return;
-               };
+               }
             }
             else
             {
                //we don't want to care in the calling code
                error(ERR_USER_CANCELED,"");
                return;
-            };
-         };
+            }
+         }
          if (result==SMB_ERROR)
          {
             error( KIO::ERR_CANNOT_LAUNCH_PROCESS, "wrlg sudgajl jtlw4jrt");
             return;
-         };
+         }
          delete proc;
          //if we get here, we had success
          if (!ai.username.isEmpty())
@@ -2274,7 +2324,7 @@
          {
             error( KIO::ERR_CANNOT_LAUNCH_PROCESS, "smbumount"+i18n("\nMake sure that the samba package is installed properly on your system."));
             return;
-         };
+         }
          clearBuffer();
          while (1)  //until smbumount exits
          {
@@ -2292,7 +2342,7 @@
                   QString p=dir.path();
                   dir.cdUp();
                   dir.rmdir(p);
-               };
+               }
                if (exitStatus!=0)
                {
                   if (m_stdoutSize>0)
@@ -2302,15 +2352,15 @@
                else
                   finished();
                return;
-            };
+            }
             if (stdoutEvent)
                readOutput(proc.fd());
-         };
+         }
       }
       break;
    default:
       break;
    }
    finished();
-};
+}
 
--- kioslave/smbro/kio_smb.h	10 Jul 2002 03:23:24 -0000	1.1.1.2
+++ kioslave/smbro/kio_smb.h	29 Mar 2003 02:34:41 -0000	1.2
@@ -112,6 +112,7 @@
 
       QString m_defaultWorkgroup;
       QString m_currentWorkgroup;
+      bool m_usefulLineFound;
 };
 
 #endif
--- kioslave/smtp/smtp.cc	13 Mar 2003 03:01:55 -0000	1.1.1.6
+++ kioslave/smtp/smtp.cc	29 Mar 2003 02:34:43 -0000	1.2
@@ -432,30 +432,28 @@
     len = DEFAULT_RESPONSE_BUFFER;
   }
 
-  while (recv_len < 1 && waitForResponse(60))
+  while (recv_len < 1)
   {
-    // grab the data
-    recv_len = readLine(buf, len - 1);
-  }
-
-  if (recv_len < 1) 
-  {
-    if (isConnectionValid())
+    if (!waitForResponse(60))
     {
       if (handleErrors)
       {
           error(KIO::ERR_SERVER_TIMEOUT, m_sServer + QString("<<") + buf + QString(">>"));
           m_errorSent = true;
       }
+      free(buf);
+      return 999;
     }
-    else
+
+    // grab the data
+    recv_len = readLine(buf, len - 1);
+    if ((recv_len < 1) && !isConnectionValid())
     {
       error(KIO::ERR_CONNECTION_BROKEN, m_sServer);
       m_errorSent = true;
+      free(buf);
+      return 999;
     }
-
-    free(buf);
-    return 999;
   }
 
   if (recv_len < 4) {
--- kioslave/thumbnail/gscreator.cpp	1 Oct 2002 02:36:19 -0000	1.1.1.2
+++ kioslave/thumbnail/gscreator.cpp	9 Apr 2003 23:17:44 -0000	1.2
@@ -59,6 +59,8 @@
     "gs",
     "-sDEVICE=png16m",
     "-sOutputFile=-",
+    "-dSAFER",
+    "-dPARANOIDSAFER",
     "-dNOPAUSE",
     "-dFirstPage=1",
     "-dLastPage=1",
--- klipper/Makefile.am	14 Jan 2003 20:11:15 -0000	1.1.1.5
+++ klipper/Makefile.am	14 Jan 2003 20:44:15 -0000	1.9
@@ -1,23 +1,30 @@
 INCLUDES= $(all_includes)
 
 bin_PROGRAMS = klipper
-lib_LTLIBRARIES = klipper.la
+lib_LTLIBRARIES = klipper.la libklipper_main.la
 kde_module_LTLIBRARIES = klipper_panelapplet.la
 
-CLEANFILES = dummy.cpp
+CLEANFILES = dummy.cpp klipper_main.cpp
 
-klipper_la_LIBADD = $(LIB_KDEUI) $(LIB_KSYCOCA) 
-klipper_la_SOURCES = main.cpp toplevel.cpp urlgrabber.cpp configdialog.cpp \
+libklipper_main_la_LIBADD = $(LIB_KDEUI) $(LIB_KSYCOCA) $(LIB_QT) -lkdecore -lDCOP
+libklipper_main_la_SOURCES = toplevel.cpp urlgrabber.cpp configdialog.cpp \
     toplevel.skel
 
-klipper_la_METASOURCES = AUTO
-klipper_la_LDFLAGS = $(all_libraries) -module -avoid-version
+libklipper_main_la_METASOURCES = AUTO
+libklipper_main_la_LDFLAGS = $(all_libraries) -avoid-version
 
-klipper_LDADD = klipper.la $(LIB_KSYCOCA)
-klipper_SOURCES = dummy.cpp
+klipper_la_LIBADD = libklipper_main.la
+klipper_la_SOURCES = main.cpp
+klipper_la_LDFLAGS = $(all_libraries) -avoid-version -module
+
+klipper_main.cpp: main.cpp
+	cat main.cpp > klipper_main.cpp
+
+klipper_LDADD = libklipper_main.la
+klipper_SOURCES = klipper_main.cpp
 klipper_LDFLAGS = $(all_libraries) $(KDE_RPATH)
 
-klipper_panelapplet_la_LIBADD = klipper.la
+klipper_panelapplet_la_LIBADD = libklipper_main.la
 klipper_panelapplet_la_SOURCES = applet.cpp applet.skel
 klipper_panelapplet_la_LDFLAGS = $(all_libraries) -module -avoid-version
 
--- kmenuedit/Makefile.am	14 Aug 2002 14:27:55 -0000	1.1.1.3
+++ kmenuedit/Makefile.am	26 Nov 2002 21:00:52 -0000	1.7
@@ -1,18 +1,24 @@
 INCLUDES = $(all_includes)
 
 bin_PROGRAMS = kmenuedit
-lib_LTLIBRARIES = kmenuedit.la
+lib_LTLIBRARIES = kmenuedit.la libkmenuedit_main.la
 
 CLEANFILES = dummy.cpp
 
-kmenuedit_la_SOURCES = basictab.cpp treeview.cpp desktopfileeditor.cpp menueditview.cpp kmenuedit.cpp main.cpp khotkeys.cpp
+libkmenuedit_main_la_SOURCES = basictab.cpp treeview.cpp desktopfileeditor.cpp menueditview.cpp kmenuedit.cpp khotkeys.cpp
+libkmenuedit_main_la_LIBADD = $(LIB_KDEUI) $(LIB_KIO) $(LIB_QT) -lkdecore -lDCOP
+libkmenuedit_main_la_LDFLAGS = $(all_libraries) -avoid-version
 
-kmenuedit_la_LIBADD = $(LIB_KDEUI) $(LIB_KIO)
-kmenuedit_la_LDFLAGS = $(all_libraries) -module -avoid-version
+kmenuedit_la_SOURCES = main.cpp
+kmenuedit_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -avoid-version -module
+kmenuedit_la_LIBADD  = libkmenuedit_main.la
 
-kmenuedit_SOURCES = dummy.cpp
-kmenuedit_LDADD   = kmenuedit.la
+kmenuedit_SOURCES = kmenuedit_main.cpp
 kmenuedit_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+kmenuedit_LDADD   = libkmenuedit_main.la
+
+kmenuedit_main.cpp: main.cpp
+	cat main.cpp > kmenuedit_main.cpp
 
 noinst_HEADERS = kmenuedit.h menueditview.h treeview.h desktopfileeditor.h basictab.h khotkeys.h
 
--- kmenuedit/treeview.cpp	3 Mar 2003 01:40:56 -0000	1.1.1.5
+++ kmenuedit/treeview.cpp	29 Mar 2003 02:34:45 -0000	1.2
@@ -89,7 +89,7 @@
     QString s = _name;
     if (_hidden)
        s += i18n(" [Hidden]");
-    setText(0, s);           
+    setText(0, s);
 }
 
 void TreeItem::setOpen(bool o)
@@ -107,7 +107,7 @@
 {
     QPixmap normal = KGlobal::iconLoader()->loadIcon(iconName, KIcon::Small, 0, KIcon::DefaultState, 0L, true);
     // make sure they are not larger than 20x20
-    if (normal.width() > 20 || normal.height() > 20) 
+    if (normal.width() > 20 || normal.height() > 20)
     {
        QImage tmp = normal.convertToImage();
        tmp = tmp.smoothScale(20, 20);
@@ -162,7 +162,7 @@
     // setup rmb menu
     _rmb = new QPopupMenu(this);
     KAction *action;
-    
+
     action = _ac->action("edit_cut");
     if(action) {
         action->plug(_rmb);
@@ -185,7 +185,7 @@
     }
 
     _rmb->insertSeparator();
-    
+
     action = _ac->action("delete");
     if(action) {
         action->plug(_rmb);
@@ -230,7 +230,7 @@
        {
           QString file = df->fileName();
           QString res = df->resource();
-          
+
           bool isLocal = true;
           QStringList files = KGlobal::dirs()->findAllResources(res.latin1(), file);
           for(QStringList::ConstIterator it = files.begin();
@@ -242,7 +242,7 @@
                 isLocal = false;
                 continue;
              }
-             
+
              KDesktopFile df2(*it);
              name = df2.readName();
 
@@ -283,9 +283,9 @@
                 continue;
 
             TreeItem* item;
-            if (parent == 0) 
+            if (parent == 0)
                 item = new TreeItem(this, *it);
-            else 
+            else
                 item = new TreeItem(parent, *it);
 
             item->setName(name);
@@ -304,7 +304,7 @@
 
 	    QString dirFile = *it + "/.directory";
 	    TreeItem* item;
-	    
+
 	    bool hidden = false;
 	    QString name;
 	    QString icon;
@@ -321,7 +321,7 @@
             icon = df.readIcon();
             if (icon.isEmpty())
                 icon = "package";
-            
+
             if (parent == 0)
                 item = new TreeItem(this,  *it);
             else
@@ -350,7 +350,7 @@
 #if 0
         // Check if the file is Writeable for us
         QFileInfo finfo((KGlobal::dirs()->findResourceDir("apps", _item->file())) + _item->file());
-       
+
         if (finfo.isWritable() && (_item->name() != i18n("Settings")))
             _ac->action("delete")->setEnabled(true);
         else
@@ -494,7 +494,7 @@
     // search the selected item in all resource dirs
     QStringList resdirs = KGlobal::dirs()->resourceDirs("apps");
     QString localFile = resdirs.first()+deskfile;
-    
+
     for (QStringList::ConstIterator it = resdirs.begin(); it != resdirs.end(); ++it) {
         QFile f((*it) + deskfile);
 
@@ -506,7 +506,7 @@
            else
               hasGlobal = true;
         }
-        
+
         isLocal = false;
     }
 
@@ -532,7 +532,7 @@
         }
         c.sync();
     }
-    
+
     return true;
 }
 
@@ -578,7 +578,7 @@
             allremoved = false;
     }
 #endif
-    
+
     if(move) {
         KSimpleConfig c(locateLocal("apps", directory + "/.directory"));
         c.setDesktopGroup();
@@ -746,7 +746,8 @@
     if(item == 0) return 0;
 
     QTextDrag *d = new QTextDrag(item->file(), (QWidget*)this);
-    d->setPixmap(*item->pixmap(0));
+    if ( item->pixmap(0) )
+        d->setPixmap(*item->pixmap(0));
     return d;
 }
 
@@ -815,7 +816,7 @@
 	dir += '/';
 
     dir += dirname + "/.directory";
-    
+
     QFile f(locateLocal("apps", dir));
     if (f.exists()) {
     	KMessageBox::sorry(0, i18n("A file exists with that name. Please provide another name."), i18n("File Exists"));
@@ -1000,9 +1001,11 @@
 
     while (f.exists()) {
         pos = newname.findRev(".desktop");
-        newname.insert(pos, " (Copy)");
-
-        f.setName(locate("apps", dest + '/' + newname));
+        if ( pos!=-1)// .directory
+            newname.insert(pos, " (Copy)");
+        else
+            newname.insert(newname.length(), " (Copy)");
+        f.setName(locate("apps", dest + '/' + newname));			
     }
 
     kdDebug() << "### clip: " << _clipboard.local8Bit() << " dest: " << dest.local8Bit() << " ###" << endl;
@@ -1100,7 +1103,7 @@
     df.deleteEntry("Hidden");
     df.deleteEntry("NoDisplay");
     df.sync();
-    
+
     item->setHidden(false);
 
     _ac->action("edit_cut")->setEnabled(false);
--- konqueror/Makefile.am	17 Jan 2003 15:03:12 -0000	1.1.1.5
+++ konqueror/Makefile.am	17 Jan 2003 15:46:03 -0000	1.4
@@ -5,7 +5,7 @@
 #SUBDIRS = . kfmexec client iconview dirtree listview keditbookmarks shellcmdplugin about pics sidebar
 SUBDIRS = . kfmexec client iconview listview keditbookmarks shellcmdplugin about pics sidebar
 
-lib_LTLIBRARIES = konqueror.la
+lib_LTLIBRARIES = konqueror.la libkonqueror_main.la
 
 konqdatadir = $(kde_datadir)/konqueror
 konqdata_DATA = konqueror.rc
@@ -22,8 +22,7 @@
 
 bin_PROGRAMS = konqueror
 
-konqueror_la_SOURCES = konq_main.cc \
-	    KonquerorIface.cc KonquerorIface.skel \
+libkonqueror_main_la_SOURCES = KonquerorIface.cc KonquerorIface.skel \
 	    KonqMainWindowIface.cc KonqMainWindowIface.skel \
 	    KonqViewIface.cc KonqViewIface.skel \
 	    konq_mainwindow.cc konq_guiclients.cc \
@@ -43,11 +42,18 @@
 	konq_misc.h konq_openurlrequest.h konq_profiledlg.h konq_run.h \
 	konq_view.h konq_viewmgr.h version.h
 
-konqueror_la_LDFLAGS = $(all_libraries) -module -avoid-version
-konqueror_la_LIBADD = ../libkonq/libkonq.la
+libkonqueror_main_la_LDFLAGS = $(all_libraries) -avoid-version
+libkonqueror_main_la_LIBADD = ../libkonq/libkonq.la
 
-konqueror_SOURCES = dummy.cc
-konqueror_LDADD = konqueror.la
+konqueror_la_SOURCES = konq_la_main.cc
+konqueror_la_LDFLAGS = $(all_libraries) -avoid-version $(KDE_RPATH) -module
+konqueror_la_LIBADD  = libkonqueror_main.la
+
+konq_la_main.cc: konq_main.cc
+	cat konq_main.cc > konq_la_main.cc
+
+konqueror_SOURCES = konq_main.cc
+konqueror_LDADD = libkonqueror_main.la
 konqueror_LDFLAGS = $(KDE_RPATH) $(all_libraries)
 
 # Hmm, this experiment of a static konq failed, don't trust it...
@@ -61,9 +67,6 @@
 #konqueror_static_SOURCES = dummy.cc
 #konqueror_static_LDADD = konqueror.la *view/*.la dirtree/*.la $(libdir)/libkhtml.la
 #konqueror_static_LDFLAGS = $(all_libraries) -static
-
-dummy.cc:
-	echo > dummy.cc
 
 messages: rc.cpp
 	$(EXTRACTRC) *.rc */*.rc >> rc.cpp
--- konqueror/konq_guiclients.cc	3 Mar 2003 01:40:57 -0000	1.1.1.5
+++ konqueror/konq_guiclients.cc	29 Mar 2003 02:34:48 -0000	1.2
@@ -251,6 +251,9 @@
     else
       newSplitterSizes << 30 << 100;
 
+    if (!childView || !childView->frame())
+        return;
+
     KonqFrameContainerBase *newContainer = childView->frame()->parentContainer();
 
     if (newContainer->frameType()=="Container")
--- konqueror/konq_mainwindow.cc	3 Mar 2003 01:40:58 -0000	1.1.1.13
+++ konqueror/konq_mainwindow.cc	29 Mar 2003 02:34:49 -0000	1.2
@@ -114,7 +114,7 @@
   m_pWorkingTab = 0L;
   m_initialKonqRun = 0L;
   m_pBookmarkMenu = 0L;
-  m_dcopObject = 0L;
+  m_dcopObject = new KonqMainWindowIface( this );
   m_combo = 0L;
   m_bURLEnterLock = false;
   m_bLocationBarConnected = false;
@@ -2114,7 +2114,9 @@
 
 void KonqMainWindow::slotBreakOffTabPopup()
 {
-  m_pViewManager->breakOffTab( m_pWorkingTab );
+  //Can't do this safely here as the tabbar may disappear and we're
+  //handing off here.
+  QTimer::singleShot(0, this, SLOT( slotBreakOffTab() ) );
 }
 
 void KonqMainWindow::slotPopupNewTabAtFront()
@@ -2154,16 +2156,26 @@
 
 void KonqMainWindow::slotRemoveTabPopup()
 {
-  m_pViewManager->removeTab( m_pWorkingTab );
+  //Can't do this safely here, since if this is the last
+  //tab, the tabbar may disappear, and the popup from
+  //which we're invoked is created in response to a tabbar
+  //event
+  QTimer::singleShot( 0, this, SLOT( slotRemoveTab() ) );
 }
 
 
-void KonqMainWindow::slotRemoveOtherTabsPopup()
+void KonqMainWindow::slotRemoveOtherTabs()
 {
       m_pViewManager->removeOtherTabs( m_pWorkingTab );
       updateViewActions();
 }
 
+void KonqMainWindow::slotRemoveOtherTabsPopup()
+{
+  //As above, delayed for safety
+  QTimer::singleShot( 0, this, SLOT( slotRemoveOtherTabs() ) );
+}
+
 
 void KonqMainWindow::slotActivateNextTab()
 {
@@ -3965,8 +3977,6 @@
 
 KonqMainWindowIface* KonqMainWindow::dcopObject()
 {
-  if ( !m_dcopObject )
-      m_dcopObject = new KonqMainWindowIface( this );
   return m_dcopObject;
 }
 
--- konqueror/konq_mainwindow.h	12 Nov 2002 04:19:31 -0000	1.1.1.6
+++ konqueror/konq_mainwindow.h	29 Mar 2003 02:34:50 -0000	1.2
@@ -381,6 +381,7 @@
   void slotPopupNewTabAtFront();
   void slotPopupPasteTo();
   void slotRemoveView();
+  void slotRemoveOtherTabs();
   void slotRemoveOtherTabsPopup();
   void slotRemoveTab();
   void slotRemoveTabPopup();
--- konqueror/konq_viewmgr.cc	10 Dec 2002 16:43:53 -0000	1.1.1.7
+++ konqueror/konq_viewmgr.cc	29 Mar 2003 02:34:50 -0000	1.2
@@ -194,6 +194,10 @@
 {
   kdDebug(1202) << "KonqViewManager::splitWindow(default)" << endl;
 
+  // Don't crash when doing things too quickly.
+  if (!m_pMainWindow || !m_pMainWindow->currentView())
+    return 0L;
+
   KURL url = m_pMainWindow->currentView()->url();
   QString locationBarURL = m_pMainWindow->currentView()->locationBarURL();
 
@@ -627,6 +631,9 @@
   m_pMainWindow->dumpViewList();
   printFullHierarchy( m_pMainWindow );
 #endif
+
+  if (!view)
+    return;
 
   KonqFrame* frame = view->frame();
   KonqFrameContainerBase* parentContainer = frame->parentContainer();
--- konqueror/client/Makefile.am	14 Aug 2002 14:30:59 -0000	1.1.1.2
+++ konqueror/client/Makefile.am	26 Nov 2002 21:00:53 -0000	1.7
@@ -1,12 +1,12 @@
 AM_CPPFLAGS = -DQT_NO_CAST_ASCII
 
 bin_PROGRAMS = kfmclient
-lib_LTLIBRARIES = kfmclient.la
+lib_LTLIBRARIES = kfmclient.la libkfmclient_main.la
 
 INCLUDES= -I.. $(all_includes)
-kfmclient_la_LDFLAGS = $(all_libraries) -module -avoid-version
-kfmclient_la_LIBADD =  $(LIB_KIO)
-kfmclient_la_SOURCES = kfmclient.cc KonquerorIface.stub KDesktopIface.stub
+libkfmclient_main_la_LDFLAGS = $(all_libraries) -avoid-version
+libkfmclient_main_la_LIBADD =  $(LIB_KIO) $(LIB_QT) -lkdecore -lDCOP -lkdeui
+libkfmclient_main_la_SOURCES = kfmclient.cc KonquerorIface.stub KDesktopIface.stub
 
 noinst_HEADERS = kfmclient.h
 METASOURCES = AUTO
@@ -14,12 +14,19 @@
 KonquerorIface_DIR =  $(srcdir)/..
 KDesktopIface_DIR = $(top_srcdir)/kdesktop
 
-kfmclient_SOURCES = dummy.cc
+kfmclient_la_LDFLAGS = $(all_libraries) -avoid-version -module $(KDE_RPATH)
+kfmclient_la_LIBADD  = libkfmclient_main.la
+kfmclient_la_SOURCES = kfmclient_la_main.cpp
+
+kfmclient_la_main.cpp: stub_main.cpp
+	cat stub_main.cpp > kfmclient_la_main.cpp
+
+kfmclient_SOURCES = kfmclient_main.cpp
 kfmclient_LDFLAGS = $(KDE_RPATH) $(all_libraries)
-kfmclient_LDADD = kfmclient.la
+kfmclient_LDADD   = libkfmclient_main.la
 
-dummy.cc:
-	echo > dummy.cc
+kfmclient_main.cpp: stub_main.cpp
+	cat stub_main.cpp > kfmclient_main.cpp
 
 messages:
 	$(XGETTEXT) -kaliasLocal *.h *.cc -o $(podir)/kfmclient.pot
--- konqueror/client/kfmclient.cc	3 Mar 2003 01:41:08 -0000	1.1.1.6
+++ konqueror/client/kfmclient.cc	29 Mar 2003 02:34:55 -0000	1.5
@@ -64,7 +64,9 @@
    {0,0,0}
 };
 
-int main( int argc, char **argv )
+extern "C" int kdemain(int, char**);
+
+int kdemain( int argc, char **argv )
 {
   KCmdLineArgs::init(argc, argv, appName, description, version, false);
 
@@ -306,7 +308,11 @@
   if ( command == "openURL" )
   {
     KInstance inst(appName);
-    KApplication::dcopClient()->attach();
+    if( !KApplication::dcopClient()->attach())
+    {
+	KApplication::startKdeinit();
+	KApplication::dcopClient()->attach();
+    }
     checkArgumentCount(argc, 1, 3);
     if ( argc == 1 )
     {
@@ -326,7 +332,11 @@
   else if ( command == "openProfile" )
   {
     KInstance inst(appName);
-    KApplication::dcopClient()->attach();
+    if( !KApplication::dcopClient()->attach())
+    {
+	KApplication::startKdeinit();
+	KApplication::dcopClient()->attach();
+    }
     checkArgumentCount(argc, 2, 3);
     QString url;
     if ( argc == 3 )
RCS file: konqueror/client/stub_main.cpp
diff -N konqueror/client/stub_main.cpp
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ konqueror/client/stub_main.cpp	26 Nov 2002 21:00:53 -0000	1.1
@@ -0,0 +1,28 @@
+/*
+ *
+ * Copyright (c) 2001 Nick Hudson <skrll@netbsd.org>
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining a copy
+ * of this software and associated documentation files (the "Software"), to deal
+ * in the Software without restriction, including without limitation the rights
+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
+ * copies of the Software, and to permit persons to whom the Software is
+ * furnished to do so, subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice shall be included in
+ * all copies or substantial portions of the Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
+ * AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN
+ * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+extern "C" int kdemain(int, char* []);
+
+int main( int argc, char* argv[] )
+{
+        return kdemain(argc, argv);
+}
+
--- konqueror/keditbookmarks/Makefile.am	29 Oct 2002 03:05:50 -0000	1.1.1.3
+++ konqueror/keditbookmarks/Makefile.am	26 Nov 2002 21:00:53 -0000	1.5
@@ -2,22 +2,29 @@
 
 METASOURCES = AUTO
 
-lib_LTLIBRARIES = keditbookmarks.la
+lib_LTLIBRARIES = keditbookmarks.la libkeditbookmarks_main.la
 
-keditbookmarks_la_SOURCES = main.cpp items.cpp toplevel.cpp favicons.cpp toplevel.skel commands.cpp
+libkeditbookmarks_main_la_SOURCES = main.cpp items.cpp toplevel.cpp favicons.cpp toplevel.skel commands.cpp
 kbookmarklistener_DIR = $(top_srcdir)/libkonq
 
-keditbookmarks_la_LIBADD  = $(top_builddir)/libkonq/libkonq.la $(LIB_KHTML)
-keditbookmarks_la_LDFLAGS = $(all_libraries) -module -avoid-version
+libkeditbookmarks_main_la_LIBADD  = $(top_builddir)/libkonq/libkonq.la $(LIB_KHTML)
+libkeditbookmarks_main_la_LDFLAGS = $(all_libraries) -avoid-version
+
+keditbookmarks_la_SOURCES = keditbookmarks_la_main.cpp
+keditbookmarks_la_LIBADD  = libkeditbookmarks_main.la
+keditbookmarks_la_LDFLAGS = $(all_libraries) -avoid-version -module
+
+keditbookmarks_la_main.cpp: stub_main.cpp
+	cat stub_main.cpp > keditbookmarks_la_main.cpp
 
 bin_PROGRAMS = keditbookmarks
 
-keditbookmarks_SOURCES = dummy.cpp
-keditbookmarks_LDADD = keditbookmarks.la
+keditbookmarks_SOURCES = keditbookmarks_main.cpp
+keditbookmarks_LDADD = libkeditbookmarks_main.la
 keditbookmarks_LDFLAGS = $(all_libraries)
 
-dummy.cpp:
-	echo > dummy.cpp
+keditbookmarks_main.cpp: stub_main.cpp
+	cat stub_main.cpp > keditbookmarks_main.cpp
 
 rcdir = $(kde_datadir)/keditbookmarks
 rc_DATA = keditbookmarksui.rc  
--- konqueror/keditbookmarks/main.cpp	5 Nov 2002 00:18:22 -0000	1.1.1.4
+++ konqueror/keditbookmarks/main.cpp	26 Nov 2002 21:00:53 -0000	1.2
@@ -110,7 +110,9 @@
   }
 }
 
-int main(int argc, char ** argv)
+extern "C" int kdemain(int, char**);
+
+int kdemain(int argc, char ** argv)
 {
   KLocale::setMainCatalogue("konqueror");
   KAboutData aboutData("keditbookmarks", I18N_NOOP("KEditBookmarks"), "1.1",
RCS file: konqueror/keditbookmarks/stub_main.cpp
diff -N konqueror/keditbookmarks/stub_main.cpp
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ konqueror/keditbookmarks/stub_main.cpp	26 Nov 2002 21:00:53 -0000	1.1
@@ -0,0 +1,28 @@
+/*
+ *
+ * Copyright (c) 2001 Nick Hudson <skrll@netbsd.org>
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining a copy
+ * of this software and associated documentation files (the "Software"), to deal
+ * in the Software without restriction, including without limitation the rights
+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
+ * copies of the Software, and to permit persons to whom the Software is
+ * furnished to do so, subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice shall be included in
+ * all copies or substantial portions of the Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
+ * AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN
+ * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+extern "C" int kdemain(int, char* []);
+
+int main( int argc, char* argv[] )
+{
+        return kdemain(argc, argv);
+}
+
--- konqueror/shellcmdplugin/Makefile.am	25 Jun 2002 02:03:53 -0000	1.1.1.1
+++ konqueror/shellcmdplugin/Makefile.am	26 Feb 2003 23:29:06 -0000	1.2
@@ -5,7 +5,7 @@
 konq_shellcmdplugin_la_SOURCES = kshellcmdexecutor.cpp kshellcmddialog.cpp \
 	kshellcmdplugin.cpp
 konq_shellcmdplugin_la_LIBADD = $(top_builddir)/libkonq/libkonq.la
-konq_shellcmdplugin_la_LDFLAGS = -module $(KDE_PLUGIN)
+konq_shellcmdplugin_la_LDFLAGS = $(all_libraries) -module $(KDE_PLUGIN)
 
 iconviewdir = $(kde_datadir)/konqiconview/kpartplugins
 iconview_DATA = kshellcmdplugin.rc
--- konqueror/sidebar/Makefile.am	14 Aug 2002 14:30:57 -0000	1.1.1.3
+++ konqueror/sidebar/Makefile.am	27 Nov 2002 16:09:11 -0000	1.2
@@ -25,7 +25,7 @@
 konq_sidebar_la_LIBADD  = $(LIB_KPARTS) $(LIB_KIO) ../../libkonq/libkonq.la ./libkonqsidebarplugin.la ../../kate/lib/libkmultitabbar.la
 
 libkonqsidebarplugin_la_SOURCES=konqsidebarplugin.cpp
-libkonqsidebarplugin_la_LDFLAGS = $(all_libraries) -no-undefined
+libkonqsidebarplugin_la_LDFLAGS = $(all_libraries) -no-undefined -avoid-version
 libkonqsidebarplugin_la_LIBADD = $(LIB_KPARTS)
 
 # this is where the desktop file will go 
--- konqueror/sidebar/trees/Makefile.am	10 Jul 2002 03:24:11 -0000	1.1.1.2
+++ konqueror/sidebar/trees/Makefile.am	26 Nov 2002 21:00:53 -0000	1.3
@@ -8,10 +8,10 @@
 METASOURCES = AUTO
 
 libkonq_sidebar_tree_la_SOURCES = konq_sidebartree.cpp konq_sidebartreeitem.cpp konq_sidebartreetoplevelitem.cpp
-libkonq_sidebar_tree_la_LDFLAGS = $(all_libraries) -module -avoid-version -no-undefined
-libkonq_sidebar_tree_la_LIBADD = $(top_builddir)/libkonq/libkonq.la ../libkonqsidebarplugin.la
+libkonq_sidebar_tree_la_LDFLAGS = $(all_libraries) -avoid-version -no-undefined
+libkonq_sidebar_tree_la_LIBADD = $(top_builddir)/libkonq/libkonq.la $(top_builddir)/konqueror/sidebar/libkonqsidebarplugin.la
 
 konqsidebar_tree_la_SOURCES = konqsidebar_tree.cpp
 konqsidebar_tree_la_LDFLAGS = $(all_libraries) -module -avoid-version -no-undefined
-konqsidebar_tree_la_LIBADD = $(top_builddir)/libkonq/libkonq.la ../libkonqsidebarplugin.la libkonq_sidebar_tree.la
+konqsidebar_tree_la_LIBADD = $(top_builddir)/libkonq/libkonq.la $(top_builddir)/konqueror/sidebar/libkonqsidebarplugin.la libkonq_sidebar_tree.la
 
--- konqueror/sidebar/trees/bookmark_module/Makefile.am	25 Jun 2002 02:03:53 -0000	1.1.1.1
+++ konqueror/sidebar/trees/bookmark_module/Makefile.am	26 Nov 2002 21:00:53 -0000	1.3
@@ -6,5 +6,5 @@
 
 konq_sidebartree_bookmarks_la_SOURCES = bookmark_module.cpp bookmark_item.cpp
 konq_sidebartree_bookmarks_la_LDFLAGS = $(all_libraries) -module $(KDE_PLUGIN)
-konq_sidebartree_bookmarks_la_LIBADD = ../../libkonqsidebarplugin.la ../libkonq_sidebar_tree.la
+konq_sidebartree_bookmarks_la_LIBADD = $(top_builddir)/konqueror/sidebar/libkonqsidebarplugin.la $(top_builddir)/konqueror/sidebar/trees/libkonq_sidebar_tree.la
 
--- konqueror/sidebar/trees/dirtree_module/Makefile.am	25 Jun 2002 02:03:53 -0000	1.1.1.1
+++ konqueror/sidebar/trees/dirtree_module/Makefile.am	26 Nov 2002 21:00:53 -0000	1.3
@@ -5,6 +5,6 @@
 METASOURCES = AUTO
 konq_sidebartree_dirtree_la_SOURCES = dirtree_module.cpp dirtree_item.cpp
 konq_sidebartree_dirtree_la_LDFLAGS = $(all_libraries) -module -avoid-version -no-undefined
-konq_sidebartree_dirtree_la_LIBADD = ../../libkonqsidebarplugin.la ../libkonq_sidebar_tree.la
+konq_sidebartree_dirtree_la_LIBADD = $(top_builddir)/konqueror/sidebar/libkonqsidebarplugin.la $(top_builddir)/konqueror/sidebar/trees/libkonq_sidebar_tree.la
 
 
--- konqueror/sidebar/trees/history_module/Makefile.am	1 Oct 2002 02:36:50 -0000	1.1.1.3
+++ konqueror/sidebar/trees/history_module/Makefile.am	26 Nov 2002 21:00:53 -0000	1.7
@@ -7,7 +7,7 @@
 konq_sidebartree_history_la_SOURCES = history_module.cpp history_item.cpp \
 	history_settings.cpp history_settings.skel
 konq_sidebartree_history_la_LDFLAGS = $(all_libraries) -module $(KDE_PLUGIN)
-konq_sidebartree_history_la_LIBADD =  ../../libkonqsidebarplugin.la ../libkonq_sidebar_tree.la
+konq_sidebartree_history_la_LIBADD =  $(top_builddir)/konqueror/sidebar/libkonqsidebarplugin.la $(top_builddir)/konqueror/sidebar/trees/libkonq_sidebar_tree.la
 
 kcm_history_la_SOURCES = kcmhistory.cpp history_dlg.ui history_settings.cpp history_settings.skel
 kcm_history_la_LDFLAGS = $(all_libraries) -module -avoid-version -no-undefined
--- konqueror/sidebar/trees/history_module/history_module.h	14 Aug 2002 14:30:58 -0000	1.1.1.2
+++ konqueror/sidebar/trees/history_module/history_module.h	14 Aug 2002 15:35:44 -0000	1.3
@@ -53,8 +53,7 @@
     bool sortsByName() const { return m_sortsByName; }
 
     static QString groupForURL( const KURL& url ) {
-	static const QString& misc = KGlobal::staticQString(i18n("Miscellaneous"));
-	return url.host().isEmpty() ? misc : url.host();
+	return url.host().isEmpty() ? KGlobal::staticQString(i18n("Miscellaneous")) : url.host();
     }
 
 public slots:
--- konsole/konsole/Makefile.am	4 Jan 2003 04:52:14 -0000	1.1.1.5
+++ konsole/konsole/Makefile.am	26 Nov 2002 21:00:53 -0000	1.7
@@ -12,13 +12,12 @@
 
 # you can add here more. This one gets installed
 bin_PROGRAMS = 	konsole konsole_grantpty kwrited #kcmkonsole
-lib_LTLIBRARIES = kwrited.la konsole.la
+lib_LTLIBRARIES = libkonsolepart_shared.la libkonsolepart.la libkwrited_main.la kwrited.la libkonsole_main.la konsole.la
 
 # libkonsolepart is a part, but konsole.la links directly to it, so we can't
 # install it under kde_module
 
-kde_module_LTLIBRARIES = libkonsolepart.la
-libkonsolepart_la_SOURCES = TEPty.cpp BlockArray.cpp konsole_part.cpp \
+libkonsolepart_shared_la_SOURCES = TEPty.cpp BlockArray.cpp konsole_part.cpp \
 	schema.cpp \
 	session.cpp \
 	TEWidget.cpp \
@@ -29,33 +28,58 @@
 	keytrans.cpp \
 	konsoleiface.skel \
         sessioniface.skel
+libkonsolepart_shared_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -avoid-version
+libkonsolepart_shared_la_LIBADD = $(LIBUTIL) $(XTESTLIB) $(LIB_KPARTS) $(LIB_QT) -lkdecore -lDCOP -lkdeui -lkio
 
-libkonsolepart_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN)
-libkonsolepart_la_LIBADD = $(LIBUTIL) $(XTESTLIB) $(LIB_KPARTS)
+libkonsolepart_la_SOURCES = dummy.cpp
+libkonsolepart_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -module -avoid-version
+libkonsolepart_la_LIBADD  = libkonsolepart_shared.la
+
+dummy.cpp:
+	echo > dummy.cpp
 
 # kwrited kdeinit module
-kwrited_la_SOURCES = kwrited.cpp
-kwrited_la_LIBADD  = libkonsolepart.la
-kwrited_la_LDFLAGS = $(all_libraries) -module -avoid-version
+libkwrited_main_la_SOURCES = kwrited.cpp
+libkwrited_main_la_LDFLAGS = $(all_libraries) -avoid-version
+libkwrited_main_la_LIBADD = $(LIB_KPARTS) $(LIB_QT) -lkdecore -lDCOP libkonsolepart_shared.la
+
+kwrited_la_SOURCES = kwrited_la_main.cpp
+kwrited_la_LDFLAGS = $(all_libraries) -avoid-version -module
+kwrited_la_LIBADD  = libkwrited_main.la
+
+kwrited_la_main.cpp: stub_main.cpp
+	cat stub_main.cpp > kwrited_la_main.cpp
 
 # kwrited executable
-kwrited_SOURCES	= dummy.cpp
-kwrited_LDADD   = kwrited.la 
+kwrited_SOURCES	= kwrited_main.cpp
+kwrited_LDADD   = libkwrited_main.la
 kwrited_LDFLAGS = $(all_libraries) $(KDE_RPATH)
 
+kwrited_main.cpp: stub_main.cpp
+	cat stub_main.cpp > kwrited_main.cpp
 
 # konsole kdeinit module
-konsole_la_SOURCES = TEPty.cpp BlockArray.cpp main.cpp konsole.cpp schema.cpp session.cpp TEWidget.cpp TEmuVt102.cpp \
+libkonsole_main_la_SOURCES = TEPty.cpp BlockArray.cpp main.cpp konsole.cpp schema.cpp session.cpp TEWidget.cpp TEmuVt102.cpp \
      TEScreen.cpp TEmulation.cpp TEHistory.cpp keytrans.cpp konsoleiface.skel sessioniface.skel \
      konsole_wcwidth.cpp konsolebookmarkhandler.cpp konsolebookmarkmenu.cpp konsole_child.cpp
-konsole_la_LDFLAGS = $(all_libraries) -module -avoid-version
-konsole_la_LIBADD = $(LIB_KDEUI) $(LIB_KIO) $(LIBUTIL) $(XTESTLIB)
+libkonsole_main_la_LDFLAGS = $(all_libraries) -avoid-version
+libkonsole_main_la_LIBADD = $(LIB_KDEUI) $(LIB_KIO) $(LIBUTIL) $(XTESTLIB) $(LIB_QT) -lkdecore -lDCOP
+
+konsole_la_SOURCES = konsole_la_main.cpp
+konsole_la_LDFLAGS = $(all_libraries) -avoid-version -module
+konsole_la_LIBADD  = libkonsole_main.la
+
+konsole_la_main.cpp: stub_main.cpp
+	cat stub_main.cpp > konsole_la_main.cpp
 
 # konsole executable
-konsole_SOURCES = dummy.cpp
-konsole_LDADD = konsole.la $(LIB_KIO)
+konsole_SOURCES = konsole_main.cpp
+konsole_LDADD = libkonsole_main.la
 konsole_LDFLAGS = $(all_libraries) $(KDE_RPATH)
 
+konsole_main.cpp: stub_main.cpp
+	cat stub_main.cpp > konsole_main.cpp
+
 # kcmkonsole_SOURCES = kcmkonsole.cpp schema.cpp
 # kcmkonsole_LDADD   = $(LIB_KDEUI)
 # kcmkonsole_LDFLAGS = $(all_libraries) $(KDE_RPATH)
@@ -97,9 +121,6 @@
 	$(XGETTEXT) rc.cpp *.cpp -o $(podir)/konsole.pot
 	rm -f schemas.cpp
 	rm -f tips.cpp
-
-dummy.cpp:
-	echo > dummy.cpp
 
 # setting up x-application/konsole as a special mimetype
 mimedir = $(kde_mimedir)/application
--- konsole/konsole/TEWidget.cpp	3 Mar 2003 01:41:38 -0000	1.1.1.7
+++ konsole/konsole/TEWidget.cpp	29 Mar 2003 02:34:57 -0000	1.7
@@ -963,8 +963,6 @@
   {
     // Extend to complete line
     bool above_not_below = ( here.y() < iPntSelCorr.y() );
-//    bool old_above_not_below = ( pntSelCorr.y() < iPntSelCorr.y() );
-    swapping = true; // triple click maybe selected a wrapped line
 
     QPoint above = above_not_below ? here : iPntSelCorr;
     QPoint below = above_not_below ? iPntSelCorr : here;
@@ -986,6 +984,11 @@
     {
       here = below; ohere = above;
     }
+
+    QPoint newSelBegin = QPoint( ohere.x(), ohere.y() );
+    swapping = !(tripleSelBegin==newSelBegin);
+    tripleSelBegin = newSelBegin;
+
     ohere.rx()++;
   }
 
@@ -1188,9 +1191,12 @@
     { i--; if (x>0) x--; else {x=columns-1; iPntSel.ry()--;} }
 
     emit beginSelectionSignal( x, iPntSel.y() );
+    tripleSelBegin = QPoint( x, iPntSel.y() );
   }
-  else
+  else {
     emit beginSelectionSignal( 0, iPntSel.y() );
+    tripleSelBegin = QPoint( 0, iPntSel.y() );
+  }
 
   while (iPntSel.y()<lines-1 && m_line_wrapped[iPntSel.y()])
     iPntSel.ry()++;
--- konsole/konsole/TEWidget.h	29 Oct 2002 03:06:21 -0000	1.1.1.5
+++ konsole/konsole/TEWidget.h	29 Mar 2003 02:34:57 -0000	1.5
@@ -201,6 +201,7 @@
 
     QPoint iPntSel; // initial selection point
     QPoint pntSel; // current selection point
+    QPoint tripleSelBegin; // help avoid flicker
     int    actSel; // selection state
     bool    word_selection_mode;
     bool    line_selection_mode;
@@ -221,7 +222,7 @@
     bool isBlinkEvent; // paintEvent due to blinking.
     QTimer* blinkT;  // active when hasBlinker
     QTimer* blinkCursorT;  // active when hasBlinkingCursor
-    
+
     KPopupMenu* m_drop;
     QString dropText;
     int m_dnd_file_count;
--- konsole/konsole/konsole_grantpty.c	1 Oct 2002 02:36:59 -0000	1.1.1.3
+++ konsole/konsole/konsole_grantpty.c	25 Mar 2003 18:16:37 -0000	1.4
@@ -33,6 +33,10 @@
 #include <sys/stat.h>
 #include <unistd.h>
 
+#if defined(__APPLE__)
+#  define UNSUPPORTED 1
+#endif
+
 #include <sys/param.h>
 #if defined(__FreeBSD__)
 #  define BSD_PTY_HACK
@@ -45,6 +49,7 @@
 
 int main (int argc, char *argv[])
 {
+
   char*         pty;
   struct stat   st;
   struct group* p;
@@ -89,7 +94,10 @@
 
   /* get slave pty name from master pty file handle in PTY_FILENO *********/
 
-#if defined(BSD_PTY_HACK)
+#if defined(UNSUPPORTED)
+  return 0;
+
+#elif defined(BSD_PTY_HACK)
   /*
     Hack to make konsole_grantpty work on FreeBSD (and possibly other systems).
     ttyname(3) does not work on FreeBSD with a file descriptor opened on a
--- konsole/konsole/kwrited.cpp	29 Oct 2002 03:06:19 -0000	1.1.1.4
+++ konsole/konsole/kwrited.cpp	26 Nov 2002 21:00:53 -0000	1.2
@@ -88,7 +88,9 @@
     ::exit(0);
 }
 
-int main(int argc, char* argv[])
+extern "C" int kdemain(int, char**);
+
+int kdemain(int argc, char* argv[])
 {
   KLocale::setMainCatalogue("konsole");
   KCmdLineArgs::init(argc, argv, "kwrited",
--- konsole/konsole/main.cpp	3 Mar 2003 01:41:37 -0000	1.1.1.6
+++ konsole/konsole/main.cpp	29 Mar 2003 02:34:58 -0000	1.6
@@ -125,7 +125,8 @@
 
 
 /* --| main |------------------------------------------------------ */
-int main(int argc, char* argv[])
+extern "C" kdemain(int, char**);
+int kdemain(int argc, char** argv)
 {
   setgid(getgid()); setuid(getuid()); // drop privileges
 
@@ -135,7 +136,7 @@
   bool toolbaron = true;
   bool frameon = true;
   bool scrollbaron = true;
-  const char* wname = PACKAGE;
+  QCString wname = PACKAGE;
 
 
   KAboutData aboutData( PACKAGE, I18N_NOOP("Konsole"),
RCS file: konsole/konsole/stub_main.cpp
diff -N konsole/konsole/stub_main.cpp
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ konsole/konsole/stub_main.cpp	26 Nov 2002 21:00:53 -0000	1.1
@@ -0,0 +1,28 @@
+/*
+ *
+ * Copyright (c) 2001 Nick Hudson <skrll@netbsd.org>
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining a copy
+ * of this software and associated documentation files (the "Software"), to deal
+ * in the Software without restriction, including without limitation the rights
+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
+ * copies of the Software, and to permit persons to whom the Software is
+ * furnished to do so, subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice shall be included in
+ * all copies or substantial portions of the Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
+ * AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN
+ * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+extern "C" int kdemain(int, char* []);
+
+int main( int argc, char* argv[] )
+{
+        return kdemain(argc, argv);
+}
+
--- ksmserver/Makefile.am	10 Jul 2002 03:24:29 -0000	1.1.1.2
+++ ksmserver/Makefile.am	26 Nov 2002 21:00:54 -0000	1.6
@@ -20,18 +20,28 @@
 INCLUDES=  $(all_includes)
 
 bin_PROGRAMS = ksmserver
-lib_LTLIBRARIES = ksmserver.la
+lib_LTLIBRARIES = ksmserver.la libksmserver_main.la
 noinst_HEADERS = global.h server.h shutdown.h
 
-ksmserver_la_METASOURCES = AUTO
+libksmserver_main_la_METASOURCES = AUTO
 # Order is important for --enable-final!
-ksmserver_la_SOURCES = main.cpp server.cpp shutdown.cpp KSMServerInterface.skel
-ksmserver_SOURCES = dummy.cpp
+libksmserver_main_la_SOURCES = main.cpp server.cpp shutdown.cpp KSMServerInterface.skel
+libksmserver_main_la_LDFLAGS = $(all_libraries) -avoid-version $(QT_LDFLAGS)
+libksmserver_main_la_LIBADD = $(LIB_KDEUI) $(LIB_QT) -lkdecore -lDCOP
 
+ksmserver_la_SOURCES = ksmserver_la_main.cpp
 ksmserver_la_LDFLAGS = $(all_libraries) -avoid-version -module
+ksmserver_la_LIBADD  = libksmserver_main.la
+
+ksmserver_la_main.cpp: stub_main.cpp
+	cat stub_main.cpp > ksmserver_la_main.cpp
+
+ksmserver_SOURCES = ksmserver_main.cpp
 ksmserver_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-ksmserver_la_LIBADD = $(LIB_KDEUI)
-ksmserver_LDADD = ksmserver.la
+ksmserver_LDADD   = libksmserver_main.la
+
+ksmserver_main.cpp: stub_main.cpp
+	cat stub_main.cpp > ksmserver_main.cpp
 
 picsdir = $(kde_datadir)/ksmserver/pics
 pics_DATA = shutdownkonq.png
@@ -47,6 +57,3 @@
 
 messages:
 	$(XGETTEXT) *.cpp -o $(podir)/ksmserver.pot
-
-dummy.cpp:
-	echo > dummy.cpp
--- ksmserver/main.cpp	14 Aug 2002 14:27:51 -0000	1.1.1.3
+++ ksmserver/main.cpp	26 Nov 2002 21:00:54 -0000	1.2
@@ -159,7 +159,8 @@
   }
 }
 
-int main( int argc, char* argv[] )
+extern "C" int kdemain(int, char**);
+int kdemain( int argc, char** argv )
 {
     sanity_check(argc, argv);
 
RCS file: ksmserver/stub_main.cpp
diff -N ksmserver/stub_main.cpp
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ ksmserver/stub_main.cpp	26 Nov 2002 21:00:54 -0000	1.1
@@ -0,0 +1,28 @@
+/*
+ *
+ * Copyright (c) 2001 Nick Hudson <skrll@netbsd.org>
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining a copy
+ * of this software and associated documentation files (the "Software"), to deal
+ * in the Software without restriction, including without limitation the rights
+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
+ * copies of the Software, and to permit persons to whom the Software is
+ * furnished to do so, subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice shall be included in
+ * all copies or substantial portions of the Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
+ * AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN
+ * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+extern "C" int kdemain(int, char* []);
+
+int main( int argc, char* argv[] )
+{
+        return kdemain(argc, argv);
+}
+
--- ksysguard/configure.in.in	29 Oct 2002 03:06:45 -0000	1.1.1.4
+++ ksysguard/configure.in.in	11 Nov 2002 20:56:20 -0000	1.2
@@ -1,3 +1,5 @@
+DO_NOT_COMPILE="$DO_NOT_COMPILE ksysguard"
+
 dnl Check whether ksysguardd can run; 
 AC_MSG_CHECKING([if ksysguardd can be compiled])
 case "$host" in 
--- ksystraycmd/ksystraycmd.cpp	14 Aug 2002 14:30:17 -0000	1.1.1.2
+++ ksystraycmd/ksystraycmd.cpp	21 Mar 2003 18:10:45 -0000	1.2
@@ -110,13 +110,15 @@
   connect( kwinmodule, SIGNAL(windowChanged(WId)), SLOT(windowChanged(WId)) );
   win = info.win;
   KWin::setSystemTrayWindowFor( winId(), win );
+
   refresh();
   show();
 
-  if ( isVisible )
+  if ( isVisible ) {
     KWin::setActiveWindow( win );
-  else
+  } else {
     hideWindow();
+  }
 }
 
 //
--- ktip/tips	29 Oct 2002 03:06:51 -0000	1.1.1.5
+++ ktip/tips	31 Oct 2002 19:19:37 -0000	1.2
@@ -704,20 +704,6 @@
 </tip>
 
 
-<tip category="Win2Unix">
-<html>
-<p>
-You might wonder why there are very few (if any) files whose
-names end in <code>.exe</code> or <code>.bat</code> on UNIX
-systems. This is because filenames on UNIX do not need an
-extension. Executable files in KDE are represented by the gear icon
-in Konqueror. In the Konsole window, they are often colored red 
-(depending on your settings).
-</p>
-<p align="right"><em>Contributed by Carsten Niehaus</em></p>
-</html>
-</tip>
-
 <tip category="KDE|Win2Unix|General">
 <html>
 <p>
--- kwin/Makefile.am	10 Jul 2002 03:24:51 -0000	1.1.1.2
+++ kwin/Makefile.am	26 Nov 2002 21:00:54 -0000	1.6
@@ -3,14 +3,21 @@
 SUBDIRS = . kcmkwin pics clients
 
 bin_PROGRAMS = kwin
-lib_LTLIBRARIES = kwin.la
+lib_LTLIBRARIES = kwin.la libkwin_main.la
 
 # workspace.cpp has to be first in order not to break --enable-final
-kwin_la_SOURCES = workspace.cpp placement.cpp atoms.cpp  client.cpp main.cpp \
+libkwin_main_la_SOURCES = workspace.cpp placement.cpp atoms.cpp  client.cpp main.cpp \
 	popupinfo.cpp tabbox.cpp options.cpp plugins.cpp events.cpp KWinInterface.skel \
 	killwindow.cpp kwinbutton.cpp
-kwin_la_LIBADD = $(LIB_KDEUI) $(LIBXINERAMA)
-kwin_la_LDFLAGS = $(all_libraries) -module -avoid-version
+libkwin_main_la_LIBADD = $(LIB_KDEUI) $(LIBXINERAMA) $(LIB_QT) -lkdecore -lDCOP
+libkwin_main_la_LDFLAGS = $(all_libraries) -avoid-version $(QT_LDFLAGS)
+
+kwin_la_SOURCES = kwin_la_main.cpp
+kwin_la_LIBADD  = libkwin_main.la
+kwin_la_LDFLAGS = $(all_libraries) -avoid-version -module
+
+kwin_la_main.cpp: kwin_main.cpp
+	cat kwin_main.cpp > kwin_la_main.cpp
 
 include_HEADERS = KWinInterface.h
 
@@ -18,7 +25,7 @@
 kwininclude_HEADERS = options.h client.h workspace.h kwinbutton.h
 
 kwin_SOURCES = kwin_main.cpp
-kwin_LDADD = kwin.la
+kwin_LDADD = libkwin_main.la
 kwin_LDFLAGS = $(all_libraries) $(KDE_RPATH)
 
 KDE_ICON = kwin
--- kwin/client.cpp	13 Mar 2003 03:03:07 -0000	1.1.1.9
+++ kwin/client.cpp	29 Mar 2003 02:35:01 -0000	1.2
@@ -619,6 +619,7 @@
 
 void Client::stopMoveResize()
 {
+    clearbound();
     if ( ( isMove() && options->moveMode != Options::Opaque )
       || ( isResize() && options->resizeMode != Options::Opaque ) )
         XUngrabServer( qt_xdisplay() );
@@ -626,6 +627,7 @@
     releaseMouse();
     workspace()->setClientIsMoving(0);
     moveResizeMode = false;
+    update();
 }
 
 /*!
@@ -1553,8 +1555,14 @@
  */
 bool Client::isMinimizable() const
 {
-    return ( !isTransient() || !workspace()->findClient( transientFor() ) )
-        && wantsTabFocus() && may_minimize;
+    if( isTransient())
+    {
+	Client* trans = workspace()->findClient( transientFor());
+	// TODO should it be allowed to have WM_TRANSIENT_FOR pointing to itself?
+	if( trans != NULL && trans != this )
+	    return false;
+    }
+    return wantsTabFocus() && may_minimize;
 }
 
 /*
@@ -1562,8 +1570,7 @@
  */
 bool Client::isCloseable() const
 {
-    return may_close && !isDesktop() && !isDock() && !isTopMenu()
-	&&  windowType() != NET::Override;
+    return may_close && !isDesktop() && !isDock() && !isTopMenu();
 }
 
 
@@ -1623,7 +1630,6 @@
     if ( (e->stateAfter() & MouseButtonMask) == 0 ) {
         buttonDown = FALSE;
         if ( moveResizeMode ) {
-            clearbound();
             stopMoveResize();
             setGeometry( geom );
             mode = mousePosition( e->pos() );
@@ -2116,14 +2122,6 @@
     case MaximizeFull: {
         QSize adjSize = adjustedSize(clientArea.size());
         QRect r = QRect(clientArea.topLeft(), adjSize);
-
-        // hide right and left border of maximized windows
-        if ( !options->moveResizeMaximizedWindows && adjSize == clientArea.size()) {
-            if ( r.left() == 0 )
-                r.setLeft( r.left() - windowWrapper()->x() );
-            if ( r.right() == workspace()->geometry().right() )
-                r.setRight( r.right() + width() -  windowWrapper()->geometry().right() );
-        }
         setGeometry( r );
         info->setState( NET::Max, NET::Max );
     } break;
@@ -2847,7 +2845,6 @@
     case Key_Return:
     case Key_Enter:
     case Key_Escape:
-        clearbound();
         stopMoveResize();
         setGeometry( geom );
         buttonDown = FALSE;
--- kwin/workspace.cpp	13 Mar 2003 03:03:09 -0000	1.1.1.10
+++ kwin/workspace.cpp	29 Mar 2003 02:35:01 -0000	1.2
@@ -1163,9 +1163,12 @@
         return TRUE;
     }
 
+    bool forward = false;
+    bool backward = false;
+
     if (tab_grab){
-        bool forward = cutWalkThroughWindows.contains( keyX );
-        bool backward = cutWalkThroughWindowsReverse.contains( keyX );
+        forward = cutWalkThroughWindows.contains( keyX );
+        backward = cutWalkThroughWindowsReverse.contains( keyX );
         if (forward || backward){
             kdDebug(125) << "== " << cutWalkThroughWindows.toStringInternal()
                 << " or " << cutWalkThroughWindowsReverse.toStringInternal() << endl;
@@ -1173,16 +1176,17 @@
         }
     }
     else if (control_grab){
-        bool forward = cutWalkThroughDesktops.contains( keyX ) ||
-                       cutWalkThroughDesktopList.contains( keyX );
-        bool backward = cutWalkThroughDesktopsReverse.contains( keyX ) ||
-                        cutWalkThroughDesktopListReverse.contains( keyX );
+        forward = cutWalkThroughDesktops.contains( keyX ) ||
+                  cutWalkThroughDesktopList.contains( keyX );
+        backward = cutWalkThroughDesktopsReverse.contains( keyX ) ||
+                   cutWalkThroughDesktopListReverse.contains( keyX );
         if (forward || backward)
             walkThroughDesktops(forward);
     }
 
     if (control_grab || tab_grab){
-        if ((keyQt & 0xffff) == Qt::Key_Escape){
+        if ( ((keyQt & 0xffff) == Qt::Key_Escape)
+	    && !(forward || backward) ){ // if Espace is part of the shortcut, don't cancel
             XUngrabKeyboard(qt_xdisplay(), qt_x_time);
             XUngrabPointer( qt_xdisplay(), qt_x_time);
             tab_box->hide();
--- kwin/clients/b2/Makefile.am	25 Jun 2002 02:03:54 -0000	1.1.1.1
+++ kwin/clients/b2/Makefile.am	26 Nov 2002 21:00:54 -0000	1.2
@@ -6,7 +6,7 @@
 kde_module_LTLIBRARIES = kwin_b2.la
 
 kwin_b2_la_SOURCES = b2client.cpp
-kwin_b2_la_LIBADD = ../../kwin.la
+kwin_b2_la_LIBADD = ../../libkwin_main.la
 kwin_b2_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 METASOURCES = AUTO
--- kwin/clients/default/Makefile.am	5 Nov 2002 00:19:26 -0000	1.1.1.3
+++ kwin/clients/default/Makefile.am	26 Nov 2002 21:00:54 -0000	1.2
@@ -6,7 +6,7 @@
 kde_module_LTLIBRARIES = kwin_default.la
 
 kwin_default_la_SOURCES = kdedefault.cpp
-kwin_default_la_LIBADD = ../../kwin.la
+kwin_default_la_LIBADD = ../../libkwin_main.la
 kwin_default_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 METASOURCES = AUTO
--- kwin/clients/icewm/Makefile.am	25 Jun 2002 02:03:54 -0000	1.1.1.1
+++ kwin/clients/icewm/Makefile.am	26 Nov 2002 21:00:54 -0000	1.2
@@ -5,7 +5,7 @@
 kde_module_LTLIBRARIES = kwin_icewm.la
 
 kwin_icewm_la_SOURCES = icewm.cpp 
-kwin_icewm_la_LIBADD = ../../kwin.la
+kwin_icewm_la_LIBADD = ../../libkwin_main.la
 kwin_icewm_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 METASOURCES = AUTO
--- kwin/clients/kde1/Makefile.am	25 Jun 2002 02:03:54 -0000	1.1.1.1
+++ kwin/clients/kde1/Makefile.am	26 Nov 2002 21:00:54 -0000	1.2
@@ -4,7 +4,7 @@
 kde_module_LTLIBRARIES = kwin_kde1.la
 
 kwin_kde1_la_SOURCES = kde1client.cpp
-kwin_kde1_la_LIBADD = ../../kwin.la
+kwin_kde1_la_LIBADD = ../../libkwin_main.la
 kwin_kde1_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 METASOURCES = AUTO
--- kwin/clients/keramik/Makefile.am	1 Oct 2002 02:37:32 -0000	1.1.1.2
+++ kwin/clients/keramik/Makefile.am	26 Nov 2002 21:00:54 -0000	1.2
@@ -13,7 +13,7 @@
 kde_module_LTLIBRARIES    = kwin_keramik.la
 
 kwin_keramik_la_SOURCES   = keramik.cpp
-kwin_keramik_la_LIBADD    = ../../kwin.la
+kwin_keramik_la_LIBADD    = ../../libkwin_main.la
 kwin_keramik_la_COMPILE_FIRST = tiles.h
 kwin_keramik_la_LDFLAGS   = $(all_libraries) $(KDE_PLUGIN) -module
 
--- kwin/clients/kstep/Makefile.am	25 Jun 2002 02:03:54 -0000	1.1.1.1
+++ kwin/clients/kstep/Makefile.am	26 Nov 2002 21:00:55 -0000	1.2
@@ -4,7 +4,7 @@
 kde_module_LTLIBRARIES = kwin_kstep.la
 
 kwin_kstep_la_SOURCES = nextclient.cpp
-kwin_kstep_la_LIBADD = ../../kwin.la
+kwin_kstep_la_LIBADD = ../../libkwin_main.la
 kwin_kstep_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 METASOURCES = AUTO
--- kwin/clients/kwmtheme/Makefile.am	25 Jun 2002 02:03:54 -0000	1.1.1.1
+++ kwin/clients/kwmtheme/Makefile.am	26 Nov 2002 21:00:55 -0000	1.2
@@ -4,7 +4,7 @@
 kde_module_LTLIBRARIES = kwin_kwmtheme.la
 
 kwin_kwmtheme_la_SOURCES = kwmthemeclient.cpp
-kwin_kwmtheme_la_LIBADD = ../../kwin.la
+kwin_kwmtheme_la_LIBADD = ../../libkwin_main.la
 kwin_kwmtheme_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 METASOURCES = AUTO
--- kwin/clients/laptop/Makefile.am	25 Jun 2002 02:03:54 -0000	1.1.1.1
+++ kwin/clients/laptop/Makefile.am	26 Nov 2002 21:00:55 -0000	1.2
@@ -4,7 +4,7 @@
 kde_module_LTLIBRARIES = kwin_laptop.la
 
 kwin_laptop_la_SOURCES = laptopclient.cpp
-kwin_laptop_la_LIBADD = ../../kwin.la
+kwin_laptop_la_LIBADD = ../../libkwin_main.la
 kwin_laptop_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 METASOURCES = AUTO
--- kwin/clients/modernsystem/Makefile.am	25 Jun 2002 02:03:54 -0000	1.1.1.1
+++ kwin/clients/modernsystem/Makefile.am	26 Nov 2002 21:00:55 -0000	1.2
@@ -7,7 +7,7 @@
 kde_module_LTLIBRARIES = kwin_modernsys.la
 
 kwin_modernsys_la_SOURCES = modernsys.cpp
-kwin_modernsys_la_LIBADD = ../../kwin.la
+kwin_modernsys_la_LIBADD = ../../libkwin_main.la
 kwin_modernsys_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 METASOURCES = AUTO
--- kwin/clients/quartz/Makefile.am	25 Jun 2002 02:03:54 -0000	1.1.1.1
+++ kwin/clients/quartz/Makefile.am	26 Nov 2002 21:00:55 -0000	1.2
@@ -6,7 +6,7 @@
 kde_module_LTLIBRARIES = kwin_quartz.la
 
 kwin_quartz_la_SOURCES = quartz.cpp
-kwin_quartz_la_LIBADD = ../../kwin.la
+kwin_quartz_la_LIBADD = ../../libkwin_main.la
 kwin_quartz_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 METASOURCES = AUTO
--- kwin/clients/redmond/Makefile.am	25 Jun 2002 02:03:54 -0000	1.1.1.1
+++ kwin/clients/redmond/Makefile.am	26 Nov 2002 21:00:55 -0000	1.2
@@ -4,7 +4,7 @@
 kde_module_LTLIBRARIES = kwin_redmond.la
 
 kwin_redmond_la_SOURCES = redmond.cpp
-kwin_redmond_la_LIBADD = ../../kwin.la
+kwin_redmond_la_LIBADD = ../../libkwin_main.la
 kwin_redmond_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 METASOURCES = AUTO
--- kwin/clients/riscos/Makefile.am	25 Jun 2002 02:03:54 -0000	1.1.1.1
+++ kwin/clients/riscos/Makefile.am	26 Nov 2002 21:00:55 -0000	1.2
@@ -12,7 +12,7 @@
 StickyButton.cpp \
 HelpButton.cpp \
 Static.cpp
-kwin_riscos_la_LIBADD = ../../kwin.la
+kwin_riscos_la_LIBADD = ../../libkwin_main.la
 kwin_riscos_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 METASOURCES = AUTO
--- kwin/clients/system/Makefile.am	25 Jun 2002 02:03:54 -0000	1.1.1.1
+++ kwin/clients/system/Makefile.am	26 Nov 2002 21:00:55 -0000	1.2
@@ -4,7 +4,7 @@
 kde_module_LTLIBRARIES = kwin_system.la
 
 kwin_system_la_SOURCES = systemclient.cpp
-kwin_system_la_LIBADD = ../../kwin.la
+kwin_system_la_LIBADD = ../../libkwin_main.la
 kwin_system_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 METASOURCES = AUTO
--- kwin/clients/web/Makefile.am	25 Jun 2002 02:03:54 -0000	1.1.1.1
+++ kwin/clients/web/Makefile.am	26 Nov 2002 21:00:55 -0000	1.2
@@ -21,7 +21,7 @@
   WebButtonMaximize.h \
   WebButtonSticky.h
 
-kwin_web_la_LIBADD      = ../../kwin.la
+kwin_web_la_LIBADD      = ../../libkwin_main.la
 kwin_web_la_LDFLAGS     = $(all_libraries) $(KDE_PLUGIN) -module
 METASOURCES               = AUTO
 
--- kwin/kcmkwin/kwinoptions/Makefile.am	1 Oct 2002 02:37:36 -0000	1.1.1.4
+++ kwin/kcmkwin/kwinoptions/Makefile.am	1 Oct 2002 12:06:42 -0000	1.2
@@ -10,7 +10,7 @@
 kcm_kwinoptions_la_LDFLAGS = -module -avoid-version $(all_libraries) -no-undefined
 kcm_kwinoptions_la_LIBADD = $(LIB_KDEUI)
 
-noinst_HEADERS = windows.h mouse.h 
+noinst_HEADERS = windows.h mouse.h main.h
 
 messages:
 	$(XGETTEXT) *.cpp -o $(podir)/kcmkwm.pot
--- kxkb/Makefile.am	29 Oct 2002 03:07:04 -0000	1.1.1.5
+++ kxkb/Makefile.am	12 Jan 2003 18:00:03 -0000	1.11
@@ -7,20 +7,30 @@
 
 bin_PROGRAMS = kxkb
 
-kxkb_SOURCES = dummy.cpp
+kxkb_SOURCES = kxkb_main.cpp
 kxkb_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-kxkb_LDADD = kxkb.la -lxkbfile
+kxkb_LDADD = libkxkb_main.la
 
-lib_LTLIBRARIES = kxkb.la
+kxkb_main.cpp: stub_main.cpp
+	cat stub_main.cpp > kxkb_main.cpp
+
+lib_LTLIBRARIES = kxkb.la libkxkb_main.la
 kde_module_LTLIBRARIES = kcm_keyboard.la
 
 kcm_keyboard_la_SOURCES = rules.cpp kcmlayout.cpp pixmap.cpp kcmmisc.cpp kcmmiscwidget.ui
 kcm_keyboard_la_LDFLAGS  = $(all_libraries) -module -avoid-version -no-undefined
 kcm_keyboard_la_LIBADD = $(XTESTLIB) $(LIB_KIO) -lxkbfile
 
-kxkb_la_SOURCES = kxkb.cpp rules.cpp extension.cpp pixmap.cpp
-kxkb_la_LDFLAGS = $(all_libraries) -module -avoid-version
-kxkb_la_LIBADD = -lX11 -lXext $(LIB_KDEUI) -lxkbfile
+libkxkb_main_la_SOURCES = kxkb.cpp rules.cpp extension.cpp pixmap.cpp
+libkxkb_main_la_LDFLAGS = $(all_libraries) -avoid-version
+libkxkb_main_la_LIBADD = $(LIB_X11) $(LIB_XEXT) $(LIB_KDEUI) -lxkbfile $(LIB_QT) -lDCOP -lkdecore
+
+kxkb_la_SOURCES = kxkb_la_main.cpp
+kxkb_la_LDFLAGS = $(all_libraries) -avoid-version -module
+kxkb_la_LIBADD = libkxkb_main.la
+
+kxkb_la_main.cpp: stub_main.cpp
+	cat stub_main.cpp > kxkb_la_main.cpp
 
 data_DATA = keyboard.desktop
 datadir = $(kde_appsdir)/Settings/Peripherals
@@ -37,6 +47,3 @@
 messages: rc.cpp
 	$(XGETTEXT) $(kxkb_la_SOURCES) kxkbbindings.cpp -o $(podir)/kxkb.pot
 	$(XGETTEXT) rules.cpp kcmlayout.cpp pixmap.cpp kcmmisc.cpp rc.cpp kxkbbindings.cpp -o $(podir)/kcmlayout.pot 
-
-dummy.cpp:
-	echo > dummy.cpp
--- kxkb/keyboard_layout.desktop	20 Nov 2002 01:15:15 -0000	1.1.1.4
+++ kxkb/keyboard_layout.desktop	29 Mar 2003 02:35:05 -0000	1.2
@@ -1,6 +1,6 @@
 [Desktop Entry]
 Encoding=UTF-8
-Exec=kcmshell keyboard
+Exec=kcmshell keyboard_layout
 Icon=keyboard
 Type=Application
 DocPath=kcontrol/keyboard/index.html
--- kxkb/kxkb.cpp	3 Mar 2003 01:42:18 -0000	1.1.1.6
+++ kxkb/kxkb.cpp	3 Mar 2003 01:55:33 -0000	1.3
@@ -508,7 +508,8 @@
 const char * DESCRIPTION =
   I18N_NOOP("A utility to switch keyboard maps.");
 
-int main(int argc, char *argv[])
+extern "C" int kdemain(int, char**);
+int kdemain(int argc, char **argv)
 {
     KAboutData about("kxkb", I18N_NOOP("KDE Keyboard Tool"), "0.8",
                      DESCRIPTION, KAboutData::License_LGPL,
RCS file: kxkb/stub_main.cpp
diff -N kxkb/stub_main.cpp
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ kxkb/stub_main.cpp	26 Nov 2002 21:00:56 -0000	1.1
@@ -0,0 +1,28 @@
+/*
+ *
+ * Copyright (c) 2001 Nick Hudson <skrll@netbsd.org>
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining a copy
+ * of this software and associated documentation files (the "Software"), to deal
+ * in the Software without restriction, including without limitation the rights
+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
+ * copies of the Software, and to permit persons to whom the Software is
+ * furnished to do so, subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice shall be included in
+ * all copies or substantial portions of the Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
+ * AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN
+ * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+extern "C" int kdemain(int, char* []);
+
+int main( int argc, char* argv[] )
+{
+        return kdemain(argc, argv);
+}
+
--- libkonq/Makefile.am	1 Oct 2002 02:37:43 -0000	1.1.1.4
+++ libkonq/Makefile.am	25 Mar 2003 18:16:38 -0000	1.7
@@ -21,7 +21,7 @@
 
 lib_LTLIBRARIES = libkonq.la
 libkonq_la_LDFLAGS = $(all_libraries) -version-info 5:0:1 -no-undefined
-libkonq_la_LIBADD = $(LIB_KPARTS)
+libkonq_la_LIBADD = $(LIB_KPARTS) $(LIBZ)
 
 libkonq_la_SOURCES = konq_popupmenu.cc knewmenu.cc \
    konq_xmlguiclient.cc\
--- libkonq/favicons/Makefile.am	25 Jun 2002 02:03:55 -0000	1.1.1.1
+++ libkonq/favicons/Makefile.am	9 Feb 2003 17:00:15 -0000	1.5
@@ -2,8 +2,8 @@
 
 INCLUDES = $(all_includes)
 kded_favicons_la_SOURCES = favicons.cpp favicons.skel
-kded_favicons_la_LDFLAGS = $(all_libraries) -module -avoid-version
-kded_favicons_la_LIBADD = $(LIB_KSYCOCA)
+kded_favicons_la_LDFLAGS = $(all_libraries) -module -avoid-version $(QT_LDFLAGS) -undefined suppress -flat_namespace
+kded_favicons_la_LIBADD = $(LIB_KSYCOCA) $(LIB_QT) $(LIB_KDECORE)
 
 METASOURCES = AUTO
 
--- nsplugins/pluginscan.cpp	29 Oct 2002 03:07:09 -0000	1.1.1.3
+++ nsplugins/pluginscan.cpp	29 Oct 2002 03:39:40 -0000	1.4
@@ -443,6 +443,7 @@
         paths.append("/usr/lib/netscape/plugins");
         paths.append("/usr/lib/netscape/plugins-libc5");
         paths.append("/usr/lib/netscape/plugins-libc6");
+        paths.append("@PREFIX@/lib/mozilla/plugins");
         paths.append("/usr/lib/mozilla/plugins");
         paths.append("$MOZILLA_HOME/plugins");
         config->writeEntry( "scanPaths", paths );
--- nsplugins/viewer/nsplugin.cpp	13 Mar 2003 03:03:24 -0000	1.1.1.5
+++ nsplugins/viewer/nsplugin.cpp	29 Mar 2003 02:35:08 -0000	1.2
@@ -549,6 +549,7 @@
    XtRealizeWidget(_form);
 
    // Create widget that is passed to the plugin
+   XtInitializeWidgetClass(xmDrawingAreaWidgetClass);
    _area = XmCreateDrawingArea( _form, (char*)("drawingArea"), args, nargs);
    XtRealizeWidget(_area);
    XtMapWidget(_area);
